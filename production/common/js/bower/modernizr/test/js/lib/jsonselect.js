/*! Copyright (c) 2011, Lloyd Hilaiel, ISC License */

!function(r){function t(r){try{return JSON&&JSON.parse?JSON.parse(r):Function("return "+r)()}catch(t){n("ijs")}}function n(r){throw Error(f[r])}function e(r){return Array.isArray?Array.isArray(r):"[object Array]"===a.call(r)}function s(r){if(null===r)return"null";var t=typeof r;return"object"===t&&e(r)&&(t="array"),t}function i(r,t,n,e,i){var o,c=[],u=">"===t[0]?t[1]:t[0],a=!0;return u.type&&(a=a&&u.type===s(r)),u.id&&(a=a&&u.id===n),a&&u.pf&&(":nth-last-child"===u.pf?e=i-e:e++,0===u.a?a=u.b===e:(o=(e-u.b)%u.a,a=!o&&e*u.a+u.b>=0)),">"!==t[0]&&":root"!==t[0].pc&&c.push(t),a&&(">"===t[0]?t.length>2&&(a=!1,c.push(t.slice(2))):t.length>1&&(a=!1,c.push(t.slice(1)))),[a,c]}function o(r,t,n,s,c,u){var a,f,p=","===r[0]?r.slice(1):[r],l=[],h=!1,d=0,y=0,b=0;for(d=0;d<p.length;d++)for(f=i(t,p[d],s,c,u),f[0]&&(h=!0),y=0;y<f[1].length;y++)l.push(f[1][y]);if(l.length&&"object"==typeof t)if(l.length>=1&&l.unshift(","),e(t))for(d=0;d<t.length;d++)o(l,t[d],n,void 0,d,t.length);else{b=0;for(a in t)t.hasOwnProperty(a)&&b++;d=0;for(a in t)t.hasOwnProperty(a)&&o(l,t[a],n,a,d++,b)}h&&n&&n(t)}function c(r,t){var n=[];return o(r,t,function(r){n.push(r)}),n}function u(r){return{sel:y(r),match:function(r){return c(this.sel,r)},forEach:function(r,t){return o(this.sel,r,t)}}}var a=Object.prototype.toString,f={ijs:"invalid json string",mpc:"multiple pseudo classes (:xxx) not allowed",mepf:"malformed expression in pseudo-function",nmi:"multiple ids not allowed",se:"selector expected",sra:"string required after '.'",uc:"unrecognized char",ujs:"unclosed json string",upc:"unrecognized pseudo class"},p={psc:1,psf:2,typ:3,str:4},l=/^(?:([\r\n\t\ ]+)|([*.,>])|(string|boolean|null|array|object|number)|(:(?:root|first-child|last-child|only-child))|(:(?:nth-child|nth-last-child))|(:\w+)|(\"(?:[^\\]|\\[^\"])*\")|(\")|((?:[_a-zA-Z]|[^\0-\0177]|\\[^\r\n\f0-9a-fA-F])(?:[_a-zA-Z0-9\-]|[^\u0000-\u0177]|(?:\\[^\r\n\f0-9a-fA-F]))*))/,h=/^\s*\(\s*(?:([+\-]?)([0-9]*)n\s*(?:([+\-])\s*([0-9]))?|(odd|even)|([+\-]?[0-9]+))\s*\)/,d=function(r,e){var s,i;return e||(e=0),(s=l.exec(r.substr(e)))?(e+=s[0].length,s[1]?i=[e," "]:s[2]?i=[e,s[0]]:s[3]?i=[e,p.typ,s[0]]:s[4]?i=[e,p.psc,s[0]]:s[5]?i=[e,p.psf,s[0]]:s[6]?n("upc"):s[7]?i=[e,p.str,t(s[0])]:s[8]?n("ujs"):s[9]&&(i=[e,p.str,s[0].replace(/\\([^\r\n\f0-9a-fA-F])/g,"$1")]),i):void 0},y=function(r){for(var t,n,e=[],s=0;;){if(n=b(r,s),e.push(n[1]),n=d(r,s=n[0]),n&&" "===n[1]&&(n=d(r,s=n[0])),!n)break;">"===n[1]?(e.push(">"),s=n[0]):","===n[1]&&(void 0===t?t=[",",e]:t.push(e),e=[],s=n[0])}return t&&t.push(e),t?t:e},b=function(r,t){var e,s=t,i={},o=d(r,t);for(o&&" "===o[1]&&(s=t=o[0],o=d(r,t)),o&&o[1]===p.typ?(i.type=o[2],o=d(r,t=o[0])):o&&"*"===o[1]&&(o=d(r,t=o[0]));;){if(void 0===o)break;if("."===o[1])o=d(r,t=o[0]),o&&o[1]===p.str||n("sra"),i.id&&n("nmi"),i.id=o[2];else if(o[1]===p.psc)(i.pc||i.pf)&&n("mpc"),":first-child"===o[2]?(i.pf=":nth-child",i.a=0,i.b=1):":last-child"===o[2]?(i.pf=":nth-last-child",i.a=0,i.b=1):i.pc=o[2];else{if(o[1]!==p.psf)break;(i.pc||i.pf)&&n("mpc"),i.pf=o[2],e=h.exec(r.substr(o[0])),e||n("mepf"),e[5]?(i.a=2,i.b="odd"===e[5]?1:0):e[6]?(i.a=0,i.b=parseInt(e[6],10)):(i.a=parseInt((e[1]?e[1]:"+")+(e[2]?e[2]:"1"),10),i.b=e[3]?parseInt(e[3]+e[4],10):0),o[0]+=e[0].length}o=d(r,t=o[0])}return s===t&&n("se"),[t,i]};r._lex=d,r._parse=y,r.match=function(r,t){return u(r).match(t)},r.forEach=function(r,t,n){return u(r).forEach(t,n)},r.compile=u}("undefined"==typeof exports?window.JSONSelect={}:exports);