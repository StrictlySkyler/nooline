/*  AES implementation in JavaScript (c) Chris Veness 2005-2011                                   */

/*  AES Counter-mode implementation in JavaScript (c) Chris Veness 2005-2011                      */

/*  Base64 class: Base 64 encoding / decoding (c) Chris Veness 2002-2011                          */

/*              single-byte character encoding (c) Chris Veness 2002-2011                         */

var Base64,Utf8,Aes={};Aes.cipher=function(r,e){var o,t,n,a=4,f=e.length/a-1,c=[[],[],[],[]];for(o=0;4*a>o;o++)c[o%4][Math.floor(o/4)]=r[o];for(c=Aes.addRoundKey(c,e,0,a),t=1;f>t;t++)c=Aes.subBytes(c,a),c=Aes.shiftRows(c,a),c=Aes.mixColumns(c,a),c=Aes.addRoundKey(c,e,t,a);for(c=Aes.subBytes(c,a),c=Aes.shiftRows(c,a),c=Aes.addRoundKey(c,e,f,a),n=Array(4*a),o=0;4*a>o;o++)n[o]=c[o%4][Math.floor(o/4)];return n},Aes.keyExpansion=function(r){var e,o,t,n=4,a=r.length/4,f=a+6,c=Array(n*(f+1)),s=Array(4);for(e=0;a>e;e++)o=[r[4*e],r[4*e+1],r[4*e+2],r[4*e+3]],c[e]=o;for(e=a;n*(f+1)>e;e++){for(c[e]=Array(4),t=0;4>t;t++)s[t]=c[e-1][t];if(0==e%a)for(s=Aes.subWord(Aes.rotWord(s)),t=0;4>t;t++)s[t]^=Aes.rCon[e/a][t];else a>6&&4==e%a&&(s=Aes.subWord(s));for(t=0;4>t;t++)c[e][t]=c[e-a][t]^s[t]}return c},Aes.subBytes=function(r,e){var o,t;for(o=0;4>o;o++)for(t=0;e>t;t++)r[o][t]=Aes.sBox[r[o][t]];return r},Aes.shiftRows=function(r,e){var o,t,n=Array(4);for(o=1;4>o;o++){for(t=0;4>t;t++)n[t]=r[o][(t+o)%e];for(t=0;4>t;t++)r[o][t]=n[t]}return r},Aes.mixColumns=function(r){var e,o,t,n;for(e=0;4>e;e++){for(o=Array(4),t=Array(4),n=0;4>n;n++)o[n]=r[n][e],t[n]=128&r[n][e]?283^r[n][e]<<1:r[n][e]<<1;r[0][e]=t[0]^o[1]^t[1]^o[2]^o[3],r[1][e]=o[0]^t[1]^o[2]^t[2]^o[3],r[2][e]=o[0]^o[1]^t[2]^o[3]^t[3],r[3][e]=o[0]^t[0]^o[1]^o[2]^t[3]}return r},Aes.addRoundKey=function(r,e,o,t){var n,a;for(n=0;4>n;n++)for(a=0;t>a;a++)r[n][a]^=e[4*o+a][n];return r},Aes.subWord=function(r){for(var e=0;4>e;e++)r[e]=Aes.sBox[r[e]];return r},Aes.rotWord=function(r){var e,o=r[0];for(e=0;3>e;e++)r[e]=r[e+1];return r[3]=o,r},Aes.sBox=[99,124,119,123,242,107,111,197,48,1,103,43,254,215,171,118,202,130,201,125,250,89,71,240,173,212,162,175,156,164,114,192,183,253,147,38,54,63,247,204,52,165,229,241,113,216,49,21,4,199,35,195,24,150,5,154,7,18,128,226,235,39,178,117,9,131,44,26,27,110,90,160,82,59,214,179,41,227,47,132,83,209,0,237,32,252,177,91,106,203,190,57,74,76,88,207,208,239,170,251,67,77,51,133,69,249,2,127,80,60,159,168,81,163,64,143,146,157,56,245,188,182,218,33,16,255,243,210,205,12,19,236,95,151,68,23,196,167,126,61,100,93,25,115,96,129,79,220,34,42,144,136,70,238,184,20,222,94,11,219,224,50,58,10,73,6,36,92,194,211,172,98,145,149,228,121,231,200,55,109,141,213,78,169,108,86,244,234,101,122,174,8,186,120,37,46,28,166,180,198,232,221,116,31,75,189,139,138,112,62,181,102,72,3,246,14,97,53,87,185,134,193,29,158,225,248,152,17,105,217,142,148,155,30,135,233,206,85,40,223,140,161,137,13,191,230,66,104,65,153,45,15,176,84,187,22],Aes.rCon=[[0,0,0,0],[1,0,0,0],[2,0,0,0],[4,0,0,0],[8,0,0,0],[16,0,0,0],[32,0,0,0],[64,0,0,0],[128,0,0,0],[27,0,0,0],[54,0,0,0]],Aes.Ctr={},Aes.Ctr.encrypt=function(r,e,o){var t,n,a,f,c,s,A,d,i,u,h,C,l,y,g,v,x,m,p,B=16;if(128!=o&&192!=o&&256!=o)return"";for(r=Utf8.encode(r),e=Utf8.encode(e),t=o/8,n=Array(t),a=0;t>a;a++)n[a]=isNaN(e.charCodeAt(a))?0:e.charCodeAt(a);for(f=Aes.cipher(n,Aes.keyExpansion(n)),f=f.concat(f.slice(0,t-16)),c=Array(B),s=(new Date).getTime(),A=s%1e3,d=Math.floor(s/1e3),i=Math.floor(65535*Math.random()),a=0;2>a;a++)c[a]=255&A>>>8*a;for(a=0;2>a;a++)c[a+2]=255&i>>>8*a;for(a=0;4>a;a++)c[a+4]=255&d>>>8*a;for(u="",a=0;8>a;a++)u+=String.fromCharCode(c[a]);for(h=Aes.keyExpansion(f),C=Math.ceil(r.length/B),l=Array(C),y=0;C>y;y++){for(g=0;4>g;g++)c[15-g]=255&y>>>8*g;for(g=0;4>g;g++)c[15-g-4]=y/4294967296>>>8*g;for(v=Aes.cipher(c,h),x=C-1>y?B:(r.length-1)%B+1,m=Array(x),a=0;x>a;a++)m[a]=v[a]^r.charCodeAt(y*B+a),m[a]=String.fromCharCode(m[a]);l[y]=m.join("")}return p=u+l.join(""),p=Base64.encode(p)},Aes.Ctr.decrypt=function(r,e,o){var t,n,a,f,c,s,A,d,i,u,h,C,l,y,g=16;if(128!=o&&192!=o&&256!=o)return"";for(r=Base64.decode(r),e=Utf8.encode(e),t=o/8,n=Array(t),a=0;t>a;a++)n[a]=isNaN(e.charCodeAt(a))?0:e.charCodeAt(a);for(f=Aes.cipher(n,Aes.keyExpansion(n)),f=f.concat(f.slice(0,t-16)),c=Array(8),ctrTxt=r.slice(0,8),a=0;8>a;a++)c[a]=ctrTxt.charCodeAt(a);for(s=Aes.keyExpansion(f),A=Math.ceil((r.length-8)/g),d=Array(A),i=0;A>i;i++)d[i]=r.slice(8+i*g,8+i*g+g);for(r=d,u=Array(r.length),i=0;A>i;i++){for(h=0;4>h;h++)c[15-h]=255&i>>>8*h;for(h=0;4>h;h++)c[15-h-4]=255&(i+1)/4294967296-1>>>8*h;for(C=Aes.cipher(c,s),l=Array(r[i].length),a=0;a<r[i].length;a++)l[a]=C[a]^r[i].charCodeAt(a),l[a]=String.fromCharCode(l[a]);u[i]=l.join("")}return y=u.join(""),y=Utf8.decode(y)},Base64={},Base64.code="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",Base64.encode=function(r,e){var o,t,n,a,f,c,s,A,d,i,u,h,C,l;if(e=void 0===e?!1:e,h=[],C="",l=Base64.code,i=e?r.encodeUTF8():r,d=i.length%3,d>0)for(;d++<3;)C+="=",i+="\x00";for(d=0;d<i.length;d+=3)o=i.charCodeAt(d),t=i.charCodeAt(d+1),n=i.charCodeAt(d+2),a=o<<16|t<<8|n,f=63&a>>18,c=63&a>>12,s=63&a>>6,A=63&a,h[d/3]=l.charAt(f)+l.charAt(c)+l.charAt(s)+l.charAt(A);return u=h.join(""),u=u.slice(0,u.length-C.length)+C},Base64.decode=function(r,e){var o,t,n,a,f,c,s,A,d,i,u,h,C;for(e=void 0===e?!1:e,u=[],h=Base64.code,i=e?r.decodeUTF8():r,C=0;C<i.length;C+=4)a=h.indexOf(i.charAt(C)),f=h.indexOf(i.charAt(C+1)),c=h.indexOf(i.charAt(C+2)),s=h.indexOf(i.charAt(C+3)),A=a<<18|f<<12|c<<6|s,o=255&A>>>16,t=255&A>>>8,n=255&A,u[C/4]=String.fromCharCode(o,t,n),64==s&&(u[C/4]=String.fromCharCode(o,t)),64==c&&(u[C/4]=String.fromCharCode(o));return d=u.join(""),e?d.decodeUTF8():d},Utf8={},Utf8.encode=function(r){var e=r.replace(/[\u0080-\u07ff]/g,function(r){var e=r.charCodeAt(0);return String.fromCharCode(192|e>>6,128|63&e)});return e=e.replace(/[\u0800-\uffff]/g,function(r){var e=r.charCodeAt(0);return String.fromCharCode(224|e>>12,128|63&e>>6,128|63&e)})},Utf8.decode=function(r){var e=r.replace(/[\u00e0-\u00ef][\u0080-\u00bf][\u0080-\u00bf]/g,function(r){var e=(15&r.charCodeAt(0))<<12|(63&r.charCodeAt(1))<<6|63&r.charCodeAt(2);return String.fromCharCode(e)});return e=e.replace(/[\u00c0-\u00df][\u0080-\u00bf]/g,function(r){var e=(31&r.charCodeAt(0))<<6|63&r.charCodeAt(1);return String.fromCharCode(e)})};