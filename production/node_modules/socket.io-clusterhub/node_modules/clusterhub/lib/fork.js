function ready(){var e,n,s;for(e in hubs)if(has(hubs,e)){if(n=hubs[e],n.isready)continue;for(n.isready=!0;s=n._onready.shift();)s()}}var origFork,cluster=null,has=null.has,commands=null.commands,hubs=null.hubs,workers=null.workers,queue=null.queue,queuemsg=null.queuemsg,isReady=null.isReady,broadcast=null.broadcast,emit=null.emit,Hub=null;process.on("message",function(e){if(e.cmd===commands.READY)return ready();if(e.dir===__dirname&&void 0!==e.hub&&has(hubs,e.hub)){var n=hubs[e.hub];e.event?emit(e.hub,e.event,e.args):(n._cb[e.key].apply(null,e.args),delete n._cb[e.key])}}),origFork=cluster.fork,cluster.fork=function(){function e(){if(d.ready=!0,isReady()){for(var e;e=queue.shift();)e.fn(e.msg);workers.forEach(function(e){e.worker.send({cmd:commands.READY})}),ready()}}function n(e){if(void 0!==e.hub&&void 0!==e.cmd&&e.dir===__dirname)switch(has(hubs,e.hub)||new Hub(e.hub),e.cmd){case commands.EVENT:queuemsg(s,e);break;case commands.ON:r(e);break;case commands.OFF:u(e);break;case commands.OFFALL:a(e);break;default:queuemsg(o,e)}}function s(e){broadcast(e.hub,e.event,e.args,i),emit(e.hub,e.event,e.args)}function r(e){has(t,e.event)?t[e.event]++:t[e.event]=1}function u(e){has(t,e.event)&&0===--t[e.event]&&delete t[e.event]}function a(e){e.event?has(t,e.event)&&delete t[e.event]:d.events=t={}}function o(e){var n=hubs[e.hub]._db,s=n[e.cmd].apply(n,e.args);e.key&&i.send({dir:__dirname,hub:e.hub,key:e.key,args:[s]})}var i=origFork(),t={},d={worker:i,events:t,ready:!1,ononline:e,onmessage:n};return workers.push(d),i.on("online",e),i.on("message",n),i.once("exit",function(){return workers.splice(workers.indexOf(d),1),i.removeListener("online",d.ononline),i.removeListener("message",d.onmessage),!1}),i};