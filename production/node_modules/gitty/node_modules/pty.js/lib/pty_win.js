/**
 * pty_win.js
 * Copyright (c) 2012, Christopher Jeffrey, Peter Sunde (MIT License)
 */

function Agent(e,t,n,i,r,o,s){var a,p,l=this;pipeIncr++,a=Date.now(),this.dataPipe="\\\\.\\pipe\\winpty-data-"+pipeIncr+a,this.ptySocket=new net.Socket,this.ptyDataPipe=net.createServer(function(r){r.setEncoding("utf8"),r.pause(),e=e,t=t.join(" "),n=n.join(" "),i=path.resolve(i),pty.startProcess(l.pid,e,t,n,i),l.ptySocket.emit("ready_datapipe",r)}).listen(this.dataPipe),p=pty.open(l.dataPipe,r,o,s),this.pid=p.pid,this.fd=p.fd,this.pty=p.pty}function Terminal(e,t,n){var i,r,o,s,a,p,l=this;"string"==typeof t&&(n={name:arguments[1],cols:arguments[2],rows:arguments[3],cwd:process.env.HOME},t=[]),t=t||[],e=e||"cmd.exe",n=n||{},s=n.cols||80,a=n.rows||30,i=clone(n.env||process.env),r=n.cwd||process.cwd(),o=n.name||i.TERM||"Windows Shell",p=n.debug||!1,i.TERM=o,i=environ(i),this.isReady=!1,this.deferreds=[],this.agent=new Agent(e,t,i,r,s,a,p),this.socket=this.agent.ptySocket,this.dataPipe=null,this.pid=this.agent.pid,this.fd=this.agent.fd,this.pty=this.agent.pty,this.socket.on("ready_datapipe",function(e){l.dataPipe=e,["connect","data","end","timeout","drain"].forEach(function(e){l.dataPipe.on(e,function(t){l.isReady||"data"!=e||(l.isReady=!0,l.deferreds.forEach(function(e){e.run()}),l.deferreds=[]),l.socket.emit(e,t)})}),l.dataPipe.resume(),l.dataPipe.on("error",function(e){if(l._close(),(!e.code||!~e.code.indexOf("errno 5")&&!~e.code.indexOf("EIO"))&&l.listeners("error").length<2)throw e}),l.dataPipe.on("close",function(){Terminal.total--,l.emit("exit",null),l._close()})}),this.file=e,this.name=o,this.cols=s,this.rows=a,this.readable=!0,this.writable=!0,Terminal.total++}function defer(e,t){if(!(e instanceof Terminal))throw Error("Must be instanceof Terminal");return e.isReady?(t.apply(e,null),void 0):(e.deferreds.push({run:function(){t.apply(e,null)}}),void 0)}function clone(e){for(var t=Object.keys(e||{}),n=t.length,i=0,r={};n>i;i++)r[t[i]]=e[t[i]];return r}function environ(e){for(var t=Object.keys(e||{}),n=t.length,i=0,r=[];n>i;i++)r.push(t[i]+"="+e[t[i]]);return r}var net=null,BaseTerminal=null.Terminal,pty=null,util=null,path=null,pipeIncr=0;Terminal.fork=Terminal.spawn=Terminal.createTerminal=function(e,t,n){return new Terminal(e,t,n)},util.inherits(Terminal,BaseTerminal),Terminal.total=0,Terminal.open=function(){throw Error("open() not supported on windows, use Fork() instead.")},Terminal.prototype.write=function(e){defer(this,function(){this.dataPipe.write(e)})},Terminal.prototype.resize=function(e,t){defer(this,function(){e=e||80,t=t||24,this.cols=e,this.rows=t,pty.resize(this.pid,e,t)})},Terminal.prototype.destroy=function(){defer(this,function(){this.kill()})},Terminal.prototype.kill=function(e){defer(this,function(){if(void 0!==e)throw Error("Signals not supported on windows.");this._close(),pty.kill(this.pid)})},Terminal.prototype.__defineGetter__("process",function(){return this.name}),module.exports=exports=Terminal,exports.Terminal=Terminal,exports.native=void 0;