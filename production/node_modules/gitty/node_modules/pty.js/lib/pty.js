/**
 * pty.js
 * Copyright (c) 2012, Christopher Jeffrey (MIT License)
 * Binding to the pseudo terminals.
 */

function Terminal(e,t,r){if(!(this instanceof Terminal))return new Terminal(e,t,r);var n,o,s,i,c,l,a=this;"string"==typeof t&&(r={name:arguments[1],cols:arguments[2],rows:arguments[3],cwd:process.env.HOME},t=[]),t=t||[],e=e||"sh",r=r||{},i=r.cols||80,c=r.rows||24,n=clone(r.env||process.env),o=r.cwd||process.cwd(),s=r.name||n.TERM||"xterm",n.TERM=s,n=environ(n),l=r.uid&&r.gid?pty.fork(e,t,n,o,i,c,r.uid,r.gid):pty.fork(e,t,n,o,i,c),this.socket=new tty.ReadStream(l.fd),this.socket.setEncoding("utf8"),this.socket.resume(),this.socket.on("error",function(e){if(a._close(),(!e.code||!~e.code.indexOf("errno 5")&&!~e.code.indexOf("EIO"))&&a.listeners("error").length<2)throw e}),this.pid=l.pid,this.fd=l.fd,this.pty=l.pty,this.file=e,this.name=s,this.cols=i,this.rows=c,this.readable=!0,this.writable=!0,Terminal.total++,this.socket.on("close",function(){Terminal.total--,a._close(),a.emit("exit",null)}),n=null}function clone(e){for(var t=Object.keys(e||{}),r=t.length,n=0,o={};r>n;n++)o[t[n]]=e[t[n]];return o}function environ(e){for(var t=Object.keys(e||{}),r=t.length,n=0,o=[];r>n;n++)o.push(t[n]+"="+e[t[n]]);return o}var net=null,tty=null,pty=null;Terminal.fork=Terminal.spawn=Terminal.createTerminal=function(e,t,r){return new Terminal(e,t,r)},Terminal.open=function(e){var t,r,n,o=Object.create(Terminal.prototype);return e=e||{},arguments.length>1&&(e={cols:arguments[1],rows:arguments[2]}),r=e.cols||80,n=e.rows||24,t=pty.open(r,n),o.master=new net.Socket(t.master),o.master.setEncoding("utf8"),o.master.resume(),o.slave=new net.Socket(t.slave),o.slave.setEncoding("utf8"),o.slave.resume(),o.socket=o.master,o.pid=null,o.fd=t.master,o.pty=t.pty,o.file=process.argv[0]||"node",o.name=process.env.TERM||"",o.cols=r,o.rows=n,o.readable=!0,o.writable=!0,o.socket.on("error",function(e){if(o._close(),o.listeners("error").length<2)throw e}),Terminal.total++,o.socket.on("close",function(){Terminal.total--,o._close()}),o},Terminal.total=0,Terminal.prototype.write=function(e){return this.socket.write(e)},Terminal.prototype.end=function(e){return this.socket.end(e)},Terminal.prototype.pipe=function(e,t){return this.socket.pipe(e,t)},Terminal.prototype.pause=function(){this.socket.pause()},Terminal.prototype.resume=function(){this.socket.resume()},Terminal.prototype.setEncoding=function(e){this.socket._decoder&&delete this.socket._decoder,e&&this.socket.setEncoding(e)},Terminal.prototype.addListener=Terminal.prototype.on=function(e,t){return this.socket.on(e,t),this},Terminal.prototype.emit=function(){return this.socket.emit.apply(this.socket,arguments)},Terminal.prototype.listeners=function(e){return this.socket.listeners(e)},Terminal.prototype.removeListener=function(e,t){return this.socket.removeListener(e,t),this},Terminal.prototype.removeAllListeners=function(e){return this.socket.removeAllListeners(e),this},Terminal.prototype.once=function(e,t){return this.socket.once(e,t),this},Terminal.prototype.__defineGetter__("stdin",function(){return this}),Terminal.prototype.__defineGetter__("stdout",function(){return this}),Terminal.prototype.__defineGetter__("stderr",function(){throw Error("No stderr.")}),Terminal.prototype.resize=function(e,t){e=e||80,t=t||24,this.cols=e,this.rows=t,pty.resize(this.fd,e,t)},Terminal.prototype.destroy=function(){var e=this;this._close(),this.socket.once("close",function(){e.kill("SIGTERM")}),this.socket.destroy()},Terminal.prototype.kill=function(e){try{process.kill(this.pid,e||"SIGTERM")}catch(t){}},Terminal.prototype.__defineGetter__("process",function(){return pty.process(this.fd,this.pty)||this.file}),Terminal.prototype._close=function(){this.socket.writable=!1,this.socket.readable=!1,this.write=function(){},this.end=function(){},this.writable=!1,this.readable=!1},exports=Terminal,exports.Terminal=Terminal,exports.native=pty,module.exports=exports;