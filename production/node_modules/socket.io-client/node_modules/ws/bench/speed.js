function roundPrec(n,e){var o=Math.pow(10,e);return Math.round(n*o)/o}function humanSize(n){return n>=1048576?roundPrec(n/1048576,2)+" MB":n>=1024?roundPrec(n/1024,2)+" kB":roundPrec(n,2)+" B"}function generateRandomData(n){var e,o=new Buffer(n);for(e=0;n>e;++e)o[e]=~~(127*Math.random());return o}function roundtrip(n,e,o,r){function s(){t.send(a,{binary:n})}var t,c,i,a=randomBytes.slice(0,o),u=util.format("Running %d roundtrips of %s %s data",e,humanSize(o),n?"binary":"text");console.log(u),t=new WebSocket("ws://localhost:8181"),i=0,t.on("error",function(n){console.error(n),process.exit()}),t.on("open",function(){c=Date.now(),s()}),t.on("message",function(){if(++i==e){var a=Date.now()-c;return cursor.up(),console.log("%s:	%ss	%s",n?u.green:u.cyan,(""+roundPrec(a/1e3,1)).green.bold,(humanSize(1e3*(o*e/a))+"/s").blue.bold),t.close(),r(),void 0}process.nextTick(s)})}var wss,cursor,configs,largest,i,l,randomBytes,cluster=null,WebSocket=null,WebSocketServer=WebSocket.Server,crypto=null,util=null,ansi=null;if(cluster.isMaster)wss=new WebSocketServer({port:8181},function(){cluster.fork()}),wss.on("connection",function(n){n.on("message",function(e,o){n.send(e,{binary:o&&o.binary})}),n.on("close",function(){})}),cluster.on("death",function(){wss.close()});else{for(cursor=ansi(process.stdout),configs=[[!0,1e4,64],[!0,5e3,16384],[!0,1e3,131072],[!0,100,1048576],[!0,1,524288e3],[!1,1e4,64],[!1,5e3,16384],[!1,1e3,131072],[!1,100,1048576]],largest=configs[0][1],i=0,l=configs.length;l>i;++i)configs[i][2]>largest&&(largest=configs[i][2]);console.log("Generating %s of test data ...",humanSize(largest)),randomBytes=generateRandomData(largest),function n(){0==configs.length&&process.exit();var e=configs.shift();e.push(n),roundtrip.apply(null,e)}()}