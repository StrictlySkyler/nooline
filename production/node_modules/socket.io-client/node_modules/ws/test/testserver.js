function validServer(e,t,n){var r,o,i,s,c;if(void 0===t.headers.upgrade||"websocket"!==t.headers.upgrade.toLowerCase())throw Error("invalid headers");if(!t.headers["sec-websocket-key"])throw n.end(),Error("websocket key is missing");r=t.headers["sec-websocket-key"],o=crypto.createHash("sha1"),o.update(r+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11"),r=o.digest("base64"),i=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade","Sec-WebSocket-Accept: "+r],n.write(i.concat("","").join("\r\n")),n.setTimeout(0),n.setNoDelay(!0),s=new Sender(n),c=new Receiver,c.ontext=function(t,n){e.emit("message",t,n),s.send(t)},c.onbinary=function(t,n){n=n||{},n.binary=!0,e.emit("message",t,n),s.send(t,{binary:!0})},c.onping=function(t,n){n=n||{},e.emit("ping",t,n)},c.onpong=function(t,n){n=n||{},e.emit("pong",t,n)},c.onclose=function(t,n,r){r=r||{},e.emit("close",t,n,r)},n.on("data",function(e){c.add(e)}),n.on("end",function(){n.end()})}function invalidRequestHandler(e,t,n){var r,o,i;if(void 0===t.headers.upgrade||"websocket"!==t.headers.upgrade.toLowerCase())throw Error("invalid headers");if(!t.headers["sec-websocket-key"])throw n.end(),Error("websocket key is missing");r=t.headers["sec-websocket-key"],o=crypto.createHash("sha1"),o.update(r+"bogus"),r=o.digest("base64"),i=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade","Sec-WebSocket-Accept: "+r],n.write(i.concat("","").join("\r\n")),n.end()}function closeAfterConnectHandler(e,t,n){var r,o,i;if(void 0===t.headers.upgrade||"websocket"!==t.headers.upgrade.toLowerCase())throw Error("invalid headers");if(!t.headers["sec-websocket-key"])throw n.end(),Error("websocket key is missing");r=t.headers["sec-websocket-key"],o=crypto.createHash("sha1"),o.update(r+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11"),r=o.digest("base64"),i=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade","Sec-WebSocket-Accept: "+r],n.write(i.concat("","").join("\r\n")),n.end()}function return401(e,t,n){var r=["HTTP/1.1 401 Unauthorized","Content-type: text/html"];n.write(r.concat("","").join("\r\n")),n.end()}function Server(e){this.webServer=e}var http=null,util=null,crypto=null,events=null,Sender=null,Receiver=null;module.exports={handlers:{valid:validServer,invalidKey:invalidRequestHandler,closeAfterConnect:closeAfterConnectHandler,return401:return401},createServer:function(e,t,n){var r,o;t&&!n&&(n=t,t=null),r=http.createServer(function(e,t){t.writeHead(200,{"Content-Type":"text/plain"}),t.end("okay")}),o=new Server(r),r.on("upgrade",function(e,n){r._socket=n,(t||validServer)(o,e,n)}),r.listen(e,"127.0.0.1",function(){n(o)})}},util.inherits(Server,events.EventEmitter),Server.prototype.close=function(){this.webServer.close(),this._socket&&this._socket.end()};