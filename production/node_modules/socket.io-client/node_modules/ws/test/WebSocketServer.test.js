function getArrayBuffer(e){var o,t=e.length,n=new ArrayBuffer(t);for(o=0;t>o;++o)n[o]=e[o];return n}function areArraysEqual(e,o){if(e.length!=o.length)return!1;for(var t=0,n=e.length;n>t;++t)if(e[t]!==o[t])return!1;return!0}var http=null,https=null,WebSocket=null,WebSocketServer=WebSocket.Server,fs=null,should=null,port=8e3;describe("WebSocketServer",function(){describe("#ctor",function(){it("throws an error if no option object is passed",function(){var e=!1;try{new WebSocketServer}catch(o){e=!0}e.should.be.ok}),it("throws an error if no port or server is specified",function(){var e=!1;try{new WebSocketServer({})}catch(o){e=!0}e.should.be.ok}),it("does not throw an error if no port or server is specified, when the noServer option is true",function(){var e=!1;try{new WebSocketServer({noServer:!0})}catch(o){e=!0}e.should.eql(!1)}),it("emits an error if http server bind fails",function(e){var o=new WebSocketServer({port:1});o.on("error",function(){e()})}),it("starts a server on a given port",function(e){var o=new WebSocketServer({port:++port},function(){new WebSocket("ws://localhost:"+port)});o.on("connection",function(){o.close(),e()})}),it("uses a precreated http server",function(e){var o=http.createServer();o.listen(++port,function(){var t=new WebSocketServer({server:o});new WebSocket("ws://localhost:"+port),t.on("connection",function(){t.close(),o.close(),e()})})}),it("uses a precreated http server listening on unix socket",function(e){var o=http.createServer(),t="/tmp/ws_socket_"+(new Date).getTime()+"."+Math.floor(1e3*Math.random());o.listen(t,function(){var n=new WebSocketServer({server:o});new WebSocket("ws+unix://"+t),n.on("connection",function(){n.close(),o.close(),e()})})}),it("emits path specific connection event",function(e){var o=http.createServer();o.listen(++port,function(){var t=new WebSocketServer({server:o});new WebSocket("ws://localhost:"+port+"/endpointName"),t.on("connection/endpointName",function(){t.close(),o.close(),e()})})}),it("can have two different instances listening on the same http server with two different paths",function(e){var o=http.createServer();o.listen(++port,function(){var t=new WebSocketServer({server:o,path:"/wss1"}),n=new WebSocketServer({server:o,path:"/wss2"}),r=0;t.on("connection",function(){t.close(),2==++r&&(o.close(),e())}),n.on("connection",function(){n.close(),2==++r&&(o.close(),e())}),new WebSocket("ws://localhost:"+port+"/wss1"),new WebSocket("ws://localhost:"+port+"/wss2?foo=1")})}),it("cannot have two different instances listening on the same http server with the same path",function(e){var o=http.createServer();o.listen(++port,function(){var t=new WebSocketServer({server:o,path:"/wss1"});try{new WebSocketServer({server:o,path:"/wss1"})}catch(n){t.close(),o.close(),e()}})})}),describe("#close",function(){it("will close all clients",function(e){var o=new WebSocketServer({port:++port},function(){var o=new WebSocket("ws://localhost:"+port);o.on("close",function(){2==++t&&e()})}),t=0;o.on("connection",function(n){n.on("close",function(){2==++t&&e()}),o.close()})}),it("does not close a precreated server",function(e){var o=http.createServer(),t=o.close;o.close=function(){should.fail("must not close pre-created server")},o.listen(++port,function(){var n=new WebSocketServer({server:o});new WebSocket("ws://localhost:"+port),n.on("connection",function(){n.close(),o.close=t,o.close(),e()})})}),it("cleans up websocket data on a precreated server",function(e){var o=http.createServer();o.listen(++port,function(){var t=new WebSocketServer({server:o,path:"/wss1"}),n=new WebSocketServer({server:o,path:"/wss2"});(typeof o._webSocketPaths).should.eql("object"),Object.keys(o._webSocketPaths).length.should.eql(2),t.close(),Object.keys(o._webSocketPaths).length.should.eql(1),n.close(),(typeof o._webSocketPaths).should.eql("undefined"),o.close(),e()})})}),describe("#clients",function(){it("returns a list of connected clients",function(e){var o=new WebSocketServer({port:++port},function(){o.clients.length.should.eql(0),new WebSocket("ws://localhost:"+port)});o.on("connection",function(){o.clients.length.should.eql(1),o.close(),e()})}),it("can be disabled",function(e){var o=new WebSocketServer({port:++port,clientTracking:!1},function(){o.clients.length.should.eql(0),new WebSocket("ws://localhost:"+port)});o.on("connection",function(){o.clients.length.should.eql(0),o.close(),e()})}),it("is updated when client terminates the connection",function(e){var o,t=new WebSocketServer({port:++port},function(){o=new WebSocket("ws://localhost:"+port)});t.on("connection",function(n){n.on("close",function(){t.clients.length.should.eql(0),t.close(),e()}),o.terminate()})}),it("is updated when client closes the connection",function(e){var o,t=new WebSocketServer({port:++port},function(){o=new WebSocket("ws://localhost:"+port)});t.on("connection",function(n){n.on("close",function(){t.clients.length.should.eql(0),t.close(),e()}),o.close()})})}),describe("#options",function(){it("exposes options passed to constructor",function(e){var o=new WebSocketServer({port:++port},function(){o.options.port.should.eql(port),o.close(),e()})})}),describe("#handleUpgrade",function(){it("can be used for a pre-existing server",function(e){var o=http.createServer();o.listen(++port,function(){var t,n=new WebSocketServer({noServer:!0});o.on("upgrade",function(e,o,t){n.handleUpgrade(e,o,t,function(e){e.send("hello")})}),t=new WebSocket("ws://localhost:"+port),t.on("message",function(t){t.should.eql("hello"),n.close(),o.close(),e()})})})}),describe("hybi mode",function(){describe("connection establishing",function(){it("does not accept connections with no sec-websocket-key",function(e){var o=new WebSocketServer({port:++port},function(){var t={port:port,host:"127.0.0.1",headers:{Connection:"Upgrade",Upgrade:"websocket"}},n=http.request(t);n.end(),n.on("response",function(t){t.statusCode.should.eql(400),o.close(),e()})});o.on("connection",function(){e(Error("connection must not be established"))}),o.on("error",function(){})}),it("does not accept connections with no sec-websocket-version",function(e){var o=new WebSocketServer({port:++port},function(){var t={port:port,host:"127.0.0.1",headers:{Connection:"Upgrade",Upgrade:"websocket","Sec-WebSocket-Key":"dGhlIHNhbXBsZSBub25jZQ=="}},n=http.request(t);n.end(),n.on("response",function(t){t.statusCode.should.eql(400),o.close(),e()})});o.on("connection",function(){e(Error("connection must not be established"))}),o.on("error",function(){})}),it("does not accept connections with invalid sec-websocket-version",function(e){var o=new WebSocketServer({port:++port},function(){var t={port:port,host:"127.0.0.1",headers:{Connection:"Upgrade",Upgrade:"websocket","Sec-WebSocket-Key":"dGhlIHNhbXBsZSBub25jZQ==","Sec-WebSocket-Version":12}},n=http.request(t);n.end(),n.on("response",function(t){t.statusCode.should.eql(400),o.close(),e()})});o.on("connection",function(){e(Error("connection must not be established"))}),o.on("error",function(){})}),it("client can be denied",function(e){var o=new WebSocketServer({port:++port,verifyClient:function(){return!1}},function(){var t={port:port,host:"127.0.0.1",headers:{Connection:"Upgrade",Upgrade:"websocket","Sec-WebSocket-Key":"dGhlIHNhbXBsZSBub25jZQ==","Sec-WebSocket-Version":8,"Sec-WebSocket-Origin":"http://foobar.com"}},n=http.request(t);n.end(),n.on("response",function(t){t.statusCode.should.eql(401),process.nextTick(function(){o.close(),e()})})});o.on("connection",function(){e(Error("connection must not be established"))}),o.on("error",function(){})}),it("client can be accepted",function(e){var o=new WebSocketServer({port:++port,verifyClient:function(){return!0}},function(){var e={port:port,host:"127.0.0.1",headers:{Connection:"Upgrade",Upgrade:"websocket","Sec-WebSocket-Key":"dGhlIHNhbXBsZSBub25jZQ==","Sec-WebSocket-Version":13,Origin:"http://foobar.com"}},o=http.request(e);o.end()});o.on("connection",function(t){t.terminate(),o.close(),e()}),o.on("error",function(){})}),it("verifyClient gets client origin",function(e){var o=!1,t=new WebSocketServer({port:++port,verifyClient:function(e){return e.origin.should.eql("http://foobarbaz.com"),o=!0,!1}},function(){var n={port:port,host:"127.0.0.1",headers:{Connection:"Upgrade",Upgrade:"websocket","Sec-WebSocket-Key":"dGhlIHNhbXBsZSBub25jZQ==","Sec-WebSocket-Version":13,Origin:"http://foobarbaz.com"}},r=http.request(n);r.end(),r.on("response",function(){o.should.be.ok,t.close(),e()})});t.on("error",function(){})}),it("verifyClient gets original request",function(e){var o=!1,t=new WebSocketServer({port:++port,verifyClient:function(e){return e.req.headers["sec-websocket-key"].should.eql("dGhlIHNhbXBsZSBub25jZQ=="),o=!0,!1}},function(){var n={port:port,host:"127.0.0.1",headers:{Connection:"Upgrade",Upgrade:"websocket","Sec-WebSocket-Key":"dGhlIHNhbXBsZSBub25jZQ==","Sec-WebSocket-Version":13,Origin:"http://foobarbaz.com"}},r=http.request(n);r.end(),r.on("response",function(){o.should.be.ok,t.close(),e()})});t.on("error",function(){})}),it("verifyClient has secure:true for ssl connections",function(e){var o={key:fs.readFileSync("test/fixtures/key.pem"),cert:fs.readFileSync("test/fixtures/certificate.pem")},t=https.createServer(o,function(e,o){o.writeHead(200),o.end()}),n=!1,r=new WebSocketServer({server:t,verifyClient:function(e){return n=e.secure===!0,!0}});t.listen(++port,function(){new WebSocket("wss://localhost:"+port)}),r.on("connection",function(o){t.close(),o.terminate(),r.close(),n.should.be.ok,e()})}),it("verifyClient has secure:false for non-ssl connections",function(e){var o=http.createServer(function(e,o){o.writeHead(200),o.end()}),t=!1,n=new WebSocketServer({server:o,verifyClient:function(e){return t=e.secure===!1,!0}});o.listen(++port,function(){new WebSocket("ws://localhost:"+port)}),n.on("connection",function(r){o.close(),r.terminate(),n.close(),t.should.be.ok,e()})}),it("client can be denied asynchronously",function(e){var o=new WebSocketServer({port:++port,verifyClient:function(e,o){process.nextTick(function(){o(!1)})}},function(){var t={port:port,host:"127.0.0.1",headers:{Connection:"Upgrade",Upgrade:"websocket","Sec-WebSocket-Key":"dGhlIHNhbXBsZSBub25jZQ==","Sec-WebSocket-Version":8,"Sec-WebSocket-Origin":"http://foobar.com"}},n=http.request(t);n.end(),n.on("response",function(t){t.statusCode.should.eql(401),process.nextTick(function(){o.close(),e()})})});o.on("connection",function(){e(Error("connection must not be established"))}),o.on("error",function(){})}),it("client can be accepted asynchronously",function(e){var o=new WebSocketServer({port:++port,verifyClient:function(e,o){process.nextTick(function(){o(!0)})}},function(){var e={port:port,host:"127.0.0.1",headers:{Connection:"Upgrade",Upgrade:"websocket","Sec-WebSocket-Key":"dGhlIHNhbXBsZSBub25jZQ==","Sec-WebSocket-Version":13,Origin:"http://foobar.com"}},o=http.request(e);o.end()});o.on("connection",function(t){t.terminate(),o.close(),e()}),o.on("error",function(){})}),it("handles messages passed along with the upgrade request (upgrade head)",function(e){var o=new WebSocketServer({port:++port,verifyClient:function(){return!0}},function(){var e={port:port,host:"127.0.0.1",headers:{Connection:"Upgrade",Upgrade:"websocket","Sec-WebSocket-Key":"dGhlIHNhbXBsZSBub25jZQ==","Sec-WebSocket-Version":13,Origin:"http://foobar.com"}},o=http.request(e);o.write(new Buffer([129,5,72,101,108,108,111],"binary")),o.end()});o.on("connection",function(t){t.on("message",function(n){n.should.eql("Hello"),t.terminate(),o.close(),e()})}),o.on("error",function(){})}),it("selects the first protocol by default",function(e){var o=new WebSocketServer({port:++port},function(){var t=new WebSocket("ws://localhost:"+port,{protocol:"prot1, prot2"});t.on("open",function(){t.protocol.should.eql("prot1"),o.close(),e()})})}),it("selects the last protocol via protocol handler",function(e){var o=new WebSocketServer({port:++port,handleProtocols:function(e,o){o(!0,e[e.length-1])}},function(){var t=new WebSocket("ws://localhost:"+port,{protocol:"prot1, prot2"});t.on("open",function(){t.protocol.should.eql("prot2"),o.close(),e()})})}),it("client detects invalid server protocol",function(e){new WebSocketServer({port:++port,handleProtocols:function(e,o){o(!0,"prot3")}},function(){var o=new WebSocket("ws://localhost:"+port,{protocol:"prot1, prot2"});o.on("open",function(){e(Error("connection must not be established"))}),o.on("error",function(){e()})})}),it("client detects no server protocol",function(e){new WebSocketServer({port:++port,handleProtocols:function(e,o){o(!0)}},function(){var o=new WebSocket("ws://localhost:"+port,{protocol:"prot1, prot2"});o.on("open",function(){e(Error("connection must not be established"))}),o.on("error",function(){e()})})}),it("client refuses server protocols",function(e){new WebSocketServer({port:++port,handleProtocols:function(e,o){o(!1)}},function(){var o=new WebSocket("ws://localhost:"+port,{protocol:"prot1, prot2"});o.on("open",function(){e(Error("connection must not be established"))}),o.on("error",function(){e()})})}),it("server detects invalid protocol handler",function(e){var o=new WebSocketServer({port:++port,handleProtocols:function(){}},function(){var t,n={port:port,host:"127.0.0.1",headers:{Connection:"Upgrade",Upgrade:"websocket","Sec-WebSocket-Key":"dGhlIHNhbXBsZSBub25jZQ==","Sec-WebSocket-Version":13,"Sec-WebSocket-Origin":"http://foobar.com"}};n.port=port,t=http.request(n),t.end(),t.on("response",function(t){t.statusCode.should.eql(501),o.close(),e()})});o.on("connection",function(){e(Error("connection must not be established"))}),o.on("error",function(){})})}),describe("messaging",function(){it("can send and receive data",function(e){var o,t,n=Array(66560);for(o=0;o<n.length;++o)n[o]=String.fromCharCode(65+~~(25*Math.random()));n=n.join(""),t=new WebSocketServer({port:++port},function(){var e=new WebSocket("ws://localhost:"+port);e.on("message",function(o){e.send(o)})}),t.on("connection",function(o){o.on("message",function(o){o.should.eql(n),t.close(),e()}),o.send(n)})})})}),describe("hixie mode",function(){it("can be disabled",function(e){var o=new WebSocketServer({port:++port,disableHixie:!0},function(){var t={port:port,host:"127.0.0.1",headers:{Connection:"Upgrade",Upgrade:"WebSocket","Sec-WebSocket-Key1":"3e6b263  4 17 80","Sec-WebSocket-Key2":"17  9 G`ZD9   2 2b 7X 3 /r90"}},n=http.request(t);n.write("WjN}|M(6"),n.end(),n.on("response",function(t){t.statusCode.should.eql(401),process.nextTick(function(){o.close(),e()})})});o.on("connection",function(){e(Error("connection must not be established"))}),o.on("error",function(){})}),describe("connection establishing",function(){it("does not accept connections with no sec-websocket-key1",function(e){var o=new WebSocketServer({port:++port},function(){var t={port:port,host:"127.0.0.1",headers:{Connection:"Upgrade",Upgrade:"WebSocket","Sec-WebSocket-Key1":"3e6b263  4 17 80"}},n=http.request(t);n.end(),n.on("response",function(t){t.statusCode.should.eql(400),o.close(),e()})});o.on("connection",function(){e(Error("connection must not be established"))}),o.on("error",function(){})}),it("does not accept connections with no sec-websocket-key2",function(e){var o=new WebSocketServer({port:++port},function(){var t={port:port,host:"127.0.0.1",headers:{Connection:"Upgrade",Upgrade:"WebSocket","Sec-WebSocket-Key2":"17  9 G`ZD9   2 2b 7X 3 /r90"}},n=http.request(t);n.end(),n.on("response",function(t){t.statusCode.should.eql(400),o.close(),e()})});o.on("connection",function(){e(Error("connection must not be established"))}),o.on("error",function(){})}),it("accepts connections with valid handshake",function(e){var o=new WebSocketServer({port:++port},function(){var e={port:port,host:"127.0.0.1",headers:{Connection:"Upgrade",Upgrade:"WebSocket","Sec-WebSocket-Key1":"3e6b263  4 17 80","Sec-WebSocket-Key2":"17  9 G`ZD9   2 2b 7X 3 /r90"}},o=http.request(e);o.write("WjN}|M(6"),o.end()});o.on("connection",function(t){t.terminate(),o.close(),e()}),o.on("error",function(){})}),it("client can be denied",function(e){var o=new WebSocketServer({port:++port,verifyClient:function(){return!1}},function(){var t={port:port,host:"127.0.0.1",headers:{Connection:"Upgrade",Upgrade:"WebSocket","Sec-WebSocket-Key1":"3e6b263  4 17 80","Sec-WebSocket-Key2":"17  9 G`ZD9   2 2b 7X 3 /r90"}},n=http.request(t);n.write("WjN}|M(6"),n.end(),n.on("response",function(t){t.statusCode.should.eql(401),process.nextTick(function(){o.close(),e()})})});o.on("connection",function(){e(Error("connection must not be established"))}),o.on("error",function(){})}),it("client can be accepted",function(e){var o=new WebSocketServer({port:++port,verifyClient:function(){return!0}},function(){var e={port:port,host:"127.0.0.1",headers:{Connection:"Upgrade",Upgrade:"WebSocket","Sec-WebSocket-Key1":"3e6b263  4 17 80","Sec-WebSocket-Key2":"17  9 G`ZD9   2 2b 7X 3 /r90"}},o=http.request(e);o.write("WjN}|M(6"),o.end()});o.on("connection",function(t){t.terminate(),o.close(),e()}),o.on("error",function(){})}),it("verifyClient gets client origin",function(e){var o=!1,t=new WebSocketServer({port:++port,verifyClient:function(e){return e.origin.should.eql("http://foobarbaz.com"),o=!0,!1}},function(){var n={port:port,host:"127.0.0.1",headers:{Connection:"Upgrade",Upgrade:"WebSocket",Origin:"http://foobarbaz.com","Sec-WebSocket-Key1":"3e6b263  4 17 80","Sec-WebSocket-Key2":"17  9 G`ZD9   2 2b 7X 3 /r90"}},r=http.request(n);r.write("WjN}|M(6"),r.end(),r.on("response",function(){o.should.be.ok,t.close(),e()})});t.on("error",function(){})}),it("verifyClient gets original request",function(e){var o=!1,t=new WebSocketServer({port:++port,verifyClient:function(e){return e.req.headers["sec-websocket-key1"].should.eql("3e6b263  4 17 80"),o=!0,!1}},function(){var n={port:port,host:"127.0.0.1",headers:{Connection:"Upgrade",Upgrade:"WebSocket",Origin:"http://foobarbaz.com","Sec-WebSocket-Key1":"3e6b263  4 17 80","Sec-WebSocket-Key2":"17  9 G`ZD9   2 2b 7X 3 /r90"}},r=http.request(n);r.write("WjN}|M(6"),r.end(),r.on("response",function(){o.should.be.ok,t.close(),e()})});t.on("error",function(){})}),it("client can be denied asynchronously",function(e){var o=new WebSocketServer({port:++port,verifyClient:function(e,o){o(!1)}},function(){var t={port:port,host:"127.0.0.1",headers:{Connection:"Upgrade",Upgrade:"WebSocket",Origin:"http://foobarbaz.com","Sec-WebSocket-Key1":"3e6b263  4 17 80","Sec-WebSocket-Key2":"17  9 G`ZD9   2 2b 7X 3 /r90"}},n=http.request(t);n.write("WjN}|M(6"),n.end(),n.on("response",function(t){t.statusCode.should.eql(401),process.nextTick(function(){o.close(),e()})})});o.on("connection",function(){e(Error("connection must not be established"))}),o.on("error",function(){})}),it("client can be accepted asynchronously",function(e){var o=new WebSocketServer({port:++port,verifyClient:function(e,o){o(!0)}},function(){var e={port:port,host:"127.0.0.1",headers:{Connection:"Upgrade",Upgrade:"WebSocket",Origin:"http://foobarbaz.com","Sec-WebSocket-Key1":"3e6b263  4 17 80","Sec-WebSocket-Key2":"17  9 G`ZD9   2 2b 7X 3 /r90"}},o=http.request(e);o.write("WjN}|M(6"),o.end()});o.on("connection",function(){o.close(),e()}),o.on("error",function(){})}),it("handles messages passed along with the upgrade request (upgrade head)",function(e){var o=new WebSocketServer({port:++port,verifyClient:function(){return!0}},function(){var e={port:port,host:"127.0.0.1",headers:{Connection:"Upgrade",Upgrade:"WebSocket","Sec-WebSocket-Key1":"3e6b263  4 17 80","Sec-WebSocket-Key2":"17  9 G`ZD9   2 2b 7X 3 /r90",Origin:"http://foobar.com"}},o=http.request(e);o.write("WjN}|M(6"),o.write(new Buffer([0,72,101,108,108,111,255],"binary")),o.end()});o.on("connection",function(t){t.on("message",function(n){n.should.eql("Hello"),t.terminate(),o.close(),e()})}),o.on("error",function(){})})})}),describe("client properties",function(){it("protocol is exposed",function(e){var o=new WebSocketServer({port:++port},function(){new WebSocket("ws://localhost:"+port,{protocol:"hi"})});o.on("connection",function(t){t.protocol.should.eql("hi"),o.close(),e()})}),it("protocolVersion is exposed",function(e){var o=new WebSocketServer({port:++port},function(){new WebSocket("ws://localhost:"+port,{protocolVersion:8})});o.on("connection",function(t){t.protocolVersion.should.eql(8),o.close(),e()})}),it("upgradeReq is the original request object",function(e){var o=new WebSocketServer({port:++port},function(){new WebSocket("ws://localhost:"+port,{protocolVersion:8})});o.on("connection",function(t){t.upgradeReq.httpVersion.should.eql("1.1"),o.close(),e()})})})});