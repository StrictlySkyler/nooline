var assert=null,Receiver=null;describe("Receiver",function(){it("can parse unmasked text message",function(){var e=new Receiver,t="81 05 48 65 6c 6c 6f",r=!1;e.ontext=function(e){r=!0,assert.equal("Hello",e)},e.add(getBufferFromHexString(t)),r.should.be.ok}),it("can parse close message",function(){var e=new Receiver,t="88 00",r=!1;e.onclose=function(){r=!0},e.add(getBufferFromHexString(t)),r.should.be.ok}),it("can parse masked text message",function(){var e=new Receiver,t="81 93 34 83 a8 68 01 b9 92 52 4f a1 c6 09 59 e6 8a 52 16 e6 cb 00 5b a1 d5",r=!1;e.ontext=function(e){r=!0,assert.equal('5:::{"name":"echo"}',e)},e.add(getBufferFromHexString(t)),r.should.be.ok}),it("can parse a masked text message longer than 125 bytes",function(){var e,t,r,n=new Receiver,a="A";for(e=0;300>e;++e)a+=""+e%5;t="81 FE "+pack(4,a.length)+" 34 83 a8 68 "+getHexStringFromBuffer(mask(a,"34 83 a8 68")),r=!1,n.ontext=function(e){r=!0,assert.equal(a,e)},n.add(getBufferFromHexString(t)),r.should.be.ok}),it("can parse a really long masked text message",function(){var e,t,r,n=new Receiver,a="A";for(e=0;65536>e;++e)a+=""+e%5;t="81 FF "+pack(16,a.length)+" 34 83 a8 68 "+getHexStringFromBuffer(mask(a,"34 83 a8 68")),r=!1,n.ontext=function(e){r=!0,assert.equal(a,e)},n.add(getBufferFromHexString(t)),r.should.be.ok}),it("can parse a fragmented masked text message of 300 bytes",function(){var e,t,r,n,a,o,f=new Receiver,g="A";for(e=0;300>e;++e)g+=""+e%5;t=g.substr(0,150),r=g.substr(150),n="01 FE "+pack(4,t.length)+" 34 83 a8 68 "+getHexStringFromBuffer(mask(t,"34 83 a8 68")),a="80 FE "+pack(4,r.length)+" 34 83 a8 68 "+getHexStringFromBuffer(mask(r,"34 83 a8 68")),o=!1,f.ontext=function(e){o=!0,assert.equal(g,e)},f.add(getBufferFromHexString(n)),f.add(getBufferFromHexString(a)),o.should.be.ok}),it("can parse a ping message",function(){var e=new Receiver,t="Hello",r="89 "+getHybiLengthAsHexString(t.length,!0)+" 34 83 a8 68 "+getHexStringFromBuffer(mask(t,"34 83 a8 68")),n=!1;e.onping=function(e){n=!0,assert.equal(t,e)},e.add(getBufferFromHexString(r)),n.should.be.ok}),it("can parse a ping with no data",function(){var e=new Receiver,t="89 00",r=!1;e.onping=function(){r=!0},e.add(getBufferFromHexString(t)),r.should.be.ok}),it("can parse a fragmented masked text message of 300 bytes with a ping in the middle",function(){var e,t,r,n,a,o,f,g,i,s=new Receiver,u="A";for(e=0;300>e;++e)u+=""+e%5;t=u.substr(0,150),r="01 FE "+pack(4,t.length)+" 34 83 a8 68 "+getHexStringFromBuffer(mask(t,"34 83 a8 68")),n="Hello",a="89 "+getHybiLengthAsHexString(n.length,!0)+" 34 83 a8 68 "+getHexStringFromBuffer(mask(n,"34 83 a8 68")),o=u.substr(150),f="80 FE "+pack(4,o.length)+" 34 83 a8 68 "+getHexStringFromBuffer(mask(o,"34 83 a8 68")),g=!1,s.ontext=function(e){g=!0,assert.equal(u,e)},i=!1,s.onping=function(e){i=!0,assert.equal(n,e)},s.add(getBufferFromHexString(r)),s.add(getBufferFromHexString(a)),s.add(getBufferFromHexString(f)),g.should.be.ok,i.should.be.ok}),it("can parse a fragmented masked text message of 300 bytes with a ping in the middle, which is delievered over sevaral tcp packets",function(){var e,t,r,n,a,o,f,g,i,s,u=new Receiver,c="A";for(e=0;300>e;++e)c+=""+e%5;for(t=c.substr(0,150),r="01 FE "+pack(4,t.length)+" 34 83 a8 68 "+getHexStringFromBuffer(mask(t,"34 83 a8 68")),n="Hello",a="89 "+getHybiLengthAsHexString(n.length,!0)+" 34 83 a8 68 "+getHexStringFromBuffer(mask(n,"34 83 a8 68")),o=c.substr(150),f="80 FE "+pack(4,o.length)+" 34 83 a8 68 "+getHexStringFromBuffer(mask(o,"34 83 a8 68")),g=!1,u.ontext=function(e){g=!0,assert.equal(c,e)},i=!1,u.onping=function(e){i=!0,assert.equal(n,e)},s=[],s=s.concat(splitBuffer(getBufferFromHexString(r))),s=s.concat(splitBuffer(getBufferFromHexString(a))),s=s.concat(splitBuffer(getBufferFromHexString(f))),e=0;e<s.length;++e)u.add(s[e]);g.should.be.ok,i.should.be.ok}),it("can parse a 100 byte long masked binary message",function(){var e,t,r,n,a=new Receiver,o=100,f=new Buffer(o);for(e=0;o>e;++e)f[e]=e%256;t=getHexStringFromBuffer(f),r="82 "+getHybiLengthAsHexString(o,!0)+" 34 83 a8 68 "+getHexStringFromBuffer(mask(f,"34 83 a8 68")),n=!1,a.onbinary=function(e){n=!0,assert.equal(t,getHexStringFromBuffer(e))},a.add(getBufferFromHexString(r)),n.should.be.ok}),it("can parse a 256 byte long masked binary message",function(){var e,t,r,n,a=new Receiver,o=256,f=new Buffer(o);for(e=0;o>e;++e)f[e]=e%256;t=getHexStringFromBuffer(f),r="82 "+getHybiLengthAsHexString(o,!0)+" 34 83 a8 68 "+getHexStringFromBuffer(mask(f,"34 83 a8 68")),n=!1,a.onbinary=function(e){n=!0,assert.equal(t,getHexStringFromBuffer(e))},a.add(getBufferFromHexString(r)),n.should.be.ok}),it("can parse a 200kb long masked binary message",function(){var e,t,r,n,a=new Receiver,o=204800,f=new Buffer(o);for(e=0;o>e;++e)f[e]=e%256;t=getHexStringFromBuffer(f),r="82 "+getHybiLengthAsHexString(o,!0)+" 34 83 a8 68 "+getHexStringFromBuffer(mask(f,"34 83 a8 68")),n=!1,a.onbinary=function(e){n=!0,assert.equal(t,getHexStringFromBuffer(e))},a.add(getBufferFromHexString(r)),n.should.be.ok}),it("can parse a 200kb long unmasked binary message",function(){var e,t,r,n,a=new Receiver,o=204800,f=new Buffer(o);for(e=0;o>e;++e)f[e]=e%256;t=getHexStringFromBuffer(f),r="82 "+getHybiLengthAsHexString(o,!1)+" "+getHexStringFromBuffer(f),n=!1,a.onbinary=function(e){n=!0,assert.equal(t,getHexStringFromBuffer(e))},a.add(getBufferFromHexString(r)),n.should.be.ok})});