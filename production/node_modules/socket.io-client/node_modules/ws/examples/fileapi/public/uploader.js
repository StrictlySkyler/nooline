function Uploader(e,n){this.ws=new WebSocket(e),n&&(this.ws.onopen=n),this.sendQueue=[],this.sending=null,this.sendCallback=null,this.ondone=null;var s=this;this.ws.onmessage=function(e){var n,t,l,o=JSON.parse(e.data);if("complete"==o.event){if(o.path!=s.sending.path)throw s.sendQueue=[],s.sending=null,s.sendCallback=null,Error("Got message for wrong file!");s.sending=null,n=s.sendCallback,s.sendCallback=null,n&&n(),0===s.sendQueue.length&&s.ondone&&s.ondone(null),s.sendQueue.length>0&&(t=s.sendQueue.pop(),setTimeout(function(){s.sendFile.apply(s,t)},0))}else"error"==o.event&&(s.sendQueue=[],s.sending=null,n=s.sendCallback,s.sendCallback=null,l=Error("Server reported send error for file "+o.path),n&&n(l),s.ondone&&s.ondone(l))}}Uploader.prototype.sendFile=function(e,n){if(this.ws.readyState!=WebSocket.OPEN)throw Error("Not connected");if(this.sending)return this.sendQueue.push(arguments),void 0;var s={name:e.name,path:e.webkitRelativePath};this.sending=s,this.sendCallback=n,this.ws.send(JSON.stringify(s)),this.ws.send(e)},Uploader.prototype.close=function(){this.ws.close()};