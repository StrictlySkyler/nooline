/*!
 * commander
 * Copyright(c) 2011 TJ Holowaychuk <tj@vision-media.ca>
 * MIT Licensed
 */

function Option(t,n){this.flags=t,this.required=~t.indexOf("<"),this.optional=~t.indexOf("["),this.bool=!~t.indexOf("-no-"),t=t.split(/[ ,|]+/),t.length>1&&!/^[[<]/.test(t[1])&&(this.short=t.shift()),this.long=t.shift(),this.description=n}function Command(t){this.commands=[],this.options=[],this.args=[],this.name=t}function camelcase(t){return t.split("-").reduce(function(t,n){return t+n[0].toUpperCase()+n.slice(1)})}function parseBool(t){return/^y|yes|ok|true$/i.test(t)}function pad(t,n){var o=Math.max(0,n-t.length);return t+Array(o+1).join(" ")}function outputHelpIfNecessary(t,n){n=n||[];for(var o=0;o<n.length;o++)("--help"==n[o]||"-h"==n[o])&&(process.stdout.write(t.helpInformation()),t.emit("--help"),process.exit(0))}var EventEmitter=null.EventEmitter,path=null,tty=null,basename=path.basename;exports=module.exports=new Command,exports.Command=Command,exports.Option=Option,Option.prototype.name=function(){return this.long.replace("--","").replace("no-","")},Option.prototype.is=function(t){return t==this.short||t==this.long},Command.prototype.__proto__=EventEmitter.prototype,Command.prototype.command=function(t){var n=t.split(/ +/),o=new Command(n.shift());return this.commands.push(o),o.parseExpectedArgs(n),o.parent=this,o},Command.prototype.parseExpectedArgs=function(t){if(t.length){var n=this;return t.forEach(function(t){switch(t[0]){case"<":n.args.push({required:!0,name:t.slice(1,-1)});break;case"[":n.args.push({required:!1,name:t.slice(1,-1)})}}),this}},Command.prototype.action=function(t){var n=this;return this.parent.on(this.name,function(o,e){e=e||[];var r=n.parseOptions(e);outputHelpIfNecessary(n,r.unknown),r.unknown.length>0&&n.unknownOption(r.unknown[0]),n.args.forEach(function(t,e){t.required&&null==o[e]&&n.missingArgument(t.name)}),n.args.length?o[n.args.length]=n:o.push(n),t.apply(this,o)}),this},Command.prototype.option=function(t,n,o,e){var r=this,i=new Option(t,n),s=i.name(),p=camelcase(s);return"function"!=typeof o&&(e=o,o=null),(0==i.bool||i.optional||i.required)&&(0==i.bool&&(e=!0),void 0!==e&&(r[p]=e)),this.options.push(i),this.on(s,function(t){null!=t&&o&&(t=o(t)),"boolean"==typeof r[p]||void 0===r[p]?r[p]=null==t?i.bool?e||!0:!1:t:null!==t&&(r[p]=t)}),this},Command.prototype.parse=function(t){this.rawArgs=t,this.name||(this.name=basename(t[1]));var n=this.parseOptions(this.normalize(t.slice(2)));return this.args=n.args,this.parseArgs(this.args,n.unknown)},Command.prototype.normalize=function(t){var n,o,e,r=[];for(o=0,e=t.length;e>o;++o)n=t[o],n.length>1&&"-"==n[0]&&"-"!=n[1]?n.slice(1).split("").forEach(function(t){r.push("-"+t)}):r.push(n);return r},Command.prototype.parseArgs=function(t,n){var o,e=this.commands;return e.length,t.length?(o=t[0],this.listeners(o).length?this.emit(t.shift(),t,n):this.emit("*",t)):(outputHelpIfNecessary(this,n),n.length>0&&this.unknownOption(n[0])),this},Command.prototype.optionFor=function(t){for(var n=0,o=this.options.length;o>n;++n)if(this.options[n].is(t))return this.options[n]},Command.prototype.parseOptions=function(t){var n,o,e,r,i=[],s=t.length,p=[];for(r=0;s>r;++r)if(e=t[r],"--"!=e)if(n)i.push(e);else if(o=this.optionFor(e))if(o.required){if(e=t[++r],null==e)return this.optionMissingArgument(o);if("-"==e[0])return this.optionMissingArgument(o,e);this.emit(o.name(),e)}else o.optional?(e=t[r+1],null==e||"-"==e[0]?e=null:++r,this.emit(o.name(),e)):this.emit(o.name());else e.length>1&&"-"==e[0]?(p.push(e),t[r+1]&&"-"!=t[r+1][0]&&p.push(t[++r])):i.push(e);else n=!0;return{args:i,unknown:p}},Command.prototype.missingArgument=function(t){console.error(),console.error("  error: missing required argument `%s'",t),console.error(),process.exit(1)},Command.prototype.optionMissingArgument=function(t,n){console.error(),n?console.error("  error: option `%s' argument missing, got `%s'",t.flags,n):console.error("  error: option `%s' argument missing",t.flags),console.error(),process.exit(1)},Command.prototype.unknownOption=function(t){console.error(),console.error("  error: unknown option `%s'",t),console.error(),process.exit(1)},Command.prototype.version=function(t,n){return 0==arguments.length?this._version:(this._version=t,n=n||"-V, --version",this.option(n,"output the version number"),this.on("version",function(){console.log(t),process.exit(0)}),this)},Command.prototype.description=function(t){return 0==arguments.length?this._description:(this._description=t,this)},Command.prototype.usage=function(t){var n=this.args.map(function(t){return t.required?"<"+t.name+">":"["+t.name+"]"}),o="[options"+(this.commands.length?"] [command":"")+"]"+(this.args.length?" "+n:"");return 0==arguments.length?this._usage||o:(this._usage=t,this)},Command.prototype.largestOptionLength=function(){return this.options.reduce(function(t,n){return Math.max(t,n.flags.length)},0)},Command.prototype.optionHelp=function(){var t=this.largestOptionLength();return[pad("-h, --help",t)+"  "+"output usage information"].concat(this.options.map(function(n){return pad(n.flags,t)+"  "+n.description})).join("\n")},Command.prototype.commandHelp=function(){return this.commands.length?["","  Commands:","",this.commands.map(function(t){var n=t.args.map(function(t){return t.required?"<"+t.name+">":"["+t.name+"]"}).join(" ");return t.name+(t.options.length?" [options]":"")+" "+n+(t.description()?"\n"+t.description():"")}).join("\n\n").replace(/^/gm,"    "),""].join("\n"):""},Command.prototype.helpInformation=function(){return["","  Usage: "+this.name+" "+this.usage(),""+this.commandHelp(),"  Options:","",""+this.optionHelp().replace(/^/gm,"    "),"",""].join("\n")},Command.prototype.promptForNumber=function(t,n){var o=this;this.promptSingleLine(t,function e(r){return r=Number(r),isNaN(r)?o.promptSingleLine(t+"(must be a number) ",e):(n(r),void 0)})},Command.prototype.promptForDate=function(t,n){var o=this;this.promptSingleLine(t,function e(r){return r=new Date(r),isNaN(r.getTime())?o.promptSingleLine(t+"(must be a date) ",e):(n(r),void 0)})},Command.prototype.promptSingleLine=function(t,n){return"function"==typeof arguments[2]?this["promptFor"+(n.name||n)](t,arguments[2]):(process.stdout.write(t),process.stdin.setEncoding("utf8"),process.stdin.once("data",function(t){n(t.trim())}).resume(),void 0)},Command.prototype.promptMultiLine=function(t,n){var o=[];console.log(t),process.stdin.setEncoding("utf8"),process.stdin.on("data",function(t){"\n"==t||"\r\n"==t?(process.stdin.removeAllListeners("data"),n(o.join("\n"))):o.push(t.trimRight())}).resume()},Command.prototype.prompt=function(t,n){function o(){var s=e.shift(),p=t[s];return s?(i.prompt(p,function(t){r[s]=t,o()}),void 0):n(r)}var e,r,i=this;if("string"==typeof t){if(/ $/.test(t))return this.promptSingleLine.apply(this,arguments);this.promptMultiLine(t,n)}else e=Object.keys(t),r={},o()},Command.prototype.password=function(t,n,o){var e=this,r="";"function"==typeof n&&(o=n,n=""),process.stdin.resume(),tty.setRawMode(!0),process.stdout.write(t),process.stdin.on("keypress",function(i,s){return s&&"enter"==s.name?(console.log(),process.stdin.removeAllListeners("keypress"),tty.setRawMode(!1),r.trim().length?(o(r),void 0):e.password(t,n,o)):(s&&s.ctrl&&"c"==s.name&&(console.log("%s",r),process.exit()),process.stdout.write(n),r+=i,void 0)}).resume()},Command.prototype.confirm=function(t,n,o){var e=this;this.prompt(t,function(r){return r.trim()?(n(parseBool(r)),void 0):(o||(t+="(yes or no) "),e.confirm(t,n,!0))})},Command.prototype.choose=function(t,n,o){function e(){r.prompt("  : ",function(r){r=parseInt(r,10)-1,i&&isNaN(r)&&(r=n),null==t[r]?e():o(r,t[r])})}var r=this,i="number"==typeof n;i||(o=n,n=null),t.forEach(function(t,o){i&&o==n?console.log("* %d) %s",o+1,t):console.log("  %d) %s",o+1,t)}),e()};