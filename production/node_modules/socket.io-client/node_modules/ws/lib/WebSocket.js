/*!
 * ws: a node.js websocket client
 * Copyright(c) 2011 Einar Otto Stangvik <einaros@gmail.com>
 * MIT Licensed
 */

function WebSocket(e,t,o){t&&!Array.isArray(t)&&"object"==typeof t&&(o=t,t=null),"string"==typeof t&&(t=[t]),Array.isArray(t)||(t=[]),this._socket=null,this.bytesReceived=0,this.readyState=null,this.supports={},Array.isArray(e)?initAsServerClient.apply(this,e.concat(o)):initAsClient.apply(this,[e,t,o])}function MessageEvent(e,t,o){this.data=e,this.type=t,this.target=o}function CloseEvent(e,t,o){this.wasClean=void 0===e||1e3==e,this.code=e,this.reason=t,this.target=o}function OpenEvent(e){this.target=e}function initAsServerClient(e,t,o,r){r=new Options({protocolVersion:protocolVersion,protocol:null}).merge(r),this.protocol=r.value.protocol,this.protocolVersion=r.value.protocolVersion,this.supports.binary="hixie-76"!=this.protocolVersion,this.upgradeReq=e,this.readyState=WebSocket.CONNECTING,this._isServer=!0,"hixie-76"==r.value.protocolVersion?establishConnection.call(this,ReceiverHixie,SenderHixie,t,o):establishConnection.call(this,Receiver,Sender,t,o)}function initAsClient(e,t,o){var r,n,i,s,c,l,a,u,d,h,p,f,v,S,y;if(o=new Options({origin:null,protocolVersion:protocolVersion,host:null,headers:null,protocol:null,agent:null,pfx:null,key:null,passphrase:null,cert:null,ca:null,ciphers:null,rejectUnauthorized:null}).merge(o),8!=o.value.protocolVersion&&13!=o.value.protocolVersion)throw Error("unsupported protocol version");if(r=url.parse(e),n="ws+unix:"===r.protocol,!r.host&&!n)throw Error("invalid url");if(i="wss:"===r.protocol||"https:"===r.protocol,s=i?https:http,c=r.port||(i?443:80),l=r.auth,this._isServer=!1,this.url=e,this.protocolVersion=o.value.protocolVersion,this.supports.binary="hixie-76"!=this.protocolVersion,a=new Buffer(o.value.protocolVersion+"-"+Date.now()).toString("base64"),u=crypto.createHash("sha1"),u.update(a+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11"),d=u.digest("base64"),h=o.value.agent,!h&&isNodeV4&&(isNodeV4=!0,h=new s.Agent({host:r.hostname,port:c})),p=r.hostname,r.port&&(i&&443!=c||!i&&80!=c)&&(p=p+":"+c),f={port:c,host:r.hostname,headers:{Connection:"Upgrade",Upgrade:"websocket",Host:p,Origin:p,"Sec-WebSocket-Version":o.value.protocolVersion,"Sec-WebSocket-Key":a}},l&&(f.headers.Authorization="Basic "+new Buffer(l).toString("base64")),o.value.protocol&&(f.headers["Sec-WebSocket-Protocol"]=o.value.protocol),o.value.host&&(f.headers.Host=o.value.host),o.value.headers)for(v in o.value.headers)o.value.headers.hasOwnProperty(v)&&(f.headers[v]=o.value.headers[v]);if(o.isDefinedAndNonNull("pfx")||o.isDefinedAndNonNull("key")||o.isDefinedAndNonNull("passphrase")||o.isDefinedAndNonNull("cert")||o.isDefinedAndNonNull("ca")||o.isDefinedAndNonNull("ciphers")||o.isDefinedAndNonNull("rejectUnauthorized")){if(isNodeV4)throw Error("Client side certificates are not supported on Node 0.4.x");o.isDefinedAndNonNull("pfx")&&(f.pfx=o.value.pfx),o.isDefinedAndNonNull("key")&&(f.key=o.value.key),o.isDefinedAndNonNull("passphrase")&&(f.passphrase=o.value.passphrase),o.isDefinedAndNonNull("cert")&&(f.cert=o.value.cert),o.isDefinedAndNonNull("ca")&&(f.ca=o.value.ca),o.isDefinedAndNonNull("ciphers")&&(f.ciphers=o.value.ciphers),o.isDefinedAndNonNull("rejectUnauthorized")&&(f.rejectUnauthorized=o.value.rejectUnauthorized),h||(h=new s.Agent(f))}f.path=isNodeV4?(r.pathname||"/")+(r.search||""):r.path||"/",h&&(f.agent=h),n&&(f.socketPath=r.pathname),o.value.origin&&(o.value.protocolVersion<13?f.headers["Sec-WebSocket-Origin"]=o.value.origin:f.headers.Origin=o.value.origin),S=this,y=s.request(f),(isNodeV4?h:y).on("error",function(e){S.emit("error",e),cleanupWebsocketResources.call(this,e)}),(isNodeV4?h:y).once("response",function(e){var t=Error("unexpected server response ("+e.statusCode+")");S.emit("error",t),cleanupWebsocketResources.call(this,t)}),(isNodeV4?h:y).once("upgrade",function(e,t,r){var n,i,s,c;return S.readyState==WebSocket.CLOSED?(S.emit("close"),removeAllListeners(S),t.end(),void 0):(n=e.headers["sec-websocket-accept"],void 0===n||n!==d?(S.emit("error","invalid server key"),removeAllListeners(S),t.end(),void 0):(i=e.headers["sec-websocket-protocol"],s=(o.value.protocol||"").split(/, */),c=null,!o.value.protocol&&i?c="server sent a subprotocol even though none requested":o.value.protocol&&!i?c="server sent no subprotocol even though requested":i&&-1===s.indexOf(i)&&(c="server responded with an invalid protocol"),c?(S.emit("error",c),removeAllListeners(S),t.end(),void 0):(i&&(S.protocol=i),establishConnection.call(S,Receiver,Sender,t,r),removeAllListeners(isNodeV4?h:y),y=null,h=null,void 0)))}),y.end(),this.readyState=WebSocket.CONNECTING}function establishConnection(e,t,o,r){function n(e){if(s.readyState==WebSocket.OPEN){if(r&&r.length>0){s.bytesReceived+=r.length;var t=r;r=null,s._receiver.add(t)}c=i,e&&(s.bytesReceived+=e.length,s._receiver.add(e))}}function i(e){e&&(s.bytesReceived+=e.length),s._receiver.add(e)}var s,c;this._socket=o,o.setTimeout(0),o.setNoDelay(!0),s=this,this._receiver=new e,o.on("end",cleanupWebsocketResources.bind(this)),o.on("close",cleanupWebsocketResources.bind(this)),o.on("error",cleanupWebsocketResources.bind(this)),c=n,process.nextTick(n),s._receiver.ontext=function(e,t){t=t||{},s.emit("message",e,t)},s._receiver.onbinary=function(e,t){t=t||{},t.binary=!0,s.emit("message",e,t)},s._receiver.onping=function(e,t){t=t||{},s.pong(e,{mask:!s._isServer,binary:t.binary===!0},!0),s.emit("ping",e,t)},s._receiver.onpong=function(e,t){s.emit("pong",e,t)},s._receiver.onclose=function(e,t,o){o=o||{},s.close(e,t)},s._receiver.onerror=function(e,t){s.close(void 0!==t?t:1002,""),s.emit("error",e,t)},this._sender=new t(o),this._sender.on("error",function(e){s.close(1002,""),s.emit("error",e)}),this.readyState=WebSocket.OPEN,this.emit("open"),o.on("data",c)}function startQueue(e){e._queue=e._queue||[]}function executeQueueSends(e){var t,o,r=e._queue;if(void 0!==r)for(delete e._queue,t=0,o=r.length;o>t;++t)r[t]()}function sendStream(e,t,o,r){t.on("data",function(t){return e.readyState!=WebSocket.OPEN?("function"==typeof r?r(Error("not opened")):(delete e._queue,e.emit("error",Error("not opened"))),void 0):(o.fin=!1,e._sender.send(t,o),void 0)}),t.on("end",function(){return e.readyState!=WebSocket.OPEN?("function"==typeof r?r(Error("not opened")):(delete e._queue,e.emit("error",Error("not opened"))),void 0):(o.fin=!0,e._sender.send(null,o),"function"==typeof r&&r(null),void 0)})}function cleanupWebsocketResources(e){var t,o;if(this.readyState!=WebSocket.CLOSED){if(t=this.readyState!=WebSocket.CONNECTING,this.readyState=WebSocket.CLOSED,clearTimeout(this._closeTimer),this._closeTimer=null,t&&this.emit("close",this._closeCode||1e3,this._closeMessage||""),this._socket){removeAllListeners(this._socket),o=this._socket,this._socket.on("error",function(){try{o.destroy()}catch(e){}});try{e?this._socket.destroy():this._socket.end()}catch(r){}this._socket=null}this._sender&&(removeAllListeners(this._sender),this._sender=null),this._receiver&&(this._receiver.cleanup(),this._receiver=null),removeAllListeners(this),this.on("error",function(){}),delete this._queue}}function removeAllListeners(e){isNodeV4?e._events={}:e.removeAllListeners()}var util=null,events=null,http=null,https=null,crypto=null,url=null,fs=null,Options=null,Sender=null,Receiver=null,SenderHixie=null,ReceiverHixie=null,protocolVersion=13,closeTimeout=3e4,isNodeV4=/^v0\.4/.test(process.version);util.inherits(WebSocket,events.EventEmitter),["CONNECTING","OPEN","CLOSING","CLOSED"].forEach(function(e,t){WebSocket.prototype[e]=WebSocket[e]=t}),WebSocket.prototype.close=function(e,t){if(this.readyState!=WebSocket.CLOSING&&this.readyState!=WebSocket.CLOSED){if(this.readyState==WebSocket.CONNECTING)return this.readyState=WebSocket.CLOSED,void 0;try{this.readyState=WebSocket.CLOSING,this._closeCode=e,this._closeMessage=t;var o=!this._isServer;this._sender.close(e,t,o)}catch(r){this.emit("error",r)}finally{this.terminate()}}},WebSocket.prototype.pause=function(){if(this.readyState!=WebSocket.OPEN)throw Error("not opened");return this._socket.pause()},WebSocket.prototype.ping=function(e,t,o){if(this.readyState!=WebSocket.OPEN){if(o===!0)return;throw Error("not opened")}t=t||{},void 0===t.mask&&(t.mask=!this._isServer),this._sender.ping(e,t)},WebSocket.prototype.pong=function(e,t,o){if(this.readyState!=WebSocket.OPEN){if(o===!0)return;throw Error("not opened")}t=t||{},void 0===t.mask&&(t.mask=!this._isServer),this._sender.pong(e,t)},WebSocket.prototype.resume=function(){if(this.readyState!=WebSocket.OPEN)throw Error("not opened");return this._socket.resume()},WebSocket.prototype.send=function(e,t,o){var r;if("function"==typeof t&&(o=t,t={}),this.readyState!=WebSocket.OPEN){if("function"!=typeof o)throw Error("not opened");return o(Error("not opened")),void 0}return e||(e=""),this._queue?(r=this,this._queue.push(function(){r.send(e,t,o)}),void 0):(t=t||{},t.fin=!0,void 0===t.binary&&(t.binary=e instanceof ArrayBuffer||e instanceof Buffer||e instanceof Uint8Array||e instanceof Uint16Array||e instanceof Uint32Array||e instanceof Int8Array||e instanceof Int16Array||e instanceof Int32Array||e instanceof Float32Array||e instanceof Float64Array),void 0===t.mask&&(t.mask=!this._isServer),e instanceof fs.ReadStream?(startQueue(this),r=this,sendStream(this,e,t,function(e){process.nextTick(function(){executeQueueSends(r)}),"function"==typeof o&&o(e)})):this._sender.send(e,t,o),void 0)},WebSocket.prototype.stream=function(e,t){var o,r;if("function"==typeof e&&(t=e,e={}),o=this,"function"!=typeof t)throw Error("callback must be provided");if(this.readyState!=WebSocket.OPEN){if("function"!=typeof t)throw Error("not opened");return t(Error("not opened")),void 0}return this._queue?(this._queue.push(function(){o.stream(e,t)}),void 0):(e=e||{},void 0===e.mask&&(e.mask=!this._isServer),startQueue(this),r=function(n,i){try{if(o.readyState!=WebSocket.OPEN)throw Error("not opened");e.fin=i===!0,o._sender.send(n,e),i?executeQueueSends(o):process.nextTick(t.bind(null,null,r))}catch(s){"function"==typeof t?t(s):(delete o._queue,o.emit("error",s))}},process.nextTick(t.bind(null,null,r)),void 0)},WebSocket.prototype.terminate=function(){if(this.readyState!=WebSocket.CLOSED)if(this._socket){try{this._socket.end()}catch(e){return cleanupWebsocketResources.call(this,!0),void 0}this._closeTimer=setTimeout(cleanupWebsocketResources.bind(this,!0),closeTimeout)}else this.readyState==WebSocket.CONNECTING&&cleanupWebsocketResources.call(this,!0)},Object.defineProperty(WebSocket.prototype,"bufferedAmount",{get:function(){var e=0;return this._socket&&(e=this._socket.bufferSize||0),e}}),["open","error","close","message"].forEach(function(e){Object.defineProperty(WebSocket.prototype,"on"+e,{get:function(){var t=this.listeners(e)[0];return t?t._listener?t._listener:t:void 0},set:function(t){this.removeAllListeners(e),this.addEventListener(e,t)}})}),WebSocket.prototype.addEventListener=function(e,t){function o(e,o){t.call(this,new MessageEvent(e,o.binary?"Binary":"Text",s))}function r(e,o){t.call(this,new CloseEvent(e,o,s))}function n(e){e.target=s,t.call(this,e)}function i(){t.call(this,new OpenEvent(s))}var s=this;"function"==typeof t&&("message"===e?(o._listener=t,this.on(e,o)):"close"===e?(r._listener=t,this.on(e,r)):"error"===e?(n._listener=t,this.on(e,n)):"open"===e?(i._listener=t,this.on(e,i)):this.on(e,t))},module.exports=WebSocket;