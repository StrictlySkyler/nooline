/*!
 * ws: a node.js websocket client
 * Copyright(c) 2011 Einar Otto Stangvik <einaros@gmail.com>
 * MIT Licensed
 */

function Receiver(){this.state=EMPTY,this.buffers=[],this.messageEnd=-1,this.spanLength=0,this.dead=!1,this.onerror=function(){},this.ontext=function(){},this.onbinary=function(){},this.onclose=function(){},this.onping=function(){},this.onpong=function(){}}function bufferIndex(e,t){for(var s=0,n=e.length;n>s;++s)if(e[s]===t)return s;return-1}var util=null,EMPTY=0,BODY=1,BINARYLENGTH=2,BINARYBODY=3;module.exports=Receiver,Receiver.prototype.add=function(e){function t(){var t,n;if(s.state===EMPTY){if(2==e.length&&255==e[0]&&0==e[1])return s.reset(),s.onclose(),void 0;if(128===e[0])s.messageEnd=0,s.state=BINARYLENGTH,e=e.slice(1);else{if(0!==e[0])return s.error("payload must start with 0x00 byte",!0),void 0;e=e.slice(1),s.state=BODY}}if(s.state===BINARYLENGTH){for(t=0;t<e.length&&128&e[t];)s.messageEnd=128*s.messageEnd+(127&e[t]),++t;t<e.length&&(s.messageEnd=128*s.messageEnd+(127&e[t]),s.state=BINARYBODY,++t),t>0&&(e=e.slice(t))}return s.state===BINARYBODY?(n=s.messageEnd-s.spanLength,e.length>=n?(s.buffers.push(e),s.spanLength+=n,s.messageEnd=n,s.parse()):(s.buffers.push(e),s.spanLength+=e.length,void 0)):(s.buffers.push(e),-1!=(s.messageEnd=bufferIndex(e,255))?(s.spanLength+=s.messageEnd,s.parse()):(s.spanLength+=e.length,void 0))}for(var s=this;e;)e=t()},Receiver.prototype.cleanup=function(){this.dead=!0,this.state=EMPTY,this.buffers=[]},Receiver.prototype.parse=function(){var e,t,s,n,i,r=new Buffer(this.spanLength),h=0;for(e=0,t=this.buffers.length;t-1>e;++e)s=this.buffers[e],s.copy(r,h),h+=s.length;return n=this.buffers[this.buffers.length-1],this.messageEnd>0&&n.copy(r,h,0,this.messageEnd),this.state!==BODY&&--this.messageEnd,i=null,this.messageEnd<n.length-1&&(i=n.slice(this.messageEnd+1)),this.reset(),this.ontext(r.toString("utf8")),i},Receiver.prototype.error=function(e,t){return this.reset(),this.onerror(e,t),this},Receiver.prototype.reset=function(){this.dead||(this.state=EMPTY,this.buffers=[],this.messageEnd=-1,this.spanLength=0)};