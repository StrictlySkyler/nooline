/*!
 * ws: a node.js websocket client
 * Copyright(c) 2011 Einar Otto Stangvik <einaros@gmail.com>
 * MIT Licensed
 */

function WebSocketServer(e,t){if(e=new Options({host:"0.0.0.0",port:null,server:null,verifyClient:null,handleProtocols:null,path:null,noServer:!1,disableHixie:!1,clientTracking:!0}).merge(e),!e.isDefinedAndNonNull("port")&&!e.isDefinedAndNonNull("server")&&!e.value.noServer)throw new TypeError("`port` or a `server` must be provided");var o=this;if(e.isDefinedAndNonNull("port"))this._server=http.createServer(function(e,t){t.writeHead(200,{"Content-Type":"text/plain"}),t.end("Not implemented")}),this._server.listen(e.value.port,e.value.host,t),this._closeServer=function(){o._server.close()};else if(e.value.server&&(this._server=e.value.server,e.value.path)){if(this._server._webSocketPaths&&e.value.server._webSocketPaths[e.value.path])throw Error("two instances of WebSocketServer cannot listen on the same http server path");"object"!=typeof this._server._webSocketPaths&&(this._server._webSocketPaths={}),this._server._webSocketPaths[e.value.path]=1}this._server&&this._server.once("listening",function(){o.emit("listening")}),void 0!==this._server&&(this._server.on("error",function(e){o.emit("error",e)}),this._server.on("upgrade",function(e,t,r){var n=new Buffer(r.length);r.copy(n),o.handleUpgrade(e,t,n,function(t){o.emit("connection"+e.url,t),o.emit("connection",t)})})),this.options=e.value,this.path=e.value.path,this.clients=[]}function handleHybiUpgrade(e,t,o,r){var n,i,s,c,a,l,h,d=function(){try{t.destroy()}catch(e){}};if(t.on("error",d),!e.headers["sec-websocket-key"])return abortConnection(t,400,"Bad Request"),void 0;if(n=parseInt(e.headers["sec-websocket-version"]),-1===[8,13].indexOf(n))return abortConnection(t,400,"Bad Request"),void 0;if(i=e.headers["sec-websocket-protocol"],s=13>n?e.headers["sec-websocket-origin"]:e.headers.origin,c=this,a=function(i){var s,a,l=e.headers["sec-websocket-key"],h=crypto.createHash("sha1");h.update(l+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11"),l=h.digest("base64"),s=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade","Sec-WebSocket-Accept: "+l],void 0!==i&&s.push("Sec-WebSocket-Protocol: "+i),c.emit("headers",s),t.setTimeout(0),t.setNoDelay(!0);try{t.write(s.concat("","").join("\r\n"))}catch(u){try{t.destroy()}catch(u){}return}a=new WebSocket([e,t,o],{protocolVersion:n,protocol:i}),c.options.clientTracking&&(c.clients.push(a),a.on("close",function(){var e=c.clients.indexOf(a);-1!=e&&c.clients.splice(e,1)})),t.removeListener("error",d),r(a)},l=function(){var e,o;return"function"==typeof c.options.handleProtocols?(e=(i||"").split(/, */),o=!1,c.options.handleProtocols(e,function(e,r){o=!0,e?a(r):abortConnection(t,404,"Unauthorized")}),o||abortConnection(t,501,"Could not process protocols"),void 0):(void 0!==i?a(i.split(/, */)[0]):a(),void 0)},"function"==typeof this.options.verifyClient){if(h={origin:s,secure:void 0!==e.connection.authorized||void 0!==e.connection.encrypted,req:e},2==this.options.verifyClient.length)return this.options.verifyClient(h,function(e){e?l():abortConnection(t,401,"Unauthorized")}),void 0;if(!this.options.verifyClient(h))return abortConnection(t,401,"Unauthorized"),void 0}l()}function handleHixieUpgrade(e,t,o,r){var n,i,s,c,a=function(){try{t.destroy()}catch(e){}};if(t.on("error",a),this.options.disableHixie)return abortConnection(t,401,"Hixie support disabled"),void 0;if(!e.headers["sec-websocket-key2"])return abortConnection(t,400,"Bad Request"),void 0;if(n=e.headers.origin,i=this,s=function(){var s,c,l,h,d,u,p,v,f;s=e.headers["x-forwarded-host"]?e.headers["x-forwarded-host"]:e.headers.host,c=("https"===e.headers["x-forwarded-proto"]||t.encrypted?"wss":"ws")+"://"+s+e.url,l=e.headers["sec-websocket-protocol"],h=function(o,s){var h,d,u,p,v=e.headers["sec-websocket-key1"],f=e.headers["sec-websocket-key2"],y=crypto.createHash("md5");[v,f].forEach(function(e){var o=parseInt(e.replace(/[^\d]/g,"")),r=e.replace(/[^ ]/g,"").length;return 0===r||0!==o%r?(abortConnection(t,400,"Bad Request"),void 0):(o/=r,y.update(String.fromCharCode(255&o>>24,255&o>>16,255&o>>8,255&o)),void 0)}),y.update(o.toString("binary")),h=["HTTP/1.1 101 Switching Protocols","Upgrade: WebSocket","Connection: Upgrade","Sec-WebSocket-Location: "+c],void 0!==l&&h.push("Sec-WebSocket-Protocol: "+l),void 0!==n&&h.push("Sec-WebSocket-Origin: "+n),t.setTimeout(0),t.setNoDelay(!0);try{d=new Buffer(h.concat("","").join("\r\n")),u=new Buffer(y.digest("binary"),"binary"),p=new Buffer(d.length+u.length),d.copy(p,0),u.copy(p,d.length),t.write(p,"binary",function(o){if(!o){var n=new WebSocket([e,t,s],{protocolVersion:"hixie-76",protocol:l});i.options.clientTracking&&(i.clients.push(n),n.on("close",function(){var e=i.clients.indexOf(n);-1!=e&&i.clients.splice(e,1)})),t.removeListener("error",a),r(n)}})}catch(b){try{t.destroy()}catch(b){}return}},d=8,o&&o.length>=d?(u=o.slice(0,d),p=o.length>d?o.slice(d):null,h.call(i,u,p)):(u=new Buffer(d),o.copy(u,0),v=o.length,p=null,f=function(e){var o=Math.min(e.length,d-v);0!==o&&(e.copy(u,v,0,o),v+=o,v==d&&(t.removeListener("data",f),o<e.length&&(p=e.slice(o)),h.call(i,u,p)))},t.on("data",f))},"function"==typeof this.options.verifyClient){if(c={origin:n,secure:void 0!==e.connection.authorized||void 0!==e.connection.encrypted,req:e},2==this.options.verifyClient.length)return i=this,this.options.verifyClient(c,function(e){e?s.apply(i):abortConnection(t,401,"Unauthorized")}),void 0;if(!this.options.verifyClient(c))return abortConnection(t,401,"Unauthorized"),void 0}s()}function abortConnection(e,t,o){try{var r=["HTTP/1.1 "+t+" "+o,"Content-type: text/html"];e.write(r.concat("","").join("\r\n"))}catch(n){}finally{try{e.destroy()}catch(n){}}}var util=null,events=null,http=null,crypto=null,url=null,Options=null,WebSocket=null,tls=null,url=null;util.inherits(WebSocketServer,events.EventEmitter),WebSocketServer.prototype.close=function(){var e,t,o=null;try{for(e=0,t=this.clients.length;t>e;++e)this.clients[e].terminate()}catch(r){o=r}this.path&&this._server._webSocketPaths&&(delete this._server._webSocketPaths[this.path],0==Object.keys(this._server._webSocketPaths).length&&delete this._server._webSocketPaths);try{void 0!==this._closeServer&&this._closeServer()}finally{delete this._server}if(o)throw o},WebSocketServer.prototype.handleUpgrade=function(e,t){if(this.options.path){var o=url.parse(e.url);if(o&&o.pathname!==this.options.path)return}return void 0===e.headers.upgrade||"websocket"!==e.headers.upgrade.toLowerCase()?(abortConnection(t,400,"Bad Request"),void 0):(e.headers["sec-websocket-key1"]?handleHixieUpgrade.apply(this,arguments):handleHybiUpgrade.apply(this,arguments),void 0)},module.exports=WebSocketServer;