/*!
 * ws: a node.js websocket client
 * Copyright(c) 2011 Einar Otto Stangvik <einaros@gmail.com>
 * MIT Licensed
 */

function Sender(t){this._socket=t,this.firstFragment=!0}function writeUInt16BE(t,e){this[e]=(65280&t)>>8,this[e+1]=255&t}function writeUInt32BE(t,e){this[e]=(4278190080&t)>>24,this[e+1]=(16711680&t)>>16,this[e+2]=(65280&t)>>8,this[e+3]=255&t}function getArrayBuffer(t){var e,r=new Uint8Array(t.buffer||t),n=t.byteLength||t.length,i=t.byteOffset||0,f=new Buffer(n);for(e=0;n>e;++e)f[e]=r[i+e];return f}function getRandomMask(){return new Buffer([~~(255*Math.random()),~~(255*Math.random()),~~(255*Math.random()),~~(255*Math.random())])}var events=null,util=null,EventEmitter=events.EventEmitter,ErrorCodes=null,bufferUtil=null.BufferUtil;util.inherits(Sender,events.EventEmitter),Sender.prototype.close=function(t,e,r){if(void 0!==t&&("number"!=typeof t||!ErrorCodes.isValidErrorCode(t)))throw Error("first argument must be a valid error code number");t=t||1e3;var n=new Buffer(2+(e?Buffer.byteLength(e):0));writeUInt16BE.call(n,t,0),n.length>2&&n.write(e,2),this.frameAndSend(8,n,!0,r)},Sender.prototype.ping=function(t,e){var r=e&&e.mask;this.frameAndSend(9,t||"",!0,r)},Sender.prototype.pong=function(t,e){var r=e&&e.mask;this.frameAndSend(10,t||"",!0,r)},Sender.prototype.send=function(t,e,r){var n=e&&e.fin===!1?!1:!0,i=e&&e.mask,f=e&&e.binary?2:1;this.firstFragment===!1?f=0:this.firstFragment=!1,n&&(this.firstFragment=!0),this.frameAndSend(f,t,n,i,r)},Sender.prototype.frameAndSend=function(t,e,r,n,i){var f,o,s,a,h,c,u,d=!1;if(e){switch(Buffer.isBuffer(e)||(d=!0,e=!e||void 0===e.byteLength&&void 0===e.buffer?new Buffer(e):getArrayBuffer(e)),f=e.length,o=n?6:2,s=f,f>=65536?(o+=8,s=127):f>125&&(o+=2,s=126),a=32768>f||n&&!d,h=a?f+o:o,c=new Buffer(h),c[0]=r?128|t:t,s){case 126:writeUInt16BE.call(c,f,2);break;case 127:writeUInt32BE.call(c,0,2),writeUInt32BE.call(c,f,6)}if(n)if(c[1]=128|s,u=this._randomMask||(this._randomMask=getRandomMask()),c[o-4]=u[0],c[o-3]=u[1],c[o-2]=u[2],c[o-1]=u[3],a){bufferUtil.mask(e,u,c,o,f);try{this._socket.write(c,"binary",i)}catch(m){"function"==typeof i?i(m):this.emit("error",m)}}else{bufferUtil.mask(e,u,e,0,f);try{this._socket.write(c,"binary"),this._socket.write(e,"binary",i)}catch(m){"function"==typeof i?i(m):this.emit("error",m)}}else if(c[1]=s,a){e.copy(c,o);try{this._socket.write(c,"binary",i)}catch(m){"function"==typeof i?i(m):this.emit("error",m)}}else try{this._socket.write(c,"binary"),this._socket.write(e,"binary",i)}catch(m){"function"==typeof i?i(m):this.emit("error",m)}}else try{this._socket.write(new Buffer([t|(r?128:0),0|(n?128:0)].concat(n?[0,0,0,0]:[])),"binary",i)}catch(m){"function"==typeof i?i(m):this.emit("error",m)}},module.exports=Sender;