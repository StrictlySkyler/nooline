/*!
 * ws: a node.js websocket client
 * Copyright(c) 2011 Einar Otto Stangvik <einaros@gmail.com>
 * MIT Licensed
 */

function Receiver(){var e,t=-1;this.fragmentedBufferPool=new BufferPool(1024,function(e,t){return e.used+t},function(e){return t=t>=0?(t+e.used)/2:e.used}),e=-1,this.unfragmentedBufferPool=new BufferPool(1024,function(e,t){return e.used+t},function(t){return e=e>=0?(e+t.used)/2:t.used}),this.state={activeFragmentedOperation:null,lastFragment:!1,masked:!1,opcode:0,fragmentedOperation:!1},this.overflow=[],this.headerBuffer=new Buffer(10),this.expectOffset=0,this.expectBuffer=null,this.expectHandler=null,this.currentMessage=[],this.expectHeader(2,this.processPacket),this.dead=!1,this.onerror=function(){},this.ontext=function(){},this.onbinary=function(){},this.onclose=function(){},this.onping=function(){},this.onpong=function(){}}function readUInt16BE(e){return(this[e]<<8)+this[e+1]}function readUInt32BE(e){return(this[e]<<24)+(this[e+1]<<16)+(this[e+2]<<8)+this[e+3]}function fastCopy(e,t,s,n){switch(e){default:t.copy(s,n,0,e);break;case 16:s[n+15]=t[15];case 15:s[n+14]=t[14];case 14:s[n+13]=t[13];case 13:s[n+12]=t[12];case 12:s[n+11]=t[11];case 11:s[n+10]=t[10];case 10:s[n+9]=t[9];case 9:s[n+8]=t[8];case 8:s[n+7]=t[7];case 7:s[n+6]=t[6];case 6:s[n+5]=t[5];case 5:s[n+4]=t[4];case 4:s[n+3]=t[3];case 3:s[n+2]=t[2];case 2:s[n+1]=t[1];case 1:s[n]=t[0]}}var opcodes,util=null,Validation=null.Validation,ErrorCodes=null,BufferPool=null,bufferUtil=null.BufferUtil,isNodeV4=/^v0\.4/.test(process.version);module.exports=Receiver,Receiver.prototype.add=function(e){var t,s,n=e.length;if(0!=n){if(null==this.expectBuffer)return this.overflow.push(e),void 0;for(t=Math.min(n,this.expectBuffer.length-this.expectOffset),fastCopy(t,e,this.expectBuffer,this.expectOffset),this.expectOffset+=t,n>t&&this.overflow.push(e.slice(t));this.expectBuffer&&this.expectOffset==this.expectBuffer.length;)s=this.expectBuffer,this.expectBuffer=null,this.expectOffset=0,this.expectHandler.call(this,s)}},Receiver.prototype.cleanup=function(){this.dead=!0,this.overflow=null,this.headerBuffer=null,this.expectBuffer=null,this.expectHandler=null,this.unfragmentedBufferPool=null,this.fragmentedBufferPool=null,this.state=null,this.currentMessage=null,this.onerror=null,this.ontext=null,this.onbinary=null,this.onclose=null,this.onping=null,this.onpong=null},Receiver.prototype.expectHeader=function(e,t){var s,n,a;if(0==e)return t(null),void 0;for(this.expectBuffer=this.headerBuffer.slice(this.expectOffset,this.expectOffset+e),this.expectHandler=t,s=e;s>0&&this.overflow.length>0;)n=this.overflow.pop(),s<n.length&&this.overflow.push(n.slice(s)),a=Math.min(n.length,s),fastCopy(a,n,this.expectBuffer,this.expectOffset),this.expectOffset+=a,s-=a},Receiver.prototype.expectData=function(e,t){var s,n,a;if(0==e)return t(null),void 0;for(this.expectBuffer=this.allocateFromPool(e,this.state.fragmentedOperation),this.expectHandler=t,s=e;s>0&&this.overflow.length>0;)n=this.overflow.pop(),s<n.length&&this.overflow.push(n.slice(s)),a=Math.min(n.length,s),fastCopy(a,n,this.expectBuffer,this.expectOffset),this.expectOffset+=a,s-=a},Receiver.prototype.allocateFromPool=isNodeV4?function(e){return new Buffer(e)}:function(e,t){return(t?this.fragmentedBufferPool:this.unfragmentedBufferPool).get(e)},Receiver.prototype.processPacket=function(e){var t,s;if(0!=(112&e[0]))return this.error("reserved fields must be empty",1002),void 0;if(this.state.lastFragment=128==(128&e[0]),this.state.masked=128==(128&e[1]),t=15&e[0],0===t){if(this.state.fragmentedOperation=!0,this.state.opcode=this.state.activeFragmentedOperation,1!=this.state.opcode&&2!=this.state.opcode)return this.error("continuation frame cannot follow current opcode",1002),void 0}else{if(3>t&&null!=this.state.activeFragmentedOperation)return this.error("data frames after the initial data frame must have opcode 0",1002),void 0;this.state.opcode=t,this.state.lastFragment===!1?(this.state.fragmentedOperation=!0,this.state.activeFragmentedOperation=t):this.state.fragmentedOperation=!1}s=opcodes[this.state.opcode],void 0===s?this.error("no handler for opcode "+this.state.opcode,1002):s.start.call(this,e)},Receiver.prototype.endPacket=function(){this.state.fragmentedOperation?this.state.lastFragment&&this.fragmentedBufferPool.reset(!1):this.unfragmentedBufferPool.reset(!0),this.expectOffset=0,this.expectBuffer=null,this.expectHandler=null,this.state.lastFragment&&this.state.opcode===this.state.activeFragmentedOperation&&(this.state.activeFragmentedOperation=null),this.state.lastFragment=!1,this.state.opcode=null!=this.state.activeFragmentedOperation?this.state.activeFragmentedOperation:0,this.state.masked=!1,this.expectHeader(2,this.processPacket)},Receiver.prototype.reset=function(){this.dead||(this.state={activeFragmentedOperation:null,lastFragment:!1,masked:!1,opcode:0,fragmentedOperation:!1},this.fragmentedBufferPool.reset(!0),this.unfragmentedBufferPool.reset(!0),this.expectOffset=0,this.expectBuffer=null,this.expectHandler=null,this.overflow=[],this.currentMessage=[])},Receiver.prototype.unmask=function(e,t,s){return null!=e&&null!=t&&bufferUtil.unmask(t,e),s?t:null!=t?t.toString("utf8"):""},Receiver.prototype.concatBuffers=function(e){var t,s,n,a=0;for(t=0,s=e.length;s>t;++t)a+=e[t].length;return n=new Buffer(a),bufferUtil.merge(n,e),n},Receiver.prototype.error=function(e,t){return this.reset(),this.onerror(e,t),this},opcodes={1:{start:function(e){var t=this,s=127&e[1];126>s?opcodes["1"].getData.call(t,s):126==s?t.expectHeader(2,function(e){opcodes["1"].getData.call(t,readUInt16BE.call(e,0))}):127==s&&t.expectHeader(8,function(e){return 0!=readUInt32BE.call(e,0)?(t.error("packets with length spanning more than 32 bit is currently not supported",1008),void 0):(opcodes["1"].getData.call(t,readUInt32BE.call(e,4)),void 0)})},getData:function(e){var t=this;t.state.masked?t.expectHeader(4,function(s){var n=s;t.expectData(e,function(e){opcodes["1"].finish.call(t,n,e)})}):t.expectData(e,function(e){opcodes["1"].finish.call(t,null,e)})},finish:function(e,t){var s,n=this.unmask(e,t,!0);if(null!=n&&this.currentMessage.push(n),this.state.lastFragment){if(s=this.concatBuffers(this.currentMessage),!Validation.isValidUTF8(s))return this.error("invalid utf8 sequence",1007),void 0;this.ontext(s.toString("utf8"),{masked:this.state.masked,buffer:s}),this.currentMessage=[]}this.endPacket()}},2:{start:function(e){var t=this,s=127&e[1];126>s?opcodes["2"].getData.call(t,s):126==s?t.expectHeader(2,function(e){opcodes["2"].getData.call(t,readUInt16BE.call(e,0))}):127==s&&t.expectHeader(8,function(e){return 0!=readUInt32BE.call(e,0)?(t.error("packets with length spanning more than 32 bit is currently not supported",1008),void 0):(opcodes["2"].getData.call(t,readUInt32BE.call(e,4,!0)),void 0)})},getData:function(e){var t=this;t.state.masked?t.expectHeader(4,function(s){var n=s;t.expectData(e,function(e){opcodes["2"].finish.call(t,n,e)})}):t.expectData(e,function(e){opcodes["2"].finish.call(t,null,e)})},finish:function(e,t){var s,n=this.unmask(e,t,!0);null!=n&&this.currentMessage.push(n),this.state.lastFragment&&(s=this.concatBuffers(this.currentMessage),this.onbinary(s,{masked:this.state.masked,buffer:s}),this.currentMessage=[]),this.endPacket()}},8:{start:function(e){var t,s=this;return 0==s.state.lastFragment?(s.error("fragmented close is not supported",1002),void 0):(t=127&e[1],126>t?opcodes["8"].getData.call(s,t):s.error("control frames cannot have more than 125 bytes of data",1002),void 0)},getData:function(e){var t=this;t.state.masked?t.expectHeader(4,function(s){var n=s;t.expectData(e,function(e){opcodes["8"].finish.call(t,n,e)})}):t.expectData(e,function(e){opcodes["8"].finish.call(t,null,e)})},finish:function(e,t){var s,n,a,i=this;if(t=i.unmask(e,t,!0),t&&1==t.length)return i.error("close packets with data must be at least two bytes long",1002),void 0;if(s=t&&t.length>1?readUInt16BE.call(t,0):1e3,!ErrorCodes.isValidErrorCode(s))return i.error("invalid error code",1002),void 0;if(n="",t&&t.length>2){if(a=t.slice(2),!Validation.isValidUTF8(a))return i.error("invalid utf8 sequence",1007),void 0;n=a.toString("utf8")}this.onclose(s,n,{masked:i.state.masked}),this.reset()}},9:{start:function(e){var t,s=this;return 0==s.state.lastFragment?(s.error("fragmented ping is not supported",1002),void 0):(t=127&e[1],126>t?opcodes["9"].getData.call(s,t):s.error("control frames cannot have more than 125 bytes of data",1002),void 0)},getData:function(e){var t=this;t.state.masked?t.expectHeader(4,function(s){var n=s;t.expectData(e,function(e){opcodes["9"].finish.call(t,n,e)})}):t.expectData(e,function(e){opcodes["9"].finish.call(t,null,e)})},finish:function(e,t){this.onping(this.unmask(e,t,!0),{masked:this.state.masked,binary:!0}),this.endPacket()}},10:{start:function(e){var t,s=this;return 0==s.state.lastFragment?(s.error("fragmented pong is not supported",1002),void 0):(t=127&e[1],126>t?opcodes["10"].getData.call(s,t):s.error("control frames cannot have more than 125 bytes of data",1002),void 0)},getData:function(e){var t=this;this.state.masked?this.expectHeader(4,function(s){var n=s;t.expectData(e,function(e){opcodes["10"].finish.call(t,n,e)})}):this.expectData(e,function(e){opcodes["10"].finish.call(t,null,e)})},finish:function(e,t){this.onpong(this.unmask(e,t,!0),{masked:this.state.masked,binary:!0}),this.endPacket()}}};