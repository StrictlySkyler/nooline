/**
 * socket.io
 * Copyright(c) 2011 LearnBoost <dev@learnboost.com>
 * MIT Licensed
 */

!function(t,n,e){function o(t){if(this.options={port:80,secure:!1,document:"document"in e?document:!1,resource:"socket.io",transports:n.transports,"connect timeout":1e4,"try multiple transports":!0,reconnect:!0,"reconnection delay":500,"reconnection limit":1/0,"reopen delay":3e3,"max reconnection attempts":10,"sync disconnect on unload":!1,"auto connect":!0,"flash policy port":10843,manualFlush:!1},n.util.merge(this.options,t),this.connected=!1,this.open=!1,this.connecting=!1,this.reconnecting=!1,this.namespaces={},this.buffer=[],this.doBuffer=!1,this.options["sync disconnect on unload"]&&(!this.isXDomain()||n.util.ua.hasCORS)){var o=this;n.util.on(e,"beforeunload",function(){o.disconnectSync()},!1)}this.options["auto connect"]&&this.connect()}function i(){}t.Socket=o,n.util.mixin(o,n.EventEmitter),o.prototype.of=function(t){return this.namespaces[t]||(this.namespaces[t]=new n.SocketNamespace(this,t),""!==t&&this.namespaces[t].packet({type:"connect"})),this.namespaces[t]},o.prototype.publish=function(){var t,n;this.emit.apply(this,arguments);for(n in this.namespaces)this.namespaces.hasOwnProperty(n)&&(t=this.of(n),t.$emit.apply(t,arguments))},o.prototype.handshake=function(t){function e(n){n instanceof Error?(c.connecting=!1,c.onError(n.message)):t.apply(null,n.split(":"))}var o,s,r,c=this,p=this.options,a=["http"+(p.secure?"s":"")+":/",p.host+":"+p.port,p.resource,n.protocol,n.util.query(this.options.query,"t="+ +new Date)].join("/");this.isXDomain()&&!n.util.ua.hasCORS?(o=document.getElementsByTagName("script")[0],s=document.createElement("script"),s.src=a+"&jsonp="+n.j.length,o.parentNode.insertBefore(s,o),n.j.push(function(t){e(t),s.parentNode.removeChild(s)})):(r=n.util.request(),r.open("GET",a,!0),this.isXDomain()&&(r.withCredentials=!0),r.onreadystatechange=function(){4==r.readyState&&(r.onreadystatechange=i,200==r.status?e(r.responseText):403==r.status?c.onError(r.responseText):(c.connecting=!1,!c.reconnecting&&c.onError(r.responseText)))},r.send(null))},o.prototype.getTransport=function(t){var e,o,i=t||this.transports;for(o=0;e=i[o];o++)if(n.Transport[e]&&n.Transport[e].check(this)&&(!this.isXDomain()||n.Transport[e].xdomainCheck(this)))return new n.Transport[e](this,this.sessionid);return null},o.prototype.connect=function(t){if(this.connecting)return this;var e=this;return e.connecting=!0,this.handshake(function(o,i,s,r){function c(t){return e.transport&&e.transport.clearTimeouts(),e.transport=e.getTransport(t),e.transport?(e.transport.ready(e,function(){e.connecting=!0,e.publish("connecting",e.transport.name),e.transport.open(),e.options["connect timeout"]&&(e.connectTimeoutTimer=setTimeout(function(){if(!e.connected&&(e.connecting=!1,e.options["try multiple transports"])){for(var t=e.transports;t.length>0&&t.splice(0,1)[0]!=e.transport.name;);t.length?c(t):e.publish("connect_failed")}},e.options["connect timeout"]))}),void 0):e.publish("connect_failed")}e.sessionid=o,e.closeTimeout=1e3*s,e.heartbeatTimeout=1e3*i,e.transports||(e.transports=e.origTransports=r?n.util.intersect(r.split(","),e.options.transports):e.options.transports),e.setHeartbeatTimeout(),c(e.transports),e.once("connect",function(){clearTimeout(e.connectTimeoutTimer),t&&"function"==typeof t&&t()})}),this},o.prototype.setHeartbeatTimeout=function(){if(clearTimeout(this.heartbeatTimeoutTimer),!this.transport||this.transport.heartbeats()){var t=this;this.heartbeatTimeoutTimer=setTimeout(function(){t.transport.onClose()},this.heartbeatTimeout)}},o.prototype.packet=function(t){return this.connected&&!this.doBuffer?this.transport.packet(t):this.buffer.push(t),this},o.prototype.setBuffer=function(t){this.doBuffer=t,!t&&this.connected&&this.buffer.length&&(this.options.manualFlush||this.flushBuffer())},o.prototype.flushBuffer=function(){this.transport.payload(this.buffer),this.buffer=[]},o.prototype.disconnect=function(){return(this.connected||this.connecting)&&(this.open&&this.of("").packet({type:"disconnect"}),this.onDisconnect("booted")),this},o.prototype.disconnectSync=function(){var t=n.util.request(),e=["http"+(this.options.secure?"s":"")+":/",this.options.host+":"+this.options.port,this.options.resource,n.protocol,"",this.sessionid].join("/")+"/?disconnect=1";t.open("GET",e,!1),t.send(null),this.onDisconnect("booted")},o.prototype.isXDomain=function(){return!1},o.prototype.onConnect=function(){this.connected||(this.connected=!0,this.connecting=!1,this.doBuffer||this.setBuffer(!1),this.emit("connect"))},o.prototype.onOpen=function(){this.open=!0},o.prototype.onClose=function(){this.open=!1,clearTimeout(this.heartbeatTimeoutTimer)},o.prototype.onPacket=function(t){this.of(t.endpoint).onPacket(t)},o.prototype.onError=function(t){t&&t.advice&&"reconnect"===t.advice&&(this.connected||this.connecting)&&(this.disconnect(),this.options.reconnect&&this.reconnect()),this.publish("error",t&&t.reason?t.reason:t)},o.prototype.onDisconnect=function(t){var n=this.connected,e=this.connecting;this.connected=!1,this.connecting=!1,this.open=!1,(n||e)&&(this.transport.close(),this.transport.clearTimeouts(),n&&(this.publish("disconnect",t),"booted"!=t&&this.options.reconnect&&!this.reconnecting&&this.reconnect()))},o.prototype.reconnect=function(){function t(){if(e.connected){for(var t in e.namespaces)e.namespaces.hasOwnProperty(t)&&""!==t&&e.namespaces[t].packet({type:"connect"});e.publish("reconnect",e.transport.name,e.reconnectionAttempts)}clearTimeout(e.reconnectionTimer),e.removeListener("connect_failed",n),e.removeListener("connect",n),e.reconnecting=!1,delete e.reconnectionAttempts,delete e.reconnectionDelay,delete e.reconnectionTimer,delete e.redoTransports,e.options["try multiple transports"]=i}function n(){return e.reconnecting?e.connected?t():e.connecting&&e.reconnecting?e.reconnectionTimer=setTimeout(n,1e3):(e.reconnectionAttempts++>=o?e.redoTransports?(e.publish("reconnect_failed"),t()):(e.on("connect_failed",n),e.options["try multiple transports"]=!0,e.transports=e.origTransports,e.transport=e.getTransport(),e.redoTransports=!0,e.connect()):(e.reconnectionDelay<s&&(e.reconnectionDelay*=2),e.connect(),e.publish("reconnecting",e.reconnectionDelay,e.reconnectionAttempts),e.reconnectionTimer=setTimeout(n,e.reconnectionDelay)),void 0):void 0}this.reconnecting=!0,this.reconnectionAttempts=0,this.reconnectionDelay=this.options["reconnection delay"];var e=this,o=this.options["max reconnection attempts"],i=this.options["try multiple transports"],s=this.options["reconnection limit"];this.options["try multiple transports"]=!1,this.reconnectionTimer=setTimeout(n,this.reconnectionDelay),this.on("connect",n)}}("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports,this);