function empty(){}function XHR(t){Polling.call(this,t),global.location&&(this.xd=t.host!=global.location.hostname||global.location.port!=t.port)}function Request(t){this.method=t.method||"GET",this.uri=t.uri,this.xd=!!t.xd,this.async=!1!==t.async,this.data=void 0!=t.data?t.data:null,this.create()}var global,xobject,Polling=null,util=null,Emitter=null,debug=null;module.exports=XHR,module.exports.Request=Request,global="undefined"!=typeof window?window:global,xobject=global[["Active"].concat("Object").join("X")],util.inherits(XHR,Polling),XHR.prototype.doOpen=function(){var t=this;util.defer(function(){Polling.prototype.doOpen.call(t)})},XHR.prototype.request=function(t){return t=t||{},t.uri=this.uri(),t.xd=this.xd,new Request(t)},XHR.prototype.doWrite=function(t,e){var o=this.request({method:"POST",data:t}),s=this;o.on("success",e),o.on("error",function(t){s.onError("xhr post error",t)}),this.sendXhr=o},XHR.prototype.doPoll=function(){var t,e;debug("xhr poll"),t=this.request(),e=this,t.on("data",function(t){e.onData(t)}),t.on("error",function(t){e.onError("xhr poll error",t)}),this.pollXhr=t},Emitter(Request.prototype),Request.prototype.create=function(){var t=this.xhr=util.request(this.xd),e=this;if(t.open(this.method,this.uri,this.async),"POST"==this.method)try{t.setRequestHeader?t.setRequestHeader("Content-type","text/plain;charset=UTF-8"):t.contentType="text/plain"}catch(o){}this.xd&&global.XDomainRequest&&t instanceof XDomainRequest?(t.onerror=function(t){e.onError(t)},t.onload=function(){e.onData(t.responseText)},t.onprogress=empty):("withCredentials"in t&&(t.withCredentials=!0),t.onreadystatechange=function(){var o;try{if(4!=t.readyState)return;200==t.status||1223==t.status?o=t.responseText:e.onError(t.status)}catch(s){e.onError(s)}void 0!==o&&e.onData(o)}),debug("sending xhr with url %s | data %s",this.uri,this.data),t.send(this.data),xobject&&(this.index=Request.requestsCount++,Request.requests[this.index]=this)},Request.prototype.onSuccess=function(){this.emit("success"),this.cleanup()},Request.prototype.onData=function(t){this.emit("data",t),this.onSuccess()},Request.prototype.onError=function(t){this.emit("error",t),this.cleanup()},Request.prototype.cleanup=function(){this.xhr.onreadystatechange=empty,this.xhr.onload=this.xhr.onerror=empty;try{this.xhr.abort()}catch(t){}xobject&&delete Request.requests[this.index],this.xhr=null},Request.prototype.abort=function(){this.cleanup()},xobject&&(Request.requestsCount=0,Request.requests={},global.attachEvent("onunload",function(){for(var t in Request.requests)Request.requests.hasOwnProperty(t)&&Request.requests[t].abort()}));