/*
 *  Copyright 2011 Twitter, Inc.
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *  http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 */

!function(n){function t(n){"}"===n.n.substr(n.n.length-1)&&(n.n=n.n.substring(0,n.n.length-1))}function r(n){return n.trim?n.trim():n.replace(/^\s*|\s*$/g,"")}function e(n,t,r){if(t.charAt(r)!=n.charAt(0))return!1;for(var e=1,i=n.length;i>e;e++)if(t.charAt(r+e)!=n.charAt(e))return!1;return!0}function i(n,t,r,e){for(var o=[],a=null,g=null;n.length>0;)if(g=n.shift(),"#"==g.tag||"^"==g.tag||c(g,e))r.push(g),g.nodes=i(n,g.tag,r,e),o.push(g);else{if("/"==g.tag){if(0===r.length)throw Error("Closing tag without opener: /"+g.n);if(a=r.pop(),g.n!=a.n&&!u(g.n,a.n,e))throw Error("Nesting error: "+a.n+" vs. "+g.n);return a.end=g.i,o}o.push(g)}if(r.length>0)throw Error("missing closing tag: "+r.pop().n);return o}function c(n,t){for(var r=0,e=t.length;e>r;r++)if(t[r].o==n.n)return n.tag="#",!0}function u(n,t,r){for(var e=0,i=r.length;i>e;e++)if(r[e].c==n&&r[e].o==t)return!0}function o(n){return n.replace(m,"\\\\").replace(d,'\\"').replace(A,"\\n").replace(b,"\\r")}function a(n){return~n.indexOf(".")?"d":"f"}function g(n){var t,r,e,i="";for(t=0,r=n.length;r>t;t++)e=n[t].tag,"#"==e?i+=f(n[t].nodes,n[t].n,a(n[t].n),n[t].i,n[t].end,n[t].otag+" "+n[t].ctag):"^"==e?i+=h(n[t].nodes,n[t].n,a(n[t].n)):"<"==e||">"==e?i+=s(n[t]):"{"==e||"&"==e?i+=l(n[t].n,a(n[t].n)):"\n"==e?i+=_('"\\n"'+(n.length-1==t?"":" + i")):"_v"==e?i+=p(n[t].n,a(n[t].n)):void 0===e&&(i+=_('"'+o(n[t])+'"'));return i}function f(n,t,r,e,i,c){return"if(_.s(_."+r+'("'+o(t)+'",c,p,1),'+"c,p,0,"+e+","+i+',"'+c+'")){'+"_.rs(c,p,"+"function(c,p,_){"+g(n)+"});c.pop();}"}function h(n,t,r){return"if(!_.s(_."+r+'("'+o(t)+'",c,p,1),c,p,1,0,0,"")){'+g(n)+"};"}function s(n){return'_.b(_.rp("'+o(n.n)+'",c,p,"'+(n.indent||"")+'"));'}function l(n,t){return"_.b(_.t(_."+t+'("'+o(n)+'",c,p,0)));'}function p(n,t){return"_.b(_.v(_."+t+'("'+o(n)+'",c,p,0)));'}function _(n){return"_.b("+n+");"}var v=/\S/,d=/\"/g,A=/\n/g,b=/\r/g,m=/\\/g,w={"#":1,"^":2,"/":3,"!":4,">":5,"<":6,"=":7,_v:8,"{":9,"&":10};n.scan=function(n,i){function c(){d.length>0&&(A.push(new String(d)),d="")}function u(){var n,t=!0;for(n=x;n<A.length;n++)if(t=A[n].tag&&w[A[n].tag]<w._v||!A[n].tag&&null===A[n].match(v),!t)return!1;return t}function o(n,t){if(c(),n&&u())for(var r,e=x;e<A.length;e++)A[e].tag||((r=A[e+1])&&">"==r.tag&&(r.indent=""+A[e]),A.splice(e,1));else t||A.push({tag:"\n"});b=!1,x=A.length}function a(n,t){var e="="+E,i=n.indexOf(e,t),c=r(n.substring(n.indexOf("=",t)+1,i)).split(" ");return S=c[0],E=c[1],i+e.length-1}var g=n.length,f=0,h=1,s=2,l=f,p=null,_=null,d="",A=[],b=!1,m=0,x=0,S="{{",E="}}";for(i&&(i=i.split(" "),S=i[0],E=i[1]),m=0;g>m;m++)l==f?e(S,n,m)?(--m,c(),l=h):"\n"==n.charAt(m)?o(b):d+=n.charAt(m):l==h?(m+=S.length-1,_=w[n.charAt(m+1)],p=_?n.charAt(m+1):"_v","="==p?(m=a(n,m),l=f):(_&&m++,l=s),b=m):e(E,n,m)?(A.push({tag:p,n:r(d),otag:S,ctag:E,i:"/"==p?b-E.length:m+S.length}),d="",m+=E.length-1,l=f,"{"==p&&("}}"==E?m++:t(A[A.length-1]))):d+=n.charAt(m);return o(b,!0),A},n.generate=function(t,r,e){var i='var _=this;_.b(i=i||"");'+g(t)+"return _.fl();";return e.asString?"function(c,p,i){"+i+";}":new n.Template(Function("c","p","i",i),r,n,e)},n.parse=function(n,t,r){return r=r||{},i(n,"",[],r.sectionTags||[])},n.cache={},n.compile=function(n,t){var r,e;return t=t||{},r=n+"||"+!!t.asString,(e=this.cache[r])?e:(e=this.generate(this.parse(this.scan(n,t.delimiters),n,t),n,t),this.cache[r]=e)}}("undefined"!=typeof exports?exports:Hogan);