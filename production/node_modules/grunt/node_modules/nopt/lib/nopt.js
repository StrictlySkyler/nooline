function nopt(e,r,o,n){o=o||process.argv,e=e||{},r=r||{},"number"!=typeof n&&(n=2),debug(e,r,o,n),o=o.slice(n);var a={},t=[],l=o,i=o.slice(0);return parse(o,a,t,e,r),clean(a,e,exports.typeDefs),a.argv={remain:t,cooked:l,original:i},a.argv.toString=function(){return this.original.map(JSON.stringify).join(" ")},a}function clean(e,r,o){o=o||exports.typeDefs;var n={},a=[!1,!0,null,String,Number];Object.keys(e).forEach(function(t){if("argv"!==t){var l=e[t],i=Array.isArray(l),s=r[t];i||(l=[l]),s||(s=a),s===Array&&(s=a.concat(Array)),Array.isArray(s)||(s=[s]),debug("val=%j",l),debug("types=",s),l=l.map(function(a){if("string"==typeof a&&(debug("string %j",a),a=a.trim(),"null"===a&&~s.indexOf(null)||"true"===a&&(~s.indexOf(!0)||~s.indexOf(Boolean))||"false"===a&&(~s.indexOf(!1)||~s.indexOf(Boolean))?(a=JSON.parse(a),debug("jsonable %j",a)):~s.indexOf(Number)&&!isNaN(a)?(debug("convert to number",a),a=+a):~s.indexOf(Date)&&!isNaN(Date.parse(a))&&(debug("convert to date",a),a=new Date(a))),!r.hasOwnProperty(t))return a;a!==!1||!~s.indexOf(null)||~s.indexOf(!1)||~s.indexOf(Boolean)||(a=null);var l={};return l[t]=a,debug("prevalidated val",l,a,r[t]),validate(l,t,a,r[t],o)?(debug("validated val",l,a,r[t]),l[t]):(exports.invalidHandler?exports.invalidHandler(t,a,r[t],e):exports.invalidHandler!==!1&&debug("invalid: "+t+"="+a,r[t]),n)}).filter(function(e){return e!==n}),l.length?i?(debug(i,e[t],l),e[t]=l):e[t]=l[0]:delete e[t],debug("k=%s val=%j",t,l,e[t])}})}function validateString(e,r,o){e[r]=o+""}function validatePath(e,r,o){return e[r]=path.resolve(o+""),!0}function validateNumber(e,r,o){return debug("validate Number %j %j %j",r,o,isNaN(o)),isNaN(o)?!1:(e[r]=+o,void 0)}function validateDate(e,r,o){debug("validate Date %j %j %j",r,o,Date.parse(o));var n=Date.parse(o);return isNaN(n)?!1:(e[r]=new Date(o),void 0)}function validateBoolean(e,r,o){o=o instanceof Boolean?o.valueOf():"string"==typeof o?isNaN(o)?"null"===o||"false"===o?!1:!0:!!+o:!!o,e[r]=o}function validateUrl(e,r,o){return o=url.parse(o+""),o.host?(e[r]=o.href,void 0):!1}function validateStream(e,r,o){return o instanceof Stream?(e[r]=o,void 0):!1}function validate(e,r,o,n,a){var t,l,i,s,u,d;if(Array.isArray(n)){for(t=0,l=n.length;l>t;t++)if(n[t]!==Array&&validate(e,r,o,n[t],a))return!0;return delete e[r],!1}if(n===Array)return!0;if(n!==n)return debug("Poison NaN",r,o,n),delete e[r],!1;if(o===n)return debug("Explicitly allowed %j",o),e[r]=o,!0;for(i=!1,s=Object.keys(a),t=0,l=s.length;l>t;t++)if(debug("test type %j %j %j",r,o,s[t]),u=a[s[t]],u&&n===u.type&&(d={},i=!1!==u.validate(d,r,o),o=d[r],i)){e[r]=o;break}return debug("OK? %j (%j %j %j)",i,r,o,s[t]),i||delete e[r],i}function parse(e,r,o,n,a){var t,l,i,s,u,d,g,f,p,c,v;for(debug("parse",e,r,o),t=abbrev(Object.keys(n)),l=abbrev(Object.keys(a)),i=0;i<e.length;i++){if(s=e[i],debug("arg",s),s.match(/^-{2,}$/)){o.push.apply(o,e.slice(i+1)),e[i]="--";break}if("-"!==s.charAt(0))o.push(s);else{if(-1!==s.indexOf("=")&&(u=s.split("="),s=u.shift(),u=u.join("="),e.splice.apply(e,[i,1].concat([s,u]))),d=resolveShort(s,a,l,t),debug("arg=%j shRes=%j",s,d),d&&(debug(s,d),e.splice.apply(e,[i,1].concat(d)),s!==d[0])){i--;continue}for(s=s.replace(/^-+/,""),g=!1;0===s.toLowerCase().indexOf("no-");)g=!g,s=s.substr(3);if(t[s]&&(s=t[s]),f=n[s]===Array||Array.isArray(n[s])&&-1!==n[s].indexOf(Array),c=e[i+1],v=g||n[s]===Boolean||Array.isArray(n[s])&&-1!==n[s].indexOf(Boolean)||"false"===c&&(null===n[s]||Array.isArray(n[s])&&~n[s].indexOf(null))){p=!g,("true"===c||"false"===c)&&(p=JSON.parse(c),c=null,g&&(p=!p),i++),Array.isArray(n[s])&&c&&(~n[s].indexOf(c)?(p=c,i++):"null"===c&&~n[s].indexOf(null)?(p=null,i++):c.match(/^-{2,}[^-]/)||isNaN(c)||!~n[s].indexOf(Number)?!c.match(/^-[^-]/)&&~n[s].indexOf(String)&&(p=c,i++):(p=+c,i++)),f?(r[s]=r[s]||[]).push(p):r[s]=p;continue}c&&c.match(/^-{2,}$/)&&(c=void 0,i--),p=void 0===c?!0:c,f?(r[s]=r[s]||[]).push(p):r[s]=p,i++}}}function resolveShort(e,r,o,n){var a,t;if(e=e.replace(/^-+/,""),n[e]&&!r[e])return null;if(o[e])e=o[e];else if(a=r.___singles,a||(a=Object.keys(r).filter(function(e){return 1===e.length}).reduce(function(e,r){return e[r]=!0,e},{}),r.___singles=a),t=e.split("").filter(function(e){return a[e]}),t.join("")===e)return t.map(function(e){return r[e]}).reduce(function(e,r){return e.concat(r)},[]);return r[e]&&!Array.isArray(r[e])&&(r[e]=r[e].split(/\s+/)),r[e]}var assert,util,shorthands,types,debug=process.env.DEBUG_NOPT||process.env.NOPT_DEBUG?function(){console.error.apply(console,arguments)}:function(){},url=require("url"),path=require("path"),Stream=require("stream").Stream,abbrev=require("abbrev");module.exports=exports=nopt,exports.clean=clean,exports.typeDefs={String:{type:String,validate:validateString},Boolean:{type:Boolean,validate:validateBoolean},url:{type:url,validate:validateUrl},Number:{type:Number,validate:validateNumber},path:{type:path,validate:validatePath},Stream:{type:Stream,validate:validateStream},Date:{type:Date,validate:validateDate}},module===require.main&&(assert=require("assert"),util=require("util"),shorthands={s:["--loglevel","silent"],d:["--loglevel","info"],dd:["--loglevel","verbose"],ddd:["--loglevel","silly"],noreg:["--no-registry"],reg:["--registry"],"no-reg":["--no-registry"],silent:["--loglevel","silent"],verbose:["--loglevel","verbose"],h:["--usage"],H:["--usage"],"?":["--usage"],help:["--usage"],v:["--version"],f:["--force"],desc:["--description"],"no-desc":["--no-description"],local:["--no-global"],l:["--long"],p:["--parseable"],porcelain:["--parseable"],g:["--global"]},types={aoa:Array,nullstream:[null,Stream],date:Date,str:String,browser:String,cache:path,color:["always",Boolean],depth:Number,description:Boolean,dev:Boolean,editor:path,force:Boolean,global:Boolean,globalconfig:path,group:[String,Number],gzipbin:String,logfd:[Number,Stream],loglevel:["silent","win","error","warn","info","verbose","silly"],"long":Boolean,"node-version":[!1,String],npaturl:url,npat:Boolean,"onload-script":[!1,String],outfd:[Number,Stream],parseable:Boolean,pre:Boolean,prefix:path,proxy:url,"rebuild-bundle":Boolean,registry:url,searchopts:String,searchexclude:[null,String],shell:path,t:[Array,String],tag:String,tar:String,tmp:path,"unsafe-perm":Boolean,usage:Boolean,user:String,username:String,userconfig:path,version:Boolean,viewer:path,_exit:Boolean},[["-v",{version:!0},[]],["---v",{version:!0},[]],["ls -s --no-reg connect -d",{loglevel:"info",registry:null},["ls","connect"]],["ls ---s foo",{loglevel:"silent"},["ls","foo"]],["ls --registry blargle",{},["ls"]],["--no-registry",{registry:null},[]],["--no-color true",{color:!1},[]],["--no-color false",{color:!0},[]],["--no-color",{color:!1},[]],["--color false",{color:!1},[]],["--color --logfd 7",{logfd:7,color:!0},[]],["--color=true",{color:!0},[]],["--logfd=10",{logfd:10},[]],["--tmp=/tmp -tar=gtar",{tmp:"/tmp",tar:"gtar"},[]],["--tmp=tmp -tar=gtar",{tmp:path.resolve(process.cwd(),"tmp"),tar:"gtar"},[]],["--logfd x",{},[]],["a -true -- -no-false",{"true":!0},["a","-no-false"]],["a -no-false",{"false":!1},["a"]],["a -no-no-true",{"true":!0},["a"]],["a -no-no-no-false",{"false":!1},["a"]],["---NO-no-No-no-no-no-nO-no-no-No-no-no-no-no-no-no-no-no-no-no-no-no-NO-NO-no-no-no-no-no-no-no-body-can-do-the-boogaloo-like-I-do",{"body-can-do-the-boogaloo-like-I-do":!1},[]],["we are -no-strangers-to-love --you-know the-rules --and so-do-i ---im-thinking-of=a-full-commitment --no-you-would-get-this-from-any-other-guy --no-gonna-give-you-up -no-gonna-let-you-down=true --no-no-gonna-run-around false --desert-you=false --make-you-cry false --no-tell-a-lie --no-no-and-hurt-you false",{"strangers-to-love":!1,"you-know":"the-rules",and:"so-do-i","you-would-get-this-from-any-other-guy":!1,"gonna-give-you-up":!1,"gonna-let-you-down":!1,"gonna-run-around":!1,"desert-you":!1,"make-you-cry":!1,"tell-a-lie":!1,"and-hurt-you":!1},["we","are"]],["-t one -t two -t three",{t:["one","two","three"]},[]],["-t one -t null -t three four five null",{t:["one","null","three"]},["four","five","null"]],["-t foo",{t:["foo"]},[]],["--no-t",{t:["false"]},[]],["-no-no-t",{t:["true"]},[]],["-aoa one -aoa null -aoa 100",{aoa:["one",null,100]},[]],["-str 100",{str:"100"},[]],["--color always",{color:"always"},[]],["--no-nullstream",{nullstream:null},[]],["--nullstream false",{nullstream:null},[]],["--notadate 2011-01-25",{notadate:"2011-01-25"},[]],["--date 2011-01-25",{date:new Date("2011-01-25")},[]]].forEach(function(e){var r,o,n,a=e[0].split(/\s+/),t=e[1],l=e[2],i=nopt(types,shorthands,a,0),s=i.argv;delete i.argv,console.log(util.inspect(i,!1,2,!0),s.remain);for(r in t)o=JSON.stringify(t[r]),n=JSON.stringify(void 0===i[r]?null:i[r]),o&&"object"==typeof o?assert.deepEqual(o,n):assert.equal(o,n);assert.deepEqual(l,s.remain)}));