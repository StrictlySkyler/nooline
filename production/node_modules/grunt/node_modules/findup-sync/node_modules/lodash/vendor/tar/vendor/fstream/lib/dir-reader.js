function DirReader(e){var r=this;if(!(r instanceof DirReader))throw Error("DirReader must be called as constructor.");if("Directory"!==e.type||!e.Directory)throw Error("Non-directory type "+e.type);r.entries=null,r._index=-1,r._paused=!1,r._length=-1,e.sort&&(this.sort=e.sort),Reader.call(this,e)}module.exports=DirReader;var fs=require("../../graceful-fs/graceful-fs.js"),fstream=require("../fstream.js"),Reader=fstream.Reader,inherits=require("../../inherits/inherits.js"),mkdir=require("../../mkdirp"),path=require("path"),Reader=require("./reader.js"),assert=require("assert").ok;inherits(DirReader,Reader),DirReader.prototype._getEntries=function(){var e=this;e._gotEntries||(e._gotEntries=!0,fs.readdir(e._path,function(r,t){function n(){e._length=e.entries.length,"function"==typeof e.sort&&(e.entries=e.entries.sort(e.sort.bind(e))),e._read()}return r?e.error(r):(e.entries=t,e.emit("entries",t),e._paused?e.once("resume",n):n(),void 0)}))},DirReader.prototype._read=function(){var e,r=this;if(!r.entries)return r._getEntries();if(!(r._paused||r._currentEntry||r._aborted)){if(r._index++,r._index>=r.entries.length)return r._ended||(r._ended=!0,r.emit("end"),r.emit("close")),void 0;e=path.resolve(r._path,r.entries[r._index]),assert(e!==r._path),assert(r.entries[r._index]),r._currentEntry=e,fs[r.props.follow?"stat":"lstat"](e,function(t,n){function i(){d||(d=!0,r.emit("childEnd",a),r.emit("entryEnd",a),r._currentEntry=null,r._paused||r._read())}var s,o,a,d;return t?r.error(t):(s=r._proxy||r,n.path=e,n.basename=path.basename(e),n.dirname=path.dirname(e),o=r.getChildProps.call(s,n),o.path=e,o.basename=path.basename(e),o.dirname=path.dirname(e),a=Reader(o,n),r._currentEntry=a,a.on("pause",function(e){r._paused||a._disowned||r.pause(e)}),a.on("resume",function(e){r._paused&&!a._disowned&&r.resume(e)}),a.on("stat",function(e){r.emit("_entryStat",a,e),a._aborted||(a._paused?a.once("resume",function(){r.emit("entryStat",a,e)}):r.emit("entryStat",a,e))}),a.on("ready",function u(){return r._paused?(a.pause(r),r.once("resume",u)):("Socket"===a.type?r.emit("socket",a):r.emitEntry(a),void 0)}),d=!1,a.on("close",i),a.on("disown",i),a.on("error",function(e){a._swallowErrors?(r.warn(e),a.emit("end"),a.emit("close")):r.emit("error",e)}),["child","childEnd","warn"].forEach(function(e){a.on(e,r.emit.bind(r,e))}),void 0)})}},DirReader.prototype.disown=function(e){e.emit("beforeDisown"),e._disowned=!0,e.parent=e.root=null,e===this._currentEntry&&(this._currentEntry=null),e.emit("disown")},DirReader.prototype.getChildProps=function(){return{depth:this.depth+1,root:this.root||this,parent:this,follow:this.follow,filter:this.filter,sort:this.props.sort}},DirReader.prototype.pause=function(e){var r=this;r._paused||(e=e||r,r._paused=!0,r._currentEntry&&r._currentEntry.pause&&r._currentEntry.pause(e),r.emit("pause",e))},DirReader.prototype.resume=function(e){var r=this;r._paused&&(e=e||r,r._paused=!1,r.emit("resume",e),r._paused||(r._currentEntry?r._currentEntry.resume&&r._currentEntry.resume(e):r._read()))},DirReader.prototype.emitEntry=function(e){this.emit("entry",e),this.emit("child",e)};