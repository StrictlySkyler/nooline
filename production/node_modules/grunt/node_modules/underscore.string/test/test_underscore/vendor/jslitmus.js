// JSLitmus.js
//
// History:
//   2008-10-27: Initial release
//   2008-11-09: Account for iteration loop overhead
//   2008-11-13: Added OS detection
//   2009-02-25: Create tinyURL automatically, shift-click runs tests in reverse
//
// Copyright (c) 2008-2009, Robert Kieffer
// All Rights Reserved
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the
// Software), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND,
// EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.

!function(){var t,e,n,s,i,r,o,u="unknown platform",l=navigator.userAgent,a=["Windows","iPhone OS","(Intel |PPC )?Mac OS X","Linux"].join("|"),c=RegExp("(("+a+") [^ );]*)").test(l)?RegExp.$1:null;c||(c=RegExp("(("+a+")[^ );]*)").test(l)?RegExp.$1:null),t=/(Chrome|MSIE|Safari|Opera|Firefox)/.test(l)?RegExp.$1:null,e=RegExp("(Version|"+t+")[ /]([^ ;]*)"),n=t&&e.test(l)?RegExp.$2:null,u=c&&t&&n?t+" "+n+" on "+c:"unknown platform",s={escape:function(t){return t=t.replace(/,/g,"\\,"),t=escape(t),t=t.replace(/\+/g,"%2b"),t=t.replace(/ /g,"+")},$:function(t){return document.getElementById(t)},F:function(){},status:function(t){var e=s.$("jsl_status");e&&(e.innerHTML=t||"")},toLabel:function(t){return 1/0==t?"Infinity":t>1e9?(t=Math.round(t/1e8),t/10+"B"):t>1e6?(t=Math.round(t/1e5),t/10+"M"):t>1e3?(t=Math.round(t/100),t/10+"K"):t},extend:function(t,e){for(var n in e)t[n]=e[n];return t},join:function(t,e,n){var s,i;if(t.join)return t.join(e);s=[];for(i in t)s.push(i+e+t[i]);return s.join(n)},indexOf:function(t,e){if(t.indexOf)return t.indexOf(e);for(var n=0;n<this.length;n++)if(t[n]===e)return n;return-1}},i=function(t,e){if(!e)throw Error("Undefined test function");if(!/function[^\(]*\(([^,\)]*)/.test(""+e))throw Error('"'+t+'" test: Test is not a valid Function object');this.loopArg=RegExp.$1,this.name=t,this.f=e},s.extend(i,{CALIBRATIONS:[new i("calibrating loop",function(t){for(;t--;);}),new i("calibrating function",s.F)],calibrate:function(t){var e,n;for(e=0;e<i.CALIBRATIONS.length;e++){if(n=i.CALIBRATIONS[e],n.running)return!0;if(!n.count)return n.isCalibration=!0,n.onStop=t,n.run(2e4),!0}return!1}}),s.extend(i.prototype,{INIT_COUNT:10,MAX_COUNT:1e9,MIN_TIME:.5,onChange:s.F,onStop:s.F,reset:function(){delete this.count,delete this.time,delete this.running,delete this.error},run:function(t){t=t||this.INIT_COUNT,s.status(this.name+" x "+t),this.running=!0;var e=this;setTimeout(function(){e._run(t)},200)},_run:function(t){var e,n,r,o,u,l=this;if(l.isCalibration||!i.calibrate(function(){l.run(t)})){this.error=null;try{if(n=this.f,r=t,e=new Date,this.loopArg)n(t);else for(;r--;)n();if(this.time=Math.max(1,new Date-e)/1e3,this.count=t,this.period=this.time/t,this.running=this.time<=this.MIN_TIME,this.running&&(o=this.MIN_TIME/this.time,u=Math.pow(2,Math.max(1,Math.ceil(Math.log(o)/Math.log(2)))),t*=u,t>this.MAX_COUNT))throw Error("Max count exceeded.  If this test uses a looping function, make sure the iteration loop is working properly.")}catch(a){this.reset(),this.error=a}this.running?l.run(t):(s.status(""),l.onStop(l)),this.onChange(this)}},getHz:function(t){var e,n=this.period;return t&&!this.isCalibration&&(e=i.CALIBRATIONS[this.loopArg?0:1],n=n<1.2*e.period?0:n-e.period),Math.round(1/n)},toString:function(){return this.name+" - "+this.time/this.count+" secs"}}),r="<style>     #jslitmus {font-family:sans-serif; font-size: 12px;}     #jslitmus a {text-decoration: none;}     #jslitmus a:hover {text-decoration: underline;}     #jsl_status {       margin-top: 10px;       font-size: 10px;       color: #888;     }     A IMG  {border:none}     #test_results {       margin-top: 10px;       font-size: 12px;       font-family: sans-serif;       border-collapse: collapse;       border-spacing: 0px;     }     #test_results th, #test_results td {       border: solid 1px #ccc;       vertical-align: top;       padding: 3px;     }     #test_results th {       vertical-align: bottom;       background-color: #ccc;       padding: 1px;       font-size: 10px;     }     #test_results #test_platform {       color: #444;       text-align:center;     }     #test_results .test_row {       color: #006;       cursor: pointer;     }     #test_results .test_nonlooping {       border-left-style: dotted;       border-left-width: 2px;     }     #test_results .test_looping {       border-left-style: solid;       border-left-width: 2px;     }     #test_results .test_name {white-space: nowrap;}     #test_results .test_pending {     }     #test_results .test_running {       font-style: italic;     }     #test_results .test_done {}     #test_results .test_done {       text-align: right;       font-family: monospace;     }     #test_results .test_error {color: #600;}     #test_results .test_error .error_head {font-weight:bold;}     #test_results .test_error .error_body {font-size:85%;}     #test_results .test_row:hover td {       background-color: #ffc;       text-decoration: underline;     }     #chart {       margin: 10px 0px;       width: 250px;     }     #chart img {       border: solid 1px #ccc;       margin-bottom: 5px;     }     #chart #tiny_url {       height: 40px;       width: 250px;     }     #jslitmus_credit {       font-size: 10px;       color: #888;       margin-top: 8px;     }     </style>",o='<div id="jslitmus">       <button onclick="JSLitmus.runAll(event)">Run Tests</button>       <button id="stop_button" disabled="disabled" onclick="JSLitmus.stop()">Stop Tests</button>       <br >       <br >       <input type="checkbox" style="vertical-align: middle" id="test_normalize" checked="checked" onchange="JSLitmus.renderAll()""> Normalize results       <table id="test_results">         <colgroup>           <col />           <col width="100" />         </colgroup>         <tr><th id="test_platform" colspan="2">'+u+'</th></tr>         <tr><th>Test</th><th>Ops/sec</th></tr>         <tr id="test_row_template" class="test_row" style="display:none">           <td class="test_name"></td>           <td class="test_result">Ready</td>         </tr>       </table>       <div id="jsl_status"></div>       <div id="chart" style="display:none">       <a id="chart_link" target="_blank"><img id="chart_image"></a>       TinyURL (for chart):       <iframe id="tiny_url" frameBorder="0" scrolling="no" src=""></iframe>       </div>       <a id="jslitmus_credit" title="JSLitmus home page" href="http://code.google.com/p/jslitmus" target="_blank">Powered by JSLitmus</a>     </div>',window.JSLitmus={_tests:[],_queue:[],params:{},_init:function(){var t,e,n,s,i,o=(location+"").match(/([^?#]*)(#.*)?$/);if(o)for(t=o[1].split("&"),e=0;e<t.length;e++)n=t[e].split("="),n.length>1&&(s=n.shift(),i=n.length>1?n.join("="):n[0],this.params[s]=i);return document.write(r),window.addEventListener?window.addEventListener("load",this._setup,!1):document.addEventListener?document.addEventListener("load",this._setup,!1):window.attachEvent&&window.attachEvent("onload",this._setup),this},_setup:function(){var t,e=s.$("jslitmus_container");for(e||document.body.appendChild(e=document.createElement("div")),e.innerHTML=o,t=0;t<JSLitmus._tests.length;t++)JSLitmus.renderTest(JSLitmus._tests[t])},renderAll:function(){for(var t=0;t<JSLitmus._tests.length;t++)JSLitmus.renderTest(JSLitmus._tests[t]);JSLitmus.renderChart()},renderChart:function(){var t=JSLitmus.chartUrl();s.$("chart_link").href=t,s.$("chart_image").src=t,s.$("chart").style.display="",s.$("tiny_url").src="http://tinyurl.com/api-create.php?url="+escape(t)},renderTest:function(t){var e,n,i,r;if(!t._row){if(e=s.$("test_row_template"),!e)return;t._row=e.cloneNode(!0),t._row.style.display="",t._row.id="",t._row.onclick=function(){JSLitmus._queueTest(t)},t._row.title="Run "+t.name+" test",e.parentNode.appendChild(t._row),t._row.cells[0].innerHTML=t.name}n=t._row.cells[1],i=[t.loopArg?"test_looping":"test_nonlooping"],t.error?(i.push("test_error"),n.innerHTML='<div class="error_head">'+t.error+"</div>"+'<ul class="error_body"><li>'+s.join(t.error,": ","</li><li>")+"</li></ul>"):t.running?(i.push("test_running"),n.innerHTML="running"):s.indexOf(JSLitmus._queue,t)>=0?(i.push("test_pending"),n.innerHTML="pending"):t.count?(i.push("test_done"),r=t.getHz(s.$("test_normalize").checked),n.innerHTML=1/0!=r?r:"&infin;"):n.innerHTML="ready",n.className=i.join(" ")},test:function(t,e){var n=new i(t,e);JSLitmus._tests.push(n),n.onChange=JSLitmus.renderTest,n.onStop=function(t){JSLitmus.onTestFinish&&JSLitmus.onTestFinish(t),JSLitmus.currentTest=null,JSLitmus._nextTest()},this.renderTest(n)},runAll:function(t){var e,n,s;for(t=t||window.event,e=t&&t.shiftKey,n=JSLitmus._tests.length,s=0;n>s;s++)JSLitmus._queueTest(JSLitmus._tests[e?n-s-1:s])},stop:function(){for(;JSLitmus._queue.length;){var t=JSLitmus._queue.shift();JSLitmus.renderTest(t)}},_nextTest:function(){if(!JSLitmus.currentTest){var t=JSLitmus._queue.shift();t?(s.$("stop_button").disabled=!1,JSLitmus.currentTest=t,t.run(),JSLitmus.renderTest(t),JSLitmus.onTestStart&&JSLitmus.onTestStart(t)):(s.$("stop_button").disabled=!0,JSLitmus.renderChart())}},_queueTest:function(t){s.indexOf(JSLitmus._queue,t)>=0||(JSLitmus._queue.push(t),JSLitmus.renderTest(t),JSLitmus._nextTest())},chartUrl:function(){var t,e,n,i,r,o,l,a,c,h,d,p,m=(JSLitmus._tests.length,[]),_=[],f=0,g=-1e10,L=s.$("test_normalize").checked;for(t=0;t<JSLitmus._tests.length;t++)e=JSLitmus._tests[t],e.count&&(n=e.getHz(L),i=1/0!=n?n:0,_.push(i),m.push("t"+s.escape(e.name+"("+s.toLabel(n)+")")+",000000,0,"+m.length+",10"),g=Math.max(i,g));return m.length<=0?null:(r=document.getElementsByTagName("title"),r=r&&r.length?r[0].innerHTML:null,o=[],r&&o.push(r),o.push("Ops/sec ("+u+")"),l=[s.toLabel(f),s.toLabel(g)],a=250,c=15,h=5,d=m.length*(c+h)+30+20*o.length,p={chtt:escape(o.join("|")),chts:"000000,10",cht:"bhg",chd:"t:"+_.join(","),chds:f+","+g,chxt:"x",chxl:"0:|"+l.join("|"),chsp:"0,1",chm:m.join("|"),chbh:[c,0,h].join(","),chs:a+"x"+d},"http://chart.apis.google.com/chart?"+s.join(p,"=","&"))}},JSLitmus._init()}();