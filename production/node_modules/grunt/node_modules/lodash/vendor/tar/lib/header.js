function TarHeader(e){return this instanceof TarHeader?(e&&this.decode(e),void 0):new TarHeader(e)}function encode(e){var r,i,t,s,f,a,l,d,c,n,u,o,h,p,m,k,x;if(!(e||this instanceof TarHeader))throw Error("encode must be called on a TarHeader, or supplied an object");for(e=e||this,r=e.block=new Buffer(512),e.prefix&&(e.path=e.prefix+"/"+e.path,e.prefix=""),e.needExtended=!1,e.mode&&("string"==typeof e.mode&&(e.mode=parseInt(e.mode,8)),e.mode=511&e.mode),i=0;null!==fields[i];i++){switch(s=fields[i],f=fieldOffs[i],a=fieldEnds[i],s){case"cksum":break;case"prefix":break;case"type":l=e.type||"0",l.length>1&&(l=tar.types[e.type],l||(l="0")),writeText(r,f,a,l);break;case"path":if(d=Buffer.byteLength(e.path),c=fieldSize[fields.path],n=fieldSize[fields.prefix],d>c&&c+n>=d){for(u=d-1-c,o=n,h=!1,p=new Buffer(e.path),m=u;o>=m;m++)if(p[m]===slash||p[m]===bslash){h=m;break}if(h!==!1){prefix=p.slice(0,h).toString("utf8"),path=p.slice(h+1).toString("utf8"),t=writeText(r,f,a,path),f=fieldOffs[fields.prefix],a=fieldEnds[fields.prefix],t=writeText(r,f,a,prefix)||t;break}}k=fieldOffs[fields.prefix],x=fieldEnds[fields.prefix],writeText(r,k,x,"");default:t=numeric[s]?writeNumeric(r,f,a,e[s]):writeText(r,f,a,e[s]||"")}e.needExtended=e.needExtended||t}return f=fieldOffs[fields.cksum],a=fieldEnds[fields.cksum],writeNumeric(r,f,a,calcSum.call(this,r)),r}function writeNumeric(e,r,i,t){var s,f=i-r,a=MAXNUM[f]||0;if(t=t||0,(t instanceof Date||"[object Date]"===Object.prototype.toString.call(t))&&(t=t.getTime()/1e3),t>a||0>t)return write256(e,r,i,t),!0;if(s=Math.floor(t).toString(8),t<MAXNUM[f-1]&&(s+=" "),s.length<f&&(s=Array(f-s.length).join("0")+s),s.length!==f-1)throw Error("invalid length: "+JSON.stringify(s)+"\n"+"expected: "+f);e.write(s,r,f,"utf8"),e[i-1]=0}function write256(e,r,i,t){var s,f,a,l,d,c,n,u=e.slice(r,i),o=t>=0;u[0]=o?128:255,o||(t*=-1),s=[];do f=t%256,s.push(f),t=(t-f)/256;while(t);for(a=s.length,l=u.length-a,d=1;l>d;d++)u[d]=o?0:255;for(c=!0,d=a;d>0;d--)n=s[a-d],o?u[l+d]=n:c&&0===n?u[l+d]=0:c?(c=!1,u[l+d]=256-n):u[l+d]=255-n}function writeText(e,r,i,t){var s,f=Buffer.byteLength(t),a=Math.min(f,i-r),l=f!==t.length||f>a;for(a>0&&e.write(t,r,a,"utf8"),s=r+a;i>s;s++)e[s]=0;return l}function calcSum(e){var r,i,t,s;if(e=e||this.block,assert(Buffer.isBuffer(e)&&512===e.length),!e)throw Error("Need block to checksum");for(r=0,i=fieldOffs[fields.cksum],t=fieldEnds[fields.cksum],s=0;s<fieldOffs[fields.cksum];s++)r+=e[s];for(s=i;t>s;s++)r+=space;for(s=t;512>s;s++)r+=e[s];return r}function checkSum(e){var r,i=calcSum.call(this,e);return e=e||this.block,r=e.slice(fieldOffs[fields.cksum],fieldEnds[fields.cksum]),r=parseNumeric(r),r===i}function decode(e){var r,i,t,s,f,a;for(e=e||this.block,assert(Buffer.isBuffer(e)&&512===e.length),this.block=e,this.cksumValid=this.checkSum(),r=null,i=0;null!==fields[i];i++)switch(t=fields[i],s=e.slice(fieldOffs[i],fieldEnds[i]),t){case"ustar":if("ustar\x00"!=""+s)return this.ustar=!1,void 0;this.ustar=""+s;break;case"prefix":f=parseNumeric(s.slice(131,143)),a=parseNumeric(s.slice(143,155)),0!==s[130]&&s[130]!==space||"number"!=typeof f||"number"!=typeof a||s[143]!==space||s[155]!==space||(this.atime=f,this.ctime=a,s=s.slice(0,130)),r=s.toString("utf8").replace(/\0+$/,"");break;default:this[t]=numeric[t]?parseNumeric(s):s.toString("utf8").replace(/\0+$/,"")}r&&(this.path=r+"/"+this.path)}function parse256(e){var r,i,t,s,f,a,l;if(128===e[0])r=!0;else{if(255!==e[0])return null;r=!1}for(i=!1,t=[],s=e.length-1;s>0;s--)f=e[s],r?t.push(f):i&&0===f?t.push(0):i?(i=!1,t.push(256-f)):t.push(255-f);for(a=0,s=0,l=t.length;l>s;s++)a+=t[s]*Math.pow(256,s);return r?a:-1*a}function parseNumeric(e){if(128&e[0])return parse256(e);var r=e.toString("utf8").split("\x00")[0].trim(),i=parseInt(r,8);return isNaN(i)?null:i}var tar,fields,fieldOffs,fieldEnds,fieldSize,numeric,assert,space,slash,bslash,MAXNUM;module.exports=TarHeader,tar=require("../tar.js"),fields=tar.fields,fieldOffs=tar.fieldOffs,fieldEnds=tar.fieldEnds,fieldSize=tar.fieldSize,numeric=tar.numeric,assert=require("assert").ok,space=" ".charCodeAt(0),slash="/".charCodeAt(0),bslash="win32"===process.platform?"\\".charCodeAt(0):null,TarHeader.prototype={decode:decode,encode:encode,calcSum:calcSum,checkSum:checkSum},TarHeader.parseNumeric=parseNumeric,TarHeader.encode=encode,TarHeader.decode=decode,MAXNUM={12:8589934591,11:1073741823,8:2097151,7:262143};