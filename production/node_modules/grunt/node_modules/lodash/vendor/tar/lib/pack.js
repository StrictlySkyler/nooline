function Pack(e){var t=this;return t instanceof Pack?(t._noProprietary=e?e.noProprietary:!1,t._global=e,t.readable=!0,t.writable=!0,t._buffer=[],t._currentEntry=null,t._processing=!1,t._pipeRoot=null,t.on("pipe",function(e){e.root!==t._pipeRoot&&(t._pipeRoot=e,e.on("end",function(){t._pipeRoot=null}),t.add(e))}),void 0):new Pack(e)}var EntryWriter,Stream,path,inherits,GlobalHeaderWriter,collect,eof,i;for(module.exports=Pack,EntryWriter=require("./entry-writer.js"),Stream=require("stream").Stream,path=require("path"),inherits=require("../vendor/inherits/inherits.js"),GlobalHeaderWriter=require("./global-header-writer.js"),collect=require("../vendor/fstream/fstream.js").collect,eof=new Buffer(512),i=0;512>i;i++)eof[i]=0;inherits(Pack,Stream),Pack.prototype.addGlobal=function(e){if(!this._didGlobal){this._didGlobal=!0;var t=this;GlobalHeaderWriter(e).on("data",function(e){t.emit("data",e)}).end()}},Pack.prototype.add=function(e){return this._global&&!this._didGlobal&&this.addGlobal(this._global),this._ended?this.emit("error",Error("add after end")):(collect(e),this._buffer.push(e),this._process(),this._needDrain=this._buffer.length>0,!this._needDrain)},Pack.prototype.pause=function(){this._paused=!0,this._currentEntry&&this._currentEntry.pause(),this.emit("pause")},Pack.prototype.resume=function(){this._paused=!1,this._currentEntry&&this._currentEntry.resume(),this.emit("resume"),this._process()},Pack.prototype.end=function(){this._ended=!0,this._buffer.push(eof),this._process()},Pack.prototype._process=function(){function e(){a||(a=!0,s._currentEntry=null,s._processing=!1,s._process())}var t,r,i,o,n,a,s=this;if(!s._paused&&!s._processing){if(t=s._buffer.shift(),!t)return s._needDrain&&s.emit("drain"),void 0;if(t.ready===!1)return s._buffer.unshift(t),t.on("ready",function(){s._process()}),void 0;if(s._processing=!0,t===eof)return s.emit("data",eof),s.emit("data",eof),s.emit("end"),s.emit("close"),void 0;switch(r=path.dirname((t.root||t).path),i={},Object.keys(t.props).forEach(function(e){i[e]=t.props[e]}),s._noProprietary&&(i.noProprietary=!0),i.path=path.relative(r,t.path),"win32"===process.platform&&(i.path=i.path.replace(/\\/g,"/")),i.type){case"Socket":return;case"Directory":i.path+="/",i.size=0;break;case"Link":o=path.resolve(path.dirname(t.path),t.linkpath),i.linkpath=path.relative(r,o)||".",i.size=0;break;case"SymbolicLink":o=path.resolve(path.dirname(t.path),t.linkpath),i.linkpath=path.relative(path.dirname(t.path),o)||".",i.size=0}n=s._currentEntry=EntryWriter(i),n.parent=s,n.on("data",function(e){s.emit("data",e)}),n.on("header",function(){Buffer.prototype.toJSON=function(){return(""+this).split(/\0/).join(".")},0===n.props.size&&e()}),n.on("close",e),a=!1,n.on("error",function(e){s.emit("error",e)}),t===s._pipeRoot&&(n.add=null),t.pipe(n)}},Pack.prototype.destroy=function(){},Pack.prototype.write=function(){};