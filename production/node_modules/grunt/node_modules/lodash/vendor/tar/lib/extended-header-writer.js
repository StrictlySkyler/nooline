function ExtendedHeaderWriter(e){var r,t=this;return t instanceof ExtendedHeaderWriter?(t.fields=e,r={path:("PaxHeader"+path.join("/",e.path||"")).replace(/\\/g,"/").substr(0,100),mode:e.mode||438,uid:e.uid||0,gid:e.gid||0,size:0,mtime:e.mtime||Date.now()/1e3,type:"x",linkpath:"",ustar:"ustar\x00",ustarver:"00",uname:e.uname||"",gname:e.gname||"",devmaj:e.devmaj||0,devmin:e.devmin||0},EntryWriter.call(t,r),t.props=r,t._meta=!0,void 0):new ExtendedHeaderWriter(e)}function encodeFields(e,r,t,i){return Object.keys(e).forEach(function(n){var a=e[n];if(tar.numeric[n],r&&(n=r+"."+n),n!==e.type||a!==!0){switch(n){case"mode":case"cksum":case"ustar":case"ustarver":case"prefix":case"basename":case"dirname":case"needExtended":case"block":case"filter":return;case"rdev":if(0===a)return;break;case"nlink":case"dev":case"ino":n="SCHILY."+n}if(a&&"object"==typeof a&&!Buffer.isBuffer(a))encodeFields(a,n,t,i);else{if(null===a||void 0===a)return;t.push.apply(t,encodeField(n,a,i))}}}),t}function encodeField(e,r,t){var i,n,a,d,s;if(e.charAt(0)===e.charAt(0).toLowerCase()&&(i=e.split(".")[0],tar.knownExtended[i]||(e="NODETAR."+e)),t&&e.charAt(0)!==e.charAt(0).toLowerCase())return[];if("number"==typeof val&&(val=val.toString(10)),n=new Buffer(" "+e+"="+r+"\n"),a=Math.floor(Math.log(n.length)/Math.log(10))+1,n.length+a>=Math.pow(10,a)&&(a+=1),d=a+n.length,s=new Buffer(""+d),s.length+n.length!==d)throw Error("Bad length calculation\nlen="+d+"\n"+"lenBuf="+JSON.stringify(""+s)+"\n"+"lenBuf.length="+s.length+"\n"+"digits="+a+"\n"+"s="+JSON.stringify(""+n)+"\n"+"s.length="+n.length);return[s,n]}var inherits,EntryWriter,tar,path,TarHeader;module.exports=ExtendedHeaderWriter,inherits=require("../vendor/inherits/inherits.js"),EntryWriter=require("./entry-writer.js"),inherits(ExtendedHeaderWriter,EntryWriter),tar=require("../tar.js"),path=require("path"),inherits=require("../vendor/inherits/inherits.js"),TarHeader=require("./header.js"),ExtendedHeaderWriter.prototype.end=function(){var e=this;if(!e._ended){if(e._ended=!0,e._encodeFields(),0===e.props.size)return e._ready=!0,e._stream.end(),void 0;e._stream.write(TarHeader.encode(e.props)),e.body.forEach(function(r){e._stream.write(r)}),e._ready=!0,this._stream.end()}},ExtendedHeaderWriter.prototype._encodeFields=function(){this.body=[],this.fields.prefix&&(this.fields.path=this.fields.prefix+"/"+this.fields.path,this.fields.prefix=""),encodeFields(this.fields,"",this.body,this.fields.noProprietary);var e=this;this.body.forEach(function(r){e.props.size+=r.length})};