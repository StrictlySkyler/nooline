function Parse(){var e=this;return e instanceof Parse?(Stream.apply(e),e.writable=!0,e.readable=!0,e._stream=new BlockStream(512),e.position=0,e._stream.on("error",function(t){e.emit("error",t)}),e._stream.on("data",function(t){e._process(t)}),e._stream.on("end",function(){e._streamEnd()}),e._stream.on("drain",function(){e.emit("drain")}),void 0):new Parse}module.exports=Parse.create=Parse;var stream=require("stream"),Stream=stream.Stream,BlockStream=require("../vendor/block-stream/block-stream.js"),tar=require("../tar.js"),TarHeader=require("./header.js"),Entry=require("./entry.js"),BufferEntry=require("./buffer-entry.js"),ExtendedHeader=require("./extended-header.js"),assert=require("assert").ok,inherits=require("../vendor/inherits/inherits.js"),fstream=require("../vendor/fstream/fstream.js");inherits(Parse,fstream.Reader),Parse.prototype._streamEnd=function(){var e=this;e._ended||e.error("unexpected eof"),e.emit("end")},Parse.prototype.write=function(e){if(!this._ended)return this._stream.write(e);for(var t=0,r=e.length;t>r;t++)if(0!==e[t])return this.error("write() after end()")},Parse.prototype.end=function(e){return this._ended=!0,this._stream.end(e)},Parse.prototype._read=function(){},Parse.prototype._process=function(e){var t,r,n;if(assert(e&&512===e.length,"block size should be 512"),this._entry)t=this._entry,t.write(e),0===t._remaining&&(t.end(),this._entry=null);else{for(r=!0,n=0;512>n&&r;n++)r=0===e[n];r?(this._ended=this._eofStarted,this._eofStarted=!0):(this._ended=this._eofStarted=!1,this._startEntry(e))}this.position+=512},Parse.prototype._startEntry=function(e){var t,r,n,a,s,i,d,o,l=new TarHeader(e),c=this,u=!1;switch(null!==l.size&&l.cksumValid||(s=Error("invalid tar file"),s.header=l,s.tar_file_offset=this.position,s.tar_block=this.position/512,this.emit("error",s)),tar.types[l.type]){case"File":case"OldFile":case"Link":case"SymbolicLink":case"CharacterDevice":case"BlockDevice":case"Directory":case"FIFO":case"ContiguousFile":case"GNUDumpDir":n=Entry,r="entry";break;case"GlobalExtendedHeader":n=ExtendedHeader,a=function(){c._global=c._global||{},Object.keys(t.fields).forEach(function(e){c._global[e]=t.fields[e]})},r="globalExtendedHeader",u=!0;break;case"ExtendedHeader":case"OldExtendedHeader":n=ExtendedHeader,a=function(){c._extended=t.fields},r="extendedHeader",u=!0;break;case"NextFileHasLongLinkpath":n=BufferEntry,a=function(){c._extended=c._extended||{},c._extended.linkpath=t.body},r="longLinkpath",u=!0;break;case"NextFileHasLongPath":case"OldGnuLongPath":n=BufferEntry,a=function(){c._extended=c._extended||{},c._extended.path=t.body},r="longPath",u=!0;break;default:n=Entry,r="ignoredEntry"}u?i=d=null:(i=this._global,d=this._extended,this._extended=null),t=new n(l,d,i),t.meta=u,u||t.on("data",function(e){o.emit("data",e)}),a&&t.on("end",a),this._entry=t,o=this,t.on("pause",function(){o.pause()}),t.on("resume",function(){o.resume()}),this.listeners("*").length&&this.emit("*",r,t),this.emit(r,t),0===t.props.size&&(t.end(),this._entry=null)};