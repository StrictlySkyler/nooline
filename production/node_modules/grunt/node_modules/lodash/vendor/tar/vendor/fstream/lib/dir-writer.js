function DirWriter(r){var e=this;e instanceof DirWriter||e.error("DirWriter must be called as constructor.",null,!0),"Directory"===r.type&&r.Directory||e.error("Non-directory type "+r.type+" "+JSON.stringify(r),null,!0),Writer.call(this,r)}module.exports=DirWriter;var fs=require("../../graceful-fs/graceful-fs.js"),fstream=require("../fstream.js"),Writer=require("./writer.js"),inherits=require("../../inherits/inherits.js"),mkdir=require("../../mkdirp"),path=require("path"),collect=require("./collect.js");inherits(DirWriter,Writer),DirWriter.prototype._create=function(){var r=this;mkdir(r._path,Writer.dirmode,function(e){return e?r.error(e):(r.ready=!0,r.emit("ready"),r._process(),void 0)})},DirWriter.prototype.write=function(){return!0},DirWriter.prototype.end=function(){this._ended=!0,this._process()},DirWriter.prototype.add=function(r){var e=this;return collect(r),!e.ready||e._currentEntry?(e._buffer.push(r),!1):e._ended?e.error("add after end"):(e._buffer.push(r),e._process(),0===this._buffer.length)},DirWriter.prototype._process=function(){function r(){s||(s=!0,p._currentChild=null,p._processing=!1,p._process())}var e,t,i,o,n,s,p=this;if(!p._processing){if(e=p._buffer.shift(),!e)return p.emit("drain"),p._ended&&p._finish(),void 0;p._processing=!0,p.emit("entry",e),t=e;do if(i=t._path||t.path,i===p.root._path||i===p._path||i&&0===i.indexOf(p._path))return p._processing=!1,e._collected&&e.pipe(),p._process();while(t=t.parent);o={parent:p,root:p.root||p,type:e.type,depth:p.depth+1},t=e._path||e.path||e.props.path,e.parent&&(t=t.substr(e.parent._path.length+1)),o.path=path.join(p.path,path.join("/",t)),o.filter=p.filter,Object.keys(e.props).forEach(function(r){o.hasOwnProperty(r)||(o[r]=e.props[r])}),n=p._currentChild=new Writer(o),n.on("ready",function(){e.pipe(n),e.resume()}),n.on("error",function(r){n._swallowErrors?(p.warn(r),n.emit("end"),n.emit("close")):p.emit("error",r)}),n.on("close",r),s=!1}};