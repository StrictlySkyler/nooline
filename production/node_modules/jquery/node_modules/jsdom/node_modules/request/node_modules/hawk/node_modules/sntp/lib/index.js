var Dgram=null,Dns=null,Hoek=null,internals={};exports.time=function(e,t){var r,s,n,i,o,a,l,c;for(2!==arguments.length&&(t=arguments[0],e={}),r=Hoek.clone(e),r.host=r.host||"pool.ntp.org",r.port=r.port||123,r.resolveReference=r.resolveReference||!1,s=0,n=0,i=!1,o=function(e,r){return s&&(clearTimeout(s),s=0),i?void 0:(i=!0,a.removeAllListeners(),a.close(),t(e,r))},a=Dgram.createSocket("udp4"),a.once("error",function(e){return o(e)}),a.on("message",function(e){var t,s,i,a,l=Date.now(),c=new internals.NtpMessage(e);return c.isValid?c.originateTimestamp!==n?o(Error("Wrong originate timestamp"),c):(t=c.originateTimestamp,s=c.receiveTimestamp,i=c.transmitTimestamp,a=l,c.d=a-t-(i-s),c.t=(s-t+(i-a))/2,c.receivedLocally=l,r.resolveReference&&"secondary"===c.stratum?(Dns.reverse(c.referenceId,function(e,t){return e||(c.referenceHost=t[0]),o(null,c)}),void 0):o(null,c)):o(Error("Invalid server response"),c)}),r.timeout&&(s=setTimeout(function(){return s=0,o(Error("Timeout"))},r.timeout)),l=new Buffer(48),c=0;48>c;c++)l[c]=0;l[0]=35,n=Date.now(),internals.fromMsecs(n,l,40),a.send(l,0,l.length,r.port,r.host,function(e,t){return e||48!==t?o(e||Error("Could not send entire message")):void 0})},internals.NtpMessage=function(e){var t,r,s,n,i;if(this.isValid=!1,48===e.length){switch(t=e[0]>>6){case 0:this.leapIndicator="no-warning";break;case 1:this.leapIndicator="last-minute-61";break;case 2:this.leapIndicator="last-minute-59";break;case 3:this.leapIndicator="alarm"}switch(r=(56&e[0])>>3,this.version=r,s=7&e[0]){case 1:this.mode="symmetric-active";break;case 2:this.mode="symmetric-passive";break;case 3:this.mode="client";break;case 4:this.mode="server";break;case 5:this.mode="broadcast";break;case 0:case 6:case 7:this.mode="reserved"}switch(n=e[1],this.stratum=0===n?"death":1===n?"primary":15>=n?"secondary":"reserved",this.pollInterval=1e3*Math.round(Math.pow(2,e[2])),this.precision=1e3*Math.pow(2,e[3]),i=256*(256*(256*e[4]+e[5])+e[6])+e[7],this.rootDelay=1e3*(i/65536),this.rootDispersion=1e3*((e[8]<<8)+e[9]+((e[10]<<8)+e[11])/Math.pow(2,16)),this.referenceId="",this.stratum){case"death":case"primary":this.referenceId=String.fromCharCode(e[12])+String.fromCharCode(e[13])+String.fromCharCode(e[14])+String.fromCharCode(e[15]);break;case"secondary":this.referenceId=""+e[12]+"."+e[13]+"."+e[14]+"."+e[15]}return this.referenceTimestamp=internals.toMsecs(e,16),this.originateTimestamp=internals.toMsecs(e,24),this.receiveTimestamp=internals.toMsecs(e,32),this.transmitTimestamp=internals.toMsecs(e,40),4===this.version&&"reserved"!==this.stratum&&"server"===this.mode&&this.originateTimestamp&&this.receiveTimestamp&&this.transmitTimestamp&&(this.isValid=!0),this}},internals.toMsecs=function(e,t){var r,s=0,n=0;for(r=0;4>r;++r)s=256*s+e[t+r];for(r=4;8>r;++r)n=256*n+e[t+r];return 1e3*(s-2208988800+n/Math.pow(2,32))},internals.fromMsecs=function(e,t,r){var s=Math.floor(e/1e3)+2208988800,n=Math.round(e%1e3/1e3*Math.pow(2,32));t[r+0]=(4278190080&s)>>24,t[r+1]=(16711680&s)>>16,t[r+2]=(65280&s)>>8,t[r+3]=255&s,t[r+4]=(4278190080&n)>>24,t[r+5]=(16711680&n)>>16,t[r+6]=(65280&n)>>8,t[r+7]=255&n},internals.last={offset:0,expires:0,host:"",port:0},exports.offset=function(e,t){var r,s;return 2!==arguments.length&&(t=arguments[0],e={}),r=Date.now(),s=e.clockSyncRefresh||864e5,internals.last.offset&&internals.last.host===e.host&&internals.last.port===e.port&&r<internals.last.expires?(process.nextTick(function(){t(null,internals.last.offset)}),void 0):(exports.time(e,function(n,i){return n?t(n,0):(internals.last={offset:Math.round(i.t),expires:r+s,host:e.host,port:e.port},t(null,internals.last.offset))}),void 0)},internals.now={intervalId:0},exports.start=function(e,t){return 2!==arguments.length&&(t=arguments[0],e={}),internals.now.intervalId?(process.nextTick(function(){t()}),void 0):(exports.offset(e,function(){return internals.now.intervalId=setInterval(function(){exports.offset(e,function(){})},e.clockSyncRefresh||864e5),t()}),void 0)},exports.stop=function(){internals.now.intervalId&&(clearInterval(internals.now.intervalId),internals.now.intervalId=0)},exports.isLive=function(){return!!internals.now.intervalId},exports.now=function(){var e=Date.now();return!exports.isLive()||e>=internals.last.expires?e:e+internals.last.offset};