var Boom=null,Hoek=null,Cryptiles=null,Crypto=null,Utils=null,internals={};exports.authenticate=function(e,t,a,o){var n,i,r,s;return o=Utils.nextTick(o),a.nonceFunc=a.nonceFunc||function(e,t,a){return a()},a.timestampSkewSec=a.timestampSkewSec||60,n=Utils.now()+(a.localtimeOffsetMsec||0),i=Utils.parseRequest(e,a),i instanceof Error?o(Boom.badRequest(i.message)):(r=Utils.parseAuthorizationHeader(i.authorization),r instanceof Error?o(r):(s={method:i.method,host:i.host,port:i.port,resource:i.url,ts:r.ts,nonce:r.nonce,hash:r.hash,ext:r.ext,app:r.app,dlg:r.dlg,mac:r.mac,id:r.id},r.id&&r.ts&&r.nonce&&r.mac?(t(r.id,function(e,t){var l,u;if(e)return o(e,t||null,s);if(!t)return o(Boom.unauthorized("Unknown credentials","Hawk"),null,s);if(!t.key||!t.algorithm)return o(Boom.internal("Invalid credentials"),t,s);if(-1===Crypto.algorithms.indexOf(t.algorithm))return o(Boom.internal("Unknown algorithm"),t,s);if(l=Crypto.calculateMac("header",t,s),!Cryptiles.fixedTimeComparison(l,r.mac))return o(Boom.unauthorized("Bad mac","Hawk"),t,s);if(null!==a.payload&&void 0!==a.payload){if(!r.hash)return o(Boom.unauthorized("Missing required payload hash","Hawk"),t,s);if(u=Crypto.calculatePayloadHash(a.payload,t.algorithm,i.contentType),!Cryptiles.fixedTimeComparison(u,r.hash))return o(Boom.unauthorized("Bad payload hash","Hawk"),t,s)}a.nonceFunc(r.nonce,r.ts,function(e){var i,l;return e?o(Boom.unauthorized("Invalid nonce","Hawk"),t,s):Math.abs(1e3*r.ts-n)>1e3*a.timestampSkewSec?(i=Math.floor((Utils.now()+(a.localtimeOffsetMsec||0))/1e3),l=Crypto.calculateTsMac(i,t),o(Boom.unauthorized("Stale timestamp","Hawk",{ts:i,tsm:l}),t,s)):o(null,t,s)})}),void 0):o(Boom.badRequest("Missing attributes"),null,s)))},exports.authenticatePayload=function(e,t,a,o){var n=Crypto.calculatePayloadHash(e,t.algorithm,o);return Cryptiles.fixedTimeComparison(n,a.hash)},exports.header=function(e,t,a){var o,n;return a=a||{},t&&"object"==typeof t&&"object"==typeof a?(t=Hoek.clone(t),delete t.mac,t.hash=a.hash,t.ext=a.ext,e&&e.key&&e.algorithm?-1===Crypto.algorithms.indexOf(e.algorithm)?"":(!t.hash&&a.hasOwnProperty("payload")&&(t.hash=Crypto.calculatePayloadHash(a.payload,e.algorithm,a.contentType)),o=Crypto.calculateMac("response",e,t),n='Hawk mac="'+o+'"'+(t.hash?', hash="'+t.hash+'"':""),null!==t.ext&&void 0!==t.ext&&""!==t.ext&&(n+=', ext="'+Utils.escapeHeaderAttribute(t.ext)+'"'),n):""):""},exports.authenticateBewit=function(e,t,a,o){var n,i,r,s,l,u,c;return o=Utils.nextTick(o),n=Utils.now()+(a.localtimeOffsetMsec||0),i=Utils.parseRequest(e,a),i instanceof Error?o(Boom.badRequest(i.message)):(r=i.url.match(/^(\/.*)([\?&])bewit\=([^&$]*)(?:&(.+))?$/))?r[3]?"GET"!==i.method&&"HEAD"!==i.method?o(Boom.unauthorized("Invalid method","Hawk")):i.authorization?o(Boom.badRequest("Multiple authentications","Hawk")):(s=Utils.base64urlDecode(r[3]),s instanceof Error?o(Boom.badRequest("Invalid bewit encoding")):(l=s.split("\\"),l&&4===l.length?(u={id:l[0],exp:parseInt(l[1],10),mac:l[2],ext:l[3]||""},u.id&&u.exp&&u.mac?(c=r[1],r[4]&&(c+=r[2]+r[4]),1e3*u.exp<=n?o(Boom.unauthorized("Access expired","Hawk"),null,u):(t(u.id,function(e,t){if(e)return o(e,t||null,u.ext);if(!t)return o(Boom.unauthorized("Unknown credentials","Hawk"),null,u);if(!t.key||!t.algorithm)return o(Boom.internal("Invalid credentials"),t,u);if(-1===Crypto.algorithms.indexOf(t.algorithm))return o(Boom.internal("Unknown algorithm"),t,u);var a=Crypto.calculateMac("bewit",t,{ts:u.exp,nonce:"",method:"GET",resource:c,host:i.host,port:i.port,ext:u.ext});return Cryptiles.fixedTimeComparison(a,u.mac)?o(null,t,u):o(Boom.unauthorized("Bad mac","Hawk"),t,u)}),void 0)):o(Boom.badRequest("Missing bewit attributes"))):o(Boom.badRequest("Invalid bewit structure")))):o(Boom.unauthorized("Empty bewit","Hawk")):o(Boom.unauthorized(null,"Hawk"))},exports.authenticateMessage=function(e,t,a,o,n,i,r){r=Utils.nextTick(r),i.nonceFunc=i.nonceFunc||function(e,t,a){return a()},i.timestampSkewSec=i.timestampSkewSec||60;var s=Utils.now()+(i.localtimeOffsetMsec||0);return o.id&&o.ts&&o.nonce&&o.hash&&o.mac?(n(o.id,function(n,l){var u,c,m;return n?r(n,l||null):l?l.key&&l.algorithm?-1===Crypto.algorithms.indexOf(l.algorithm)?r(Boom.internal("Unknown algorithm"),l):(u={ts:o.ts,nonce:o.nonce,host:e,port:t,hash:o.hash},c=Crypto.calculateMac("message",l,u),Cryptiles.fixedTimeComparison(c,o.mac)?(m=Crypto.calculatePayloadHash(a,l.algorithm),Cryptiles.fixedTimeComparison(m,o.hash)?(i.nonceFunc(o.nonce,o.ts,function(e){return e?r(Boom.unauthorized("Invalid nonce","Hawk"),l):Math.abs(1e3*o.ts-s)>1e3*i.timestampSkewSec?r(Boom.unauthorized("Stale timestamp"),l):r(null,l)}),void 0):r(Boom.unauthorized("Bad message hash","Hawk"),l)):r(Boom.unauthorized("Bad mac","Hawk"),l)):r(Boom.internal("Invalid credentials"),l):r(Boom.unauthorized("Unknown credentials","Hawk"))}),void 0):r(Boom.badRequest("Invalid authorization"))};