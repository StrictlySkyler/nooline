// Copyright 2011 Mark Cavage <mcavage@gmail.com> All rights reserved.

function Reader(t){if(!t||!Buffer.isBuffer(t))throw new TypeError("data must be a node Buffer");this._buf=t,this._size=t.length,this._len=0,this._offset=0;var e=this;this.__defineGetter__("length",function(){return e._len}),this.__defineGetter__("offset",function(){return e._offset}),this.__defineGetter__("remain",function(){return e._size-e._offset}),this.__defineGetter__("buffer",function(){return e._buf.slice(e._offset)})}var assert=null,ASN1=null,errors=null,newInvalidAsn1Error=errors.newInvalidAsn1Error;Reader.prototype.readByte=function(t){if(this._size-this._offset<1)return null;var e=255&this._buf[this._offset];return t||(this._offset+=1),e},Reader.prototype.peek=function(){return this.readByte(!0)},Reader.prototype.readLength=function(t){var e,r;if(void 0===t&&(t=this._offset),t>=this._size)return null;if(e=255&this._buf[t++],null===e)return null;if(128==(128&e)){if(e&=127,0==e)throw newInvalidAsn1Error("Indefinite length not supported");if(e>4)throw newInvalidAsn1Error("encoding too long");if(this._size-t<e)return null;for(this._len=0,r=0;e>r;r++)this._len=(this._len<<8)+(255&this._buf[t++])}else this._len=e;return t},Reader.prototype.readSequence=function(t){var e,r=this.peek();if(null===r)return null;if(void 0!==t&&t!==r)throw newInvalidAsn1Error("Expected 0x"+t.toString(16)+": got 0x"+r.toString(16));return e=this.readLength(this._offset+1),null===e?null:(this._offset=e,r)},Reader.prototype.readInt=function(){return this._readTag(ASN1.Integer)},Reader.prototype.readBoolean=function(){return 0===this._readTag(ASN1.Boolean)?!1:!0},Reader.prototype.readEnumeration=function(){return this._readTag(ASN1.Enumeration)},Reader.prototype.readString=function(t,e){var r,n,i;if(t||(t=ASN1.OctetString),r=this.peek(),null===r)return null;if(r!==t)throw newInvalidAsn1Error("Expected 0x"+t.toString(16)+": got 0x"+r.toString(16));return n=this.readLength(this._offset+1),null===n?null:this.length>this._size-n?null:(this._offset=n,0===this.length?"":(i=this._buf.slice(this._offset,this._offset+this.length),this._offset+=this.length,e?i:i.toString("utf8")))},Reader.prototype.readOID=function(t){var e,r,n,i,s,o;if(t||(t=ASN1.OID),e=this.peek(),null===e)return null;if(e!==t)throw newInvalidAsn1Error("Expected 0x"+t.toString(16)+": got 0x"+e.toString(16));if(r=this.readLength(this._offset+1),null===r)return null;if(this.length>this._size-r)return null;for(this._offset=r,n=[],i=0,s=0;s<this.length;s++)o=255&this._buf[this._offset++],i<<=7,i+=127&o,0==(128&o)&&(n.push(i),i=0);return i=n.shift(),n.unshift(i%40),n.unshift(i/40>>0),n.join(".")},Reader.prototype._readTag=function(t){var e,r,n,i,s;if(assert.ok(void 0!==t),e=this.peek(),null===e)return null;if(e!==t)throw newInvalidAsn1Error("Expected 0x"+t.toString(16)+": got 0x"+e.toString(16));if(r=this.readLength(this._offset+1),null===r)return null;if(this.length>4)throw newInvalidAsn1Error("Integer too long: "+this.length);if(this.length>this._size-r)return null;for(this._offset=r,n=this._buf[this._offset++],i=0,i=127&n,s=1;s<this.length;s++)i<<=8,i|=255&this._buf[this._offset++];return 128==(128&n)&&(i=-i),i},module.exports=Reader;