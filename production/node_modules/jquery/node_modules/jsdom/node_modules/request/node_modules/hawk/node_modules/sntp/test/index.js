var Dgram=null,Lab=null,Sntp=null,internals={},expect=Lab.expect,before=Lab.before,after=Lab.after,describe=Lab.experiment,it=Lab.test;describe("SNTP",function(){describe("#time",function(){it("returns consistent result over multiple tries",function(t){Sntp.time(function(e,o){expect(e).to.not.exist,expect(o).to.exist;var n=o.t;Sntp.time(function(e,o){expect(e).to.not.exist,expect(o).to.exist;var i=o.t;expect(Math.abs(n-i)).is.below(200),t()})})}),it("resolves reference IP",function(t){Sntp.time({host:"ntp.exnet.com",resolveReference:!0},function(e,o){expect(e).to.not.exist,expect(o).to.exist,expect(o.referenceHost).to.exist,t()})}),it("times out on no response",function(t){Sntp.time({port:124,timeout:100},function(e,o){expect(e).to.exist,expect(o).to.not.exist,expect(e.message).to.equal("Timeout"),t()})}),it("errors on error event",function(t){var e=Dgram.createSocket;Dgram.createSocket=function(t){Dgram.createSocket=e;var o=Dgram.createSocket(t);return process.nextTick(function(){o.emit("error",Error("Fake"))}),o},Sntp.time(function(e,o){expect(e).to.exist,expect(o).to.not.exist,expect(e.message).to.equal("Fake"),t()})}),it("times out on invalid host",function(t){Sntp.time({host:"error",timeout:1e4},function(e,o){expect(e).to.exist,expect(o).to.not.exist,expect(e.message).to.equal("getaddrinfo ENOTFOUND"),t()})}),it("fails on bad response buffer size",function(t){var e=Dgram.createSocket("udp4");e.on("message",function(t,o){var t=new Buffer(10);e.send(t,0,t.length,o.port,o.address,function(){e.close()})}),e.bind(49123),Sntp.time({host:"localhost",port:49123},function(e){expect(e).to.exist,expect(e.message).to.equal("Invalid server response"),t()})});var t=function(t){var e=Dgram.createSocket("udp4");e.on("message",function(o,n){var i,s;for(o=new Buffer([36,1,0,227,0,0,0,0,0,0,0,0,65,67,84,83,212,168,45,199,28,93,73,27,212,168,45,230,103,239,157,178,212,168,45,230,113,237,181,251,212,168,45,230,113,238,108,197]),i=0,s=t.length;s>i;++i)o[t[i][0]]=t[i][1];e.send(o,0,o.length,n.port,n.address,function(){e.close()})}),e.bind(49123)};it("fails on bad version",function(e){t([[0,28]]),Sntp.time({host:"localhost",port:49123},function(t,o){expect(t).to.exist,expect(o.version).to.equal(3),expect(t.message).to.equal("Invalid server response"),e()})}),it("fails on bad originate timestamp and alarm li",function(e){t([[0,228]]),Sntp.time({host:"localhost",port:49123},function(t,o){expect(t).to.exist,expect(t.message).to.equal("Wrong originate timestamp"),expect(o.leapIndicator).to.equal("alarm"),e()})}),it("returns time with death stratum and last61 li",function(e){t([[0,100],[1,0]]),Sntp.time({host:"localhost",port:49123},function(t,o){expect(o.stratum).to.equal("death"),expect(o.leapIndicator).to.equal("last-minute-61"),e()})}),it("returns time with reserved stratum and last59 li",function(e){t([[0,164],[1,31]]),Sntp.time({host:"localhost",port:49123},function(t,o){expect(o.stratum).to.equal("reserved"),expect(o.leapIndicator).to.equal("last-minute-59"),e()})}),it("fails on bad mode (symmetric-active)",function(e){t([[0,33]]),Sntp.time({host:"localhost",port:49123},function(t,o){expect(t).to.exist,expect(o.mode).to.equal("symmetric-active"),e()})}),it("fails on bad mode (symmetric-passive)",function(e){t([[0,34]]),Sntp.time({host:"localhost",port:49123},function(t,o){expect(t).to.exist,expect(o.mode).to.equal("symmetric-passive"),e()})}),it("fails on bad mode (client)",function(e){t([[0,35]]),Sntp.time({host:"localhost",port:49123},function(t,o){expect(t).to.exist,expect(o.mode).to.equal("client"),e()})}),it("fails on bad mode (broadcast)",function(e){t([[0,37]]),Sntp.time({host:"localhost",port:49123},function(t,o){expect(t).to.exist,expect(o.mode).to.equal("broadcast"),e()})}),it("fails on bad mode (reserved)",function(e){t([[0,38]]),Sntp.time({host:"localhost",port:49123},function(t,o){expect(t).to.exist,expect(o.mode).to.equal("reserved"),e()})})}),describe("#offset",function(){it("gets the current offset",function(t){Sntp.offset(function(e,o){expect(e).to.not.exist,expect(o).to.not.equal(0),t()})}),it("gets the current offset from cache",function(t){Sntp.offset(function(e,o){expect(e).to.not.exist,expect(o).to.not.equal(0);var n=o;Sntp.offset({},function(e,o){expect(e).to.not.exist,expect(o).to.equal(n),t()})})}),it("fails getting the current offset on invalid server",function(t){Sntp.offset({host:"error"},function(e,o){expect(e).to.exist,expect(o).to.equal(0),t()})})}),describe("#now",function(){it("starts auto-sync, gets now, then stops",function(t){Sntp.stop();var e=Sntp.now();expect(e).to.equal(Date.now()),Sntp.start(function(){var e=Sntp.now();expect(e).to.not.equal(Date.now()),Sntp.stop(),t()})}),it("starts twice",function(t){Sntp.start(function(){Sntp.start(function(){var e=Sntp.now();expect(e).to.not.equal(Date.now()),Sntp.stop(),t()})})}),it("starts auto-sync, gets now, waits, gets again after timeout",function(t){Sntp.stop();var e=Sntp.now();expect(e).to.equal(Date.now()),Sntp.start({clockSyncRefresh:100},function(){var e=Sntp.now();expect(e).to.not.equal(Date.now()),expect(e).to.equal(Sntp.now()),setTimeout(function(){expect(Sntp.now()).to.not.equal(e),Sntp.stop(),t()},110)})})})});