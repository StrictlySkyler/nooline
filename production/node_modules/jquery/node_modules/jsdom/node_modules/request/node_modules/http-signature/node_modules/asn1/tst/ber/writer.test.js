// Copyright 2011 Mark Cavage <mcavage@gmail.com> All rights reserved.

var BerWriter,BerReader,test=null.test,sys=null;test("load library",function(e){BerWriter=null.BerWriter,e.ok(BerWriter),e.ok(new BerWriter),e.end()}),test("write byte",function(e){var n,t=new BerWriter;t.writeByte(194),n=t.buffer,e.ok(n),e.equal(n.length,1,"Wrong length"),e.equal(n[0],194,"value wrong"),e.end()}),test("write 1 byte int",function(e){var n,t=new BerWriter;t.writeInt(127),n=t.buffer,e.ok(n),e.equal(n.length,3,"Wrong length for an int: "+n.length),e.equal(n[0],2,"ASN.1 tag wrong (2) -> "+n[0]),e.equal(n[1],1,"length wrong(1) -> "+n[1]),e.equal(n[2],127,"value wrong(3) -> "+n[2]),e.end()}),test("write 2 byte int",function(e){var n,t=new BerWriter;t.writeInt(32766),n=t.buffer,e.ok(n),e.equal(n.length,4,"Wrong length for an int"),e.equal(n[0],2,"ASN.1 tag wrong"),e.equal(n[1],2,"length wrong"),e.equal(n[2],127,"value wrong (byte 1)"),e.equal(n[3],254,"value wrong (byte 2)"),e.end()}),test("write 3 byte int",function(e){var n,t=new BerWriter;t.writeInt(8388606),n=t.buffer,e.ok(n),e.equal(n.length,5,"Wrong length for an int"),e.equal(n[0],2,"ASN.1 tag wrong"),e.equal(n[1],3,"length wrong"),e.equal(n[2],127,"value wrong (byte 1)"),e.equal(n[3],255,"value wrong (byte 2)"),e.equal(n[4],254,"value wrong (byte 3)"),e.end()}),test("write 4 byte int",function(e){var n,t=new BerWriter;t.writeInt(2147483646),n=t.buffer,e.ok(n),e.equal(n.length,6,"Wrong length for an int"),e.equal(n[0],2,"ASN.1 tag wrong"),e.equal(n[1],4,"length wrong"),e.equal(n[2],127,"value wrong (byte 1)"),e.equal(n[3],255,"value wrong (byte 2)"),e.equal(n[4],255,"value wrong (byte 3)"),e.equal(n[5],254,"value wrong (byte 4)"),e.end()}),test("write boolean",function(e){var n,t=new BerWriter;t.writeBoolean(!0),t.writeBoolean(!1),n=t.buffer,e.ok(n),e.equal(n.length,6,"Wrong length"),e.equal(n[0],1,"tag wrong"),e.equal(n[1],1,"length wrong"),e.equal(n[2],255,"value wrong"),e.equal(n[3],1,"tag wrong"),e.equal(n[4],1,"length wrong"),e.equal(n[5],0,"value wrong"),e.end()}),test("write string",function(e){var n,t=new BerWriter;t.writeString("hello world"),n=t.buffer,e.ok(n),e.equal(n.length,13,"wrong length"),e.equal(n[0],4,"wrong tag"),e.equal(n[1],11,"wrong length"),e.equal(n.slice(2).toString("utf8"),"hello world","wrong value"),e.end()}),test("write buffer",function(e){var n,t,r,l,g=new BerWriter;for(g.writeString("hello world"),n=g.buffer,t=new Buffer([4,11,48,9,2,1,15,1,1,255,1,1,255]),g.writeBuffer(t.slice(2,t.length),4),n=g.buffer,e.ok(n),e.equal(n.length,26,"wrong length"),e.equal(n[0],4,"wrong tag"),e.equal(n[1],11,"wrong length"),e.equal(n.slice(2,13).toString("utf8"),"hello world","wrong value"),e.equal(n[13],t[0],"wrong tag"),e.equal(n[14],t[1],"wrong length"),r=13,l=0;r<n.length&&l<t.length;r++,l++)e.equal(n[r],t[l],"buffer contents not identical");e.end()}),test("write string array",function(e){var n,t=new BerWriter;t.writeStringArray(["hello world","fubar!"]),n=t.buffer,e.ok(n),e.equal(n.length,21,"wrong length"),e.equal(n[0],4,"wrong tag"),e.equal(n[1],11,"wrong length"),e.equal(n.slice(2,13).toString("utf8"),"hello world","wrong value"),e.equal(n[13],4,"wrong tag"),e.equal(n[14],6,"wrong length"),e.equal(n.slice(15).toString("utf8"),"fubar!","wrong value"),e.end()}),test("resize internal buffer",function(e){var n,t=new BerWriter({size:2});t.writeString("hello world"),n=t.buffer,e.ok(n),e.equal(n.length,13,"wrong length"),e.equal(n[0],4,"wrong tag"),e.equal(n[1],11,"wrong length"),e.equal(n.slice(2).toString("utf8"),"hello world","wrong value"),e.end()}),test("sequence",function(e){var n,t=new BerWriter({size:25});t.startSequence(),t.writeString("hello world"),t.endSequence(),n=t.buffer,e.ok(n),console.log(n),e.equal(n.length,15,"wrong length"),e.equal(n[0],48,"wrong tag"),e.equal(n[1],13,"wrong length"),e.equal(n[2],4,"wrong tag"),e.equal(n[3],11,"wrong length"),e.equal(n.slice(4).toString("utf8"),"hello world","wrong value"),e.end()}),test("nested sequence",function(e){var n,t=new BerWriter({size:25});t.startSequence(),t.writeString("hello world"),t.startSequence(),t.writeString("hello world"),t.endSequence(),t.endSequence(),n=t.buffer,e.ok(n),e.equal(n.length,30,"wrong length"),e.equal(n[0],48,"wrong tag"),e.equal(n[1],28,"wrong length"),e.equal(n[2],4,"wrong tag"),e.equal(n[3],11,"wrong length"),e.equal(n.slice(4,15).toString("utf8"),"hello world","wrong value"),e.equal(n[15],48,"wrong tag"),e.equal(n[16],13,"wrong length"),e.equal(n[17],4,"wrong tag"),e.equal(n[18],11,"wrong length"),e.equal(n.slice(19,30).toString("utf8"),"hello world","wrong value"),e.end()}),test("LDAP bind message",function(e){var n,t="cn=foo,ou=unit,o=test",r=new BerWriter;r.startSequence(),r.writeInt(3),r.startSequence(96),r.writeInt(3),r.writeString(t),r.writeByte(128),r.writeByte(0),r.endSequence(),r.endSequence(),n=r.buffer,e.ok(n),e.equal(n.length,35,"wrong length (buffer)"),e.equal(n[0],48,"wrong tag"),e.equal(n[1],33,"wrong length"),e.equal(n[2],2,"wrong tag"),e.equal(n[3],1,"wrong length"),e.equal(n[4],3,"wrong value"),e.equal(n[5],96,"wrong tag"),e.equal(n[6],28,"wrong length"),e.equal(n[7],2,"wrong tag"),e.equal(n[8],1,"wrong length"),e.equal(n[9],3,"wrong value"),e.equal(n[10],4,"wrong tag"),e.equal(n[11],t.length,"wrong length"),e.equal(n.slice(12,33).toString("utf8"),t,"wrong value"),e.equal(n[33],128,"wrong tag"),e.equal(n[34],0,"wrong len"),e.end()}),test("Write OID",function(e){var n,t="1.2.840.113549.1.1.1",r=new BerWriter;r.writeOID(t),n=r.buffer,e.ok(n),console.log(null.inspect(n)),console.log(null.inspect(new Buffer([6,9,42,134,72,134,247,13,1,1,1]))),e.end()});