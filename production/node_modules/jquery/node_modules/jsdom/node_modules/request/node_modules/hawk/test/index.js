var Url=null,Lab=null,Hawk=null,internals={},expect=Lab.expect,before=Lab.before,after=Lab.after,describe=Lab.experiment,it=Lab.test;describe("Hawk",function(){var e=function(e,t){var a={id:e,key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"1"===e?"sha1":"sha256",user:"steve"};return t(null,a)};it("should generate a header then successfully parse it (configuration)",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080};e("123456",function(o,r){a.authorization=Hawk.client.header(Url.parse("http://example.com:8080/resource/4?filter=a"),a.method,{credentials:r,ext:"some-app-data"}).field,expect(a.authorization).to.exist,Hawk.server.authenticate(a,e,{},function(e,a,o){expect(e).to.not.exist,expect(a.user).to.equal("steve"),expect(o.ext).to.equal("some-app-data"),t()})})}),it("should generate a header then successfully parse it (node request)",function(t){var a={method:"POST",url:"/resource/4?filter=a",headers:{host:"example.com:8080","content-type":"text/plain;x=y"}},o="some not so random text";e("123456",function(r,s){var n=Hawk.client.header("http://example.com:8080/resource/4?filter=a",a.method,{credentials:s,ext:"some-app-data",payload:o,contentType:a.headers["content-type"]});a.headers.authorization=n.field,Hawk.server.authenticate(a,e,{},function(e,r,s){expect(e).to.not.exist,expect(r.user).to.equal("steve"),expect(s.ext).to.equal("some-app-data"),expect(Hawk.server.authenticatePayload(o,r,s,a.headers["content-type"])).to.equal(!0);var n={headers:{"content-type":"text/plain"}};n.headers["server-authorization"]=Hawk.server.header(r,s,{payload:"some reply",contentType:"text/plain",ext:"response-specific"}),expect(n.headers["server-authorization"]).to.exist,expect(Hawk.client.authenticate(n,r,s,{payload:"some reply"})).to.equal(!0),t()})})}),it("should generate a header then successfully parse it (no server header options)",function(t){var a={method:"POST",url:"/resource/4?filter=a",headers:{host:"example.com:8080","content-type":"text/plain;x=y"}},o="some not so random text";e("123456",function(r,s){var n=Hawk.client.header("http://example.com:8080/resource/4?filter=a",a.method,{credentials:s,ext:"some-app-data",payload:o,contentType:a.headers["content-type"]});a.headers.authorization=n.field,Hawk.server.authenticate(a,e,{},function(e,r,s){expect(e).to.not.exist,expect(r.user).to.equal("steve"),expect(s.ext).to.equal("some-app-data"),expect(Hawk.server.authenticatePayload(o,r,s,a.headers["content-type"])).to.equal(!0);var n={headers:{"content-type":"text/plain"}};n.headers["server-authorization"]=Hawk.server.header(r,s),expect(n.headers["server-authorization"]).to.exist,expect(Hawk.client.authenticate(n,r,s)).to.equal(!0),t()})})}),it("should generate a header then fails to parse it (missing server header hash)",function(t){var a={method:"POST",url:"/resource/4?filter=a",headers:{host:"example.com:8080","content-type":"text/plain;x=y"}},o="some not so random text";e("123456",function(r,s){var n=Hawk.client.header("http://example.com:8080/resource/4?filter=a",a.method,{credentials:s,ext:"some-app-data",payload:o,contentType:a.headers["content-type"]});a.headers.authorization=n.field,Hawk.server.authenticate(a,e,{},function(e,r,s){expect(e).to.not.exist,expect(r.user).to.equal("steve"),expect(s.ext).to.equal("some-app-data"),expect(Hawk.server.authenticatePayload(o,r,s,a.headers["content-type"])).to.equal(!0);var n={headers:{"content-type":"text/plain"}};n.headers["server-authorization"]=Hawk.server.header(r,s),expect(n.headers["server-authorization"]).to.exist,expect(Hawk.client.authenticate(n,r,s,{payload:"some reply"})).to.equal(!1),t()})})}),it("should generate a header then successfully parse it (with hash)",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080};e("123456",function(o,r){a.authorization=Hawk.client.header("http://example.com:8080/resource/4?filter=a",a.method,{credentials:r,payload:"hola!",ext:"some-app-data"}).field,Hawk.server.authenticate(a,e,{},function(e,a,o){expect(e).to.not.exist,expect(a.user).to.equal("steve"),expect(o.ext).to.equal("some-app-data"),t()})})}),it("should generate a header then successfully parse it then validate payload",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080};e("123456",function(o,r){a.authorization=Hawk.client.header("http://example.com:8080/resource/4?filter=a",a.method,{credentials:r,payload:"hola!",ext:"some-app-data"}).field,Hawk.server.authenticate(a,e,{},function(e,a,o){expect(e).to.not.exist,expect(a.user).to.equal("steve"),expect(o.ext).to.equal("some-app-data"),expect(Hawk.server.authenticatePayload("hola!",a,o)).to.be.true,expect(Hawk.server.authenticatePayload("hello!",a,o)).to.be.false,t()})})}),it("should generate a header then successfully parse it (app)",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080};e("123456",function(o,r){a.authorization=Hawk.client.header("http://example.com:8080/resource/4?filter=a",a.method,{credentials:r,ext:"some-app-data",app:"asd23ased"}).field,Hawk.server.authenticate(a,e,{},function(e,a,o){expect(e).to.not.exist,expect(a.user).to.equal("steve"),expect(o.ext).to.equal("some-app-data"),expect(o.app).to.equal("asd23ased"),t()})})}),it("should generate a header then successfully parse it (app, dlg)",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080};e("123456",function(o,r){a.authorization=Hawk.client.header("http://example.com:8080/resource/4?filter=a",a.method,{credentials:r,ext:"some-app-data",app:"asd23ased",dlg:"23434szr3q4d"}).field,Hawk.server.authenticate(a,e,{},function(e,a,o){expect(e).to.not.exist,expect(a.user).to.equal("steve"),expect(o.ext).to.equal("some-app-data"),expect(o.app).to.equal("asd23ased"),expect(o.dlg).to.equal("23434szr3q4d"),t()})})}),it("should generate a header then fail authentication due to bad hash",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080};e("123456",function(o,r){a.authorization=Hawk.client.header("http://example.com:8080/resource/4?filter=a",a.method,{credentials:r,payload:"hola!",ext:"some-app-data"}).field,Hawk.server.authenticate(a,e,{payload:"byebye!"},function(e){expect(e).to.exist,expect(e.response.payload.message).to.equal("Bad payload hash"),t()})})}),it("should generate a header for one resource then fail to authenticate another",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080};e("123456",function(o,r){a.authorization=Hawk.client.header("http://example.com:8080/resource/4?filter=a",a.method,{credentials:r,ext:"some-app-data"}).field,a.url="/something/else",Hawk.server.authenticate(a,e,{},function(e,a){expect(e).to.exist,expect(a).to.exist,t()})})})});