// Copyright 2012 Joyent, Inc.  All rights reserved.

function readNext(e,t){var r,n=ctype.ruint32(e,"big",t);return t+=4,r=t+n,{data:e.slice(t,r),offset:r}}function writeInt(e,t){e.writeByte(2),e.writeLength(t.length);for(var r=0;r<t.length;r++)e.writeByte(t[r]);return e}function rsaToPEM(e){var t,r,n,s,a,i,o,u="",d=0;try{if(t=new Buffer(e.split(" ")[1],"base64"),o=readNext(t,d),i=""+o.data,d=o.offset,"ssh-rsa"!==i)throw Error("Invalid ssh key type: "+i);o=readNext(t,d),n=o.data,d=o.offset,o=readNext(t,d),a=o.data}catch(f){throw Error("Invalid ssh key: "+e)}for(r=new asn1.BerWriter,r.startSequence(),r.startSequence(),r.writeOID("1.2.840.113549.1.1.1"),r.writeNull(),r.endSequence(),r.startSequence(3),r.writeByte(0),r.startSequence(),writeInt(r,a),writeInt(r,n),r.endSequence(),r.endSequence(),r.endSequence(),o=r.buffer.toString("base64"),s=0;s<o.length;s++)0===s%64&&(u+="\n"),u+=o.charAt(s);return/\\n$/.test(u)||(u+="\n"),"-----BEGIN PUBLIC KEY-----"+u+"-----END PUBLIC KEY-----\n"}function dsaToPEM(e){var t,r,n,s,a,i,o,u,d,f=0,c="";try{if(t=new Buffer(e.split(" ")[1],"base64"),r=readNext(t,f),s=""+r.data,f=r.offset,!/^ssh-ds[as].*/.test(s))throw Error("Invalid ssh key type: "+s);r=readNext(t,f),a=r.data,f=r.offset,r=readNext(t,f),i=r.data,f=r.offset,r=readNext(t,f),o=r.data,f=r.offset,r=readNext(t,f),u=r.data}catch(l){throw console.log(l.stack),Error("Invalid ssh key: "+e)}for(n=new asn1.BerWriter,n.startSequence(),n.startSequence(),n.writeOID("1.2.840.10040.4.1"),n.startSequence(),writeInt(n,a),writeInt(n,i),writeInt(n,o),n.endSequence(),n.endSequence(),n.startSequence(3),n.writeByte(0),writeInt(n,u),n.endSequence(),n.endSequence(),r=n.buffer.toString("base64"),d=0;d<r.length;d++)0===d%64&&(c+="\n"),c+=r.charAt(d);return/\\n$/.test(c)||(c+="\n"),"-----BEGIN PUBLIC KEY-----"+c+"-----END PUBLIC KEY-----\n"}var assert=null,crypto=null,asn1=null,ctype=null;module.exports={sshKeyToPEM:function(e){if(assert.string(e,"ssh_key"),/^ssh-rsa.*/.test(e))return rsaToPEM(e);if(/^ssh-ds[as].*/.test(e))return dsaToPEM(e);throw Error("Only RSA and DSA public keys are allowed")},fingerprint:function(e){var t,r,n,s,a,i;if(assert.string(e,"ssh_key"),t=e.split(" "),!t||!t.length||t.length<2)throw Error("invalid ssh key");for(r=new Buffer(t[1],"base64"),n=crypto.createHash("md5"),n.update(r),s=n.digest("hex"),a="",i=0;i<s.length;i++)i&&0===i%2&&(a+=":"),a+=s[i];return a}};