var Http=null,Lab=null,Hawk=null,internals={},expect=Lab.expect,before=Lab.before,after=Lab.after,describe=Lab.experiment,it=Lab.test;describe("Hawk",function(){describe("Uri",function(){var e=function(e,t){var o={id:e,key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"sha256",user:"steve"};return t(null,o)};it("should generate a bewit then successfully authenticate it",function(t){var o={method:"GET",url:"/resource/4?a=1&b=2",host:"example.com",port:80};e("123456",function(a,i){var c=Hawk.uri.getBewit("http://example.com/resource/4?a=1&b=2",{credentials:i,ttlSec:31536e5,ext:"some-app-data"});o.url+="&bewit="+c,Hawk.uri.authenticate(o,e,{},function(e,o,a){expect(e).to.not.exist,expect(o.user).to.equal("steve"),expect(a.ext).to.equal("some-app-data"),t()})})}),it("should generate a bewit then successfully authenticate it (no ext)",function(t){var o={method:"GET",url:"/resource/4?a=1&b=2",host:"example.com",port:80};e("123456",function(a,i){var c=Hawk.uri.getBewit("http://example.com/resource/4?a=1&b=2",{credentials:i,ttlSec:31536e5});o.url+="&bewit="+c,Hawk.uri.authenticate(o,e,{},function(e,o){expect(e).to.not.exist,expect(o.user).to.equal("steve"),t()})})}),it("should successfully authenticate a request (last param)",function(t){var o={method:"GET",url:"/resource/4?a=1&b=2&bewit=MTIzNDU2XDQ1MTE0ODQ2MjFcMzFjMmNkbUJFd1NJRVZDOVkva1NFb2c3d3YrdEVNWjZ3RXNmOGNHU2FXQT1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(o,e,{},function(e,o,a){expect(e).to.not.exist,expect(o.user).to.equal("steve"),expect(a.ext).to.equal("some-app-data"),t()})}),it("should successfully authenticate a request (first param)",function(t){var o={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MTE0ODQ2MjFcMzFjMmNkbUJFd1NJRVZDOVkva1NFb2c3d3YrdEVNWjZ3RXNmOGNHU2FXQT1cc29tZS1hcHAtZGF0YQ&a=1&b=2",host:"example.com",port:8080};Hawk.uri.authenticate(o,e,{},function(e,o,a){expect(e).to.not.exist,expect(o.user).to.equal("steve"),expect(a.ext).to.equal("some-app-data"),t()})}),it("should successfully authenticate a request (only param)",function(t){var o={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MTE0ODQ2NDFcZm1CdkNWT3MvcElOTUUxSTIwbWhrejQ3UnBwTmo4Y1VrSHpQd3Q5OXJ1cz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(o,e,{},function(e,o,a){expect(e).to.not.exist,expect(o.user).to.equal("steve"),expect(a.ext).to.equal("some-app-data"),t()})}),it("should fail on multiple authentication",function(t){var o={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MTE0ODQ2NDFcZm1CdkNWT3MvcElOTUUxSTIwbWhrejQ3UnBwTmo4Y1VrSHpQd3Q5OXJ1cz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080,authorization:"Basic asdasdasdasd"};Hawk.uri.authenticate(o,e,{},function(e){expect(e).to.exist,expect(e.response.payload.message).to.equal("Multiple authentications"),t()})}),it("should fail on method other than GET",function(t){e("123456",function(o,a){var i={method:"POST",url:"/resource/4?filter=a",host:"example.com",port:8080},c=Math.floor(Hawk.utils.now()/1e3)+60,n="some-app-data",u=Hawk.crypto.calculateMac("bewit",a,{timestamp:c,nonce:"",method:i.method,resource:i.url,host:i.host,port:i.port,ext:n}),r=a.id+"\\"+c+"\\"+u+"\\"+n;i.url+="&bewit="+Hawk.utils.base64urlEncode(r),Hawk.uri.authenticate(i,e,{},function(e){expect(e).to.exist,expect(e.response.payload.message).to.equal("Invalid method"),t()})})}),it("should fail on invalid host header",function(t){var o={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ",headers:{host:"example.com:something"}};Hawk.uri.authenticate(o,e,{},function(e){expect(e).to.exist,expect(e.response.payload.message).to.equal("Invalid Host header"),t()})}),it("should fail on empty bewit",function(t){var o={method:"GET",url:"/resource/4?bewit=",host:"example.com",port:8080};Hawk.uri.authenticate(o,e,{},function(e){expect(e).to.exist,expect(e.response.payload.message).to.equal("Empty bewit"),expect(e.isMissing).to.not.exist,t()})}),it("should fail on invalid bewit",function(t){var o={method:"GET",url:"/resource/4?bewit=*",host:"example.com",port:8080};Hawk.uri.authenticate(o,e,{},function(e){expect(e).to.exist,expect(e.response.payload.message).to.equal("Invalid bewit encoding"),expect(e.isMissing).to.not.exist,t()})}),it("should fail on missing bewit",function(t){var o={method:"GET",url:"/resource/4",host:"example.com",port:8080};Hawk.uri.authenticate(o,e,{},function(e){expect(e).to.exist,expect(e.response.payload.message).to.not.exist,expect(e.isMissing).to.equal(!0),t()})}),it("should fail on invalid bewit structure",function(t){var o={method:"GET",url:"/resource/4?bewit=abc",host:"example.com",port:8080};Hawk.uri.authenticate(o,e,{},function(e){expect(e).to.exist,expect(e.response.payload.message).to.equal("Invalid bewit structure"),t()})}),it("should fail on empty bewit attribute",function(t){var o={method:"GET",url:"/resource/4?bewit=YVxcY1xk",host:"example.com",port:8080};Hawk.uri.authenticate(o,e,{},function(e){expect(e).to.exist,expect(e.response.payload.message).to.equal("Missing bewit attributes"),t()})}),it("should fail on expired access",function(t){var o={method:"GET",url:"/resource/4?a=1&b=2&bewit=MTIzNDU2XDEzNTY0MTg1ODNcWk1wZlMwWU5KNHV0WHpOMmRucTRydEk3NXNXTjFjeWVITTcrL0tNZFdVQT1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(o,e,{},function(e){expect(e).to.exist,expect(e.response.payload.message).to.equal("Access expired"),t()})}),it("should fail on credentials function error",function(e){var t={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(t,function(e,t){t(Hawk.error.badRequest("Boom"))},{},function(t){expect(t).to.exist,expect(t.response.payload.message).to.equal("Boom"),e()})}),it("should fail on null credentials function response",function(e){var t={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(t,function(e,t){t(null,null)},{},function(t){expect(t).to.exist,expect(t.response.payload.message).to.equal("Unknown credentials"),e()})}),it("should fail on invalid credentials function response",function(e){var t={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(t,function(e,t){t(null,{})},{},function(t){expect(t).to.exist,expect(t.message).to.equal("Invalid credentials"),e()})}),it("should fail on invalid credentials function response (unknown algorithm)",function(e){var t={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(t,function(e,t){t(null,{key:"xxx",algorithm:"xxx"})},{},function(t){expect(t).to.exist,expect(t.message).to.equal("Unknown algorithm"),e()})}),it("should fail on expired access",function(e){var t={method:"GET",url:"/resource/4?bewit=MTIzNDU2XDQ1MDk5OTE3MTlcTUE2eWkwRWRwR0pEcWRwb0JkYVdvVDJrL0hDSzA1T0Y3MkhuZlVmVy96Zz1cc29tZS1hcHAtZGF0YQ",host:"example.com",port:8080};Hawk.uri.authenticate(t,function(e,t){t(null,{key:"xxx",algorithm:"sha256"})},{},function(t){expect(t).to.exist,expect(t.response.payload.message).to.equal("Bad mac"),e()})})}),describe("#getBewit",function(){it("should return a valid bewit value",function(e){var t={id:"123456",key:"2983d45yun89q",algorithm:"sha256"},o=Hawk.uri.getBewit("https://example.com/somewhere/over/the/rainbow",{credentials:t,ttlSec:300,localtimeOffsetMsec:1356420407232-Hawk.utils.now(),ext:"xandyandz"});expect(o).to.equal("MTIzNDU2XDEzNTY0MjA3MDdca3NjeHdOUjJ0SnBQMVQxekRMTlBiQjVVaUtJVTl0T1NKWFRVZEc3WDloOD1ceGFuZHlhbmR6"),e()}),it("should return an empty bewit on invalid credentials",function(e){var t={key:"2983d45yun89q",algorithm:"sha256"},o=Hawk.uri.getBewit("https://example.com/somewhere/over/the/rainbow",{credentials:t,ttlSec:3e3,ext:"xandyandz"});expect(o).to.equal(""),e()}),it("should return an empty bewit on invalid algorithm",function(e){var t={id:"123456",key:"2983d45yun89q",algorithm:"hmac-sha-0"},o=Hawk.uri.getBewit("https://example.com/somewhere/over/the/rainbow",{credentials:t,ttlSec:300,ext:"xandyandz"});expect(o).to.equal(""),e()}),it("should return an empty bewit on missing options",function(e){var t=Hawk.uri.getBewit("https://example.com/somewhere/over/the/rainbow");expect(t).to.equal(""),e()})})});