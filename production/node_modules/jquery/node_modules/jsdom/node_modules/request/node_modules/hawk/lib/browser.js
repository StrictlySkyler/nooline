/*
    HTTP Hawk Authentication Scheme
    Copyright (c) 2012-2013, Eran Hammer <eran@hueniverse.com>
    MIT Licensed
*/

// (c) Steven Levithan <stevenlevithan.com>

// Based on: Crypto-JS v3.1.2
// Copyright (c) 2009-2013, Jeff Mott. All rights reserved.
// http://code.google.com/p/crypto-js/
// http://code.google.com/p/crypto-js/wiki/License

var CryptoJS,hawk={};"undefined"!=typeof module&&module.exports&&(module.exports=hawk),hawk.client={header:function(t,e,r){var n,a,o,i,s,h,c={field:"",artifacts:{}};return t&&("string"==typeof t||"object"==typeof t)&&e&&"string"==typeof e&&r&&"object"==typeof r?(n=r.timestamp||Math.floor((hawk.utils.now()+(r.localtimeOffsetMsec||0))/1e3),a=r.credentials,a&&a.id&&a.key&&a.algorithm?-1===hawk.crypto.algorithms.indexOf(a.algorithm)?c:("string"==typeof t&&(t=hawk.utils.parseUri(t)),o={ts:n,nonce:r.nonce||hawk.utils.randomString(6),method:e,resource:t.relative,host:t.hostname,port:t.port,hash:r.hash,ext:r.ext,app:r.app,dlg:r.dlg},c.artifacts=o,!o.hash&&r.hasOwnProperty("payload")&&(o.hash=hawk.crypto.calculatePayloadHash(r.payload,a.algorithm,r.contentType)),i=hawk.crypto.calculateMac("header",a,o),s=null!==o.ext&&void 0!==o.ext&&""!==o.ext,h='Hawk id="'+a.id+'", ts="'+o.ts+'", nonce="'+o.nonce+(o.hash?'", hash="'+o.hash:"")+(s?'", ext="'+hawk.utils.escapeHeaderAttribute(o.ext):"")+'", mac="'+i+'"',o.app&&(h+=', app="'+o.app+(o.dlg?'", dlg="'+o.dlg:"")+'"'),c.field=h,c):c):c},authenticate:function(t,e,r,n){var a,o,i,s,h;if(n=n||{},t.getResponseHeader("www-authenticate")){if(a=hawk.utils.parseAuthorizationHeader(t.getResponseHeader("www-authenticate"),["ts","tsm","error"]),!a)return!1;if(a.ts){if(o=hawk.crypto.calculateTsMac(a.ts,e),o!==a.tsm)return!1;hawk.utils.setNtpOffset(a.ts-Math.floor(Date.now()/1e3))}}return t.getResponseHeader("server-authorization")||n.required?(a=hawk.utils.parseAuthorizationHeader(t.getResponseHeader("server-authorization"),["mac","ext","hash"]))?(i={ts:r.ts,nonce:r.nonce,method:r.method,resource:r.resource,host:r.host,port:r.port,hash:a.hash,ext:a.ext,app:r.app,dlg:r.dlg},s=hawk.crypto.calculateMac("response",e,i),s!==a.mac?!1:n.hasOwnProperty("payload")?a.hash?(h=hawk.crypto.calculatePayloadHash(n.payload,e.algorithm,t.getResponseHeader("content-type")),h===a.hash):!1:!0):!1:!0},message:function(t,e,r,n){var a,o,i,s;return t&&"string"==typeof t&&e&&"number"==typeof e&&null!==r&&void 0!==r&&"string"==typeof r&&n&&"object"==typeof n?(a=n.timestamp||Math.floor((hawk.utils.now()+(n.localtimeOffsetMsec||0))/1e3),o=n.credentials,o&&o.id&&o.key&&o.algorithm?-1===hawk.crypto.algorithms.indexOf(o.algorithm)?null:(i={ts:a,nonce:n.nonce||hawk.utils.randomString(6),host:t,port:e,hash:hawk.crypto.calculatePayloadHash(r,o.algorithm)},s={id:o.id,ts:i.ts,nonce:i.nonce,hash:i.hash,mac:hawk.crypto.calculateMac("message",o,i)}):null):null}},hawk.crypto={headerVersion:"1",algorithms:["sha1","sha256"],calculateMac:function(t,e,r){var n=hawk.crypto.generateNormalizedString(t,r),a=CryptoJS["Hmac"+e.algorithm.toUpperCase()](n,e.key);return a.toString(CryptoJS.enc.Base64)},generateNormalizedString:function(t,e){var r="hawk."+hawk.crypto.headerVersion+"."+t+"\n"+e.ts+"\n"+e.nonce+"\n"+(e.method||"").toUpperCase()+"\n"+(e.resource||"")+"\n"+e.host.toLowerCase()+"\n"+e.port+"\n"+(e.hash||"")+"\n";return e.ext&&(r+=e.ext.replace("\\","\\\\").replace("\n","\\n")),r+="\n",e.app&&(r+=e.app+"\n"+(e.dlg||"")+"\n"),r},calculatePayloadHash:function(t,e,r){var n=CryptoJS.algo[e.toUpperCase()].create();return n.update("hawk."+hawk.crypto.headerVersion+".payload\n"),n.update(hawk.utils.parseContentType(r)+"\n"),n.update(t||""),n.update("\n"),n.finalize().toString(CryptoJS.enc.Base64)},calculateTsMac:function(t,e){var r=CryptoJS["Hmac"+e.algorithm.toUpperCase()]("hawk."+hawk.crypto.headerVersion+".ts\n"+t+"\n",e.key);return r.toString(CryptoJS.enc.Base64)}},hawk.utils={storage:{_cache:{},setItem:function(t,e){hawk.utils.storage._cache[t]=e},getItem:function(t){return hawk.utils.storage._cache[t]}},setStorage:function(t){var e=hawk.utils.getNtpOffset()||0;hawk.utils.storage=t,hawk.utils.setNtpOffset(e)},setNtpOffset:function(t){hawk.utils.storage.setItem("hawk_ntp_offset",t)},getNtpOffset:function(){return parseInt(hawk.utils.storage.getItem("hawk_ntp_offset")||"0",10)},now:function(){return Date.now()+hawk.utils.getNtpOffset()},escapeHeaderAttribute:function(t){return t.replace(/\\/g,"\\\\").replace(/\"/g,'\\"')},parseContentType:function(t){return t?t.split(";")[0].trim().toLowerCase():""},parseAuthorizationHeader:function(t,e){var r,n,a,o,i;return t?(r=t.match(/^(\w+)(?:\s+(.*))?$/))?(n=r[1],"hawk"!==n.toLowerCase()?null:(a=r[2])?(o={},i=a.replace(/(\w+)="([^"\\]*)"\s*(?:,\s*|$)/g,function(t,r,n){return-1===e.indexOf(r)||null===n.match(/^[ \w\!#\$%&'\(\)\*\+,\-\.\/\:;<\=>\?@\[\]\^`\{\|\}~]+$/)||o.hasOwnProperty(r)?void 0:(o[r]=n,"")}),""!==i?null:o):null):null:null},randomString:function(t){var e,r="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",n=r.length,a=[];for(e=0;t>e;++e)a[e]=r[Math.floor(Math.random()*n)];return a.join("")},parseUri:function(t){for(var e=["source","protocol","authority","userInfo","user","password","hostname","port","resource","relative","pathname","directory","file","query","fragment"],r=/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?(((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?)(?:#(.*))?)/,n=r.exec(t),a={},o=15;o--;)a[e[o]]=n[o]||"";return(null===a.port||""===a.port)&&(a.port="http"===a.protocol.toLowerCase()?"80":"https"===a.protocol.toLowerCase()?"443":""),a}},CryptoJS=CryptoJS||function(t,e){var r,n={},a=n.lib={},o=function(){},i=a.Base={extend:function(t){o.prototype=this;var e=new o;return t&&e.mixIn(t),e.hasOwnProperty("init")||(e.init=function(){e.$super.init.apply(this,arguments)}),e.init.prototype=e,e.$super=this,e},create:function(){var t=this.extend();return t.init.apply(t,arguments),t},init:function(){},mixIn:function(t){for(var e in t)t.hasOwnProperty(e)&&(this[e]=t[e]);t.hasOwnProperty("toString")&&(this.toString=t.toString)},clone:function(){return this.init.prototype.extend(this)}},s=a.WordArray=i.extend({init:function(t,r){t=this.words=t||[],this.sigBytes=r!=e?r:4*t.length},toString:function(t){return(t||c).stringify(this)},concat:function(t){var e,r=this.words,n=t.words,a=this.sigBytes;if(t=t.sigBytes,this.clamp(),a%4)for(e=0;t>e;e++)r[a+e>>>2]|=(255&n[e>>>2]>>>24-8*(e%4))<<24-8*((a+e)%4);else if(65535<n.length)for(e=0;t>e;e+=4)r[a+e>>>2]=n[e>>>2];else r.push.apply(r,n);return this.sigBytes+=t,this},clamp:function(){var e=this.words,r=this.sigBytes;e[r>>>2]&=4294967295<<32-8*(r%4),e.length=t.ceil(r/4)},clone:function(){var t=i.clone.call(this);return t.words=this.words.slice(0),t},random:function(e){for(var r=[],n=0;e>n;n+=4)r.push(0|4294967296*t.random());return new s.init(r,e)}}),h=n.enc={},c=h.Hex={stringify:function(t){var e,r,n,a=t.words;for(t=t.sigBytes,e=[],r=0;t>r;r++)n=255&a[r>>>2]>>>24-8*(r%4),e.push((n>>>4).toString(16)),e.push((15&n).toString(16));return e.join("")},parse:function(t){for(var e=t.length,r=[],n=0;e>n;n+=2)r[n>>>3]|=parseInt(t.substr(n,2),16)<<24-4*(n%8);return new s.init(r,e/2)}},u=h.Latin1={stringify:function(t){var e,r,n=t.words;for(t=t.sigBytes,e=[],r=0;t>r;r++)e.push(String.fromCharCode(255&n[r>>>2]>>>24-8*(r%4)));return e.join("")},parse:function(t){for(var e=t.length,r=[],n=0;e>n;n++)r[n>>>2]|=(255&t.charCodeAt(n))<<24-8*(n%4);return new s.init(r,e)}},l=h.Utf8={stringify:function(t){try{return decodeURIComponent(escape(u.stringify(t)))}catch(e){throw Error("Malformed UTF-8 data")}},parse:function(t){return u.parse(unescape(encodeURIComponent(t)))}},p=a.BufferedBlockAlgorithm=i.extend({reset:function(){this._data=new s.init,this._nDataBytes=0},_append:function(t){"string"==typeof t&&(t=l.parse(t)),this._data.concat(t),this._nDataBytes+=t.sigBytes},_process:function(e){var r,n=this._data,a=n.words,o=n.sigBytes,i=this.blockSize,h=o/(4*i);if(h=e?t.ceil(h):t.max((0|h)-this._minBufferSize,0),e=h*i,o=t.min(4*e,o),e){for(r=0;e>r;r+=i)this._doProcessBlock(a,r);r=a.splice(0,e),n.sigBytes-=o}return new s.init(r,o)},clone:function(){var t=i.clone.call(this);return t._data=this._data.clone(),t},_minBufferSize:0});return a.Hasher=p.extend({cfg:i.extend(),init:function(t){this.cfg=this.cfg.extend(t),this.reset()},reset:function(){p.reset.call(this),this._doReset()},update:function(t){return this._append(t),this._process(),this},finalize:function(t){return t&&this._append(t),this._doFinalize()},blockSize:16,_createHelper:function(t){return function(e,r){return new t.init(r).finalize(e)}},_createHmacHelper:function(t){return function(e,n){return new r.HMAC.init(t,n).finalize(e)}}}),r=n.algo={},n}(Math),function(){var t=CryptoJS,e=t.lib,r=e.WordArray,n=e.Hasher,a=[],e=t.algo.SHA1=n.extend({_doReset:function(){this._hash=new r.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(t,e){var r,n,o,i,s,h,c,u;for(r=this._hash.words,n=r[0],o=r[1],i=r[2],s=r[3],h=r[4],c=0;80>c;c++)16>c?a[c]=0|t[e+c]:(u=a[c-3]^a[c-8]^a[c-14]^a[c-16],a[c]=u<<1|u>>>31),u=(n<<5|n>>>27)+h+a[c],u=20>c?u+((o&i|~o&s)+1518500249):40>c?u+((o^i^s)+1859775393):60>c?u+((o&i|o&s|i&s)-1894007588):u+((o^i^s)-899497514),h=s,s=i,i=o<<30|o>>>2,o=n,n=u;r[0]=0|r[0]+n,r[1]=0|r[1]+o,r[2]=0|r[2]+i,r[3]=0|r[3]+s,r[4]=0|r[4]+h},_doFinalize:function(){var t=this._data,e=t.words,r=8*this._nDataBytes,n=8*t.sigBytes;return e[n>>>5]|=128<<24-n%32,e[(n+64>>>9<<4)+14]=Math.floor(r/4294967296),e[(n+64>>>9<<4)+15]=r,t.sigBytes=4*e.length,this._process(),this._hash},clone:function(){var t=n.clone.call(this);return t._hash=this._hash.clone(),t}});t.SHA1=n._createHelper(e),t.HmacSHA1=n._createHmacHelper(e)}(),function(t){var e,r,n,a,o,i,s,h,c,u,l,p,f;for(e=CryptoJS,r=e.lib,n=r.WordArray,a=r.Hasher,r=e.algo,o=[],i=[],s=function(t){return 0|4294967296*(t-(0|t))},h=2,c=0;64>c;){t:{for(u=h,l=t.sqrt(u),p=2;l>=p;p++)if(!(u%p)){u=!1;break t}u=!0}u&&(8>c&&(o[c]=s(t.pow(h,.5))),i[c]=s(t.pow(h,1/3)),c++),h++}f=[],r=r.SHA256=a.extend({_doReset:function(){this._hash=new n.init(o.slice(0))},_doProcessBlock:function(t,e){var r,n,a,o,s,h,c,u,l,p,d,g;for(r=this._hash.words,n=r[0],a=r[1],o=r[2],s=r[3],h=r[4],c=r[5],u=r[6],l=r[7],p=0;64>p;p++)16>p?f[p]=0|t[e+p]:(d=f[p-15],g=f[p-2],f[p]=((d<<25|d>>>7)^(d<<14|d>>>18)^d>>>3)+f[p-7]+((g<<15|g>>>17)^(g<<13|g>>>19)^g>>>10)+f[p-16]),d=l+((h<<26|h>>>6)^(h<<21|h>>>11)^(h<<7|h>>>25))+(h&c^~h&u)+i[p]+f[p],g=((n<<30|n>>>2)^(n<<19|n>>>13)^(n<<10|n>>>22))+(n&a^n&o^a&o),l=u,u=c,c=h,h=0|s+d,s=o,o=a,a=n,n=0|d+g;r[0]=0|r[0]+n,r[1]=0|r[1]+a,r[2]=0|r[2]+o,r[3]=0|r[3]+s,r[4]=0|r[4]+h,r[5]=0|r[5]+c,r[6]=0|r[6]+u,r[7]=0|r[7]+l},_doFinalize:function(){var e=this._data,r=e.words,n=8*this._nDataBytes,a=8*e.sigBytes;return r[a>>>5]|=128<<24-a%32,r[(a+64>>>9<<4)+14]=t.floor(n/4294967296),r[(a+64>>>9<<4)+15]=n,e.sigBytes=4*r.length,this._process(),this._hash},clone:function(){var t=a.clone.call(this);return t._hash=this._hash.clone(),t}}),e.SHA256=a._createHelper(r),e.HmacSHA256=a._createHmacHelper(r)}(Math),function(){var t=CryptoJS,e=t.enc.Utf8;t.algo.HMAC=t.lib.Base.extend({init:function(t,r){var n,a,o,i,s,h,c;for(t=this._hasher=new t.init,"string"==typeof r&&(r=e.parse(r)),n=t.blockSize,a=4*n,r.sigBytes>a&&(r=t.finalize(r)),r.clamp(),o=this._oKey=r.clone(),i=this._iKey=r.clone(),s=o.words,h=i.words,c=0;n>c;c++)s[c]^=1549556828,h[c]^=909522486;o.sigBytes=i.sigBytes=a,this.reset()},reset:function(){var t=this._hasher;t.reset(),t.update(this._iKey)},update:function(t){return this._hasher.update(t),this},finalize:function(t){var e=this._hasher;return t=e.finalize(t),e.reset(),e.finalize(this._oKey.clone().concat(t))}})}(),function(){var t=CryptoJS,e=t.lib.WordArray;t.enc.Base64={stringify:function(t){var e,r,n,a=t.words,o=t.sigBytes,i=this._map;for(t.clamp(),t=[],e=0;o>e;e+=3)for(r=(255&a[e>>>2]>>>24-8*(e%4))<<16|(255&a[e+1>>>2]>>>24-8*((e+1)%4))<<8|255&a[e+2>>>2]>>>24-8*((e+2)%4),n=0;4>n&&o>e+.75*n;n++)t.push(i.charAt(63&r>>>6*(3-n)));if(a=i.charAt(64))for(;t.length%4;)t.push(a);return t.join("")},parse:function(t){var r,n,a,o,i=t.length,s=this._map,h=s.charAt(64);for(h&&(h=t.indexOf(h),-1!=h&&(i=h)),h=[],r=0,n=0;i>n;n++)n%4&&(a=s.indexOf(t.charAt(n-1))<<2*(n%4),o=s.indexOf(t.charAt(n))>>>6-2*(n%4),h[r>>>2]|=(a|o)<<24-8*(r%4),r++);return e.create(h,r)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}();