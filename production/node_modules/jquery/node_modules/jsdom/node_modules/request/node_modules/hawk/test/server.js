var Url=null,Lab=null,Hawk=null,internals={},expect=Lab.expect,before=Lab.before,after=Lab.after,describe=Lab.experiment,it=Lab.test;describe("Hawk",function(){describe("server",function(){var e=function(e,t){var a={id:e,key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"1"===e?"sha1":"sha256",user:"steve"};return t(null,a)};describe("#authenticate",function(){it("should parse a valid authentication header (sha1)",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="1", ts="1353788437", nonce="k3j4h2", mac="zy79QQ5/EYFmQqutVnYb73gAc/U=", ext="hello"'};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,a){expect(e).to.not.exist,expect(a.user).to.equal("steve"),t()})}),it("should parse a valid authentication header (sha256)",function(t){var a={method:"GET",url:"/resource/1?b=1&a=2",host:"example.com",port:8e3,authorization:'Hawk id="dh37fgj492je", ts="1353832234", nonce="j4h3g2", mac="m8r1rHbXN6NgO+KIIhjO7sFRyd78RNGVUwehe8Cp2dU=", ext="some-app-data"'};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1353832234e3-Hawk.utils.now()},function(e,a){expect(e).to.not.exist,expect(a.user).to.equal("steve"),t()})}),it("should parse a valid authentication header (host override)",function(t){var a={method:"GET",url:"/resource/4?filter=a",headers:{host:"example1.com:8080",authorization:'Hawk id="1", ts="1353788437", nonce="k3j4h2", mac="zy79QQ5/EYFmQqutVnYb73gAc/U=", ext="hello"'}};Hawk.server.authenticate(a,e,{host:"example.com",localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,a){expect(e).to.not.exist,expect(a.user).to.equal("steve"),t()})}),it("should parse a valid authentication header (host port override)",function(t){var a={method:"GET",url:"/resource/4?filter=a",headers:{host:"example1.com:80",authorization:'Hawk id="1", ts="1353788437", nonce="k3j4h2", mac="zy79QQ5/EYFmQqutVnYb73gAc/U=", ext="hello"'}};Hawk.server.authenticate(a,e,{host:"example.com",port:8080,localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e,a){expect(e).to.not.exist,expect(a.user).to.equal("steve"),t()})}),it("should parse a valid authentication header (POST with payload)",function(t){var a={method:"POST",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123456", ts="1357926341", nonce="1AwuJD", hash="qAiXIVv+yjDATneWxZP2YCTa9aHRgQdnH9b3Wc+o3dg=", ext="some-app-data", mac="UeYcj5UoTVaAWXNvJfLVia7kU3VabxCqrccXP8sUGC4="'};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1357926341e3-Hawk.utils.now()},function(e,a){expect(e).to.not.exist,expect(a.user).to.equal("steve"),t()})}),it("should fail on missing hash",function(t){var a={method:"GET",url:"/resource/1?b=1&a=2",host:"example.com",port:8e3,authorization:'Hawk id="dh37fgj492je", ts="1353832234", nonce="j4h3g2", mac="m8r1rHbXN6NgO+KIIhjO7sFRyd78RNGVUwehe8Cp2dU=", ext="some-app-data"'};Hawk.server.authenticate(a,e,{payload:"body",localtimeOffsetMsec:1353832234e3-Hawk.utils.now()},function(e){expect(e).to.exist,expect(e.response.payload.message).to.equal("Missing required payload hash"),t()})}),it("should fail on a stale timestamp",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123456", ts="1362337299", nonce="UzmxSs", ext="some-app-data", mac="wnNUxchvvryMH2RxckTdZ/gY3ijzvccx4keVvELC61w="'};Hawk.server.authenticate(a,e,{},function(e,a,o){var i,n,r,s;expect(e).to.exist,expect(e.response.payload.message).to.equal("Stale timestamp"),i=e.response.headers["WWW-Authenticate"],n=i.match(/^Hawk ts\=\"(\d+)\"\, tsm\=\"([^\"]+)\"\, error=\"Stale timestamp\"$/),r=Hawk.utils.now(),expect(1e3*parseInt(n[1],10)).to.be.within(r-1e3,r+1e3),s={headers:{"www-authenticate":i}},expect(Hawk.client.authenticate(s,a,o)).to.equal(!0),t()})}),it("should fail on a replay",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="bXx7a7p1h9QYQNZ8x7QhvDQym8ACgab4m3lVSFn4DBw=", ext="hello"'},o={},i={localtimeOffsetMsec:1353788437e3-Hawk.utils.now(),nonceFunc:function(e,t,a){return o[e]?a(Error()):(o[e]=!0,a())}};Hawk.server.authenticate(a,e,i,function(o,n){expect(o).to.not.exist,expect(n.user).to.equal("steve"),Hawk.server.authenticate(a,e,i,function(e){expect(e).to.exist,expect(e.response.payload.message).to.equal("Invalid nonce"),t()})})}),it("should fail on an invalid authentication header: wrong scheme",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:"Basic asdasdasdasd"};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e){expect(e).to.exist,expect(e.response.payload.message).to.not.exist,t()})}),it("should fail on an invalid authentication header: no scheme",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:"!@#"};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e){expect(e).to.exist,expect(e.response.payload.message).to.equal("Invalid header syntax"),t()})}),it("should fail on an missing authorization header",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080};Hawk.server.authenticate(a,e,{},function(e){expect(e).to.exist,expect(e.isMissing).to.equal(!0),t()})}),it("should fail on an missing host header",function(t){var a={method:"GET",url:"/resource/4?filter=a",headers:{authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'}};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e){expect(e).to.exist,expect(e.response.payload.message).to.equal("Invalid Host header"),t()})}),it("should fail on an missing authorization attribute (id)",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e){expect(e).to.exist,expect(e.response.payload.message).to.equal("Missing attributes"),t()})}),it("should fail on an missing authorization attribute (ts)",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e){expect(e).to.exist,expect(e.response.payload.message).to.equal("Missing attributes"),t()})}),it("should fail on an missing authorization attribute (nonce)",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e){expect(e).to.exist,expect(e.response.payload.message).to.equal("Missing attributes"),t()})}),it("should fail on an missing authorization attribute (mac)",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", ext="hello"'};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e){expect(e).to.exist,expect(e.response.payload.message).to.equal("Missing attributes"),t()})}),it("should fail on an unknown authorization attribute",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", x="3", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e){expect(e).to.exist,expect(e.response.payload.message).to.equal("Unknown attribute: x"),t()})}),it("should fail on an bad authorization header format",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123\\", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e){expect(e).to.exist,expect(e.response.payload.message).to.equal("Bad header format"),t()})}),it("should fail on an bad authorization attribute value",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="	", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e){expect(e).to.exist,expect(e.response.payload.message).to.equal("Bad attribute value: id"),t()})}),it("should fail on an empty authorization attribute value",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e){expect(e).to.exist,expect(e.response.payload.message).to.equal("Bad attribute value: id"),t()})}),it("should fail on duplicated authorization attribute key",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", id="456", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e){expect(e).to.exist,expect(e.response.payload.message).to.equal("Duplicate attribute: id"),t()})}),it("should fail on an invalid authorization header format",function(t){var a={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:"Hawk"};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e){expect(e).to.exist,expect(e.response.payload.message).to.equal("Invalid header syntax"),t()})}),it("should fail on an bad host header (missing host)",function(t){var a={method:"GET",url:"/resource/4?filter=a",headers:{host:":8080",authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'}};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e){expect(e).to.exist,expect(e.response.payload.message).to.equal("Invalid Host header"),t()})}),it("should fail on an bad host header (pad port)",function(t){var a={method:"GET",url:"/resource/4?filter=a",headers:{host:"example.com:something",authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'}};Hawk.server.authenticate(a,e,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(e){expect(e).to.exist,expect(e.response.payload.message).to.equal("Invalid Host header"),t()})}),it("should fail on credentialsFunc error",function(e){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'},a=function(e,t){return t(Error("Unknown user"))};Hawk.server.authenticate(t,a,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(t){expect(t).to.exist,expect(t.message).to.equal("Unknown user"),e()})}),it("should fail on missing credentials",function(e){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'},a=function(e,t){return t(null,null)};Hawk.server.authenticate(t,a,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(t){expect(t).to.exist,expect(t.response.payload.message).to.equal("Unknown credentials"),e()})}),it("should fail on invalid credentials",function(e){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'},a=function(e,t){var a={key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",user:"steve"};return t(null,a)};Hawk.server.authenticate(t,a,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(t){expect(t).to.exist,expect(t.message).to.equal("Invalid credentials"),expect(t.response.payload.message).to.equal("An internal server error occurred"),e()})}),it("should fail on unknown credentials algorithm",function(e){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcUyW6EEgUH4jlr7T/wuKe3dKijvTvSos=", ext="hello"'},a=function(e,t){var a={key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"hmac-sha-0",user:"steve"};return t(null,a)};Hawk.server.authenticate(t,a,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(t){expect(t).to.exist,expect(t.message).to.equal("Unknown algorithm"),expect(t.response.payload.message).to.equal("An internal server error occurred"),e()})}),it("should fail on unknown bad mac",function(e){var t={method:"GET",url:"/resource/4?filter=a",host:"example.com",port:8080,authorization:'Hawk id="123", ts="1353788437", nonce="k3j4h2", mac="/qwS4UjfVWMcU4jlr7T/wuKe3dKijvTvSos=", ext="hello"'},a=function(e,t){var a={key:"werxhqb98rpaxn39848xrunpaw3489ruxnpa98w4rxn",algorithm:"sha256",user:"steve"};return t(null,a)};Hawk.server.authenticate(t,a,{localtimeOffsetMsec:1353788437e3-Hawk.utils.now()},function(t){expect(t).to.exist,expect(t.response.payload.message).to.equal("Bad mac"),e()})})}),describe("#header",function(){it("should return an empty authorization header on missing options",function(e){var t=Hawk.server.header();expect(t).to.equal(""),e()}),it("should return an empty authorization header on missing credentials",function(e){var t=Hawk.server.header(null,{});expect(t).to.equal(""),e()}),it("should return an empty authorization header on invalid credentials",function(e){var t={key:"2983d45yun89q"},a=Hawk.server.header(t);expect(a).to.equal(""),e()}),it("should return an empty authorization header on invalid algorithm",function(e){var t={id:"123456"},a={key:"2983d45yun89q",algorithm:"hmac-sha-0"},o=Hawk.server.header(a,t);expect(o).to.equal(""),e()})})})});