function bouncy(e,s){return function(){var t={a:"b",b:"c",c:"d",d:"e",e:"f",f:"g",g:"h",h:"end"},r=!0;Object.keys(t).forEach(function(n){var i=t[n],o=r?301:302;r=!r,e.on("/"+n,function(e,t){t.writeHead(o,{location:s+"/"+i}),t.end()})}),e.on("/end",function(e){var s=e.headers["x-test-key"];hits[s]=!0,pending--,0===pending&&done()})}}function done(){assert.deepEqual(hits,expect),process.exit(0)}var hits,expect,pending,i,val,server=null,assert=null,request=null,s=server.createServer(),ss=server.createSSLServer(),sUrl="http://localhost:"+s.port,ssUrl="https://localhost:"+ss.port;for(s.listen(s.port,bouncy(s,ssUrl)),ss.listen(ss.port,bouncy(ss,sUrl)),hits={},expect={},pending=0,i=0;5>i;i++)pending++,val="test_"+i,expect[val]=!0,request({url:(i%2?sUrl:ssUrl)+"/a",headers:{"x-test-key":val},rejectUnauthorized:!1});