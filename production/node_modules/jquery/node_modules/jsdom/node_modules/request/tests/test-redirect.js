var server=null,assert=null,request=null,Cookie=null,Jar=Cookie.Jar,s=server.createServer();s.listen(s.port,function(){function e(e,t){var o=t+"_landing";s.on("/"+t,function(s,r){n[t]=!0,r.writeHead(e,{location:a+"/"+o,"set-cookie":"ham=eggs"}),r.end()}),s.on("/"+o,function(e,t){return"GET"!==e.method?(console.error("Got a non-GET request to the redirect destination URL"),t.writeHead(400),t.end(),void 0):(assert.equal(e.headers.cookie,"foo=bar; quux=baz; ham=eggs"),n[o]=!0,t.writeHead(200),t.end(o),void 0)})}function t(){r+=1,9==r&&(console.log(i+" tests passed."),s.close())}var o,r,a="http://localhost:"+s.port,n={},i=0;e(301,"temp"),e(302,"perm"),e(302,"nope"),o=new Jar,o.add(new Cookie("quux=baz")),request({uri:a+"/perm",jar:o,headers:{cookie:"foo=bar"}},function(e,o,s){if(e)throw e;if(200!==o.statusCode)throw Error("Status is not 200: "+o.statusCode);assert.ok(n.perm,"Original request is to /perm"),assert.ok(n.perm_landing,"Forward to permanent landing URL"),assert.equal(s,"perm_landing","Got permanent landing content"),i+=1,t()}),request({uri:a+"/temp",jar:o,headers:{cookie:"foo=bar"}},function(e,o,s){if(e)throw e;if(200!==o.statusCode)throw Error("Status is not 200: "+o.statusCode);assert.ok(n.temp,"Original request is to /temp"),assert.ok(n.temp_landing,"Forward to temporary landing URL"),assert.equal(s,"temp_landing","Got temporary landing content"),i+=1,t()}),request({uri:a+"/nope",jar:o,headers:{cookie:"foo=bar"},followRedirect:!1},function(e,o){if(e)throw e;if(302!==o.statusCode)throw Error("Status is not 302: "+o.statusCode);assert.ok(n.nope,"Original request to /nope"),assert.ok(!n.nope_landing,"No chasing the redirect"),assert.equal(o.statusCode,302,"Response is the bounce itself"),i+=1,t()}),request.post(a+"/temp",{jar:o,headers:{cookie:"foo=bar"}},function(e,o){if(e)throw e;if(301!==o.statusCode)throw Error("Status is not 301: "+o.statusCode);assert.ok(n.temp,"Original request is to /temp"),assert.ok(!n.temp_landing,"No chasing the redirect when post"),assert.equal(o.statusCode,301,"Response is the bounce itself"),i+=1,t()}),request.post({uri:a+"/temp",followAllRedirects:!0,jar:o,headers:{cookie:"foo=bar"}},function(e,o,s){if(e)throw e;if(200!==o.statusCode)throw Error("Status is not 200: "+o.statusCode);assert.ok(n.temp,"Original request is to /temp"),assert.ok(n.temp_landing,"Forward to temporary landing URL"),assert.equal(s,"temp_landing","Got temporary landing content"),i+=1,t()}),request.post({uri:a+"/temp",followAllRedirects:!1,jar:o,headers:{cookie:"foo=bar"}},function(e,o){if(e)throw e;if(301!==o.statusCode)throw Error("Status is not 301: "+o.statusCode);assert.ok(n.temp,"Original request is to /temp"),assert.ok(!n.temp_landing,"No chasing the redirect"),assert.equal(o.statusCode,301,"Response is the bounce itself"),i+=1,t()}),request.del(a+"/temp",{jar:o,headers:{cookie:"foo=bar"}},function(e,o){if(e)throw e;if(o.statusCode<301)throw Error("Status is not a redirect.");assert.ok(n.temp,"Original request is to /temp"),assert.ok(!n.temp_landing,"No chasing the redirect when delete"),assert.equal(o.statusCode,301,"Response is the bounce itself"),i+=1,t()}),request.del(a+"/temp",{followRedirect:!0,jar:o,headers:{cookie:"foo=bar"}},function(e,o){if(e)throw e;if(301!==o.statusCode)throw Error("Status is not 301: "+o.statusCode);assert.ok(n.temp,"Original request is to /temp"),assert.ok(!n.temp_landing,"No chasing the redirect when delete"),assert.equal(o.statusCode,301,"Response is the bounce itself"),i+=1,t()}),request.del(a+"/temp",{followAllRedirects:!0,jar:o,headers:{cookie:"foo=bar"}},function(e,o,s){if(e)throw e;if(200!==o.statusCode)throw Error("Status is not 200: "+o.statusCode);assert.ok(n.temp,"Original request is to /temp"),assert.ok(n.temp_landing,"Forward to temporary landing URL"),assert.equal(s,"temp_landing","Got temporary landing content"),i+=1,t()}),r=0});