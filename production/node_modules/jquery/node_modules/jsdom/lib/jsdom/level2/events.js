function getDocument(t){return t.nodeType==core.Node.DOCUMENT_NODE?t:t._ownerDocument}function mutationEventsEnabled(t){return t.nodeType!=core.Node.ATTRIBUTE_NODE&&getDocument(t).implementation.hasFeature("MutationEvents")}function dispatchAttrEvent(t){return function(e,n,r){var i,o,s,a,u,l,v=this._parentNode,c=e.apply(this,n);return mutationEventsEnabled(v)&&(o=v._ownerDocument,s=events.MutationEvent.prototype[t],a=c&&c.name||r.name,u=c&&c.value||null,l="ADDITION"==t?r.value:null,l&&l==u||(i=o.createEvent("MutationEvents"),i.initMutationEvent("DOMAttrModified",!0,!1,v,u,l,a,s),v.dispatchEvent(i))),c}}var events,core=require("./core").dom.level2.core,utils=require("../utils");core=Object.create(core),events={},events.EventException=function(){this._code=arguments.length>0?arguments[0]:0,this._message=arguments.length>1?arguments[1]:"Unspecified event type",Error.call(this,this._message),Error.captureStackTrace&&Error.captureStackTrace(this,events.EventException)},events.EventException.prototype={UNSPECIFIED_EVENT_TYPE_ERR:0,get code(){return this._code}},events.EventException.prototype.__proto__=Error.prototype,events.Event=function(t){this._eventType=t,this._type=null,this._bubbles=null,this._cancelable=null,this._target=null,this._currentTarget=null,this._eventPhase=null,this._timeStamp=null,this._preventDefault=!1,this._stopPropagation=!1},events.Event.prototype={initEvent:function(t,e,n){this._type=t,this._bubbles=e,this._cancelable=n},preventDefault:function(){this._cancelable&&(this._preventDefault=!0)},stopPropagation:function(){this._stopPropagation=!0},CAPTURING_PHASE:1,AT_TARGET:2,BUBBLING_PHASE:3,get eventType(){return this._eventType},get type(){return this._type},get bubbles(){return this._bubbles},get cancelable(){return this._cancelable},get target(){return this._target},get currentTarget(){return this._currentTarget},get eventPhase(){return this._eventPhase},get timeStamp(){return this._timeStamp}},events.UIEvent=function(t){events.Event.call(this,t),this.view=null,this.detail=null},events.UIEvent.prototype={initUIEvent:function(t,e,n,r,i){this.initEvent(t,e,n),this.view=r,this.detail=i}},events.UIEvent.prototype.__proto__=events.Event.prototype,events.MouseEvent=function(t){events.UIEvent.call(this,t),this.screenX=null,this.screenY=null,this.clientX=null,this.clientY=null,this.ctrlKey=null,this.shiftKey=null,this.altKey=null,this.metaKey=null,this.button=null,this.relatedTarget=null},events.MouseEvent.prototype={initMouseEvent:function(t,e,n,r,i,o,s,a,u,l,v,c,h,p,E){this.initUIEvent(t,e,n,r,i),this.screenX=o,this.screenY=s,this.clientX=a,this.clientY=u,this.ctrlKey=l,this.shiftKey=c,this.altKey=v,this.metaKey=h,this.button=p,this.relatedTarget=E}},events.MouseEvent.prototype.__proto__=events.UIEvent.prototype,events.MutationEvent=function(t){events.Event.call(this,t),this.relatedNode=null,this.prevValue=null,this.newValue=null,this.attrName=null,this.attrChange=null},events.MutationEvent.prototype={initMutationEvent:function(t,e,n,r,i,o,s,a){this.initEvent(t,e,n),this.relatedNode=r,this.prevValue=i,this.newValue=o,this.attrName=s,this.attrChange=a},MODIFICATION:1,ADDITION:2,REMOVAL:3},events.MutationEvent.prototype.__proto__=events.Event.prototype,events.EventTarget=function(){},events.EventTarget.getListeners=function(t,e,n){var r,i,o=t._listeners&&t._listeners[e]&&t._listeners[e][n]||[];return n||(r=t["on"+e],r&&(i=t._ownerDocument?t._ownerDocument.implementation:t.document.implementation,i.hasFeature("ProcessExternalResources","script")&&o.push(r))),o},events.EventTarget.dispatch=function(t,e,n){for(var r,i,o=e();o&&!t._stopPropagation;){for(r=events.EventTarget.getListeners(o,t._type,n),i=r.length;i--;){t._currentTarget=o;try{r[i].call(o,t)}catch(s){o.raise("error","Dispatching event '"+t._type+"' failed",{error:s,event:t})}}o=e()}return!t._stopPropagation},events.EventTarget.forwardIterator=function(t){var e=0,n=t.length;return function(){return n>e?t[e++]:null}},events.EventTarget.backwardIterator=function(t){var e=t.length;return function(){return e>=0?t[--e]:null}},events.EventTarget.singleIterator=function(t){var e=1;return function(){return e--?t:null}},events.EventTarget.prototype={addEventListener:function(t,e,n){var r,i,o;for(this._listeners=this._listeners||{},r=this._listeners[t]||{},n=n===!0,i=r[n]||[],o=0;o<i.length;o++)if(i[o]===e)return;i.push(e),r[n]=i,this._listeners[t]=r},removeEventListener:function(t,e,n){var r,i,o=this._listeners&&this._listeners[t];if(o&&(r=o[n===!0]))for(i=0;i<r.length;i++)if(r[i]===e)return r.splice(i,1),void 0},dispatchEvent:function(t){var e,n,r,i;if(null==t)throw new events.EventException(0,"Null event");if(null==t._type||""==t._type)throw new events.EventException(0,"Uninitialized event");for(e=[],t._target=this,n=this,r=n._parentNode;r;)e.push(r),n=r,r=n._parentNode;return r=n._parentWindow,r&&e.push(r),i=events.EventTarget.backwardIterator(e),t._eventPhase=t.CAPTURING_PHASE,events.EventTarget.dispatch(t,i,!0)?(i=events.EventTarget.singleIterator(t._target),t._eventPhase=t.AT_TARGET,events.EventTarget.dispatch(t,i,!1)?(t._bubbles&&!t._stopPropagation&&(i=events.EventTarget.forwardIterator(e),t._eventPhase=t.BUBBLING_PHASE,events.EventTarget.dispatch(t,i,!1)),t._preventDefault):t._preventDefault):t._preventDefault}},core.Node.prototype.__proto__=events.EventTarget.prototype,utils.intercept(core.Node,"insertBefore",function(t,e,n){var r,i,o=t.apply(this,e);return mutationEventsEnabled(this)&&(r=getDocument(this),i=r.createEvent("MutationEvents"),i.initMutationEvent("DOMNodeInserted",!0,!1,this,null,null,null,null),n.dispatchEvent(i),(this.nodeType==core.Node.DOCUMENT_NODE||this._attachedToDocument)&&(i=r.createEvent("MutationEvents"),i.initMutationEvent("DOMNodeInsertedIntoDocument",!1,!1,null,null,null,null,null),core.visitTree(n,function(t){t.nodeType==core.Node.ELEMENT_NODE&&(t.dispatchEvent(i),t._attachedToDocument=!0)}))),o}),utils.intercept(core.Node,"removeChild",function(t,e,n){if(mutationEventsEnabled(this)){var r=getDocument(this),i=r.createEvent("MutationEvents");i.initMutationEvent("DOMNodeRemoved",!0,!1,this,null,null,null,null),n.dispatchEvent(i),i=r.createEvent("MutationEvents"),i.initMutationEvent("DOMNodeRemovedFromDocument",!1,!1,null,null,null,null,null),core.visitTree(n,function(t){t.nodeType==core.Node.ELEMENT_NODE&&(t.dispatchEvent(i),t._attachedToDocument=!1)})}return t.apply(this,e)}),utils.intercept(core.AttrNodeMap,"removeNamedItem",dispatchAttrEvent("REMOVAL")),utils.intercept(core.AttrNodeMap,"setNamedItem",dispatchAttrEvent("ADDITION")),core.CharacterData.prototype.__defineGetter__("_nodeValue",function(){return this.__nodeValue}),core.CharacterData.prototype.__defineSetter__("_nodeValue",function(t){var e,n=this.__nodeValue;this.__nodeValue=t,this._ownerDocument&&this._parentNode&&mutationEventsEnabled(this)&&(e=this._ownerDocument.createEvent("MutationEvents"),e.initMutationEvent("DOMCharacterDataModified",!0,!1,this,n,t,null,null),this.dispatchEvent(e))}),core.Document.prototype.createEvent=function(t){switch(t){case"MutationEvents":return new events.MutationEvent(t);case"UIEvents":return new events.UIEvent(t);case"MouseEvents":return new events.MouseEvent(t);case"HTMLEvents":return new events.Event(t)}return new events.Event(t)},exports.dom={level2:{core:core,events:events}};