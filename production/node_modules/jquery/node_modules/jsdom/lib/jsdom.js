var createWindow,dom=exports.dom=require("./jsdom/level3/index").dom,features=null,fs=require("fs"),pkg=JSON.parse(fs.readFileSync(__dirname+"/../package.json")),request=null,URL=null,style=null;exports.defaultLevel=dom.level3.html,exports.browserAugmentation=require("./jsdom/browser/index").browserAugmentation,exports.windowAugmentation=require("./jsdom/browser/index").windowAugmentation,["availableDocumentFeatures","defaultDocumentFeatures","applyDocumentFeatures"].forEach(function(e){exports.__defineGetter__(e,function(){return features[e]}),exports.__defineSetter__(e,function(t){return features[e]=t})}),exports.debugMode=!1,createWindow=exports.createWindow=require("./jsdom/browser/index").createWindow,exports.__defineGetter__("version",function(){return pkg.version}),exports.level=function(e,t){return t||(t="core"),require("./jsdom/level"+e+"/"+t).dom["level"+e][t]},exports.jsdom=function(e,t,r){r=r||{},t="string"==typeof t?exports.level(t,"html"):t||exports.defaultLevel,r.url||(r.url="jsdom"===module.parent.id?module.parent.parent.filename:module.parent.filename,r.url=r.url.replace(/\\/g,"/"),"/"!==r.url[0]&&(r.url="/"+r.url),r.url="file://"+r.url);var n=exports.browserAugmentation(t,r),o=n.HTMLDocument?new n.HTMLDocument(r):new n.Document(r);return r.features&&r.features.QuerySelector&&require("./jsdom/selectors/index").applyQuerySelector(o,t),features.applyDocumentFeatures(o,r.features),void 0===e||null===e?o.write("<html><head></head><body></body></html>"):o.write(e+""),o.close&&!r.deferClose&&o.close(),o.createWindow=function(){return o.createWindow&&delete o.createWindow,o.parentWindow},o},exports.html=function(e,t,r){e+="";var n=e.toLowerCase();return~n.indexOf("<body")||(e="<body>"+e+"</body>"),~n.indexOf("<html")||(e="<html>"+e+"</html>"),exports.jsdom(e,t,r)},exports.jQueryify=exports.jsdom.jQueryify=function(e){var t,r,n,o,s;if(e&&e.document)return r=Array.prototype.slice.call(arguments),n="function"==typeof r[r.length-1]&&r.pop(),o=e.document.createElement("script"),o.className="jsdom",r.length>1&&(t=r[1]),s=e.document.implementation._features,e.document.implementation.addFeature("FetchExternalResources",["script"]),e.document.implementation.addFeature("ProcessExternalResources",["script"]),e.document.implementation.addFeature("MutationEvents",["1.0"]),o.src=t||"http://code.jquery.com/jquery-latest.js",e.document.body.appendChild(o),o.onload=function(){n&&n(e,e.jQuery),e.document.implementation._features=s},e},exports.env=exports.jsdom.env=function(){var e,t=Array.prototype.slice.call(arguments),r=exports.env.processArguments(t),n=r.done,o=function(e,t){var o,s,u,c,i,a,l;return t+="",e?n(e):(r.scripts=r.scripts||[],"string"==typeof r.scripts&&(r.scripts=[r.scripts]),r.src=r.src||[],"string"==typeof r.src&&(r.src=[r.src]),o={features:r.features||{FetchExternalResources:!1,ProcessExternalResources:!1,SkipExternalResources:!1},url:r.url},s=exports.html(t,null,o).createWindow(),u=JSON.parse(JSON.stringify(s.document.implementation._features)),c=0,i=r.scripts.length+r.src.length,a=null,s&&s.document?(r.document&&(s.document._referrer=r.document.referrer,s.document._cookie=r.document.cookie),s.document.implementation.addFeature("FetchExternalResources",["script"]),s.document.implementation.addFeature("ProcessExternalResources",["script"]),s.document.implementation.addFeature("MutationEvents",["1.0"]),l=function(){c++,c>=i&&(s.document.implementation._features=u,a&&(a=a.concat(s.document.errors||[])),process.nextTick(function(){n(a,s)}))},r.scripts.length>0||r.src.length>0?(r.scripts.forEach(function(e){var t=s.document.createElement("script");t.className="jsdom",t.onload=function(){l()},t.onerror=function(e){a||(a=[]),a.push(e.error),l()},t.src=e;try{s.document.documentElement.appendChild(t)}catch(r){a||(a=[]),a.push(r.error||r.message),l()}}),r.src.forEach(function(e){var t=s.document.createElement("script");t.onload=function(){process.nextTick(l)},t.onerror=function(e){a||(a=[]),a.push(e.error||e.message),process.nextTick(l)},t.text=e,s.document.documentElement.appendChild(t),s.document.documentElement.removeChild(t)})):l(),void 0):n(Error("JSDOM: a window object could not be created.")))};r.html+="",r.html.indexOf("\n")>0||r.html.match(/^\W*</)?o(null,r.html):(e=URL.parse(r.html),r.url=r.url||e.href,e.hostname?request({uri:e,encoding:r.encoding||"utf8",headers:r.headers||{},proxy:r.proxy||null},function(e,t,r){o(e,r)}):fs.readFile(r.html,o))},exports.env.processArguments=function(e){if(!e||!e.length||e.length<1)throw Error("No arguments passed to jsdom.env().");var t={html:!0,done:!0,scripts:!1,config:!1,url:!1,document:!1},r=Object.keys(t),n={code:[]},o=e.length;return 1===o?n=e[0]:e.forEach(function(e){var t=typeof e;e&&("string"===t||e+""===e?n.html=e:"object"===t?e.length&&e[0]?n.scripts=e:(r.forEach(function(t){void 0!==e[t]&&void 0===n[t]&&(n[t]=e[t],delete e[t])}),n.config=e):"function"===t&&(n.done=e))}),r.forEach(function(e){var r=t[e];if(r&&void 0===n[e])throw Error("jsdom.env requires a '"+e+"' argument")}),n};