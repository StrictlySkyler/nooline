/**
 * Wrapper for built-in http.js to emulate the browser XMLHttpRequest object.
 *
 * This can be used with JS designed for browsers to improve reuse of code and
 * allow the use of existing libraries.
 *
 * Usage: include("XMLHttpRequest.js") and use XMLHttpRequest per W3C specs.
 *
 * @author Dan DeFelippi <dan@driverdan.com>
 * @contributor David Ellis <d.f.ellis@ieee.org>
 * @license MIT
 */

var Url=require("url"),spawn=require("child_process").spawn,fs=null;exports.XMLHttpRequest=function(){var e,t,s,n,r,o=this,a=null,i=null,h={},c={"User-Agent":"node-XMLHttpRequest",Accept:"*/*"},u=c,d=["accept-charset","accept-encoding","access-control-request-headers","access-control-request-method","connection","content-length","content-transfer-encoding","cookie","cookie2","date","expect","host","keep-alive","origin","referer","te","trailer","transfer-encoding","upgrade","via"],E=["TRACE","TRACK","CONNECT"],l=!1,p=!1,f={};this.UNSENT=0,this.OPENED=1,this.HEADERS_RECEIVED=2,this.LOADING=3,this.DONE=4,this.readyState=this.UNSENT,this.onreadystatechange=null,this.responseText="",this.responseXML="",this.status=null,this.statusText=null,s=function(e){return e&&-1===d.indexOf(e.toLowerCase())},n=function(e){return e&&-1===E.indexOf(e)},this.open=function(e,t,s,o,a){if(this.abort(),p=!1,!n(e))throw"SecurityError: Request method not allowed";h={method:e,url:""+t,async:"boolean"!=typeof s?!0:s,user:o||null,password:a||null},r(this.OPENED)},this.setRequestHeader=function(e,t){if(this.readyState!=this.OPENED)throw"INVALID_STATE_ERR: setRequestHeader can only be called when state is OPEN";if(!s(e))return console.warn('Refused to set unsafe header "'+e+'"'),void 0;if(l)throw"INVALID_STATE_ERR: send flag is true";u[e]=t},this.getResponseHeader=function(e){return"string"==typeof e&&this.readyState>this.OPENED&&t.headers[e.toLowerCase()]&&!p?t.headers[e.toLowerCase()]:null},this.getAllResponseHeaders=function(){var e,s;if(this.readyState<this.HEADERS_RECEIVED||p)return"";e="";for(s in t.headers)"set-cookie"!==s&&"set-cookie2"!==s&&(e+=s+": "+t.headers[s]+"\r\n");return e.substr(0,e.length-2)},this.getRequestHeader=function(e){return"string"==typeof e&&u[e]?u[e]:""},this.send=function(s){var n,c,d,E,f,T,S,R,y,N,O,D;if(this.readyState!=this.OPENED)throw"INVALID_STATE_ERR: connection must be opened before send() is called";if(l)throw"INVALID_STATE_ERR: send has already been called";switch(n=!1,c=!1,d=Url.parse(h.url),d.protocol){case"https:":n=!0;case"http:":E=d.hostname;break;case"file:":c=!0;break;case void 0:case"":E="localhost";break;default:throw"Protocol not supported."}if(c){if("GET"!==h.method)throw"XMLHttpRequest: Only GET method is supported";if(h.async)fs.readFile(d.pathname,"utf8",function(e,t){e?o.handleError(e):(o.status=200,o.responseText=t,r(o.DONE))});else try{this.responseText=fs.readFileSync(d.pathname,"utf8"),this.status=200,r(o.DONE)}catch(g){this.handleError(g)}}else if(f=d.port||(n?443:80),T=d.pathname+(d.search?d.search:""),u.Host=E,n&&443===f||80===f||(u.Host+=":"+d.port),h.user&&(void 0===h.password&&(h.password=""),S=new Buffer(h.user+":"+h.password),u.Authorization="Basic "+S.toString("base64")),"GET"===h.method||"HEAD"===h.method?s=null:s?(u["Content-Length"]=Buffer.byteLength(s),u["Content-Type"]||(u["Content-Type"]="text/plain;charset=UTF-8")):"POST"===h.method&&(u["Content-Length"]=0),R={host:E,port:f,path:T,method:h.method,headers:u},p=!1,h.async)y=n?i.request:a.request,l=!0,o.dispatchEvent("readystatechange"),e=y(R,function(e){t=e,t.setEncoding("utf8"),r(o.HEADERS_RECEIVED),o.status=t.statusCode,t.on("data",function(e){e&&(o.responseText+=e),l&&r(o.LOADING)}),t.on("end",function(){l&&(r(o.DONE),l=!1)}),t.on("error",function(e){o.handleError(e)})}).on("error",function(e){o.handleError(e)}),s&&e.write(s),e.end(),o.dispatchEvent("loadstart");else{for(N=".node-xmlhttprequest-sync-"+process.pid,fs.writeFileSync(N,"","utf8"),O="var http = null;var doRequest = http"+(n?"s":"")+".request;"+"var options = "+JSON.stringify(R)+";"+"var responseText = '';"+"var req = doRequest(options, function(response) {"+"response.setEncoding('utf8');"+"response.on('data', function(chunk) {"+"responseText += chunk;"+"});"+"response.on('end', function() {"+"fs.writeFileSync('"+N+"', 'NODE-XMLHTTPREQUEST-STATUS:' + response.statusCode + ',' + responseText, 'utf8');"+"});"+"response.on('error', function(error) {"+"fs.writeFileSync('"+N+"', 'NODE-XMLHTTPREQUEST-ERROR:' + JSON.stringify(error), 'utf8');"+"});"+"}).on('error', function(error) {"+"fs.writeFileSync('"+N+"', 'NODE-XMLHTTPREQUEST-ERROR:' + JSON.stringify(error), 'utf8');"+"});"+(s?"req.write('"+s.replace(/'/g,"\\'")+"');":"")+"req.end();",syncProc=spawn(process.argv[0],["-e",O]);""==(o.responseText=fs.readFileSync(N,"utf8")););syncProc.stdin.end(),fs.unlinkSync(N),o.responseText.match(/^NODE-XMLHTTPREQUEST-ERROR:/)?(D=o.responseText.replace(/^NODE-XMLHTTPREQUEST-ERROR:/,""),o.handleError(D)):(o.status=o.responseText.replace(/^NODE-XMLHTTPREQUEST-STATUS:([0-9]*),.*/,"$1"),o.responseText=o.responseText.replace(/^NODE-XMLHTTPREQUEST-STATUS:[0-9]*,(.*)/,"$1"),r(o.DONE))}},this.handleError=function(e){this.status=503,this.statusText=e,this.responseText=e.stack,p=!0,r(this.DONE)},this.abort=function(){e&&(e.abort(),e=null),u=c,this.responseText="",this.responseXML="",p=!0,this.readyState===this.UNSENT||this.readyState===this.OPENED&&!l||this.readyState===this.DONE||(l=!1,r(this.DONE)),this.readyState=this.UNSENT},this.addEventListener=function(e,t){e in f||(f[e]=[]),f[e].push(t)},this.removeEventListener=function(e,t){e in f&&(f[e]=f[e].filter(function(e){return e!==t}))},this.dispatchEvent=function(e){if("function"==typeof o["on"+e]&&o["on"+e](),e in f)for(var t=0,s=f[e].length;s>t;t++)f[e][t].call(o)},r=function(e){o.readyState!==e&&(o.readyState=e,(h.async||o.readyState<o.OPENED||o.readyState===o.DONE)&&o.dispatchEvent("readystatechange"),o.readyState!==o.DONE||p||(o.dispatchEvent("load"),o.dispatchEvent("loadend")))}};