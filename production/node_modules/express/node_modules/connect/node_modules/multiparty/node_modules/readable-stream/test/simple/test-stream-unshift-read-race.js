// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.

function pushError(){assert.throws(function(){r.push(new Buffer(1))})}var i,c,pos,pushedNull,w,written,ended,finished,common=null,assert=null,stream=null,hwm=10,r=stream.Readable({highWaterMark:hwm}),chunks=10,t=5*chunks,data=new Buffer(chunks*hwm+Math.ceil(hwm/2));for(i=0;i<data.length;i++)c="asdf".charCodeAt(i%4),data[i]=c;pos=0,pushedNull=!1,r._read=function(e){function s(s){assert(!pushedNull,"push() after null push");var t;pos>=data.length?t=null:(e+pos>data.length&&(e=data.length-pos),t=data.slice(pos,pos+e)),pushedNull=null===t,s?(pos+=e,r.push(t),null===t&&pushError()):setTimeout(function(){pos+=e,r.push(t),null===t&&pushError()})}assert(!pushedNull,"_read after null push"),s(!(chunks%3))},w=stream.Writable(),written=[],w._write=function(e,s,t){written.push(""+e),t()},ended=!1,r.on("end",function(){assert(!ended,"end emitted more than once"),assert.throws(function(){r.unshift(new Buffer(1))}),ended=!0,w.end()}),r.on("readable",function(){for(var e;null!==(e=r.read(10));)w.write(e),e.length>4&&r.unshift(new Buffer("1234"))}),finished=!1,w.on("finish",function(){var e,s,t,n;for(finished=!0,assert.equal(written[0],"asdfasdfas"),e="d",console.error("0: %s",written[0]),s=1;s<written.length;s++)for(console.error("%s: %s",s.toString(32),written[s]),assert.equal(written[s].slice(0,4),"1234"),t=4;t<written[s].length;t++)switch(n=written[s].charAt(t),assert.equal(n,e),e){case"a":e="s";break;case"s":e="d";break;case"d":e="f";break;case"f":e="a"}}),process.on("exit",function(){assert.equal(written.length,18),assert(ended,"stream ended"),assert(finished,"stream finished"),console.log("ok")});