// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.

function zlibBuffer(i,e,n){function t(){for(var e;null!==(e=i.read());)s.push(e),l+=e.length;i.once("readable",t)}function r(e){i.removeListener("end",o),i.removeListener("readable",t),n(e)}function o(){var i=Buffer.concat(s,l);s=[],n(null,i)}var s=[],l=0;i.on("error",r),i.on("end",o),i.end(e),t()}function Deflate(i){return this instanceof Deflate?(Zlib.call(this,i,binding.DEFLATE),void 0):new Deflate(i)}function Inflate(i){return this instanceof Inflate?(Zlib.call(this,i,binding.INFLATE),void 0):new Inflate(i)}function Gzip(i){return this instanceof Gzip?(Zlib.call(this,i,binding.GZIP),void 0):new Gzip(i)}function Gunzip(i){return this instanceof Gunzip?(Zlib.call(this,i,binding.GUNZIP),void 0):new Gunzip(i)}function DeflateRaw(i){return this instanceof DeflateRaw?(Zlib.call(this,i,binding.DEFLATERAW),void 0):new DeflateRaw(i)}function InflateRaw(i){return this instanceof InflateRaw?(Zlib.call(this,i,binding.INFLATERAW),void 0):new InflateRaw(i)}function Unzip(i){return this instanceof Unzip?(Zlib.call(this,i,binding.UNZIP),void 0):new Unzip(i)}function Zlib(i,e){if(this._opts=i=i||{},this._chunkSize=i.chunkSize||exports.Z_DEFAULT_CHUNK,Transform.call(this,i),this._readableState.chunkSize=null,i.chunkSize&&(i.chunkSize<exports.Z_MIN_CHUNK||i.chunkSize>exports.Z_MAX_CHUNK))throw Error("Invalid chunk size: "+i.chunkSize);if(i.windowBits&&(i.windowBits<exports.Z_MIN_WINDOWBITS||i.windowBits>exports.Z_MAX_WINDOWBITS))throw Error("Invalid windowBits: "+i.windowBits);if(i.level&&(i.level<exports.Z_MIN_LEVEL||i.level>exports.Z_MAX_LEVEL))throw Error("Invalid compression level: "+i.level);if(i.memLevel&&(i.memLevel<exports.Z_MIN_MEMLEVEL||i.memLevel>exports.Z_MAX_MEMLEVEL))throw Error("Invalid memLevel: "+i.memLevel);if(i.strategy&&i.strategy!=exports.Z_FILTERED&&i.strategy!=exports.Z_HUFFMAN_ONLY&&i.strategy!=exports.Z_RLE&&i.strategy!=exports.Z_FIXED&&i.strategy!=exports.Z_DEFAULT_STRATEGY)throw Error("Invalid strategy: "+i.strategy);if(i.dictionary&&!Buffer.isBuffer(i.dictionary))throw Error("Invalid dictionary: it should be a Buffer instance");this._binding=new binding.Zlib(e);var n=this;this._hadError=!1,this._binding.onerror=function(i,e){n._binding=null,n._hadError=!0;var t=Error(i);t.errno=e,t.code=exports.codes[e],n.emit("error",t)},this._binding.init(i.windowBits||exports.Z_DEFAULT_WINDOWBITS,i.level||exports.Z_DEFAULT_COMPRESSION,i.memLevel||exports.Z_DEFAULT_MEMLEVEL,i.strategy||exports.Z_DEFAULT_STRATEGY,i.dictionary),this._buffer=new Buffer(this._chunkSize),this._offset=0,this._closed=!1,this.once("end",this.close)}var Transform=null,binding=process.binding("zlib"),util=null,assert=null.ok;binding.Z_MIN_WINDOWBITS=8,binding.Z_MAX_WINDOWBITS=15,binding.Z_DEFAULT_WINDOWBITS=15,binding.Z_MIN_CHUNK=64,binding.Z_MAX_CHUNK=1/0,binding.Z_DEFAULT_CHUNK=16384,binding.Z_MIN_MEMLEVEL=1,binding.Z_MAX_MEMLEVEL=9,binding.Z_DEFAULT_MEMLEVEL=8,binding.Z_MIN_LEVEL=-1,binding.Z_MAX_LEVEL=9,binding.Z_DEFAULT_LEVEL=binding.Z_DEFAULT_COMPRESSION,Object.keys(binding).forEach(function(i){i.match(/^Z/)&&(exports[i]=binding[i])}),exports.codes={Z_OK:binding.Z_OK,Z_STREAM_END:binding.Z_STREAM_END,Z_NEED_DICT:binding.Z_NEED_DICT,Z_ERRNO:binding.Z_ERRNO,Z_STREAM_ERROR:binding.Z_STREAM_ERROR,Z_DATA_ERROR:binding.Z_DATA_ERROR,Z_MEM_ERROR:binding.Z_MEM_ERROR,Z_BUF_ERROR:binding.Z_BUF_ERROR,Z_VERSION_ERROR:binding.Z_VERSION_ERROR},Object.keys(exports.codes).forEach(function(i){exports.codes[exports.codes[i]]=i}),exports.Deflate=Deflate,exports.Inflate=Inflate,exports.Gzip=Gzip,exports.Gunzip=Gunzip,exports.DeflateRaw=DeflateRaw,exports.InflateRaw=InflateRaw,exports.Unzip=Unzip,exports.createDeflate=function(i){return new Deflate(i)},exports.createInflate=function(i){return new Inflate(i)},exports.createDeflateRaw=function(i){return new DeflateRaw(i)},exports.createInflateRaw=function(i){return new InflateRaw(i)},exports.createGzip=function(i){return new Gzip(i)},exports.createGunzip=function(i){return new Gunzip(i)},exports.createUnzip=function(i){return new Unzip(i)},exports.deflate=function(i,e){zlibBuffer(new Deflate,i,e)},exports.gzip=function(i,e){zlibBuffer(new Gzip,i,e)},exports.deflateRaw=function(i,e){zlibBuffer(new DeflateRaw,i,e)},exports.unzip=function(i,e){zlibBuffer(new Unzip,i,e)},exports.inflate=function(i,e){zlibBuffer(new Inflate,i,e)},exports.gunzip=function(i,e){zlibBuffer(new Gunzip,i,e)},exports.inflateRaw=function(i,e){zlibBuffer(new InflateRaw,i,e)},util.inherits(Zlib,Transform),Zlib.prototype.reset=function(){return this._binding.reset()},Zlib.prototype._flush=function(i,e){var n=this._readableState,t=this;this._transform(null,i,function(i){return i?e(i):(n.length&&n.length<n.lowWaterMark&&!n.ended&&n.needReadable&&t.emit("readable"),e(),void 0)})},Zlib.prototype.flush=function(i){var e,n=this._writableState,t=this._transformState;return n.writing?(n.needDrain=!0,e=this,this.once("drain",function(){e._flush(t.output,i)}),void 0):(this._flush(t.output,i||function(){}),void 0)},Zlib.prototype.close=function(i){if(i&&process.nextTick(i),!this._closed){this._closed=!0,this._binding.close();var e=this;process.nextTick(function(){e.emit("close")})}},Zlib.prototype._transform=function(i,e,n){function t(f,_){var u,c,d;if(!a._hadError)return u=s-_,assert(u>=0,"have should not go down"),u>0&&(c=a._buffer.slice(a._offset,a._offset+u),a._offset+=u,e(c)),(0===_||a._offset>=a._chunkSize)&&(s=a._chunkSize,a._offset=0,a._buffer=new Buffer(a._chunkSize)),0===_?(l+=o-f,o=f,d=a._binding.write(r,i,l,o,a._buffer,a._offset,a._chunkSize),d.callback=t,d.buffer=i,void 0):(n(),void 0)}var r,o,s,l,f,a,_=this._writableState,u=_.ending||_.ended,c=u&&(!i||_.length===i.length);return null===i||Buffer.isBuffer(i)?(r=c?binding.Z_FINISH:null===i?binding.Z_FULL_FLUSH:binding.Z_NO_FLUSH,o=i&&i.length,s=this._chunkSize-this._offset,l=0,f=this._binding.write(r,i,l,o,this._buffer,this._offset,s),f.buffer=i,f.callback=t,a=this,void 0):n(Error("invalid input"))},util.inherits(Deflate,Zlib),util.inherits(Inflate,Zlib),util.inherits(Gzip,Zlib),util.inherits(Gunzip,Zlib),util.inherits(DeflateRaw,Zlib),util.inherits(InflateRaw,Zlib),util.inherits(Unzip,Zlib);