// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.

function TestReader(x){R.apply(this),this._buffer=new Buffer(x||100),this._buffer.fill("x"),this._pos=0,this._bufs=10}function TestWriter(){EE.apply(this),this.received=[],this.flush=!1}function test(x,e){count++,tests.push([x,e])}function run(){var x,e,t=tests.shift();return t?(x=t[0],e=t[1],console.log("# %s",x),e({same:assert.deepEqual,ok:assert,equal:assert.equal,end:function(){count--,run()}}),void 0):console.error("ok")}var tests,count,common=null,R=null,assert=null,util=null,EE=null.EventEmitter;util.inherits(TestReader,R),TestReader.prototype._read=function(x){var e,t,n=this._buffer.length-this._pos;return x=Math.max(x,0),e=Math.min(x,n),0===e?(setTimeout(function(){this._pos=0,this._bufs-=1,this._bufs<=0?this.ended||this.push(null):this._read(x)}.bind(this),10),void 0):(t=this._buffer.slice(this._pos,this._pos+e),this._pos+=e,this.push(t),void 0)},util.inherits(TestWriter,EE),TestWriter.prototype.write=function(x){return this.received.push(""+x),this.emit("write",x),!0},TestWriter.prototype.end=function(x){x&&this.write(x),this.emit("end",this.received)},tests=[],count=0,process.on("exit",function(){assert.equal(count,0)}),process.nextTick(run),test("a most basic test",function(x){function e(){for(var x;null!==(x=n.read(t++));)s.push(""+x);n.once("readable",e)}var t,n=new TestReader(20),s=[],i=["x","xx","xxx","xxxx","xxxxx","xxxxxxxxx","xxxxxxxxxx","xxxxxxxxxxxx","xxxxxxxxxxxxx","xxxxxxxxxxxxxxx","xxxxxxxxxxxxxxxxx","xxxxxxxxxxxxxxxxxxx","xxxxxxxxxxxxxxxxxxxxx","xxxxxxxxxxxxxxxxxxxxxxx","xxxxxxxxxxxxxxxxxxxxxxxxx","xxxxxxxxxxxxxxxxxxxxx"];n.on("end",function(){x.same(s,i),x.end()}),t=1,e()}),test("pipe",function(x){var e=new TestReader(5),t=["xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx"],n=new TestWriter;n.on("end",function(e){x.same(e,t),x.end()}),e.pipe(n)}),[1,2,3,4,5,6,7,8,9].forEach(function(x){test("unpipe",function(e){var t,n,s,i,r,o=new TestReader(5),u=["xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx"];u=[u.slice(0,x),u.slice(x)],t=[new TestWriter,new TestWriter],n=x,t[0].on("write",function(){0===--n&&(o.unpipe(),e.equal(o._readableState.pipes,null),t[0].end(),o.pipe(t[1]),e.equal(o._readableState.pipes,t[1]))}),s=0,i=!1,r=!1,t[0].on("end",function(x){e.equal(i,!1),i=!0,s++,e.same(x,u[0])}),t[1].on("end",function(x){e.equal(r,!1),r=!0,s++,e.equal(s,2),e.same(x,u[1]),e.end()}),o.pipe(t[0])})}),test("multipipe",function(x){var e=new TestReader(5),t=[new TestWriter,new TestWriter],n=["xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx"],s=2;t[0].on("end",function(e){x.same(e,n,"first"),0===--s&&x.end()}),t[1].on("end",function(e){x.same(e,n,"second"),0===--s&&x.end()}),e.pipe(t[0]),e.pipe(t[1])}),[1,2,3,4,5,6,7,8,9].forEach(function(x){test("multi-unpipe",function(e){var t,n,s,i=new TestReader(5),r=["xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx","xxxxx"];r=[r.slice(0,x),r.slice(x)],t=[new TestWriter,new TestWriter,new TestWriter],n=x,t[0].on("write",function(){0===--n&&(i.unpipe(),t[0].end(),i.pipe(t[1]))}),s=0,t[0].on("end",function(x){s++,e.same(x,r[0])}),t[1].on("end",function(x){s++,e.equal(s,2),e.same(x,r[1]),e.end()}),i.pipe(t[0]),i.pipe(t[2])})}),test("back pressure respected",function(x){function e(){}var t,n,s,i,r,o=new R({objectMode:!0});o._read=e,t=0,o.push(["one"]),o.push(["two"]),o.push(["three"]),o.push(["four"]),o.push(null),n=new R,n.write=function(x){console.error('w1.emit("close")'),assert.equal(x[0],"one"),n.emit("close"),process.nextTick(function(){o.pipe(i),o.pipe(r)})},n.end=e,o.pipe(n),s=["two","two","three","three","four","four"],i=new R,i.write=function(x){return console.error("w2 write",x,t),assert.equal(x[0],s.shift()),assert.equal(t,0),t++,"four"===x[0]?!0:(setTimeout(function(){t--,console.error("w2 drain"),i.emit("drain")},10),!1)},i.end=e,r=new R,r.write=function(x){return console.error("w3 write",x,t),assert.equal(x[0],s.shift()),assert.equal(t,1),t++,"four"===x[0]?!0:(setTimeout(function(){t--,console.error("w3 drain"),r.emit("drain")},50),!1)},r.end=function(){assert.equal(t,2),assert.equal(s.length,0),x.end()}}),test("read(0) for ended streams",function(x){var e,t,n=new R,s=!1,i=!1;n._read=function(){},n.push(new Buffer("foo")),n.push(null),e=n.read(0),assert.equal(e,null),t=new R,t.write=function(x){s=!0,assert.equal(i,!1),assert.equal(""+x,"foo")},t.end=function(){i=!0,assert.equal(s,!0),x.end()},n.pipe(t)}),test("sync _read ending",function(x){var e=new R,t=!1;e._read=function(){e.push(null)},e.once("end",function(){t=!0}),e.read(),process.nextTick(function(){assert.equal(t,!0),x.end()})}),test("adding readable triggers data flow",function(x){var e=new R({highWaterMark:5}),t=!1,n=0;e._read=function(){2===n++?e.push(null):e.push(new Buffer("asdf"))},e.on("readable",function(){t=!0,e.read()}),e.on("end",function(){x.equal(n,3),x.ok(t),x.end()})});