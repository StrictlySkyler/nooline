// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.

function protoCtrChain(t){for(var r=[];t;t=t.__proto__)r.push(t.constructor);return r.join()}function runCallChecks(t){if(0===t){var r=mustCallChecks.filter(function(t){return t.actual!==t.expected});r.forEach(function(t){console.log("Mismatched %s function calls. Expected %d, actual %d.",t.name,t.expected,t.actual),console.log(t.stack.split("\n").slice(2).join("\n"))}),r.length&&process.exit(1)}}var util,i,mustCallChecks,path=null,assert=null;exports.testDir=path.dirname(__filename),exports.fixturesDir=path.join(exports.testDir,"fixtures"),exports.libDir=path.join(exports.testDir,"../lib"),exports.tmpDir=path.join(exports.testDir,"tmp"),exports.PORT=+process.env.NODE_COMMON_PORT||12346,exports.PIPE="win32"===process.platform?"\\\\.\\pipe\\libuv-test":exports.tmpDir+"/test.sock",util=null;for(i in util)exports[i]=util[i];exports.indirectInstanceOf=function(t,r){var e,s;return t instanceof r?!0:(e=protoCtrChain(r.prototype),s=protoCtrChain(t),s.slice(-e.length)===e)},exports.ddCommand=function(t,r){if("win32"===process.platform){var e=path.resolve(exports.fixturesDir,"create-file.js");return'"'+process.argv[0]+'" "'+e+'" "'+t+'" '+1024*r}return'dd if=/dev/zero of="'+t+'" bs=1024 count='+r},exports.spawnCat=function(t){var r=null.spawn;return"win32"===process.platform?r("more",[],t):r("cat",[],t)},exports.spawnPwd=function(t){var r=null.spawn;return"win32"===process.platform?r("cmd.exe",["/c","cd"],t):r("pwd",[],t)},exports.globalCheck=!0,process.on("exit",function(){var t,r,e,s;if(exports.globalCheck){t=[setTimeout,setInterval,setImmediate,clearTimeout,clearInterval,clearImmediate,console,Buffer,process,global],global.gc&&t.push(gc),global.DTRACE_HTTP_SERVER_RESPONSE&&(t.push(DTRACE_HTTP_SERVER_RESPONSE),t.push(DTRACE_HTTP_SERVER_REQUEST),t.push(DTRACE_HTTP_CLIENT_RESPONSE),t.push(DTRACE_HTTP_CLIENT_REQUEST),t.push(DTRACE_NET_STREAM_END),t.push(DTRACE_NET_SERVER_CONNECTION),t.push(DTRACE_NET_SOCKET_READ),t.push(DTRACE_NET_SOCKET_WRITE)),global.COUNTER_NET_SERVER_CONNECTION&&(t.push(COUNTER_NET_SERVER_CONNECTION),t.push(COUNTER_NET_SERVER_CONNECTION_CLOSE),t.push(COUNTER_HTTP_SERVER_REQUEST),t.push(COUNTER_HTTP_SERVER_RESPONSE),t.push(COUNTER_HTTP_CLIENT_REQUEST),t.push(COUNTER_HTTP_CLIENT_RESPONSE)),global.ArrayBuffer&&(t.push(ArrayBuffer),t.push(Int8Array),t.push(Uint8Array),t.push(Uint8ClampedArray),t.push(Int16Array),t.push(Uint16Array),t.push(Int32Array),t.push(Uint32Array),t.push(Float32Array),t.push(Float64Array),t.push(DataView));for(r in global){e=!1;for(s in t)if(global[r]===t[s]){e=!0;break}e||(console.error("Unknown global: %s",r),assert.ok(!1,"Unknown global found"))}}}),mustCallChecks=[],exports.mustCall=function(t,r){"number"!=typeof r&&(r=1);var e={expected:r,actual:0,stack:Error().stack,name:t.name||"<anonymous>"};return 0===mustCallChecks.length&&process.on("exit",runCallChecks),mustCallChecks.push(e),function(){return e.actual++,t.apply(this,arguments)}};