// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.

function ReadableState(e){e=e||{};var t=e.highWaterMark;this.highWaterMark=t||0===t?t:16384,this.highWaterMark=~~this.highWaterMark,this.buffer=[],this.length=0,this.pipes=null,this.pipesCount=0,this.flowing=null,this.ended=!1,this.endEmitted=!1,this.reading=!1,this.sync=!0,this.needReadable=!1,this.emittedReadable=!1,this.readableListening=!1,this.objectMode=!!e.objectMode,this.defaultEncoding=e.defaultEncoding||"utf8",this.ranOut=!1,this.awaitDrain=0,this.readingMore=!1,this.decoder=null,this.encoding=null,e.encoding&&(StringDecoder||(StringDecoder=null.StringDecoder),this.decoder=new StringDecoder(e.encoding),this.encoding=e.encoding)}function Readable(e){return this instanceof Readable?(this._readableState=new ReadableState(e,this),this.readable=!0,Stream.call(this),void 0):new Readable(e)}function readableAddChunk(e,t,n,i,r){var a,d=chunkInvalid(t,n);return d?e.emit("error",d):util.isNullOrUndefined(n)?(t.reading=!1,t.ended||onEofChunk(e,t)):t.objectMode||n&&n.length>0?t.ended&&!r?(a=Error("stream.push() after EOF"),e.emit("error",a)):t.endEmitted&&r?(a=Error("stream.unshift() after end event"),e.emit("error",a)):(!t.decoder||r||i||(n=t.decoder.write(n)),r||(t.reading=!1),t.flowing&&0===t.length&&!t.sync?(e.emit("data",n),e.read(0)):(t.length+=t.objectMode?1:n.length,r?t.buffer.unshift(n):t.buffer.push(n),t.needReadable&&emitReadable(e)),maybeReadMore(e,t)):r||(t.reading=!1),needMoreData(t)}function needMoreData(e){return!e.ended&&(e.needReadable||e.length<e.highWaterMark||0===e.length)}function roundUpToNextPowerOf2(e){if(e>=MAX_HWM)e=MAX_HWM;else{e--;for(var t=1;32>t;t<<=1)e|=e>>t;e++}return e}function howMuchToRead(e,t){return 0===t.length&&t.ended?0:t.objectMode?0===e?0:1:isNaN(e)||util.isNull(e)?t.flowing&&t.buffer.length?t.buffer[0].length:t.length:0>=e?0:(e>t.highWaterMark&&(t.highWaterMark=roundUpToNextPowerOf2(e)),e>t.length?t.ended?t.length:(t.needReadable=!0,0):e)}function chunkInvalid(e,t){var n=null;return util.isBuffer(t)||util.isString(t)||util.isNullOrUndefined(t)||e.objectMode||n||(n=new TypeError("Invalid non-string/buffer chunk")),n}function onEofChunk(e,t){if(t.decoder&&!t.ended&&t.decoder.end){var n=t.decoder.end();n&&n.length&&(t.buffer.push(n),t.length+=t.objectMode?1:n.length)}t.ended=!0,emitReadable(e)}function emitReadable(e){var t=e._readableState;t.needReadable=!1,t.emittedReadable||(debug("emitReadable",t.flowing),t.emittedReadable=!0,t.sync?process.nextTick(function(){emitReadable_(e)}):emitReadable_(e))}function emitReadable_(e){debug("emit readable"),e.emit("readable"),flow(e)}function maybeReadMore(e,t){t.readingMore||(t.readingMore=!0,process.nextTick(function(){maybeReadMore_(e,t)}))}function maybeReadMore_(e,t){for(var n=t.length;!t.reading&&!t.flowing&&!t.ended&&t.length<t.highWaterMark&&(debug("maybeReadMore read 0"),e.read(0),n!==t.length);)n=t.length;t.readingMore=!1}function pipeOnDrain(e){return function(){var t=e._readableState;debug("pipeOnDrain",t.awaitDrain),t.awaitDrain&&t.awaitDrain--,0===t.awaitDrain&&EE.listenerCount(e,"data")&&(t.flowing=!0,flow(e))}}function resume(e,t){t.resumeScheduled||(t.resumeScheduled=!0,process.nextTick(function(){resume_(e,t)}))}function resume_(e,t){t.resumeScheduled=!1,e.emit("resume"),flow(e),t.flowing&&!t.reading&&e.read(0)}function flow(e){var t,n=e._readableState;if(debug("flow",n.flowing),n.flowing)do t=e.read();while(null!==t&&n.flowing)}function fromList(e,t){var n,i,r,a,d,o,l=t.buffer,u=t.length,s=!!t.decoder,h=!!t.objectMode;if(0===l.length)return null;if(0===u)n=null;else if(h)n=l.shift();else if(!e||e>=u)n=s?l.join(""):Buffer.concat(l,u),l.length=0;else if(e<l[0].length)i=l[0],n=i.slice(0,e),l[0]=i.slice(e);else if(e===l[0].length)n=l.shift();else for(n=s?"":new Buffer(e),r=0,a=0,d=l.length;d>a&&e>r;a++)i=l[0],o=Math.min(e-r,i.length),s?n+=i.slice(0,o):i.copy(n,r,0,o),o<i.length?l[0]=i.slice(o):l.shift(),r+=o;return n}function endReadable(e){var t=e._readableState;if(t.length>0)throw Error("endReadable called on non-empty stream");t.endEmitted||(t.ended=!0,process.nextTick(function(){t.endEmitted||0!==t.length||(t.endEmitted=!0,e.readable=!1,e.emit("end"))}))}var EE,Stream,util,utilIs,f,StringDecoder,debug,MAX_HWM;if(module.exports=Readable,Readable.ReadableState=ReadableState,EE=null.EventEmitter,EE.listenerCount||(EE.listenerCount=function(e,t){return e.listeners(t).length}),global.setImmediate||(global.setImmediate=function(e){return setTimeout(e,0)}),global.clearImmediate||(global.clearImmediate=function(e){return clearTimeout(e)}),Stream=null,util=null,!util.isUndefined){utilIs=null;for(f in utilIs)util[f]=utilIs[f]}if(util.debuglog)debug=util.debuglog("stream");else try{debug=null}catch(er){debug=function(){}}util.inherits(Readable,Stream),Readable.prototype.push=function(e,t){var n=this._readableState;return util.isString(e)&&!n.objectMode&&(t=t||n.defaultEncoding,t!==n.encoding&&(e=new Buffer(e,t),t="")),readableAddChunk(this,n,e,t,!1)},Readable.prototype.unshift=function(e){var t=this._readableState;return readableAddChunk(this,t,e,"",!0)},Readable.prototype.setEncoding=function(e){StringDecoder||(StringDecoder=null.StringDecoder),this._readableState.decoder=new StringDecoder(e),this._readableState.encoding=e},MAX_HWM=8388608,Readable.prototype.read=function(e){var t,n,i,r;return debug("read",e),t=this._readableState,n=e,(!util.isNumber(e)||e>0)&&(t.emittedReadable=!1),0===e&&t.needReadable&&(t.length>=t.highWaterMark||t.ended)?(debug("read: emitReadable",t.length,t.ended),0===t.length&&t.ended?endReadable(this):emitReadable(this),null):(e=howMuchToRead(e,t),0===e&&t.ended?(0===t.length&&endReadable(this),null):(i=t.needReadable,debug("need readable",i),(0===t.length||t.length-e<t.highWaterMark)&&(i=!0,debug("length less than watermark",i)),(t.ended||t.reading)&&(i=!1,debug("reading or ended",i)),i&&(debug("do read"),t.reading=!0,t.sync=!0,0===t.length&&(t.needReadable=!0),this._read(t.highWaterMark),t.sync=!1),i&&!t.reading&&(e=howMuchToRead(n,t)),r=e>0?fromList(e,t):null,util.isNull(r)&&(t.needReadable=!0,e=0),t.length-=e,0!==t.length||t.ended||(t.needReadable=!0),n!==e&&t.ended&&0===t.length&&endReadable(this),util.isNull(r)||this.emit("data",r),r))},Readable.prototype._read=function(){this.emit("error",Error("not implemented"))},Readable.prototype.pipe=function(e,t){function n(e){debug("onunpipe"),e===g&&r()}function i(){debug("onend"),e.end()}function r(){debug("cleanup"),e.removeListener("close",o),e.removeListener("finish",l),e.removeListener("drain",f),e.removeListener("error",d),e.removeListener("unpipe",n),g.removeListener("end",i),g.removeListener("end",r),g.removeListener("data",a),!b.awaitDrain||e._writableState&&!e._writableState.needDrain||f()}function a(t){debug("ondata");var n=e.write(t);!1===n&&(debug("false write response, pause",g._readableState.awaitDrain),g._readableState.awaitDrain++,g.pause())}function d(t){debug("onerror",t),u(),e.removeListener("error",d),0===EE.listenerCount(e,"error")&&e.emit("error",t)}function o(){e.removeListener("finish",l),u()}function l(){debug("onfinish"),e.removeListener("close",o),u()}function u(){debug("unpipe"),g.unpipe(e)}var s,h,f,g=this,b=this._readableState;switch(b.pipesCount){case 0:b.pipes=e;break;case 1:b.pipes=[b.pipes,e];break;default:b.pipes.push(e)}return b.pipesCount+=1,debug("pipe count=%d opts=%j",b.pipesCount,t),s=(!t||t.end!==!1)&&e!==process.stdout&&e!==process.stderr,h=s?i:r,b.endEmitted?process.nextTick(h):g.once("end",h),e.on("unpipe",n),f=pipeOnDrain(g),e.on("drain",f),g.on("data",a),e._events.error?Array.isArray(e._events.error)?e._events.error.unshift(d):e._events.error=[d,e._events.error]:e.on("error",d),e.once("close",o),e.once("finish",l),e.emit("pipe",g),b.flowing||(debug("pipe resume"),g.resume()),e},Readable.prototype.unpipe=function(e){var t,n,i,r=this._readableState;if(0===r.pipesCount)return this;if(1===r.pipesCount)return e&&e!==r.pipes?this:(e||(e=r.pipes),r.pipes=null,r.pipesCount=0,r.flowing=!1,e&&e.emit("unpipe",this),this);if(!e){for(t=r.pipes,n=r.pipesCount,r.pipes=null,r.pipesCount=0,r.flowing=!1,i=0;n>i;i++)t[i].emit("unpipe",this);return this}return i=r.pipes.indexOf(e),-1===i?this:(r.pipes.splice(i,1),r.pipesCount-=1,1===r.pipesCount&&(r.pipes=r.pipes[0]),e.emit("unpipe",this),this)},Readable.prototype.on=function(e,t){var n,i,r=Stream.prototype.on.call(this,e,t);return"data"===e&&!1!==this._readableState.flowing&&this.resume(),"readable"===e&&this.readable&&(n=this._readableState,n.readableListening||(n.readableListening=!0,n.emittedReadable=!1,n.needReadable=!0,n.reading?n.length&&emitReadable(this,n):(i=this,process.nextTick(function(){debug("readable nexttick read 0"),i.read(0)})))),r},Readable.prototype.addListener=Readable.prototype.on,Readable.prototype.resume=function(){var e=this._readableState;e.flowing||(debug("resume"),e.flowing=!0,e.reading||(debug("resume read 0"),this.read(0)),resume(this,e))},Readable.prototype.pause=function(){debug("call pause flowing=%j",this._readableState.flowing),!1!==this._readableState.flowing&&(debug("pause"),this._readableState.flowing=!1,this.emit("pause"))},Readable.prototype.wrap=function(e){var t,n,i=this._readableState,r=!1,a=this;e.on("end",function(){if(debug("wrapped end"),i.decoder&&!i.ended){var e=i.decoder.end();e&&e.length&&a.push(e)}a.push(null)}),e.on("data",function(t){if(debug("wrapped data"),i.decoder&&(t=i.decoder.write(t)),t&&(i.objectMode||t.length)){var n=a.push(t);n||(r=!0,e.pause())}});for(t in e)util.isFunction(e[t])&&util.isUndefined(this[t])&&(this[t]=function(t){return function(){return e[t].apply(e,arguments)}}(t));return n=["error","close","destroy","pause","resume"],n.forEach(function(t){e.on(t,a.emit.bind(a,t))}),a._read=function(t){debug("wrapped _read",t),r&&(r=!1,e.resume())},a},Readable._fromList=fromList;