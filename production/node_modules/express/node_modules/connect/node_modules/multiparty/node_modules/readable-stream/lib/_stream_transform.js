// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.

function TransformState(r,t){this.afterTransform=function(r,n){return afterTransform(t,r,n)},this.needTransform=!1,this.transforming=!1,this.writecb=null,this.writechunk=null}function afterTransform(r,t,n){var e,i,a=r._transformState;return a.transforming=!1,(e=a.writecb)?(a.writechunk=null,a.writecb=null,util.isNullOrUndefined(n)||r.push(n),e&&e(t),i=r._readableState,i.reading=!1,(i.needReadable||i.length<i.highWaterMark)&&r._read(i.highWaterMark),void 0):r.emit("error",Error("no writecb in Transform class"))}function Transform(r){if(!(this instanceof Transform))return new Transform(r);Duplex.call(this,r),this._transformState=new TransformState(r,this);var t=this;this._readableState.needReadable=!0,this._readableState.sync=!1,this.once("prefinish",function(){util.isFunction(this._flush)?this._flush(function(r){done(t,r)}):done(t)})}function done(r,t){var n,e;if(t)return r.emit("error",t);if(n=r._writableState,e=r._transformState,n.length)throw Error("calling transform done when ws.length != 0");if(e.transforming)throw Error("calling transform done when still transforming");return r.push(null)}var Duplex,util,utilIs,f;if(module.exports=Transform,Duplex=null,util=null,!util.isUndefined){utilIs=null;for(f in utilIs)util[f]=utilIs[f]}util.inherits(Transform,Duplex),Transform.prototype.push=function(r,t){return this._transformState.needTransform=!1,Duplex.prototype.push.call(this,r,t)},Transform.prototype._transform=function(){throw Error("not implemented")},Transform.prototype._write=function(r,t,n){var e,i=this._transformState;i.writecb=n,i.writechunk=r,i.writeencoding=t,i.transforming||(e=this._readableState,(i.needTransform||e.needReadable||e.length<e.highWaterMark)&&this._read(e.highWaterMark))},Transform.prototype._read=function(){var r=this._transformState;util.isNull(r.writechunk)||!r.writecb||r.transforming?r.needTransform=!0:(r.transforming=!0,this._transform(r.writechunk,r.writeencoding,r.afterTransform))};