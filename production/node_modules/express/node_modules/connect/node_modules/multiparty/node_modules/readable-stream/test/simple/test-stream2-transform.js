// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.

function test(e,r){count++,tests.push([e,r])}function run(){var e,r,n=tests.shift();return n?(e=n[0],r=n[1],console.log("# %s",e),r({same:assert.deepEqual,equal:assert.equal,ok:assert,end:function(){count--,run()}}),void 0):console.error("ok")}var assert=null,common=null,PassThrough=null.PassThrough,Transform=null.Transform,tests=[],count=0;process.on("exit",function(){assert.equal(count,0)}),process.nextTick(run),test("writable side consumption",function(e){var r,n=new Transform({highWaterMark:10}),a=0;for(n._transform=function(e,r,t){a+=e.length,n.push(e),t()},r=1;10>=r;r++)n.write(new Buffer(r));n.end(),e.equal(n._readableState.length,10),e.equal(a,10),e.equal(n._transformState.writechunk.length,5),e.same(n._writableState.buffer.map(function(e){return e.chunk.length}),[6,7,8,9,10]),e.end()}),test("passthrough",function(e){var r=new PassThrough;r.write(new Buffer("foog")),r.write(new Buffer("bark")),r.write(new Buffer("bazy")),r.write(new Buffer("kuel")),r.end(),e.equal(""+r.read(5),"foogb"),e.equal(""+r.read(5),"arkba"),e.equal(""+r.read(5),"zykue"),e.equal(""+r.read(5),"l"),e.end()}),test("object passthrough",function(e){var r=new PassThrough({objectMode:!0});r.write(1),r.write(!0),r.write(!1),r.write(0),r.write("foo"),r.write(""),r.write({a:"b"}),r.end(),e.equal(r.read(),1),e.equal(r.read(),!0),e.equal(r.read(),!1),e.equal(r.read(),0),e.equal(r.read(),"foo"),e.equal(r.read(),""),e.same(r.read(),{a:"b"}),e.end()}),test("simple transform",function(e){var r=new Transform;r._transform=function(e,n,a){var t=new Buffer(e.length);t.fill("x"),r.push(t),a()},r.write(new Buffer("foog")),r.write(new Buffer("bark")),r.write(new Buffer("bazy")),r.write(new Buffer("kuel")),r.end(),e.equal(""+r.read(5),"xxxxx"),e.equal(""+r.read(5),"xxxxx"),e.equal(""+r.read(5),"xxxxx"),e.equal(""+r.read(5),"x"),e.end()}),test("simple object transform",function(e){var r=new Transform({objectMode:!0});r._transform=function(e,n,a){r.push(JSON.stringify(e)),a()},r.write(1),r.write(!0),r.write(!1),r.write(0),r.write("foo"),r.write(""),r.write({a:"b"}),r.end(),e.equal(r.read(),"1"),e.equal(r.read(),"true"),e.equal(r.read(),"false"),e.equal(r.read(),"0"),e.equal(r.read(),'"foo"'),e.equal(r.read(),'""'),e.equal(r.read(),'{"a":"b"}'),e.end()}),test("async passthrough",function(e){var r=new Transform;r._transform=function(e,n,a){setTimeout(function(){r.push(e),a()},10)},r.write(new Buffer("foog")),r.write(new Buffer("bark")),r.write(new Buffer("bazy")),r.write(new Buffer("kuel")),r.end(),r.on("finish",function(){e.equal(""+r.read(5),"foogb"),e.equal(""+r.read(5),"arkba"),e.equal(""+r.read(5),"zykue"),e.equal(""+r.read(5),"l"),e.end()})}),test("assymetric transform (expand)",function(e){var r=new Transform;r._transform=function(e,n,a){setTimeout(function(){r.push(e),setTimeout(function(){r.push(e),a()},10)},10)},r.write(new Buffer("foog")),r.write(new Buffer("bark")),r.write(new Buffer("bazy")),r.write(new Buffer("kuel")),r.end(),r.on("finish",function(){e.equal(""+r.read(5),"foogf"),e.equal(""+r.read(5),"oogba"),e.equal(""+r.read(5),"rkbar"),e.equal(""+r.read(5),"kbazy"),e.equal(""+r.read(5),"bazyk"),e.equal(""+r.read(5),"uelku"),e.equal(""+r.read(5),"el"),e.end()})}),test("assymetric transform (compress)",function(e){var r=new Transform;r.state="",r._transform=function(e,n,a){e||(e="");var t=""+e;setTimeout(function(){this.state+=t.charAt(0),3===this.state.length&&(r.push(new Buffer(this.state)),this.state=""),a()}.bind(this),10)},r._flush=function(e){r.push(new Buffer(this.state)),this.state="",e()},r.write(new Buffer("aaaa")),r.write(new Buffer("bbbb")),r.write(new Buffer("cccc")),r.write(new Buffer("dddd")),r.write(new Buffer("eeee")),r.write(new Buffer("aaaa")),r.write(new Buffer("bbbb")),r.write(new Buffer("cccc")),r.write(new Buffer("dddd")),r.write(new Buffer("eeee")),r.write(new Buffer("aaaa")),r.write(new Buffer("bbbb")),r.write(new Buffer("cccc")),r.write(new Buffer("dddd")),r.end(),r.on("finish",function(){e.equal(""+r.read(5),"abcde"),e.equal(""+r.read(5),"abcde"),e.equal(""+r.read(5),"abcd"),e.end()})}),test("complex transform",function(e){var r=0,n=null,a=new Transform({highWaterMark:3});a._transform=function(e,t,o){1===r++?n=e:(n&&(a.push(n),n=null),a.push(e)),o()},a.once("readable",function(){process.nextTick(function(){a.write(new Buffer("d")),a.write(new Buffer("ef"),function(){a.end(),e.end()}),e.equal(""+a.read(),"abcdef"),e.equal(a.read(),null)})}),a.write(new Buffer("abc"))}),test("passthrough event emission",function(e){var r=new PassThrough,n=0;r.on("readable",function(){r._readableState,console.error(">>> emit readable %d",n),n++}),r.write(new Buffer("foog")),console.error("need emit 0"),r.write(new Buffer("bark")),console.error("should have emitted readable now 1 === %d",n),e.equal(n,1),e.equal(""+r.read(5),"foogb"),e.equal(r.read(5)+"","null"),console.error("need emit 1"),r.write(new Buffer("bazy")),console.error("should have emitted, but not again"),r.write(new Buffer("kuel")),console.error("should have emitted readable now 2 === %d",n),e.equal(n,2),e.equal(""+r.read(5),"arkba"),e.equal(""+r.read(5),"zykue"),e.equal(r.read(5),null),console.error("need emit 2"),r.end(),e.equal(n,3),e.equal(""+r.read(5),"l"),e.equal(r.read(5),null),console.error("should not have emitted again"),e.equal(n,3),e.end()}),test("passthrough event emission reordered",function(e){var r=new PassThrough,n=0;r.on("readable",function(){console.error("emit readable",n),n++}),r.write(new Buffer("foog")),console.error("need emit 0"),r.write(new Buffer("bark")),console.error("should have emitted readable now 1 === %d",n),e.equal(n,1),e.equal(""+r.read(5),"foogb"),e.equal(r.read(5),null),console.error("need emit 1"),r.once("readable",function(){e.equal(""+r.read(5),"arkba"),e.equal(r.read(5),null),console.error("need emit 2"),r.once("readable",function(){e.equal(""+r.read(5),"zykue"),e.equal(r.read(5),null),r.once("readable",function(){e.equal(""+r.read(5),"l"),e.equal(r.read(5),null),e.equal(n,4),e.end()}),r.end()}),r.write(new Buffer("kuel"))}),r.write(new Buffer("bazy"))}),test("passthrough facaded",function(e){var r,n;console.error("passthrough facaded"),r=new PassThrough,n=[],r.on("data",function(e){n.push(""+e)}),r.on("end",function(){e.same(n,["foog","bark","bazy","kuel"]),e.end()}),r.write(new Buffer("foog")),setTimeout(function(){r.write(new Buffer("bark")),setTimeout(function(){r.write(new Buffer("bazy")),setTimeout(function(){r.write(new Buffer("kuel")),setTimeout(function(){r.end()},10)},10)},10)},10)}),test("object transform (json parse)",function(e){var r,n,a;console.error("json parse stream"),r=new Transform({objectMode:!0}),r._transform=function(e,n,a){try{r.push(JSON.parse(e)),a()}catch(t){a(t)}},n=[{foo:"bar"},100,"string",{nested:{things:[{foo:"bar"},100,"string"]}}],a=!1,r.on("end",function(){a=!0}),n.forEach(function(n){r.write(JSON.stringify(n));var a=r.read();e.same(a,n)}),r.end(),r.read(),process.nextTick(function(){e.ok(a),e.end()})}),test("object transform (json stringify)",function(e){var r,n,a;console.error("json parse stream"),r=new Transform({objectMode:!0}),r._transform=function(e,n,a){try{r.push(JSON.stringify(e)),a()}catch(t){a(t)}},n=[{foo:"bar"},100,"string",{nested:{things:[{foo:"bar"},100,"string"]}}],a=!1,r.on("end",function(){a=!0}),n.forEach(function(n){r.write(n);var a=r.read();e.equal(a,JSON.stringify(n))}),r.end(),r.read(),process.nextTick(function(){e.ok(a),e.end()})});