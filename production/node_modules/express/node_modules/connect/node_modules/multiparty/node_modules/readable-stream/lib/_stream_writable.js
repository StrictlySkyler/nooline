// Copyright Joyent, Inc. and other Node contributors.
//
// Permission is hereby granted, free of charge, to any person obtaining a
// copy of this software and associated documentation files (the
// "Software"), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// The above copyright notice and this permission notice shall be included
// in all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.

function WriteReq(e,i,t){this.chunk=e,this.encoding=i,this.callback=t}function WritableState(e,i){var t,n;e=e||{},t=e.highWaterMark,this.highWaterMark=t||0===t?t:16384,this.objectMode=!!e.objectMode,this.highWaterMark=~~this.highWaterMark,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1,n=e.decodeStrings===!1,this.decodeStrings=!n,this.defaultEncoding=e.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(e){onwrite(i,e)},this.writecb=null,this.writelen=0,this.buffer=[],this.pendingcb=0,this.prefinished=!1}function Writable(e){return this instanceof Writable||this instanceof null?(this._writableState=new WritableState(e,this),this.writable=!0,Stream.call(this),void 0):new Writable(e)}function writeAfterEnd(e,i,t){var n=Error("write after end");e.emit("error",n),process.nextTick(function(){t(n)})}function validChunk(e,i,t,n){var r,f=!0;return util.isBuffer(t)||util.isString(t)||util.isNullOrUndefined(t)||i.objectMode||(r=new TypeError("Invalid non-string/buffer chunk"),e.emit("error",r),process.nextTick(function(){n(r)}),f=!1),f}function decodeChunk(e,i,t){return!e.objectMode&&e.decodeStrings!==!1&&util.isString(i)&&(i=new Buffer(i,t)),i}function writeOrBuffer(e,i,t,n,r){var f,o;return t=decodeChunk(i,t,n),util.isBuffer(t)&&(n="buffer"),f=i.objectMode?1:t.length,i.length+=f,o=i.length<i.highWaterMark,i.needDrain=!o,i.writing||i.corked?i.buffer.push(new WriteReq(t,n,r)):doWrite(e,i,!1,f,t,n,r),o}function doWrite(e,i,t,n,r,f,o){i.writelen=n,i.writecb=o,i.writing=!0,i.sync=!0,t?e._writev(r,i.onwrite):e._write(r,f,i.onwrite),i.sync=!1}function onwriteError(e,i,t,n,r){t?process.nextTick(function(){i.pendingcb--,r(n)}):(i.pendingcb--,r(n)),e.emit("error",n)}function onwriteStateUpdate(e){e.writing=!1,e.writecb=null,e.length-=e.writelen,e.writelen=0}function onwrite(e,i){var t,n=e._writableState,r=n.sync,f=n.writecb;onwriteStateUpdate(n),i?onwriteError(e,n,r,i,f):(t=needFinish(e,n),t||n.corked||n.bufferProcessing||!n.buffer.length||clearBuffer(e,n),r?process.nextTick(function(){afterWrite(e,n,t,f)}):afterWrite(e,n,t,f))}function afterWrite(e,i,t,n){t||onwriteDrain(e,i),i.pendingcb--,n(),finishMaybe(e,i)}function onwriteDrain(e,i){0===i.length&&i.needDrain&&(i.needDrain=!1,e.emit("drain"))}function clearBuffer(e,i){var t,n,r,f,o,u,l;if(i.bufferProcessing=!0,e._writev&&i.buffer.length>1){for(t=[],n=0;n<i.buffer.length;n++)t.push(i.buffer[n].callback);i.pendingcb++,doWrite(e,i,!0,i.length,i.buffer,"",function(e){for(var n=0;n<t.length;n++)i.pendingcb--,t[n](e)}),i.buffer=[]}else{for(n=0;n<i.buffer.length;n++)if(r=i.buffer[n],f=r.chunk,o=r.encoding,u=r.callback,l=i.objectMode?1:f.length,doWrite(e,i,!1,l,f,o,u),i.writing){n++;break}n<i.buffer.length?i.buffer=i.buffer.slice(n):i.buffer.length=0}i.bufferProcessing=!1}function needFinish(e,i){return i.ending&&0===i.length&&!i.finished&&!i.writing}function prefinish(e,i){i.prefinished||(i.prefinished=!0,e.emit("prefinish"))}function finishMaybe(e,i){var t=needFinish(e,i);return t&&(0===i.pendingcb?(prefinish(e,i),i.finished=!0,e.emit("finish")):prefinish(e,i)),t}function endWritable(e,i,t){i.ending=!0,finishMaybe(e,i),t&&(i.finished?process.nextTick(t):e.once("finish",t)),i.ended=!0}var util,utilIs,f,Stream;if(module.exports=Writable,Writable.WritableState=WritableState,util=null,!util.isUndefined){utilIs=null;for(f in utilIs)util[f]=utilIs[f]}Stream=null,util.inherits(Writable,Stream),Writable.prototype.pipe=function(){this.emit("error",Error("Cannot pipe. Not readable."))},Writable.prototype.write=function(e,i,t){var n=this._writableState,r=!1;return util.isFunction(i)&&(t=i,i=null),util.isBuffer(e)?i="buffer":i||(i=n.defaultEncoding),util.isFunction(t)||(t=function(){}),n.ended?writeAfterEnd(this,n,t):validChunk(this,n,e,t)&&(n.pendingcb++,r=writeOrBuffer(this,n,e,i,t)),r},Writable.prototype.cork=function(){var e=this._writableState;e.corked++},Writable.prototype.uncork=function(){var e=this._writableState;e.corked&&(e.corked--,e.writing||e.corked||e.finished||e.bufferProcessing||!e.buffer.length||clearBuffer(this,e))},Writable.prototype._write=function(e,i,t){t(Error("not implemented"))},Writable.prototype._writev=null,Writable.prototype.end=function(e,i,t){var n=this._writableState;util.isFunction(e)?(t=e,e=null,i=null):util.isFunction(i)&&(t=i,i=null),util.isNullOrUndefined(e)||this.write(e,i),n.corked&&(n.corked=1,this.uncork()),n.ending||n.finished||endWritable(this,n,t)};