function Form(e){var r=this;stream.Writable.call(r),e=e||{},r.error=null,r.finished=!1,r.autoFields=!!e.autoFields,r.autoFiles=!!e.autoFields,r.maxFields=e.maxFields||1e3,r.maxFieldsSize=e.maxFieldsSize||2097152,r.uploadDir=e.uploadDir||os.tmpDir(),r.encoding=e.encoding||"utf8",r.hash=e.hash||!1,r.bytesReceived=0,r.bytesExpected=null,r.openedFiles=[],r.totalFieldSize=0,r.totalFieldCount=0,r.flushing=0,r.backpressure=!1,r.writeCbs=[],e.boundary&&setUpParser(r,e.boundary),r.on("newListener",function(e){"file"===e?r.autoFiles=!0:"field"===e&&(r.autoFields=!0)})}function flushWriteCbs(e){e.writeCbs.forEach(function(e){process.nextTick(e)}),e.writeCbs=[],e.backpressure=!1}function getBytesExpected(e){var r=e["content-length"];return r?parseInt(r,10):null==e["transfer-encoding"]?0:null}function beginFlush(e){e.flushing+=1}function endFlush(e){e.flushing-=1,maybeClose(e)}function maybeClose(e){e.flushing||!e.finished||e.error||e.emit("close")}function handleFile(e,r){var a,t,n,i;beginFlush(e),a={fieldName:r.name,originalFilename:r.filename,path:uploadPath(e.uploadDir,r.filename),headers:r.headers},a.ws=fs.createWriteStream(a.path),e.openedFiles.push(a),r.pipe(a.ws),t=new StreamCounter,r.pipe(t),i=null,e.hash&&(n=stream.Writable(),i=crypto.createHash(e.hash),n._write=function(e,r,a){i.update(e),a()},r.pipe(n)),a.ws.on("error",function(r){e.error||e.handleError(r)}),a.ws.on("close",function(){i&&(a.hash=i.digest("hex")),a.size=t.bytes,e.emit("file",r.name,a),endFlush(e)})}function handleField(e,r){var a="",t=new StringDecoder(e.encoding);beginFlush(e),r.on("readable",function(){var n=r.read();if(n)return e.totalFieldSize+=n.length,e.totalFieldSize>e.maxFieldsSize?(e.handleError(Error("maxFieldsSize "+e.maxFieldsSize+" exceeded")),void 0):(a+=t.write(n),void 0)}),r.on("end",function(){e.emit("field",r.name,a),endFlush(e)})}function clearPartVars(e){e.partHeaders={},e.partName=null,e.partFilename=null,e.partTransferEncoding="binary",e.destStream=null,e.headerFieldDecoder=new StringDecoder(e.encoding),e.headerField="",e.headerValueDecoder=new StringDecoder(e.encoding),e.headerValue=""}function setUpParser(e,r){e.boundary=new Buffer(r.length+4),e.boundary.write("\r\n--",0,r.length+4,"ascii"),e.boundary.write(r,4,r.length,"ascii"),e.lookbehind=new Buffer(e.boundary.length+8),e.state=START,e.boundaryChars={};for(var a=0;a<e.boundary.length;a++)e.boundaryChars[e.boundary[a]]=!0;e.index=null,e.partBoundaryFlag=!1,e.lastBoundaryFlag=!1,e.on("finish",function(){e.state===HEADER_FIELD_START&&0===e.index||e.state===PART_DATA&&e.index===e.boundary.length?e.onParsePartEnd():e.state!==END&&e.handleError(Error("stream ended unexpectedly")),e.finished=!0,maybeClose(e)})}function uploadPath(e,r){var a=path.extname(r).replace(FILE_EXT_RE,"$1"),t=process.pid+"-"+(4294967296*Math.random()+1).toString(36)+a;return path.join(e,t)}function parseFilename(e){var r,a=e.match(/\bfilename="(.*?)"($|; )/i);if(a)return r=a[1].substr(a[1].lastIndexOf("\\")+1),r=r.replace(/%22/g,'"'),r=r.replace(/&#([\d]{4});/g,function(e,r){return String.fromCharCode(r)})}function lower(e){return 32|e}var stream,util,fs,crypto,path,os,StringDecoder,StreamCounter,START,START_BOUNDARY,HEADER_FIELD_START,HEADER_FIELD,HEADER_VALUE_START,HEADER_VALUE,HEADER_VALUE_ALMOST_DONE,HEADERS_ALMOST_DONE,PART_DATA_START,PART_DATA,PART_END,END,LF,CR,SPACE,HYPHEN,COLON,A,Z,CONTENT_TYPE_RE,FILE_EXT_RE,LAST_BOUNDARY_SUFFIX_LEN;exports.Form=Form,stream=null,util=null,fs=null,crypto=null,path=null,os=null,StringDecoder=null.StringDecoder,StreamCounter=null,START=0,START_BOUNDARY=1,HEADER_FIELD_START=2,HEADER_FIELD=3,HEADER_VALUE_START=4,HEADER_VALUE=5,HEADER_VALUE_ALMOST_DONE=6,HEADERS_ALMOST_DONE=7,PART_DATA_START=8,PART_DATA=9,PART_END=10,END=11,LF=10,CR=13,SPACE=32,HYPHEN=45,COLON=58,A=97,Z=122,CONTENT_TYPE_RE=/^multipart\/(form-data|related);\s*boundary=(?:"([^"]+)"|([^;]+))$/i,FILE_EXT_RE=/(\.[_\-a-zA-Z0-9]{0,16}).*/,LAST_BOUNDARY_SUFFIX_LEN=4,util.inherits(Form,stream.Writable),Form.prototype.parse=function(e,r){function a(){E.emit("aborted"),t(Error("Request aborted"))}function t(r){var t=!E.error;t&&(E.error=r,e.removeListener("aborted",a),e.unpipe&&e.unpipe(E)),E.openedFiles.forEach(function(e){e.ws.destroy(),fs.unlink(e.path,function(){})}),E.openedFiles=[],t&&E.emit("error",r)}var n,i,o,s,d,l,u,E=this;return r&&(E.autoFields=!0,E.autoFiles=!0),E.handleError=t,E.bytesExpected=getBytesExpected(e.headers),e.on("error",t),e.on("aborted",a),(n=e.headers["content-type"])?(i=n.match(CONTENT_TYPE_RE))?(o=i[2]||i[3],setUpParser(E,o),e.pipe(E),r&&(s={},d={},l=[],u=[],E.on("error",function(e){r(e)}),E.on("field",function(e,r){s[e]=r,l.push({name:e,value:r})}),E.on("file",function(e,r){d[e]=r,u.push(r)}),E.on("close",function(){r(null,s,d,l,u)})),void 0):(t(Error("unrecognized content-type: "+n)),void 0):(t(Error("missing content-type header")),void 0)},Form.prototype._write=function(e,r,a){var t,n,i,o=this,s=0,d=e.length,l=o.index,u=o.index,E=o.state,h=o.lookbehind,c=o.boundary,p=o.boundaryChars,f=o.boundary.length,F=f-1,D=e.length;for(s=0;d>s;s++)switch(t=e[s],E){case START:u=0,E=START_BOUNDARY;case START_BOUNDARY:if(u===f-2){if(t!==CR)return o.handleError(Error("Expected CR Received "+t));u++;break}if(u===f-1){if(t!==LF)return o.handleError(Error("Expected LF Received "+t));u=0,o.onParsePartBegin(),E=HEADER_FIELD_START;break}t!==c[u+2]&&(u=-2),t===c[u+2]&&u++;break;case HEADER_FIELD_START:E=HEADER_FIELD,o.headerFieldMark=s,u=0;case HEADER_FIELD:if(t===CR){o.headerFieldMark=null,E=HEADERS_ALMOST_DONE;break}if(u++,t===HYPHEN)break;if(t===COLON){if(1===u)return o.handleError(Error("Empty header field")),void 0;o.onParseHeaderField(e.slice(o.headerFieldMark,s)),o.headerFieldMark=null,E=HEADER_VALUE_START;break}if(n=lower(t),A>n||n>Z)return o.handleError(Error("Expected alphabetic character, received "+t)),void 0;break;case HEADER_VALUE_START:if(t===SPACE)break;o.headerValueMark=s,E=HEADER_VALUE;case HEADER_VALUE:t===CR&&(o.onParseHeaderValue(e.slice(o.headerValueMark,s)),o.headerValueMark=null,o.onParseHeaderEnd(),E=HEADER_VALUE_ALMOST_DONE);break;case HEADER_VALUE_ALMOST_DONE:if(t!==LF)return o.handleError(Error("Expected LF Received "+t));E=HEADER_FIELD_START;break;case HEADERS_ALMOST_DONE:if(t!==LF)return o.handleError(Error("Expected LF Received "+t));if(i=o.onParseHeadersEnd(s+1))return o.handleError(i);E=PART_DATA_START;break;case PART_DATA_START:E=PART_DATA,o.partDataMark=s;case PART_DATA:if(l=u,0===u){for(s+=F;D>s&&!(e[s]in p);)s+=f;s-=F,t=e[s]}if(f>u)c[u]===t?(0===u&&(o.onParsePartData(e.slice(o.partDataMark,s)),o.partDataMark=null),u++):u=0;else if(u===f)u++,t===CR?o.partBoundaryFlag=!0:t===HYPHEN?o.lastBoundaryFlag=!0:u=0;else if(u-1===f)if(o.partBoundaryFlag){if(u=0,t===LF){o.partBoundaryFlag=!1,o.onParsePartEnd(),o.onParsePartBegin(),E=HEADER_FIELD_START;break}}else o.lastBoundaryFlag?t===HYPHEN?(o.onParsePartEnd(),o.end(),E=END):u=0:u=0;u>0?h[u-1]=t:l>0&&(o.onParsePartData(h.slice(0,l)),l=0,o.partDataMark=s,s--);break;case END:break;default:return o.handleError(Error("Parser has invalid state.")),void 0}null!=o.headerFieldMark&&(o.onParseHeaderField(e.slice(o.headerFieldMark)),o.headerFieldMark=0),null!=o.headerValueMark&&(o.onParseHeaderValue(e.slice(o.headerValueMark)),o.headerValueMark=0),null!=o.partDataMark&&(o.onParsePartData(e.slice(o.partDataMark)),o.partDataMark=0),o.index=u,o.state=E,o.bytesReceived+=e.length,o.emit("progress",o.bytesReceived,o.bytesExpected),o.backpressure?o.writeCbs.push(a):a()},Form.prototype.onParsePartBegin=function(){clearPartVars(this)},Form.prototype.onParseHeaderField=function(e){this.headerField+=this.headerFieldDecoder.write(e)},Form.prototype.onParseHeaderValue=function(e){this.headerValue+=this.headerValueDecoder.write(e)},Form.prototype.onParseHeaderEnd=function(){this.headerField=this.headerField.toLowerCase(),this.partHeaders[this.headerField]=this.headerValue;var e;"content-disposition"===this.headerField?((e=this.headerValue.match(/\bname="([^"]+)"/i))&&(this.partName=e[1]),this.partFilename=parseFilename(this.headerValue)):"content-transfer-encoding"===this.headerField&&(this.partTransferEncoding=this.headerValue.toLowerCase()),this.headerFieldDecoder=new StringDecoder(this.encoding),this.headerField="",this.headerValueDecoder=new StringDecoder(this.encoding),this.headerValue=""},Form.prototype.onParsePartData=function(e){this.backpressure="base64"===this.partTransferEncoding?!this.destStream.write(e.toString("ascii"),"base64"):!this.destStream.write(e)},Form.prototype.onParsePartEnd=function(){if(this.destStream){flushWriteCbs(this);var e=this.destStream;process.nextTick(function(){e.end()})}clearPartVars(this)},Form.prototype.onParseHeadersEnd=function(e){var r,a=this;switch(a.partTransferEncoding){case"binary":case"7bit":case"8bit":a.partTransferEncoding="binary";break;case"base64":break;default:return Error("unknown transfer-encoding: "+a.partTransferEncoding)}return a.totalFieldCount+=1,a.totalFieldCount>=a.maxFields?Error("maxFields "+a.maxFields+" exceeded."):(a.destStream=new stream.PassThrough,a.destStream.on("drain",function(){flushWriteCbs(a)}),a.destStream.headers=a.partHeaders,a.destStream.name=a.partName,a.destStream.filename=a.partFilename,a.destStream.byteOffset=a.bytesReceived+e,r=a.destStream.headers["content-length"],a.destStream.byteCount=r?parseInt(r,10):a.bytesExpected-a.destStream.byteOffset-a.boundary.length-LAST_BOUNDARY_SUFFIX_LEN,a.emit("part",a.destStream),null==a.destStream.filename&&a.autoFields?handleField(a,a.destStream):null!=a.destStream.filename&&a.autoFiles&&handleFile(a,a.destStream),void 0)};