/*!
 * Connect - HTTPServer
 * Copyright(c) 2010 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * MIT Licensed
 */

var http=null,utils=null,debug=null,app=module.exports={},env=process.env.NODE_ENV||"development";app.use=function(e,t){if("string"!=typeof e&&(t=e,e="/"),"function"==typeof t.handle){var n=t;t.route=e,t=function(e,t,r){n.handle(e,t,r)}}return t instanceof http.Server&&(t=t.listeners("request")[0]),"/"==e[e.length-1]&&(e=e.slice(0,-1)),debug("use %s %s",e||"/",t.name||"anonymous"),this.stack.push({route:e,handle:t}),this},app.handle=function(e,t,n){function r(d){var h,p,f,c,g;if(o&&(e.url=e.url.substr(1),o=!1),e.url=l+a+e.url,e.originalUrl=e.originalUrl||e.url,a="",h=s[i++],h&&!t.headerSent)try{if(p=utils.parseUrl(e).pathname,void 0==p&&(p="/"),0!=p.toLowerCase().indexOf(h.route.toLowerCase()))return r(d);if(f=p[h.route.length],f&&"/"!=f&&"."!=f)return r(d);a=h.route,e.url=l+e.url.substr(l.length+a.length),u||"/"==e.url[0]||(e.url="/"+e.url,o=!0),debug("%s %s : %s",h.handle.name||"anonymous",h.route,e.originalUrl),g=h.handle.length,d?4===g?h.handle(d,e,t,r):r(d):4>g?h.handle(e,t,r):r()}catch(m){r(m)}else{if(n)return n(d);if(d){if(t.statusCode<400&&(t.statusCode=500),debug("default %s",t.statusCode),d.status&&(t.statusCode=d.status),c="production"==env?http.STATUS_CODES[t.statusCode]:d.stack||""+d,c=utils.escape(c),"test"!=env&&console.error(d.stack||""+d),t.headerSent)return e.socket.destroy();if(t.setHeader("Content-Type","text/html"),t.setHeader("Content-Length",Buffer.byteLength(c)),"HEAD"==e.method)return t.end();t.end(c)}else{if(debug("default 404"),t.statusCode=404,t.setHeader("Content-Type","text/html"),"HEAD"==e.method)return t.end();t.end("Cannot "+utils.escape(e.method)+" "+utils.escape(e.originalUrl))}}}var s=this.stack,u=1+e.url.indexOf("://"),l=u?e.url.substr(0,e.url.indexOf("/",2+u)):"",a="",o=!1,i=0;e.url=e.url.substr(l.length),r()},app.listen=function(){var e=http.createServer(this);return e.listen.apply(e,arguments)};