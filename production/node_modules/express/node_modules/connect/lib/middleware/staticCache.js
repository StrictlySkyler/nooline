/*!
 * Connect - staticCache
 * Copyright(c) 2011 Sencha Inc.
 * MIT Licensed
 */

function respondFromCache(e,a,t){function n(){for(;o.length;)if(!1===a.write(o.shift()))return a.once("drain",n),void 0;a.end()}var r=t[0],c=utils.merge({},t[1]),o=t.slice(2);switch(c.age=(new Date-new Date(c.date))/1e3||0,e.method){case"HEAD":a.writeHead(r,c),a.end();break;case"GET":utils.conditionalGET(e)&&fresh(e.headers,c)?(c["content-length"]=0,a.writeHead(304,c),a.end()):(a.writeHead(r,c),n());break;default:a.writeHead(500,""),a.end()}}function mustRevalidate(e,a){var t=a[1],n=utils.parseCacheControl(e.headers["cache-control"]||""),r=utils.parseCacheControl(t["cache-control"]||""),c=(new Date-new Date(t.date))/1e3||0;return r["no-cache"]||r["must-revalidate"]||r["proxy-revalidate"]?!0:n["no-cache"]?!0:null!=n["max-age"]?n["max-age"]<c:null!=r["max-age"]?r["max-age"]<c:!1}function cacheKey(e){return utils.parseUrl(e).path}var utils=null,Cache=null,fresh=null;module.exports=function(e){var e=e||{},a=new Cache(e.maxObjects||128),t=e.maxLength||262144;return console.warn("connect.staticCache() is deprecated and will be removed in 3.0"),console.warn("use varnish or similar reverse proxy caches."),function(e,n,r){var c=cacheKey(e),o=e.headers.range,i=e.headers.cookie,s=a.get(c);e.on("static",function(e){var r,o,s=n._headers,l=utils.parseCacheControl(s["cache-control"]||""),d=s["content-length"];if(s["set-cookie"])return i=!0;if(!(i||!d||d>t||s["content-range"]||l["no-cache"]||l["no-store"]||l["private"]||l["must-revalidate"])){if(r=a.get(c)){if(s.etag==r[0].etag)return r[0].date=new Date,void 0;a.remove(c)}null!=e&&(o=[],e.on("data",function(e){o.push(e)}),e.on("end",function(){var e=a.add(c);delete s["x-cache"],e.push(200),e.push(s),e.push.apply(e,o)}))}}),"GET"==e.method||"HEAD"==e.method?o?r():i||!s||mustRevalidate(e,s)?(n.setHeader("X-Cache","MISS"),r()):(n.setHeader("X-Cache","HIT"),respondFromCache(e,n,s)):r()}};