/*!
 * Connect - logger
 * Copyright(c) 2010 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * MIT Licensed
 */

/*!
 * Log buffer.
 */

/*!
 * Default log buffer duration.
 */

function compile(e){e=e.replace(/"/g,'\\"');var t='  return "'+e.replace(/:([-\w]{2,})(?:\[([^\]]+)\])?/g,function(e,t,r){return'"\n    + (tokens["'+t+'"](req, res, "'+r+'") || "-") + "'})+'";';return Function("tokens, req, res",t)}var bytes=null,buf=[],defaultBufferDuration=1e3;exports=module.exports=function(e){var t,r,o,n,s,u;return e="object"==typeof e?e||{}:e?{format:e}:{},t=e.immediate,r=exports[e.format]||e.format||exports.default,"function"!=typeof r&&(r=compile(r)),o=e.stream||process.stdout,n=e.buffer,n&&(s=o,u="number"==typeof n?n:defaultBufferDuration,setInterval(function(){buf.length&&(s.write(buf.join("")),buf.length=0)},u),o={write:function(e){buf.push(e)}}),function(e,n,s){function u(){n.removeListener("finish",u),n.removeListener("close",u);var t=r(exports,e,n);null!=t&&o.write(t+"\n")}var i=e.socket;e._startTime=new Date,e._remoteAddress=i.socket?i.socket.remoteAddress:i.remoteAddress,t?u():(n.on("finish",u),n.on("close",u)),s()}},exports.token=function(e,t){return exports[e]=t,this},exports.format=function(e,t){return exports[e]=t,this},exports.format("default",':remote-addr - - [:date] ":method :url HTTP/:http-version" :status :res[content-length] ":referrer" ":user-agent"'),exports.format("short",":remote-addr - :method :url HTTP/:http-version :status :res[content-length] - :response-time ms"),exports.format("tiny",":method :url :status :res[content-length] - :response-time ms"),exports.format("dev",function(e,t,r){var o=r.statusCode,n=parseInt(r.getHeader("Content-Length"),10),s=32;return o>=500?s=31:o>=400?s=33:o>=300&&(s=36),n=isNaN(n)?"":n=" - "+bytes(n),"[90m"+t.method+" "+t.originalUrl+" "+"["+s+"m"+r.statusCode+" [90m"+(new Date-t._startTime)+"ms"+n+"[0m"}),exports.token("url",function(e){return e.originalUrl||e.url}),exports.token("method",function(e){return e.method}),exports.token("response-time",function(e){return Date.now()-e._startTime+""}),exports.token("date",function(){return(new Date).toUTCString()}),exports.token("status",function(e,t){return t.headerSent?t.statusCode:null}),exports.token("referrer",function(e){return e.headers.referer||e.headers.referrer}),exports.token("remote-addr",function(e){if(e.ip)return e.ip;if(e._remoteAddress)return e._remoteAddress;var t=e.socket;return t.socket?t.socket.remoteAddress:t.remoteAddress}),exports.token("http-version",function(e){return e.httpVersionMajor+"."+e.httpVersionMinor}),exports.token("user-agent",function(e){return e.headers["user-agent"]}),exports.token("req",function(e,t,r){return e.headers[r.toLowerCase()]}),exports.token("res",function(e,t,r){return(t._headers||{})[r.toLowerCase()]});