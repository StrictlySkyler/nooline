/*!
 * Connect - json
 * Copyright(c) 2010 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * MIT Licensed
 */

var utils=null,getBody=null,bytes=null;exports=module.exports=function(t){var e,i;return t=t||{},e=t.strict!==!1,i=t.limit?"number"==typeof t.limit?t.limit:"string"==typeof t.limit?bytes(t.limit):null:bytes("1mb"),function(r,n,o){return r._body?o():(r.body=r.body||{},utils.hasBody(r)?exports.regexp.test(utils.mime(r))?(r._body=!0,getBody(r,{limit:i,expected:r.headers["content-length"]},function(i,n){if(i)return o(i);n=n.toString("utf8").trim();var l=n[0];if(0==n.length)return o(utils.error(400,"invalid json, empty body"));if(e&&"{"!=l&&"["!=l)return o(utils.error(400,"invalid json"));try{r.body=JSON.parse(n,t.reviver)}catch(i){return i.body=n,i.status=400,o(i)}o()}),void 0):o():o())}},exports.regexp=/^application\/([\w!#\$%&\*`\-\.\^~]*\+)?json$/i;