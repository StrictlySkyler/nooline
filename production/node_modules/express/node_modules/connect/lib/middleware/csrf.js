/*!
 * Connect - csrf
 * Copyright(c) 2011 Sencha Inc.
 * MIT Licensed
 */

function defaultValue(e){return e.body&&e.body._csrf||e.query&&e.query._csrf||e.headers["x-csrf-token"]||e.headers["x-xsrf-token"]}function saltedToken(e){return createToken(generateSalt(10),e)}function createToken(e,r){return e+crypto.createHash("sha1").update(e+r).digest("base64")}function checkToken(e,r){return"string"!=typeof e?!1:e===createToken(e.slice(0,10),r)}function generateSalt(e){var r,n=[];for(r=0;e>r;++r)n.push(SALTCHARS[Math.floor(Math.random()*SALTCHARS.length)]);return n.join("")}var SALTCHARS,utils=null,uid=null,crypto=null;module.exports=function(e){e=e||{};var r=e.value||defaultValue;return function(e,n,t){function o(n){var o,s;return e.csrfToken=function(){return o||(o=saltedToken(n))},Object.defineProperty(e.session,"_csrf",{configurable:!0,get:function(){return console.warn("req.session._csrf is deprecated, use req.csrfToken() instead"),e.csrfToken()}}),"GET"==e.method||"HEAD"==e.method||"OPTIONS"==e.method?t():(s=r(e),checkToken(s,n)?(t(),void 0):t(utils.error(403)))}var s=e.session._csrfSecret;return s?o(s):(uid(24,function(r,n){return r?t(r):(e.session._csrfSecret=n,o(n),void 0)}),void 0)}},SALTCHARS="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";