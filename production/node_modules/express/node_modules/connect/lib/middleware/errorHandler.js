/*!
 * Connect - errorHandler
 * Copyright(c) 2010 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * MIT Licensed
 */

var utils=null,fs=null,env=process.env.NODE_ENV||"development";exports=module.exports=function(){return function(e,t,s){var n,r,a,l;if(e.status&&(s.statusCode=e.status),s.statusCode<400&&(s.statusCode=500),"test"!=env&&console.error(e.stack),n=t.headers.accept||"",~n.indexOf("html"))fs.readFile(__dirname+"/../public/style.css","utf8",function(t,n){fs.readFile(__dirname+"/../public/error.html","utf8",function(t,r){var a=(e.stack||"").split("\n").slice(1).map(function(e){return"<li>"+e+"</li>"}).join("");r=r.replace("{style}",n).replace("{stack}",a).replace("{title}",exports.title).replace("{statusCode}",s.statusCode).replace(/\{error\}/g,utils.escape(""+e)),s.setHeader("Content-Type","text/html; charset=utf-8"),s.end(r)})});else if(~n.indexOf("json")){r={message:e.message,stack:e.stack};for(a in e)r[a]=e[a];l=JSON.stringify({error:r}),s.setHeader("Content-Type","application/json"),s.end(l)}else s.writeHead(s.statusCode,{"Content-Type":"text/plain"}),s.end(e.stack)}},exports.title="Connect";