/*!
 * Connect - directory
 * Copyright(c) 2011 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * MIT Licensed
 */

/*!
 * Icon cache.
 */

function htmlPath(e){var n=[];return e.split("/").map(function(e){return n.push(encodeURIComponent(e)),e?'<a href="'+n.join("/")+'">'+e+"</a>":""}).join(" / ")}function html(e,n,t){return'<ul id="files">'+e.map(function(e){var i="",r=[],o=n.split("/").map(function(e){return encodeURIComponent(e)});return t&&".."!=e&&(i=icons[extname(e)]||icons.default,i='<img src="data:image/png;base64,'+load(i)+'" />',r.push("icon")),o.push(encodeURIComponent(e)),'<li><a href="'+utils.normalizeSlashes(normalize(o.join("/")))+'" class="'+r.join(" ")+'"'+' title="'+e+'">'+i+e+"</a></li>"}).join("\n")+"</ul>"}function load(e){return cache[e]?cache[e]:cache[e]=fs.readFileSync(__dirname+"/../public/icons/"+e,"base64")}function removeHidden(e){return e.filter(function(e){return"."!=e[0]})}var icons,fs=null,parse=null.parse,utils=null,path=null,normalize=path.normalize,sep=path.sep,extname=path.extname,join=path.join,Negotiator=null,cache={},mediaTypes=["text/html","text/plain","application/json"],mediaType={"text/html":"html","text/plain":"plain","application/json":"json"};exports=module.exports=function(e,n){if(n=n||{},!e)throw Error("directory() root path required");var t=n.hidden,i=n.icons,r=n.filter,e=normalize(e+sep);return function(n,o,a){if("GET"!=n.method&&"HEAD"!=n.method)return a();var p=parse(n.url),l=decodeURIComponent(p.pathname),s=normalize(join(e,l)),c=parse(n.originalUrl),u=decodeURIComponent(c.pathname),d=s!=e;return~s.indexOf("\x00")?a(utils.error(400)):0!=s.indexOf(e)?a(utils.error(403)):(fs.stat(s,function(e,p){return e?"ENOENT"==e.code?a():a(e):p.isDirectory()?(fs.readdir(s,function(e,p){if(e)return a(e);t||(p=removeHidden(p)),r&&(p=p.filter(r)),p.sort();var l=new Negotiator(n).preferredMediaType(mediaTypes);return l?(exports[mediaType[l]](n,o,p,a,u,d,i),void 0):a(utils.error(406))}),void 0):a()}),void 0)}},exports.html=function(e,n,t,i,r,o,a){fs.readFile(__dirname+"/../public/directory.html","utf8",function(e,p){return e?i(e):(fs.readFile(__dirname+"/../public/style.css","utf8",function(e,l){return e?i(e):(o&&t.unshift(".."),p=p.replace("{style}",l).replace("{files}",html(t,r,a)).replace("{directory}",r).replace("{linked-path}",htmlPath(r)),n.setHeader("Content-Type","text/html"),n.setHeader("Content-Length",p.length),n.end(p),void 0)}),void 0)})},exports.json=function(e,n,t){t=JSON.stringify(t),n.setHeader("Content-Type","application/json"),n.setHeader("Content-Length",t.length),n.end(t)},exports.plain=function(e,n,t){t=t.join("\n")+"\n",n.setHeader("Content-Type","text/plain"),n.setHeader("Content-Length",t.length),n.end(t)},icons={".js":"page_white_code_red.png",".c":"page_white_c.png",".h":"page_white_h.png",".cc":"page_white_cplusplus.png",".php":"page_white_php.png",".rb":"page_white_ruby.png",".cpp":"page_white_cplusplus.png",".swf":"page_white_flash.png",".pdf":"page_white_acrobat.png","default":"page_white.png"};