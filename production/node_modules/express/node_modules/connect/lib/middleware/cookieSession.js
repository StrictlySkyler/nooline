/*!
 * Connect - cookieSession
 * Copyright(c) 2011 Sencha Inc.
 * MIT Licensed
 */

var utils=null,Cookie=null,debug=null,signature=null,crc32=null;module.exports=function(e){e=e||{};var s=e.key||"connect.sess",o=e.proxy;return function(i,n,r){var t,c,d,u,l=e.secret||i.secret;if(!l)throw Error("`secret` option required for cookie sessions");return i.session={},t=i.session.cookie=new Cookie(e.cookie),0!=i.originalUrl.indexOf(t.path)?r():(!e.secret&&i.secret?(i.session=i.signedCookies[s]||{},i.session.cookie=t):(c=i.cookies[s],c&&(d=utils.parseSignedCookie(c,l),d&&(u=crc32.signed(d),i.session=utils.parseJSONCookie(d)||{},i.session.cookie=t))),n.on("header",function(){var e,r,c;return i.session?(delete i.session.cookie,e=(i.headers["x-forwarded-proto"]||"").toLowerCase(),r=i.connection.encrypted||o&&"https"==e.split(/\s*,\s*/)[0],t.secure&&!r?debug("not secured"):(debug("serializing %j",i.session),c="j:"+JSON.stringify(i.session),u==crc32.signed(c)?debug("unmodified session"):(c="s:"+signature.sign(c,l),c=t.serialize(s,c),debug("set-cookie %j",t),n.setHeader("Set-Cookie",c),void 0))):(debug("clear session"),t.expires=new Date(0),n.setHeader("Set-Cookie",t.serialize(s,"")),void 0)}),r(),void 0)}};