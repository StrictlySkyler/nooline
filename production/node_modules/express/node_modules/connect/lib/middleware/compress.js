/*!
 * Connect - compress
 * Copyright(c) 2010 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * MIT Licensed
 */

function getSize(e){return Buffer.isBuffer(e)?e.length:Buffer.byteLength(e)}var zlib=null,utils=null,Negotiator=null;exports.methods={gzip:zlib.createGzip,deflate:zlib.createDeflate},exports.filter=function(e,t){return/json|text|javascript|dart|image\/svg\+xml|application\/x-font-ttf|application\/vnd\.ms-opentype|application\/vnd\.ms-fontobject/.test(t.getHeader("Content-Type"))},module.exports=function(e){var t,n;return e=e||{},t=e.filter||exports.filter,n=!1===e.threshold||0===e.threshold?0:"string"==typeof e.threshold?utils.parseBytes(e.threshold):e.threshold||1024,function i(r,o,d){var a,c=r.headers["accept-encoding"],l=o.write,s=o.end,i=!0;r.on("close",function(){o.write=o.end=function(){}}),o.write=function(e,t){return this.headerSent||this._implicitHeader(),a?a.write(new Buffer(e,t)):l.call(o,e,t)},o.end=function(e,t){return e?(!this.headerSent&&getSize(e)<n&&(i=!1),this.write(e,t)):this.headerSent||(i=!1),a?a.end():s.call(o)},o.on("header",function(){var n,d,f;t(r,o)&&(n=o.getHeader("Vary"),n?~n.indexOf("Accept-Encoding")||o.setHeader("Vary",n+", Accept-Encoding"):o.setHeader("Vary","Accept-Encoding"),i&&(d=o.getHeader("Content-Encoding")||"identity","identity"==d&&c&&"HEAD"!=r.method&&(f=new Negotiator(r).preferredEncoding(["gzip","deflate","identity"]),"identity"!==f&&(a=exports.methods[f](e),o.setHeader("Content-Encoding",f),o.removeHeader("Content-Length"),a.on("data",function(e){l.call(o,e)}),a.on("end",function(){s.call(o)}),a.on("drain",function(){o.emit("drain")})))))}),d()}};