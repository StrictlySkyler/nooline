function send(e,t,r){return new SendStream(e,t,r)}function SendStream(e,t,r){this.req=e,this.path=t,this.options=r||{},this.maxage(0),this.hidden(!1),this.index("index.html")}var debug=null,parseRange=null,Stream=null,mime=null,fresh=null,path=null,http=null,fs=null,basename=path.basename,normalize=path.normalize,join=path.join,utils=null;exports=module.exports=send,exports.mime=mime,SendStream.prototype.__proto__=Stream.prototype,SendStream.prototype.hidden=function(e){return debug("hidden %s",e),this._hidden=e,this},SendStream.prototype.index=function(e){return debug("index %s",e),this._index=e,this},SendStream.prototype.root=SendStream.prototype.from=function(e){return this._root=normalize(e),this},SendStream.prototype.maxage=function(e){return 1/0==e&&(e=31536e6),debug("max-age %d",e),this._maxage=e,this},SendStream.prototype.error=function(e,t){var r=this.res,n=http.STATUS_CODES[e];return t=t||Error(n),t.status=e,this.listeners("error").length?this.emit("error",t):(r.statusCode=t.status,r.end(n),void 0)},SendStream.prototype.isMalicious=function(){return!this._root&&~this.path.indexOf("..")},SendStream.prototype.hasTrailingSlash=function(){return"/"==this.path[this.path.length-1]},SendStream.prototype.hasLeadingDot=function(){return"."==basename(this.path)[0]},SendStream.prototype.isConditionalGET=function(){return this.req.headers["if-none-match"]||this.req.headers["if-modified-since"]},SendStream.prototype.removeContentHeaderFields=function(){var e=this.res;Object.keys(e._headers).forEach(function(t){0==t.indexOf("content")&&e.removeHeader(t)})},SendStream.prototype.notModified=function(){var e=this.res;debug("not modified"),this.removeContentHeaderFields(),e.statusCode=304,e.end()},SendStream.prototype.isCachable=function(){var e=this.res;return e.statusCode>=200&&e.statusCode<300||304==e.statusCode},SendStream.prototype.onStatError=function(e){var t=["ENOENT","ENAMETOOLONG","ENOTDIR"];return~t.indexOf(e.code)?this.error(404,e):(this.error(500,e),void 0)},SendStream.prototype.isFresh=function(){return fresh(this.req.headers,this.res._headers)},SendStream.prototype.redirect=function(e){if(this.listeners("directory").length)return this.emit("directory");var t=this.res;e+="/",t.statusCode=301,t.setHeader("Location",e),t.end("Redirecting to "+utils.escape(e))},SendStream.prototype.pipe=function(e){var t=this,r=this.path,n=this._root;return this.res=e,r=utils.decode(r),-1==r?this.error(400):~r.indexOf("\x00")?this.error(400):(n&&(r=normalize(join(this._root,r))),this.isMalicious()?this.error(403):n&&0!=r.indexOf(n)?this.error(403):!this._hidden&&this.hasLeadingDot()?this.error(404):(this._index&&this.hasTrailingSlash()&&(r+=this._index),debug('stat "%s"',r),fs.stat(r,function(e,n){return e?t.onStatError(e):n.isDirectory()?t.redirect(t.path):(t.emit("file",r,n),t.send(r,n),void 0)}),e))},SendStream.prototype.send=function(e,t){var r,n=this.options,i=t.size,s=this.res,o=this.req,a=o.headers.range,d=n.start||0;if(this.setHeader(t),this.type(e),this.isConditionalGET()&&this.isCachable()&&this.isFresh())return this.notModified();if(i=Math.max(0,i-d),void 0!==n.end&&(r=n.end-d+1,i>r&&(i=r)),a){if(a=parseRange(i,a),-1==a)return s.setHeader("Content-Range","bytes */"+t.size),this.error(416);-2!=a&&(n.start=d+a[0].start,n.end=d+a[0].end,s.statusCode=206,s.setHeader("Content-Range","bytes "+a[0].start+"-"+a[0].end+"/"+i),i=n.end-n.start+1)}return s.setHeader("Content-Length",i),"HEAD"==o.method?s.end():(this.stream(e,n),void 0)},SendStream.prototype.stream=function(e,t){var r=this,n=this.res,i=this.req,s=fs.createReadStream(e,t);this.emit("stream",s),s.pipe(n),i.on("close",s.destroy.bind(s)),s.on("error",function(e){return n._header?(console.error(e.stack),i.destroy(),void 0):(e.status=500,r.emit("error",e),void 0)}),s.on("end",function(){r.emit("end")})},SendStream.prototype.type=function(e){var t,r,n=this.res;n.getHeader("Content-Type")||(t=mime.lookup(e),r=mime.charsets.lookup(t),debug("content-type %s",t),n.setHeader("Content-Type",t+(r?"; charset="+r:"")))},SendStream.prototype.setHeader=function(e){var t=this.res;t.getHeader("Accept-Ranges")||t.setHeader("Accept-Ranges","bytes"),t.getHeader("ETag")||t.setHeader("ETag",utils.etag(e)),t.getHeader("Date")||t.setHeader("Date",(new Date).toUTCString()),t.getHeader("Cache-Control")||t.setHeader("Cache-Control","public, max-age="+this._maxage/1e3),t.getHeader("Last-Modified")||t.setHeader("Last-Modified",e.mtime.toUTCString())};