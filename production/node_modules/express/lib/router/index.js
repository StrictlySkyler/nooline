function Router(t){t=t||{};var r=this;this.map={},this.params={},this._params=[],this.caseSensitive=t.caseSensitive,this.strict=t.strict,this.middleware=function(t,e,o){r._dispatch(t,e,o)}}var Route=null,utils=null,methods=null,debug=null,parse=null.utils.parseUrl;exports=module.exports=Router,Router.prototype.param=function(t,r){var e,o,i,s;if("function"==typeof t)return this._params.push(t),void 0;for(o=this._params,i=o.length,s=0;i>s;++s)(e=o[s](t,r))&&(r=e);if("function"!=typeof r)throw Error("invalid param() call for "+t+", got "+r);return(this.params[t]=this.params[t]||[]).push(r),this},Router.prototype._dispatch=function(t,r,e){var o=this.params,i=this;debug("dispatching %s %s (%s)",t.method,t.url,t.originalUrl),function s(a,n){function u(r){s(t._route_index+1,r)}function h(r){g=0,v=d[a++],l=v&&t.params[v.name],f=v&&o[v.name];try{"route"==r?u():r?(a=0,c(r)):f&&void 0!==l?p():v?h():(a=0,c())}catch(r){h(r)}}function p(e){var o=f[g++];return e||!o?h(e):(o(t,r,p,l,v.name),void 0)}function c(e){var o=m.callbacks[a++];try{if("route"==e)u();else if(e&&o){if(o.length<4)return c(e);o(e,t,r,c)}else if(o){if(o.length<4)return o(t,r,c);c()}else u(e)}catch(e){c(e)}}var f,l,m,d,v,g=0;return t.route=m=i.matchRequest(t,a),m||"OPTIONS"!=t.method?m?(debug("matched %s %s",m.method,m.path),t.params=m.params,d=m.keys,a=0,h(n),void 0):e(n):i._options(t,r)}(0)},Router.prototype._options=function(t,r){var e=parse(t).pathname,o=this._optionsFor(e).join(",");r.set("Allow",o).send(o)},Router.prototype._optionsFor=function(t){var r=this;return methods.filter(function(e){var o,i,s=r.map[e];if(s&&"options"!=e)for(o=0,i=s.length;i>o;++o)if(s[o].match(t))return!0}).map(function(t){return t.toUpperCase()})},Router.prototype.matchRequest=function(t,r,e){var o,i,s=t.method.toLowerCase(),a=parse(t),n=a.pathname,u=this.map;if(r=r||0,!e&&"head"==s){if(o=this.matchRequest(t,r,!0))return o;s="get"}if(u=u[s])for(i=u.length;i>r;++r)if(o=u[r],o.match(n))return t._route_index=r,o},Router.prototype.match=function(t,r,e,o){var i={method:t,url:r};return this.matchRequest(i,e,o)},Router.prototype.route=function(t,r,e){var o;if(t=t.toLowerCase(),e=utils.flatten([].slice.call(arguments,2)),!r)throw Error("Router#"+t+"() requires a path");return e.forEach(function(r){var e,o;if("function"!=typeof r)throw e={}.toString.call(r),o="."+t+"() requires callback functions but got a "+e,Error(o)}),debug("defined %s %s",t,r),o=new Route(t,r,e,{sensitive:this.caseSensitive,strict:this.strict}),(this.map[t]=this.map[t]||[]).push(o),this},methods.forEach(function(t){Router.prototype[t]=function(){var r=[t].concat([].slice.call(arguments));return this.route.apply(this,r),this}});