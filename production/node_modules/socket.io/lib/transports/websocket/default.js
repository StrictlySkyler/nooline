/*!
 * socket.io-node
 * Copyright(c) 2011 LearnBoost <dev@learnboost.com>
 * MIT Licensed
 */

function WebSocket(e,t,r){var o=this;this.parser=new Parser,this.parser.on("data",function(e){o.log.debug(o.name+" received data packet",e),o.onMessage(parser.decodePacket(e))}),this.parser.on("close",function(){o.end()}),this.parser.on("error",function(){o.end()}),Transport.call(this,e,t,r)}function Parser(){this.buffer="",this.i=0}var Transport=null,EventEmitter=process.EventEmitter,crypto=null,parser=null;exports=module.exports=WebSocket,WebSocket.prototype.__proto__=Transport.prototype,WebSocket.prototype.name="websocket",WebSocket.prototype.protocolVersion="hixie-76",WebSocket.prototype.onSocketConnect=function(){var e,t,r,o,i=this;if(this.socket.setNoDelay(!0),this.buffer=!0,this.buffered=[],"WebSocket"!==this.req.headers.upgrade)return this.log.warn(this.name+" connection invalid"),this.end(),void 0;e=this.req.headers.origin,t=!1,location=this.manager.settings["match origin protocol"]?(e.indexOf("https")>-1?"wss":"ws")+"://"+this.req.headers.host+this.req.url:this.socket.encrypted?"wss://"+this.req.headers.host+this.req.url:"ws://"+this.req.headers.host+this.req.url,this.req.headers["sec-websocket-key1"]?(this.req.head&&this.req.head.length>=8||(t=!0),r=["HTTP/1.1 101 WebSocket Protocol Handshake","Upgrade: WebSocket","Connection: Upgrade","Sec-WebSocket-Origin: "+e,"Sec-WebSocket-Location: "+location],this.req.headers["sec-websocket-protocol"]&&r.push("Sec-WebSocket-Protocol: "+this.req.headers["sec-websocket-protocol"])):r=["HTTP/1.1 101 Web Socket Protocol Handshake","Upgrade: WebSocket","Connection: Upgrade","WebSocket-Origin: "+e,"WebSocket-Location: "+location];try{this.socket.write(r.concat("","").join("\r\n")),this.socket.setTimeout(0),this.socket.setNoDelay(!0),this.socket.setEncoding("utf8")}catch(s){return this.end(),void 0}t?this.socket.setEncoding("binary"):this.proveReception(r)&&i.flush(),o="",this.socket.on("data",function(e){if(t){if(o+=e,o.length<8)return;return i.socket.setEncoding("utf8"),t=!1,i.req.head=o.substr(0,8),o="",i.proveReception(r)&&i.flush(),void 0}i.parser.add(e)})},WebSocket.prototype.write=function(e){if(this.open){if(this.drained=!1,this.buffer)return this.buffered.push(e),this;var t=Buffer.byteLength(e),r=new Buffer(2+t);r.write("\x00","binary"),r.write(e,1,"utf8"),r.write("ÿ",1+t,"binary");try{this.socket.write(r)&&(this.drained=!0)}catch(o){this.end()}this.log.debug(this.name+" writing",e)}},WebSocket.prototype.flush=function(){this.buffer=!1;for(var e=0,t=this.buffered.length;t>e;e++)this.write(this.buffered.splice(0,1)[0])},WebSocket.prototype.proveReception=function(){var e,t=this,r=this.req.headers["sec-websocket-key1"],o=this.req.headers["sec-websocket-key2"];if(r&&o){e=crypto.createHash("md5"),[r,o].forEach(function(r){var o=parseInt(r.replace(/[^\d]/g,"")),i=r.replace(/[^ ]/g,"").length;return 0===i||0!==o%i?(t.log.warn("Invalid "+t.name+' key: "'+r+'".'),t.end(),!1):(o/=i,e.update(String.fromCharCode(255&o>>24,255&o>>16,255&o>>8,255&o)),void 0)}),e.update(this.req.head.toString("binary"));try{this.socket.write(e.digest("binary"),"binary")}catch(i){this.end()}}return!0},WebSocket.prototype.payload=function(e){for(var t=0,r=e.length;r>t;t++)this.write(e[t]);return this},WebSocket.prototype.doClose=function(){this.socket.end()},Parser.prototype.__proto__=EventEmitter.prototype,Parser.prototype.add=function(e){this.buffer+=e,this.parse()},Parser.prototype.parse=function(){for(var e,t=this.i,r=this.buffer.length;r>t;t++){if(e=this.buffer[t],2==this.buffer.length&&"\x00"==this.buffer[1])return this.emit("close"),this.buffer="",this.i=0,void 0;if(0===t){if("\x00"==e)continue;this.error("Bad framing. Expected null byte as first frame")}if("�"==e)return this.emit("data",this.buffer.substr(1,t-1)),this.buffer=this.buffer.substr(t+1),this.i=0,this.parse()}},Parser.prototype.error=function(e){return this.buffer="",this.i=0,this.emit("error",e),this};