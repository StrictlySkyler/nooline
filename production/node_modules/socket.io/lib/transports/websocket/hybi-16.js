/*!
 * socket.io-node
 * Copyright(c) 2011 LearnBoost <dev@learnboost.com>
 * MIT Licensed
 */

function WebSocket(e,t,r){var n=this;this.manager=e,this.parser=new Parser,this.parser.on("data",function(e){n.onMessage(parser.decodePacket(e))}),this.parser.on("ping",function(){try{n.socket.write("ÂŠ\x00")}catch(e){return n.end(),void 0}}),this.parser.on("close",function(){n.end()}),this.parser.on("error",function(e){n.log.warn(n.name+" parser error: "+e),n.end()}),Transport.call(this,e,t,r)}function Parser(){this.state={activeFragmentedOperation:null,lastFragment:!1,masked:!1,opcode:0},this.overflow=null,this.expectOffset=0,this.expectBuffer=null,this.expectHandler=null,this.currentMessage="";var e=this;this.opcodeHandlers={1:function(t){var r=function(t,r){e.currentMessage+=e.unmask(t,r),e.state.lastFragment&&(e.emit("data",e.currentMessage),e.currentMessage=""),e.endPacket()},n=function(t){e.state.masked?e.expect("Mask",4,function(n){var o=n;e.expect("Data",t,function(e){r(o,e)})}):e.expect("Data",t,function(e){r(null,e)})},o=127&t[1];126>o?n(o):126==o?e.expect("Length",2,function(e){n(util.unpack(e))}):127==o&&e.expect("Length",8,function(t){return 0!=util.unpack(t.slice(0,4))?(e.error("packets with length spanning more than 32 bit is currently not supported"),void 0):(t.slice(4),n(util.unpack(t)),void 0)})},2:function(t){var r=function(t,r){"string"==typeof e.currentMessage&&(e.currentMessage=[]),e.currentMessage.push(e.unmask(t,r,!0)),e.state.lastFragment&&(e.emit("binary",e.concatBuffers(e.currentMessage)),e.currentMessage=""),e.endPacket()},n=function(t){e.state.masked?e.expect("Mask",4,function(n){var o=n;e.expect("Data",t,function(e){r(o,e)})}):e.expect("Data",t,function(e){r(null,e)})},o=127&t[1];126>o?n(o):126==o?e.expect("Length",2,function(e){n(util.unpack(e))}):127==o&&e.expect("Length",8,function(t){return 0!=util.unpack(t.slice(0,4))?(e.error("packets with length spanning more than 32 bit is currently not supported"),void 0):(t.slice(4),n(util.unpack(t)),void 0)})},8:function(){e.emit("close"),e.reset()},9:function(t){var r,n,o;return 0==e.state.lastFragment?(e.error("fragmented ping is not supported"),void 0):(r=function(t,r){e.emit("ping",e.unmask(t,r)),e.endPacket()},n=function(t){e.state.masked?e.expect("Mask",4,function(n){var o=n;e.expect("Data",t,function(e){r(o,e)})}):e.expect("Data",t,function(e){r(null,e)})},o=127&t[1],0==o?r(null,null):126>o?n(o):126==o?e.expect("Length",2,function(e){n(util.unpack(e))}):127==o&&e.expect("Length",8,function(e){n(util.unpack(e))}),void 0)}},this.expect("Opcode",2,this.processPacket)}var Transport=null,EventEmitter=process.EventEmitter,crypto=null,url=null,parser=null,util=null;exports=module.exports=WebSocket,exports.Parser=Parser,WebSocket.prototype.__proto__=Transport.prototype,WebSocket.prototype.name="websocket",WebSocket.prototype.protocolVersion="16",WebSocket.prototype.onSocketConnect=function(){var e,t,r,n,o=this;if(void 0===this.req.headers.upgrade||"websocket"!==this.req.headers.upgrade.toLowerCase())return this.log.warn(this.name+" connection invalid"),this.end(),void 0;if(e=this.req.headers.origin||"",((this.manager.settings["match origin protocol"]?e.match(/^https/):this.socket.encrypted)?"wss":"ws")+"://"+this.req.headers.host+this.req.url,!this.verifyOrigin(e))return this.log.warn(this.name+" connection invalid: origin mismatch"),this.end(),void 0;if(!this.req.headers["sec-websocket-key"])return this.log.warn(this.name+" connection invalid: received no key"),this.end(),void 0;t=this.req.headers["sec-websocket-key"],r=crypto.createHash("sha1"),r.update(t+"258EAFA5-E914-47DA-95CA-C5AB0DC85B11"),t=r.digest("base64"),n=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade","Sec-WebSocket-Accept: "+t];try{this.socket.write(n.concat("","").join("\r\n")),this.socket.setTimeout(0),this.socket.setNoDelay(!0)}catch(s){return this.end(),void 0}this.socket.on("data",function(e){o.parser.add(e)})},WebSocket.prototype.verifyOrigin=function(e){var t,r,n=this.manager.get("origins");if("null"===e&&(e="*"),-1!==n.indexOf("*:*"))return!0;if(e)try{return t=url.parse(e),t.port=t.port||80,r=~n.indexOf(t.hostname+":"+t.port)||~n.indexOf(t.hostname+":*")||~n.indexOf("*:"+t.port),r||this.log.warn("illegal origin: "+e),r}catch(o){this.log.warn("error parsing origin")}else this.log.warn("origin missing from websocket call, yet required by config");return!1},WebSocket.prototype.write=function(e){if(this.open){var t=this.frame(129,e);try{this.socket.write(t,"binary")}catch(r){return this.end(),void 0}this.log.debug(this.name+" writing",e)}},WebSocket.prototype.payload=function(e){for(var t=0,r=e.length;r>t;t++)this.write(e[t]);return this},WebSocket.prototype.frame=function(e,t){var r,n,o,s=new Buffer(t),i=s.length,a=2,c=i;switch(i>65536?(a=10,c=127):i>125&&(a=4,c=126),r=new Buffer(i+a),r[0]=e,r[1]=c,s.copy(r,a),c){case 126:r[2]=i>>>8,r[3]=i%256;break;case 127:for(n=i,o=1;8>=o;++o)r[a-o]=255&n,n>>>=8}return r},WebSocket.prototype.doClose=function(){this.socket.end()},Parser.prototype.__proto__=EventEmitter.prototype,Parser.prototype.add=function(e){var t,r;return null==this.expectBuffer?(this.addToOverflow(e),void 0):(t=Math.min(e.length,this.expectBuffer.length-this.expectOffset),e.copy(this.expectBuffer,this.expectOffset,0,t),this.expectOffset+=t,t<e.length&&(this.overflow=new Buffer(e.length-t),e.copy(this.overflow,0,t,t+this.overflow.length)),this.expectOffset==this.expectBuffer.length&&(r=this.expectBuffer,this.expectBuffer=null,this.expectOffset=0,this.expectHandler.call(this,r)),void 0)},Parser.prototype.addToOverflow=function(e){if(null==this.overflow)this.overflow=e;else{var t=this.overflow;this.overflow=new Buffer(this.overflow.length+e.length),t.copy(this.overflow,0),e.copy(this.overflow,t.length)}},Parser.prototype.expect=function(e,t,r){if(this.expectBuffer=new Buffer(t),this.expectOffset=0,this.expectHandler=r,null!=this.overflow){var n=this.overflow;this.overflow=null,this.add(n)}},Parser.prototype.processPacket=function(e){var t,r;if(0!=(112&e[0]))return this.error("reserved fields must be empty"),void 0;if(this.state.lastFragment=128==(128&e[0]),this.state.masked=128==(128&e[1]),t=15&e[0],0==t){if(this.state.opcode=this.state.activeFragmentedOperation,1!=this.state.opcode&&2!=this.state.opcode)return this.error("continuation frame cannot follow current opcode"),void 0}else this.state.opcode=t,this.state.lastFragment===!1&&(this.state.activeFragmentedOperation=t);r=this.opcodeHandlers[this.state.opcode],void 0===r?this.error("no handler for opcode "+this.state.opcode):r(e)},Parser.prototype.endPacket=function(){this.expectOffset=0,this.expectBuffer=null,this.expectHandler=null,this.state.lastFragment&&this.state.opcode==this.state.activeFragmentedOperation&&(this.state.activeFragmentedOperation=null),this.state.lastFragment=!1,this.state.opcode=null!=this.state.activeFragmentedOperation?this.state.activeFragmentedOperation:0,this.state.masked=!1,this.expect("Opcode",2,this.processPacket)},Parser.prototype.reset=function(){this.state={activeFragmentedOperation:null,lastFragment:!1,masked:!1,opcode:0},this.expectOffset=0,this.expectBuffer=null,this.expectHandler=null,this.overflow=null,this.currentMessage=""},Parser.prototype.unmask=function(e,t,r){if(null!=e)for(var n=0,o=t.length;o>n;n++)t[n]^=e[n%4];return r?t:null!=t?t.toString("utf8"):""},Parser.prototype.concatBuffers=function(e){var t,r,n,o,s=0;for(t=0,r=e.length;r>t;++t)s+=e[t].length;for(n=new Buffer(s),o=0,t=0,r=e.length;r>t;++t)e[t].copy(n,o),o+=e[t].length;return n},Parser.prototype.error=function(e){return this.reset(),this.emit("error",e),this};