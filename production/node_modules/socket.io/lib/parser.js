/*!
 * socket.io-node
 * Copyright(c) 2011 LearnBoost <dev@learnboost.com>
 * MIT Licensed
 */

function parse(e){try{return JSON.parse(e)}catch(a){return!1}}var regexp,packets=exports.packets={disconnect:0,connect:1,heartbeat:2,message:3,json:4,event:5,ack:6,error:7,noop:8},packetslist=Object.keys(packets),reasons=exports.reasons={"transport not supported":0,"client not handshaken":1,unauthorized:2},reasonslist=Object.keys(reasons),advice=exports.advice={reconnect:0},advicelist=Object.keys(advice);exports.encodePacket=function(e){var a,r,s,t,n=packets[e.type],c=e.id||"",o=e.endpoint||"",i=e.ack,d=null;switch(e.type){case"message":""!==e.data&&(d=e.data);break;case"event":a={name:e.name},e.args&&e.args.length&&(a.args=e.args),d=JSON.stringify(a);break;case"json":d=JSON.stringify(e.data);break;case"ack":d=e.ackId+(e.args&&e.args.length?"+"+JSON.stringify(e.args):"");break;case"connect":e.qs&&(d=e.qs);break;case"error":r=e.reason?reasons[e.reason]:"",s=e.advice?advice[e.advice]:"",(""!==r||""!==s)&&(d=r+(""!==s?"+"+s:""))}return t=n+":"+c+("data"==i?"+":"")+":"+o,null!==d&&void 0!==d&&(t+=":"+d),t},exports.encodePayload=function(e){var a,r,s,t="";if(1==e.length)return e[0];for(a=0,r=e.length;r>a;a++)s=e[a],t+="�"+s.length+"�"+e[a];return t},regexp=/([^:]+):([0-9]+)?(\+)?:([^:]+)?:?([\s\S]*)?/,exports.decodePacket=function(e){var a,r,s=e.match(regexp);if(!s)return{};switch(a=s[2]||"",e=s[5]||"",r={type:packetslist[s[1]],endpoint:s[4]||""},a&&(r.id=a,r.ack=s[3]?"data":!0),r.type){case"message":r.data=e||"";break;case"event":s=parse(e),s&&(r.name=s.name,r.args=s.args),r.args=r.args||[];break;case"json":r.data=parse(e);break;case"connect":r.qs=e||"";break;case"ack":s=e.match(/^([0-9]+)(\+)?(.*)/),s&&(r.ackId=s[1],r.args=[],s[3]&&(r.args=parse(s[3])||[]));break;case"error":s=e.split("+"),r.reason=reasonslist[s[0]]||"",r.advice=advicelist[s[1]]||""}return r},exports.decodePayload=function(e){var a,r,s;if(void 0==e||null==e)return[];if("�"==e[0]){for(a=[],r=1,s="";r<e.length;r++)"�"==e[r]?(a.push(exports.decodePacket(e.substr(r+1,s))),r+=Number(s)+1,s=""):s+=e[r];return a}return[exports.decodePacket(e)]};