/*!
 * socket.io-node
 * Copyright(c) 2011 LearnBoost <dev@learnboost.com>
 * MIT Licensed
 */

function Redis(t){var e,s,i,r;if(t=t||{},e=t.nodeId||function(){return Math.abs(0|Math.random()*Math.random()*Date.now())},this.nodeId=e(),t.pack)this.pack=t.pack,this.unpack=t.unpack;else try{s=null,this.pack=s.pack,this.unpack=s.unpack}catch(n){this.pack=JSON.stringify,this.unpack=JSON.parse}i=t.redis||null,r=i.RedisClient,t.redisPub instanceof r?this.pub=t.redisPub:(t.redisPub||(t.redisPub={}),this.pub=i.createClient(t.redisPub.port,t.redisPub.host,t.redisPub)),t.redisSub instanceof r?this.sub=t.redisSub:(t.redisSub||(t.redisSub={}),this.sub=i.createClient(t.redisSub.port,t.redisSub.host,t.redisSub)),t.redisClient instanceof r?this.cmd=t.redisClient:(t.redisClient||(t.redisClient={}),this.cmd=i.createClient(t.redisClient.port,t.redisClient.host,t.redisClient)),Store.call(this,t),this.sub.setMaxListeners(0),this.setMaxListeners(0)}function Client(t,e){Store.Client.call(this,t,e)}var crypto=null,Store=null,assert=null;exports=module.exports=Redis,Redis.Client=Client,Redis.prototype.__proto__=Store.prototype,Redis.prototype.publish=function(t){var e=Array.prototype.slice.call(arguments,1);this.pub.publish(t,this.pack({nodeId:this.nodeId,args:e})),this.emit.apply(this,["publish",t].concat(e))},Redis.prototype.subscribe=function(t,e,s){if(this.sub.subscribe(t),e||s){var i=this;i.sub.on("subscribe",function r(n){function o(s,r){t==s&&(r=i.unpack(r),i.nodeId!=r.nodeId&&e.apply(null,r.args))}t==n&&(i.sub.on("message",o),i.on("unsubscribe",function u(e){t==e&&(i.sub.removeListener("message",o),i.removeListener("unsubscribe",u))}),i.sub.removeListener("subscribe",r),s&&s())})}this.emit("subscribe",t,e,s)},Redis.prototype.unsubscribe=function(t,e){if(this.sub.unsubscribe(t),e){var s=this.sub;s.on("unsubscribe",function i(r){t==r&&(e(),s.removeListener("unsubscribe",i))})}this.emit("unsubscribe",t,e)},Redis.prototype.destroy=function(){Store.prototype.destroy.call(this),this.pub.end(),this.sub.end(),this.cmd.end()},Client.prototype.__proto__=Store.Client,Client.prototype.get=function(t,e){return this.store.cmd.hget(this.id,t,e),this},Client.prototype.set=function(t,e,s){return this.store.cmd.hset(this.id,t,e,s),this},Client.prototype.del=function(t,e){return this.store.cmd.hdel(this.id,t,e),this},Client.prototype.has=function(t,e){return this.store.cmd.hexists(this.id,t,function(t,s){return t?e(t):(e(null,!!s),void 0)}),this},Client.prototype.destroy=function(t){return"number"!=typeof t?this.store.cmd.del(this.id):this.store.cmd.expire(this.id,t),this};