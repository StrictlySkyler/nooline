/*!
 * socket.io-node
 * Copyright(c) 2011 LearnBoost <dev@learnboost.com>
 * MIT Licensed
 */

function Socket(t,e,i,s){this.id=e,this.namespace=i,this.manager=t,this.disconnected=!1,this.ackPackets=0,this.acks={},this.setFlags(),this.readable=s,this.store=this.manager.store.client(this.id),this.on("error",defaultError)}var defaultError,parser=null,util=null,EventEmitter=process.EventEmitter;exports=module.exports=Socket,defaultError=function(){},Socket.prototype.__proto__=EventEmitter.prototype,Socket.prototype.__defineGetter__("handshake",function(){return this.manager.handshaken[this.id]}),Socket.prototype.__defineGetter__("transport",function(){return this.manager.transports[this.id].name}),Socket.prototype.__defineGetter__("log",function(){return this.manager.log}),Socket.prototype.__defineGetter__("json",function(){return this.flags.json=!0,this}),Socket.prototype.__defineGetter__("volatile",function(){return this.flags.volatile=!0,this}),Socket.prototype.__defineGetter__("broadcast",function(){return this.flags.broadcast=!0,this}),Socket.prototype.to=Socket.prototype.in=function(t){return this.flags.room=t,this},Socket.prototype.setFlags=function(){return this.flags={endpoint:this.namespace.name,room:""},this},Socket.prototype.onDisconnect=function(t){this.disconnected||(this.$emit("disconnect",t),this.disconnected=!0)},Socket.prototype.join=function(t,e){var i=this.namespace.name,t=i+"/"+t;return this.manager.onJoin(this.id,t),this.manager.store.publish("join",this.id,t),e&&(this.log.warn("Client#join callback is deprecated"),e()),this},Socket.prototype.leave=function(t,e){var i=this.namespace.name,t=i+"/"+t;return this.manager.onLeave(this.id,t),this.manager.store.publish("leave",this.id,t),e&&(this.log.warn("Client#leave callback is deprecated"),e()),this},Socket.prototype.packet=function(t){return this.flags.broadcast?(this.log.debug("broadcasting packet"),this.namespace.in(this.flags.room).except(this.id).packet(t)):(t.endpoint=this.flags.endpoint,t=parser.encodePacket(t),this.dispatch(t,this.flags.volatile)),this.setFlags(),this},Socket.prototype.dispatch=function(t,e){this.manager.transports[this.id]&&this.manager.transports[this.id].open?this.manager.transports[this.id].onDispatch(t,e):(e||this.manager.onClientDispatch(this.id,t,e),this.manager.store.publish("dispatch:"+this.id,t,e))},Socket.prototype.set=function(t,e,i){return this.store.set(t,e,i),this},Socket.prototype.get=function(t,e){return this.store.get(t,e),this},Socket.prototype.has=function(t,e){return this.store.has(t,e),this},Socket.prototype.del=function(t,e){return this.store.del(t,e),this},Socket.prototype.disconnect=function(){return this.disconnected||(this.log.info("booting client"),""===this.namespace.name?this.manager.transports[this.id]&&this.manager.transports[this.id].open?this.manager.transports[this.id].onForcedDisconnect():(this.manager.onClientDisconnect(this.id),this.manager.store.publish("disconnect:"+this.id)):(this.packet({type:"disconnect"}),this.manager.onLeave(this.id,this.namespace.name),this.$emit("disconnect","booted"))),this},Socket.prototype.send=function(t,e){var i={type:this.flags.json?"json":"message",data:t};return e&&(i.id=++this.ackPackets,i.ack=!0,this.acks[i.id]=e),this.packet(i)},Socket.prototype.$emit=EventEmitter.prototype.emit,Socket.prototype.emit=function(t){if("newListener"==t)return this.$emit.apply(this,arguments);var e=util.toArray(arguments).slice(1),i=e[e.length-1],s={type:"event",name:t};return"function"==typeof i&&(s.id=++this.ackPackets,s.ack=i.length?"data":!0,this.acks[s.id]=i,e=e.slice(0,e.length-1)),s.args=e,this.packet(s)};