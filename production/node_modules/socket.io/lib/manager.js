/*!
 * socket.io-node
 * Copyright(c) 2011 LearnBoost <dev@learnboost.com>
 * MIT Licensed
 */

function Manager(t,e){var n,s;this.server=t,this.namespaces={},this.sockets=this.of(""),this.settings={origins:"*:*",log:!0,store:new MemoryStore,logger:new Logger,"static":new Static(this),heartbeats:!0,resource:"/socket.io",transports:defaultTransports,authorization:!1,blacklist:["disconnect"],"log level":3,"log colors":tty.isatty(process.stdout.fd),"close timeout":60,"heartbeat interval":25,"heartbeat timeout":60,"polling duration":20,"flash policy server":!0,"flash policy port":10843,"destroy upgrade":!0,"destroy buffer size":1e8,"browser client":!0,"browser client cache":!0,"browser client minification":!1,"browser client etag":!1,"browser client expires":31536e4,"browser client gzip":!1,"browser client handler":!1,"client store expiration":15,"match origin protocol":!1};for(n in e)e.hasOwnProperty(n)&&(this.settings[n]=e[n]);s=this,t.on("error",function(t){s.log.warn("error raised: "+t)}),this.initStore(),this.on("set:store",function(){s.initStore()}),this.oldListeners=t.listeners("request").splice(0),t.removeAllListeners("request"),t.on("request",function(t,e){s.handleRequest(t,e)}),t.on("upgrade",function(t,e,n){s.handleUpgrade(t,e,n)}),t.on("close",function(){clearInterval(s.gc)}),t.once("listening",function(){s.gc=setInterval(s.garbageCollection.bind(s),1e4)});for(n in transports)transports.hasOwnProperty(n)&&transports[n].init&&transports[n].init(this);s=this,this.sockets.on("connection",function(t){s.emit("connection",t)}),this.sequenceNumber=0|Date.now(),this.log.info("socket.io started")}var defaultTransports,parent,protocol,jsonpolling_re,regexp,fs=null,url=null,tty=null,crypto=null,util=null,store=null,client=null,transports=null,Logger=null,Socket=null,MemoryStore=null,SocketNamespace=null,Static=null,EventEmitter=process.EventEmitter;exports=module.exports=Manager,defaultTransports=exports.defaultTransports=["websocket","htmlfile","xhr-polling","jsonp-polling"],parent=module.parent.exports,protocol=parent.protocol,jsonpolling_re=/^\d+$/,Manager.prototype.__proto__=EventEmitter.prototype,Manager.prototype.__defineGetter__("store",function(){var t=this.get("store");return t.manager=this,t}),Manager.prototype.__defineGetter__("log",function(){var t=this.get("logger");return t.level=this.get("log level")||-1,t.colors=this.get("log colors"),t.enabled=this.enabled("log"),t}),Manager.prototype.__defineGetter__("static",function(){return this.get("static")}),Manager.prototype.get=function(t){return this.settings[t]},Manager.prototype.set=function(t,e){return 1==arguments.length?this.get(t):(this.settings[t]=e,this.emit("set:"+t,this.settings[t],t),this)},Manager.prototype.enable=function(t){return this.settings[t]=!0,this.emit("set:"+t,this.settings[t],t),this},Manager.prototype.disable=function(t){return this.settings[t]=!1,this.emit("set:"+t,this.settings[t],t),this},Manager.prototype.enabled=function(t){return!!this.settings[t]},Manager.prototype.disabled=function(t){return!this.settings[t]},Manager.prototype.configure=function(t,e){return"function"==typeof t?t.call(this):t==(process.env.NODE_ENV||"development")&&e.call(this),this},Manager.prototype.initStore=function(){this.handshaken={},this.connected={},this.open={},this.closed={},this.rooms={},this.roomClients={};var t=this;this.store.subscribe("handshake",function(e,n){t.onHandshake(e,n)}),this.store.subscribe("connect",function(e){t.onConnect(e)}),this.store.subscribe("open",function(e){t.onOpen(e)}),this.store.subscribe("join",function(e,n){t.onJoin(e,n)}),this.store.subscribe("leave",function(e,n){t.onLeave(e,n)}),this.store.subscribe("close",function(e){t.onClose(e)}),this.store.subscribe("dispatch",function(e,n,s,o){t.onDispatch(e,n,s,o)}),this.store.subscribe("disconnect",function(e){t.onDisconnect(e)})},Manager.prototype.onHandshake=function(t,e){this.handshaken[t]=e},Manager.prototype.onConnect=function(t){this.connected[t]=!0},Manager.prototype.onOpen=function(t){if(this.open[t]=!0,this.closed[t]){var e=this;this.store.unsubscribe("dispatch:"+t,function(){var n=e.transports[t];e.closed[t]&&e.closed[t].length&&n&&n.open&&(n.payload(e.closed[t]),e.closed[t]=[])})}this.transports[t]&&(this.transports[t].discard(),this.transports[t]=null)},Manager.prototype.onDispatch=function(t,e,n,s){var o,r,i;if(this.rooms[t])for(o=0,r=this.rooms[t].length;r>o;o++)i=this.rooms[t][o],~s.indexOf(i)||(this.transports[i]&&this.transports[i].open?this.transports[i].onDispatch(e,n):n||this.onClientDispatch(i,e))},Manager.prototype.onJoin=function(t,e){this.roomClients[t]||(this.roomClients[t]={}),this.rooms[e]||(this.rooms[e]=[]),~this.rooms[e].indexOf(t)||(this.rooms[e].push(t),this.roomClients[t][e]=!0)},Manager.prototype.onLeave=function(t,e){if(this.rooms[e]){var n=this.rooms[e].indexOf(t);n>=0&&this.rooms[e].splice(n,1),this.rooms[e].length||delete this.rooms[e],this.roomClients[t]&&delete this.roomClients[t][e]}},Manager.prototype.onClose=function(t){this.open[t]&&delete this.open[t],this.closed[t]=[];var e=this;this.store.subscribe("dispatch:"+t,function(n,s){s||e.onClientDispatch(t,n)})},Manager.prototype.onClientDispatch=function(t,e){this.closed[t]&&this.closed[t].push(e)},Manager.prototype.onClientMessage=function(t,e){this.namespaces[e.endpoint]&&this.namespaces[e.endpoint].handlePacket(t,e)},Manager.prototype.onClientDisconnect=function(t,e){for(var n in this.namespaces)this.namespaces.hasOwnProperty(n)&&this.namespaces[n].handleDisconnect(t,e,void 0!==this.roomClients[t]&&void 0!==this.roomClients[t][n]);this.onDisconnect(t)},Manager.prototype.onDisconnect=function(t,e){if(delete this.handshaken[t],this.open[t]&&delete this.open[t],this.connected[t]&&delete this.connected[t],this.transports[t]&&(this.transports[t].discard(),delete this.transports[t]),this.closed[t]&&delete this.closed[t],this.roomClients[t]){for(var n in this.roomClients[t])this.roomClients[t].hasOwnProperty(n)&&this.onLeave(t,n);delete this.roomClients[t]}this.store.destroyClient(t,this.get("client store expiration")),this.store.unsubscribe("dispatch:"+t),e&&(this.store.unsubscribe("message:"+t),this.store.unsubscribe("disconnect:"+t))},Manager.prototype.handleRequest=function(t,e){var n,s,o=this.checkRequest(t);{if(o)return o.static||!o.transport&&!o.protocol?(o.static&&this.enabled("browser client")?this.static.write(o.path,t,e):(e.writeHead(200),e.end("Welcome to socket.io."),this.log.info("unhandled socket.io url")),void 0):(o.protocol!=protocol?(e.writeHead(500),e.end("Protocol version not supported."),this.log.info("client protocol version unsupported")):o.id?this.handleHTTPRequest(o,t,e):this.handleHandshake(o,t,e),void 0);for(n=0,s=this.oldListeners.length;s>n;n++)this.oldListeners[n].call(this.server,t,e)}},Manager.prototype.handleUpgrade=function(t,e,n){var s=this.checkRequest(t);return s?(t.head=n,this.handleClient(s,t),t.head=null,void 0):(this.enabled("destroy upgrade")&&(e.end(),this.log.debug("destroying non-socket.io upgrade")),void 0)},Manager.prototype.handleHTTPRequest=function(t,e,n){e.res=n,this.handleClient(t,e)},Manager.prototype.handleClient=function(t,e){var n,s,o,r=(e.socket,this.store,this);if(void 0!=t.query.disconnect)return this.transports[t.id]&&this.transports[t.id].open?this.transports[t.id].onForcedDisconnect():this.store.publish("disconnect-force:"+t.id),e.res.writeHead(200),e.res.end(),void 0;if(!~this.get("transports").indexOf(t.transport))return this.log.warn('unknown transport: "'+t.transport+'"'),e.connection.end(),void 0;if(n=new transports[t.transport](this,t,e),s=this.handshaken[t.id],n.disconnected)return e.connection.end(),void 0;if(s){if(n.open&&(this.closed[t.id]&&this.closed[t.id].length&&(n.payload(this.closed[t.id]),this.closed[t.id]=[]),this.onOpen(t.id),this.store.publish("open",t.id),this.transports[t.id]=n),!this.connected[t.id]){this.onConnect(t.id),this.store.publish("connect",t.id),delete s.issued,this.onHandshake(t.id,s),this.store.publish("handshake",t.id,s);for(o in this.namespaces)this.namespaces.hasOwnProperty(o)&&(this.namespaces[o].socket(t.id,!0),""===o&&this.namespaces[o].handlePacket(t.id,{type:"connect"}));this.store.subscribe("message:"+t.id,function(e){r.onClientMessage(t.id,e)}),this.store.subscribe("disconnect:"+t.id,function(e){r.onClientDisconnect(t.id,e)})}}else n.open&&n.error("client not handshaken","reconnect"),n.discard()},Manager.prototype.generateId=function(){var t=new Buffer(15);return t.writeInt32BE?(this.sequenceNumber=0|this.sequenceNumber+1,t.writeInt32BE(this.sequenceNumber,11),crypto.randomBytes?crypto.randomBytes(12).copy(t):[0,4,8].forEach(function(e){t.writeInt32BE(0|Math.random()*Math.pow(2,32),e)}),t.toString("base64").replace(/\//g,"_").replace(/\+/g,"-")):""+Math.abs(0|Math.random()*Math.random()*Date.now())+(""+Math.abs(0|Math.random()*Math.random()*Date.now()))},Manager.prototype.handleHandshake=function(t,e,n){function s(e,s){t.query.jsonp&&jsonpolling_re.test(t.query.jsonp)?(n.writeHead(200,{"Content-Type":"application/javascript"}),n.end("io.j["+t.query.jsonp+'](new Error("'+s+'"));')):(n.writeHead(e,h),n.end(s))}function o(t){s(500,"handshake error"),i.log.warn("handshake error "+t)}var r,i=this,a=e.headers.origin,h={"Content-Type":"text/plain"};return this.verifyOrigin(e)?(r=this.handshakeData(t),a&&(h["Access-Control-Allow-Origin"]=a,h["Access-Control-Allow-Credentials"]="true"),this.authorize(r,function(e,a,c){if(e)return o(e);if(a){var l=i.generateId(),p=[l,i.enabled("heartbeats")?i.get("heartbeat timeout")||"":"",i.get("close timeout")||"",i.transports(t).join(",")].join(":");t.query.jsonp&&jsonpolling_re.test(t.query.jsonp)?(p="io.j["+t.query.jsonp+"]("+JSON.stringify(p)+");",n.writeHead(200,{"Content-Type":"application/javascript"})):n.writeHead(200,h),n.end(p),i.onHandshake(l,c||r),i.store.publish("handshake",l,c||r),i.log.info("handshake authorized",l)}else s(403,"handshake unauthorized"),i.log.info("handshake unauthorized")}),void 0):(s(403,"handshake bad origin"),void 0)},Manager.prototype.handshakeData=function(t){var e,n=t.request.connection,s=new Date;return n.remoteAddress?e={address:n.remoteAddress,port:n.remotePort}:n.socket&&n.socket.remoteAddress&&(e={address:n.socket.remoteAddress,port:n.socket.remotePort}),{headers:t.headers,address:e,time:""+s,query:t.query,url:t.request.url,xdomain:!!t.request.headers.origin,secure:t.request.connection.secure,issued:+s}},Manager.prototype.verifyOrigin=function(t){var e,n,s=t.headers.origin||t.headers.referer,o=this.get("origins");if("null"===s&&(s="*"),-1!==o.indexOf("*:*"))return!0;if(s)try{return e=url.parse(s),e.port=e.port||80,n=~o.indexOf(e.hostname+":"+e.port)||~o.indexOf(e.hostname+":*")||~o.indexOf("*:"+e.port),n||this.log.warn("illegal origin: "+s),n}catch(r){this.log.warn("error parsing origin")}else this.log.warn("origin missing from handshake, yet required by config");return!1},Manager.prototype.handlePacket=function(t,e){this.of(e.endpoint||"").handlePacket(t,e)},Manager.prototype.authorize=function(t,e){if(this.get("authorization")){var n=this;this.get("authorization").call(this,t,function(t,s){n.log.debug("authorized"),e(t,s)})}else this.log.debug("client authorized"),e(null,!0);return this},Manager.prototype.transports=function(t){var e,n,s,o=this.get("transports"),r=[];for(e=0,n=o.length;n>e;e++)s=o[e],s&&(!s.checkClient||s.checkClient(t))&&r.push(s);return r},regexp=/^\/([^\/]+)\/?([^\/]+)?\/?([^\/]+)?\/?$/,Manager.prototype.checkRequest=function(t){var e,n,s,o,r,i=this.get("resource");return"string"==typeof i?(e=t.url.substr(0,i.length),e!==i&&(e=null)):(e=i.exec(t.url),e&&(e=e[0])),e?(n=url.parse(t.url.substr(e.length),!0),s=n.pathname||"",o=s.match(regexp),r={query:n.query||{},headers:t.headers,request:t,path:s},o&&(r.protocol=Number(o[1]),r.transport=o[2],r.id=o[3],r.static=!!this.static.has(s)),r):!1},Manager.prototype.of=function(t){return this.namespaces[t]?this.namespaces[t]:this.namespaces[t]=new SocketNamespace(this,t)},Manager.prototype.garbageCollection=function(){for(var t,e=Object.keys(this.handshaken),n=e.length,s=Date.now();n--;)t=this.handshaken[e[n]],"issued"in t&&s-t.issued>=3e4&&this.onDisconnect(e[n])};