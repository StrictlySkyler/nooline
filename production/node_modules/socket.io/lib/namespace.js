function SocketNamespace(t,e){this.manager=t,this.name=e||"",this.sockets={},this.auth=!1,this.setFlags()}var Socket=null,EventEmitter=process.EventEmitter,parser=null,util=null;exports=module.exports=SocketNamespace,SocketNamespace.prototype.__proto__=EventEmitter.prototype,SocketNamespace.prototype.$emit=EventEmitter.prototype.emit,SocketNamespace.prototype.clients=function(t){var t=this.name+(void 0!==t?"/"+t:"");return this.manager.rooms[t]?this.manager.rooms[t].map(function(t){return this.socket(t)},this):[]},SocketNamespace.prototype.__defineGetter__("log",function(){return this.manager.log}),SocketNamespace.prototype.__defineGetter__("store",function(){return this.manager.store}),SocketNamespace.prototype.__defineGetter__("json",function(){return this.flags.json=!0,this}),SocketNamespace.prototype.__defineGetter__("volatile",function(){return this.flags.volatile=!0,this}),SocketNamespace.prototype.in=SocketNamespace.prototype.to=function(t){return this.flags.endpoint=this.name+(t?"/"+t:""),this},SocketNamespace.prototype.except=function(t){return this.flags.exceptions.push(t),this},SocketNamespace.prototype.setFlags=function(){return this.flags={endpoint:this.name,exceptions:[]},this},SocketNamespace.prototype.packet=function(t){t.endpoint=this.name;var e=(this.store,this.log,this.flags.volatile),s=this.flags.exceptions,t=parser.encodePacket(t);return this.manager.onDispatch(this.flags.endpoint,t,e,s),this.store.publish("dispatch",this.flags.endpoint,t,e,s),this.setFlags(),this},SocketNamespace.prototype.send=function(t){return this.packet({type:this.flags.json?"json":"message",data:t})},SocketNamespace.prototype.emit=function(t){return"newListener"==t?this.$emit.apply(this,arguments):this.packet({type:"event",name:t,args:util.toArray(arguments).slice(1)})},SocketNamespace.prototype.socket=function(t,e){return this.sockets[t]||(this.sockets[t]=new Socket(this.manager,t,this,e)),this.sockets[t]},SocketNamespace.prototype.authorization=function(t){return this.auth=t,this},SocketNamespace.prototype.handleDisconnect=function(t,e,s){this.sockets[t]&&this.sockets[t].readable&&(s&&this.sockets[t].onDisconnect(e),delete this.sockets[t])},SocketNamespace.prototype.authorize=function(t,e){if(this.auth){var s=this;this.auth.call(this,t,function(t,a){s.log.debug("client "+(a?"":"un")+"authorized for "+s.name),e(t,a)})}else this.log.debug("client authorized for "+this.name),e(null,!0);return this},SocketNamespace.prototype.handlePacket=function(t,e){function s(){h.log.debug("sending data ack packet"),c.packet({type:"ack",args:util.toArray(arguments),ackId:e.id})}function a(t){h.log.warn("handshake error "+t+" for "+h.name),c.packet({type:"error",reason:t})}function o(){h.manager.onJoin(t,h.name),h.store.publish("join",t,h.name),c.packet({type:"connect"}),h.$emit("connection",c)}var n,i,c=this.socket(t),r="data"==e.ack,p=this.manager,h=this;switch(e.type){case"connect":""==e.endpoint?o():(n=p.handshaken[t],this.authorize(n,function(e,s,i){return e?a(e):(s?(p.onHandshake(t,i||n),h.store.publish("handshake",t,i||n),o()):a("unauthorized"),void 0)}));break;case"ack":c.acks[e.ackId]?c.acks[e.ackId].apply(c,e.args):this.log.info("unknown ack packet");break;case"event":-~p.get("blacklist").indexOf(e.name)?this.log.debug("ignoring blacklisted event `"+e.name+"`"):(i=[e.name].concat(e.args),r&&i.push(s),c.$emit.apply(c,i));break;case"disconnect":this.manager.onLeave(t,this.name),this.store.publish("leave",t,this.name),c.$emit("disconnect",e.reason||"packet");break;case"json":case"message":i=["message",e.data],r&&i.push(s),c.$emit.apply(c,i)}};