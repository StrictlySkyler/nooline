/*!
* socket.io-node
* Copyright(c) 2011 LearnBoost <dev@learnboost.com>
* MIT Licensed
*/

function Static(e){this.manager=e,this.cache={},this.paths={},this.init()}var client=null,cp=null,fs=null,util=null,mime={js:{type:"application/javascript",encoding:"utf8",gzip:!0},swf:{type:"application/x-shockwave-flash",encoding:"binary",gzip:!1}},bundle=/\+((?:\+)?[\w\-]+)*(?:\.v\d+\.\d+\.\d+)?(?:\.js)$/,versioning=/\.v\d+\.\d+\.\d+(?:\.js)$/;exports=module.exports=Static,Static.prototype.init=function(){function e(e){var t=e.join("").split("").map(function(e){return(""+e.charCodeAt(0)).split("").pop()}).reduce(function(e,t){return e+t});return client.version+":"+t}function t(t,i){client.builder(t,{minify:n.manager.enabled("browser client minification")},function(n,a){i(n,a?new Buffer(a):null,e(t))})}var n=this;this.add("/static/flashsocket/WebSocketMain.swf",{file:client.dist+"/WebSocketMain.swf"}),this.add("/static/flashsocket/WebSocketMainInsecure.swf",{file:client.dist+"/WebSocketMainInsecure.swf"}),this.add("/socket.io.js",function(e,i){t(n.manager.get("transports"),i)}),this.add("/socket.io.v",{mime:mime.js},function(e,i){t(n.manager.get("transports"),i)}),this.add("/socket.io+",{mime:mime.js},function(e,i){var a=n.manager.get("transports"),o=e.match(bundle),r=[];return o?(o[0].split(".")[0].split("+").slice(1).forEach(function(e){~a.indexOf(e)&&r.push(e)}),r.length?(t(r,i),void 0):i("No valid transports")):i("No valid transports")}),this.manager.on("set:transports",function(){delete n.cache["/socket.io.js"],Object.keys(n.cache).forEach(function(e){bundle.test(e)&&delete n.cache[e]})})},Static.prototype.gzip=function(e,t){var n,i=cp.spawn("gzip",["-9","-c","-f","-n"]),a=Buffer.isBuffer(e)?"binary":"utf8",o=[];i.stdout.on("data",function(e){o.push(e)}),i.stderr.on("data",function(e){n=e+"",o.length=0}),i.on("close",function(){if(n)return t(n);for(var e,i=0,a=0,r=o.length;r--;)i+=o[r].length;e=new Buffer(i),r=o.length,o.forEach(function(t){var n=t.length;t.copy(e,a,0,n),a+=n}),o.length=0,t(null,e)}),i.stdin.end(e,a)},Static.prototype.has=function(e){if(this.paths[e])return this.paths[e];for(var t=Object.keys(this.paths),n=t.length;n--;)if(-~e.indexOf(t[n]))return this.paths[t[n]];return!1},Static.prototype.add=function(e,t,n){var i=/(?:\.(\w{1,4}))$/.exec(e);return n||"function"!=typeof t||(n=t,t={}),t.mime=t.mime||(i?mime[i[1]]:!1),n&&(t.callback=n),(t.file||t.callback)&&t.mime?(this.paths[e]=t,!0):!1},Static.prototype.write=function(e,t,n){function i(e,i,a,o){try{n.writeHead(e,i||void 0),n.end("HEAD"!==t.method&&a?a:"",o||void 0)}catch(r){}}function a(n){var a,o,r,s,l,h,g=t.headers["if-none-match"]===n.etag;return g&&c.manager.enabled("browser client etag")?i(304):(a=t.headers["accept-encoding"]||"",o=!!~a.toLowerCase().indexOf("gzip"),r=n.mime,s=n.versioned,l={"Content-Type":r.type},c.manager.enabled("browser client etag")&&n.etag&&!s&&(l.Etag=n.etag),s&&(h=c.manager.get("browser client expires"),l["Cache-Control"]='private, x-gzip-ok="", max-age='+h,l.Date=(new Date).toUTCString(),l.Expires=new Date(Date.now()+1e3*h).toUTCString()),o&&n.gzip?(l["Content-Length"]=n.gzip.length,l["Content-Encoding"]="gzip",l.Vary="Accept-Encoding",i(200,l,n.gzip.content,r.encoding)):(l["Content-Length"]=n.length,i(200,l,n.content,r.encoding)),c.manager.log.debug("served static content "+e),void 0)}function o(t,n,o){if(t)return c.manager.log.warn("Unable to serve file. "+(t.message||t)),i(500,null,"Error serving static "+e);var s=c.cache[e]={content:n,length:n.length,mime:r.mime,etag:o||client.version,versioned:versioning.test(e)};r.mime.gzip&&c.manager.enabled("browser client gzip")?c.gzip(n,function(e,t){e||(s.gzip={content:t,length:t.length}),a(s)}):a(s)}var r,c=this;return this.manager.enabled("browser client cache")&&this.cache[e]?a(this.cache[e]):this.manager.get("browser client handler")?this.manager.get("browser client handler").call(this,t,n):((r=this.has(e))?r.file?fs.readFile(r.file,o):r.callback?r.callback.call(this,e,o):i(404,null,"File handle not found"):i(404,null,"File not found"),void 0)};