function RedisReplyParser(t){this.name=exports.name,this.options=t||{},this.reset(),events.EventEmitter.call(this)}function small_toString(t,e){var s,i="";for(s=0;e>s;s+=1)i+=String.fromCharCode(t[s]);return i}var events=require("events"),util=require("../util");exports.debug_mode=!1,exports.name="javascript",util.inherits(RedisReplyParser,events.EventEmitter),exports.Parser=RedisReplyParser,RedisReplyParser.prototype.reset=function(){this.return_buffer=new Buffer(16384),this.return_string="",this.tmp_string="",this.multi_bulk_length=0,this.multi_bulk_replies=null,this.multi_bulk_pos=0,this.multi_bulk_nested_length=0,this.multi_bulk_nested_replies=null,this.states={TYPE:1,SINGLE_LINE:2,MULTI_BULK_COUNT:3,INTEGER_LINE:4,BULK_LENGTH:5,ERROR_LINE:6,BULK_DATA:7,UNKNOWN_TYPE:8,FINAL_CR:9,FINAL_LF:10,MULTI_BULK_COUNT_LF:11,BULK_LF:12},this.state=this.states.TYPE},RedisReplyParser.prototype.parser_error=function(t){this.emit("error",t),this.reset()},RedisReplyParser.prototype.execute=function(t){for(var e,s,i,r=0,l=this.states;r<t.length;)switch(this.state){case 1:switch(this.type=t[r],r+=1,this.type){case 43:this.state=l.SINGLE_LINE,this.return_buffer.end=0,this.return_string="";break;case 42:this.state=l.MULTI_BULK_COUNT,this.tmp_string="";break;case 58:this.state=l.INTEGER_LINE,this.return_buffer.end=0,this.return_string="";break;case 36:this.state=l.BULK_LENGTH,this.tmp_string="";break;case 45:this.state=l.ERROR_LINE,this.return_buffer.end=0,this.return_string="";break;default:this.state=l.UNKNOWN_TYPE}break;case 4:13===t[r]?(this.send_reply(+small_toString(this.return_buffer,this.return_buffer.end)),this.state=l.FINAL_LF):(this.return_buffer[this.return_buffer.end]=t[r],this.return_buffer.end+=1),r+=1;break;case 6:13===t[r]?(this.send_error(this.return_buffer.toString("ascii",0,this.return_buffer.end)),this.state=l.FINAL_LF):(this.return_buffer[this.return_buffer.end]=t[r],this.return_buffer.end+=1),r+=1;break;case 2:13===t[r]?(this.send_reply(this.return_string),this.state=l.FINAL_LF):this.return_string+=String.fromCharCode(t[r]),r+=1;break;case 3:13===t[r]?this.state=l.MULTI_BULK_COUNT_LF:this.tmp_string+=String.fromCharCode(t[r]),r+=1;break;case 11:if(10!==t[r])return this.parser_error(Error("didn't see LF after NL reading multi bulk count")),void 0;this.multi_bulk_length&&(this.multi_bulk_nested_length=this.multi_bulk_length,this.multi_bulk_nested_replies=this.multi_bulk_replies,this.multi_bulk_nested_pos=this.multi_bulk_pos),this.multi_bulk_length=+this.tmp_string,this.multi_bulk_pos=0,this.state=l.TYPE,this.multi_bulk_length<0?(this.send_reply(null),this.multi_bulk_length=0):0===this.multi_bulk_length?(this.multi_bulk_pos=0,this.multi_bulk_replies=null,this.send_reply([])):this.multi_bulk_replies=Array(this.multi_bulk_length),r+=1;break;case 5:13===t[r]?this.state=l.BULK_LF:this.tmp_string+=String.fromCharCode(t[r]),r+=1;break;case 12:if(10!==t[r])return this.parser_error(Error("didn't see LF after NL while reading bulk length")),void 0;this.bulk_length=+this.tmp_string,-1===this.bulk_length?(this.send_reply(null),this.state=l.TYPE):0===this.bulk_length?(this.send_reply(new Buffer("")),this.state=l.FINAL_CR):(this.state=l.BULK_DATA,this.bulk_length>this.return_buffer.length&&(exports.debug_mode&&console.log("Growing return_buffer from "+this.return_buffer.length+" to "+this.bulk_length),this.return_buffer=new Buffer(this.bulk_length)),this.return_buffer.end=0),r+=1;break;case 7:if(this.return_buffer[this.return_buffer.end]=t[r],this.return_buffer.end+=1,r+=1,this.return_buffer.end===this.bulk_length){if(e=new Buffer(this.bulk_length),this.bulk_length>10)this.return_buffer.copy(e,0,0,this.bulk_length);else for(s=0,i=this.bulk_length;i>s;s+=1)e[s]=this.return_buffer[s];this.send_reply(e),this.state=l.FINAL_CR}break;case 9:if(13!==t[r])return this.parser_error(Error("saw "+t[r]+" when expecting final CR")),void 0;this.state=l.FINAL_LF,r+=1;break;case 10:if(10!==t[r])return this.parser_error(Error("saw "+t[r]+" when expecting final LF")),void 0;this.state=l.TYPE,r+=1;break;default:this.parser_error(Error("invalid state "+this.state))}},RedisReplyParser.prototype.send_error=function(t){this.multi_bulk_length>0||this.multi_bulk_nested_length>0?this.add_multi_bulk_reply(t):this.emit("reply error",t)},RedisReplyParser.prototype.send_reply=function(t){this.multi_bulk_length>0||this.multi_bulk_nested_length>0?!this.options.return_buffers&&Buffer.isBuffer(t)?this.add_multi_bulk_reply(t.toString("utf8")):this.add_multi_bulk_reply(t):!this.options.return_buffers&&Buffer.isBuffer(t)?this.emit("reply",t.toString("utf8")):this.emit("reply",t)},RedisReplyParser.prototype.add_multi_bulk_reply=function(t){if(this.multi_bulk_replies){if(this.multi_bulk_replies[this.multi_bulk_pos]=t,this.multi_bulk_pos+=1,this.multi_bulk_pos<this.multi_bulk_length)return}else this.multi_bulk_replies=t;this.multi_bulk_nested_length>0?(this.multi_bulk_nested_replies[this.multi_bulk_nested_pos]=this.multi_bulk_replies,this.multi_bulk_nested_pos+=1,this.multi_bulk_length=0,this.multi_bulk_replies=null,this.multi_bulk_pos=0,this.multi_bulk_nested_length===this.multi_bulk_nested_pos&&(this.emit("reply",this.multi_bulk_nested_replies),this.multi_bulk_nested_length=0,this.multi_bulk_nested_pos=0,this.multi_bulk_nested_replies=null)):(this.emit("reply",this.multi_bulk_replies),this.multi_bulk_length=0,this.multi_bulk_replies=null,this.multi_bulk_pos=0)};